<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload File - Google Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fa-solid fa-cloud-arrow-up mr-2"></i>Test Upload File lên Google Drive
        </h1>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Chọn file để upload:
            </label>
            <input 
                type="file" 
                id="file-input" 
                accept="image/*" 
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
        </div>

        <div id="preview" class="mb-6 hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Preview:</label>
            <img id="preview-img" src="" alt="Preview" class="max-w-full h-64 object-contain border rounded-lg">
        </div>

        <div class="flex gap-3">
            <button 
                id="btn-upload" 
                onclick="testUpload()" 
                class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
                <i class="fa-solid fa-upload mr-2"></i>Test Upload
            </button>
            <button 
                onclick="clearForm()" 
                class="px-6 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition"
            >
                <i class="fa-solid fa-rotate-left mr-2"></i>Clear
            </button>
        </div>

        <div id="result" class="mt-6 hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-3">Kết quả:</h2>
            <div id="result-content" class="p-4 rounded-lg border"></div>
        </div>

        <div id="debug" class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h2 class="text-lg font-bold text-gray-800 mb-3">Debug Info:</h2>
            <pre id="debug-content" class="text-xs text-gray-600 overflow-auto max-h-64"></pre>
        </div>
    </div>

    <!-- Load scripts -->
    <script src="js/google-docs-config.js"></script>
    <script src="js/google-docs-api.js"></script>
    <script src="js/utils.js"></script>

    <script>
        let debugLogs = [];

        function addDebugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const logEntry = `[${timestamp}] ${message}` + (data ? '\n' + JSON.stringify(data, null, 2) : '');
            debugLogs.push(logEntry);
            updateDebugDisplay();
            console.log(message, data || '');
        }

        function updateDebugDisplay() {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.textContent = debugLogs.join('\n\n');
            }
        }

        // Preview image
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    const previewImg = document.getElementById('preview-img');
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                addDebugLog('File selected:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
            }
        });

        async function testUpload() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                if (typeof window.showToast === 'function') {
                    window.showToast('Vui lòng chọn file để upload', 'warning');
                } else {
                    alert('Vui lòng chọn file để upload');
                }
                return;
            }

            const btn = document.getElementById('btn-upload');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang upload...';

            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');
            resultDiv.classList.add('hidden');

            try {
                addDebugLog('=== Bắt đầu upload ===');
                
                // Check Google Docs API
                if (!window.googleDocsAPI || !window.googleDocsAPI.uploadFiles) {
                    throw new Error('Google Docs API chưa được load. Kiểm tra js/google-docs-api.js');
                }
                
                addDebugLog('Google Docs API đã sẵn sàng');

                // Check URL
                if (!window.GOOGLE_DOCS_CONFIG || !window.GOOGLE_DOCS_CONFIG.url) {
                    throw new Error('Google Apps Script URL chưa được cấu hình');
                }
                
                addDebugLog('Google Apps Script URL:', window.GOOGLE_DOCS_CONFIG.url);

                // Create FileList
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const fileList = dataTransfer.files;

                addDebugLog('FileList created:', {
                    length: fileList.length,
                    fileNames: Array.from(fileList).map(f => f.name)
                });

                // Upload
                addDebugLog('Đang gọi uploadFiles...');
                const uploadResult = await window.googleDocsAPI.uploadFiles(fileList);

                addDebugLog('Upload result:', uploadResult);
                addDebugLog('Upload result type:', typeof uploadResult);
                addDebugLog('Upload result keys:', uploadResult ? Object.keys(uploadResult) : 'null');

                // Display result
                resultDiv.classList.remove('hidden');
                
                // Check success - be more flexible
                const isSuccess = uploadResult && (
                    uploadResult.success === true || 
                    (uploadResult.urls && uploadResult.urls.length > 0) ||
                    (!uploadResult.error && !uploadResult.corsError && !uploadResult.message?.includes('thất bại'))
                );
                
                if (isSuccess) {
                    resultContent.className = 'p-4 rounded-lg border border-green-200 bg-green-50';
                    resultContent.innerHTML = `
                        <div class="text-green-700">
                            <p class="font-bold mb-2"><i class="fa-solid fa-check-circle mr-2"></i>Upload thành công!</p>
                            ${uploadResult.urls && uploadResult.urls.length > 0 ? `
                                <p class="text-sm mb-2">Đã upload ${uploadResult.urls.length} file:</p>
                                <ul class="list-disc list-inside text-sm space-y-1">
                                    ${uploadResult.urls.map(url => `
                                        <li>
                                            <a href="${url.url}" target="_blank" class="text-blue-600 hover:underline">
                                                ${url.name}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : '<p class="text-sm">File đã được upload (không có URL trả về)</p>'}
                        </div>
                    `;
                    
                    if (typeof window.showToast === 'function') {
                        window.showToast('Upload thành công!', 'success');
                    }
                } else {
                    resultContent.className = 'p-4 rounded-lg border border-red-200 bg-red-50';
                    resultContent.innerHTML = `
                        <div class="text-red-700">
                            <p class="font-bold mb-2"><i class="fa-solid fa-exclamation-circle mr-2"></i>Upload thất bại!</p>
                            <p class="text-sm">${uploadResult.message || 'Lỗi không xác định'}</p>
                            ${uploadResult.corsError ? `
                                <p class="text-sm mt-2 text-orange-700">
                                    <strong>Lỗi CORS:</strong> Google Apps Script chưa được deploy đúng cách hoặc CORS chưa được fix.
                                </p>
                            ` : ''}
                            ${uploadResult.error ? `
                                <p class="text-sm mt-2">Chi tiết: ${uploadResult.error}</p>
                            ` : ''}
                        </div>
                    `;
                    
                    if (typeof window.showToast === 'function') {
                        window.showToast('Upload thất bại: ' + (uploadResult.message || 'Lỗi không xác định'), 'danger');
                    }
                }
            } catch (error) {
                addDebugLog('Exception caught:', error);
                console.error('Upload error:', error);
                
                resultDiv.classList.remove('hidden');
                resultContent.className = 'p-4 rounded-lg border border-red-200 bg-red-50';
                resultContent.innerHTML = `
                    <div class="text-red-700">
                        <p class="font-bold mb-2"><i class="fa-solid fa-exclamation-circle mr-2"></i>Lỗi!</p>
                        <p class="text-sm">${error.message}</p>
                        <p class="text-xs mt-2 text-gray-600">Xem console để biết thêm chi tiết</p>
                    </div>
                `;
                
                if (typeof window.showToast === 'function') {
                    window.showToast('Lỗi: ' + error.message, 'danger');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function clearForm() {
            document.getElementById('file-input').value = '';
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            debugLogs = [];
            updateDebugDisplay();
        }

        // Check on load
        window.addEventListener('load', () => {
            addDebugLog('=== Page loaded ===');
            addDebugLog('Google Docs API:', typeof window.googleDocsAPI !== 'undefined' ? 'Đã load' : 'Chưa load');
            addDebugLog('Google Docs Config:', window.GOOGLE_DOCS_CONFIG ? 'Đã load' : 'Chưa load');
            if (window.GOOGLE_DOCS_CONFIG) {
                addDebugLog('Script URL:', window.GOOGLE_DOCS_CONFIG.url);
            }
        });
    </script>
</body>
</html>

