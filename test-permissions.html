<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permissions System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fa-solid fa-flask text-purple-600 mr-2"></i>
                Test Hệ Thống Phân Quyền
            </h1>

            <!-- Test 1: Kiểm tra Migration -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-lg font-semibold text-blue-800 mb-3">
                    <i class="fa-solid fa-database mr-2"></i>
                    Test 1: Kiểm tra Migration
                </h2>
                <p class="text-sm text-gray-600 mb-3">
                    Kiểm tra xem cột permissions đã được thêm vào bảng users chưa
                </p>
                <button 
                    onclick="testMigration()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                >
                    <i class="fa-solid fa-play mr-2"></i>Chạy Test
                </button>
                <div id="test1-result" class="mt-3 text-sm"></div>
            </div>

            <!-- Test 2: Kiểm tra Permissions Helper -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                <h2 class="text-lg font-semibold text-purple-800 mb-3">
                    <i class="fa-solid fa-code mr-2"></i>
                    Test 2: Kiểm tra Permissions Helper Functions
                </h2>
                <p class="text-sm text-gray-600 mb-3">
                    Kiểm tra xem permissions.js đã được load và functions có hoạt động không
                </p>
                <button 
                    onclick="testPermissionsHelper()" 
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                >
                    <i class="fa-solid fa-play mr-2"></i>Chạy Test
                </button>
                <div id="test2-result" class="mt-3 text-sm"></div>
            </div>

            <!-- Test 3: Kiểm tra User với Permissions -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-lg font-semibold text-green-800 mb-3">
                    <i class="fa-solid fa-user-check mr-2"></i>
                    Test 3: Kiểm tra User Permissions
                </h2>
                <p class="text-sm text-gray-600 mb-3">
                    Kiểm tra xem user có permissions và hệ thống đọc được không
                </p>
                <div class="mb-3">
                    <input 
                        type="text" 
                        id="test-username" 
                        placeholder="Nhập username (ví dụ: admin, tvbh1)"
                        class="px-3 py-2 border border-gray-300 rounded-lg w-full max-w-xs"
                        value="admin"
                    >
                </div>
                <button 
                    onclick="testUserPermissions()" 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                >
                    <i class="fa-solid fa-play mr-2"></i>Chạy Test
                </button>
                <div id="test3-result" class="mt-3 text-sm"></div>
            </div>

            <!-- Test 4: Test API Update Permissions -->
            <div class="mb-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                <h2 class="text-lg font-semibold text-orange-800 mb-3">
                    <i class="fa-solid fa-cloud-upload-alt mr-2"></i>
                    Test 4: Test API Update Permissions
                </h2>
                <p class="text-sm text-gray-600 mb-3">
                    Test API để cập nhật permissions cho user (cần đăng nhập ADMIN)
                </p>
                <button 
                    onclick="testUpdatePermissions()" 
                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
                >
                    <i class="fa-solid fa-play mr-2"></i>Chạy Test
                </button>
                <div id="test4-result" class="mt-3 text-sm"></div>
            </div>

            <!-- Results Summary -->
            <div id="summary" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <h3 class="font-semibold text-gray-800 mb-2">Tổng kết:</h3>
                <div id="summary-content" class="text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/supabase-api.js"></script>
    <script src="js/permissions.js"></script>

    <script>
        const testResults = {};

        async function testMigration() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div class="text-blue-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang kiểm tra...</div>';
            
            try {
                // Load supabase config
                if (typeof window.SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Supabase config chưa được load');
                }

                const { createClient } = supabase;
                const supabaseClient = createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );

                // Test: Lấy một user và kiểm tra có cột permissions không
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('username, permissions')
                    .limit(1);

                if (error) {
                    throw error;
                }

                if (users && users.length > 0) {
                    const user = users[0];
                    const hasPermissionsColumn = 'permissions' in user;
                    
                    testResults.migration = {
                        success: hasPermissionsColumn,
                        message: hasPermissionsColumn 
                            ? `✅ Cột permissions đã tồn tại! Giá trị mặc định: ${JSON.stringify(user.permissions)}`
                            : '❌ Cột permissions chưa tồn tại'
                    };
                    
                    resultDiv.innerHTML = `
                        <div class="${hasPermissionsColumn ? 'text-green-600' : 'text-red-600'}">
                            ${testResults.migration.message}
                        </div>
                    `;
                } else {
                    throw new Error('Không tìm thấy user nào');
                }
            } catch (error) {
                testResults.migration = {
                    success: false,
                    message: `❌ Lỗi: ${error.message}`
                };
                resultDiv.innerHTML = `<div class="text-red-600">${testResults.migration.message}</div>`;
            }
            
            updateSummary();
        }

        function testPermissionsHelper() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '<div class="text-purple-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang kiểm tra...</div>';
            
            try {
                const checks = {
                    'window.Permissions': typeof window.Permissions !== 'undefined',
                    'hasPermission function': typeof hasPermission === 'function',
                    'getUserPermissions function': typeof getUserPermissions === 'function',
                    'ALL_PERMISSIONS': typeof window.Permissions !== 'undefined' && window.Permissions.ALL_PERMISSIONS,
                    'DEFAULT_PERMISSIONS_BY_ROLE': typeof window.Permissions !== 'undefined' && window.Permissions.DEFAULT_PERMISSIONS_BY_ROLE
                };

                const allPassed = Object.values(checks).every(v => v === true);
                const messages = Object.entries(checks).map(([key, passed]) => 
                    `${passed ? '✅' : '❌'} ${key}`
                ).join('<br>');

                testResults.permissionsHelper = {
                    success: allPassed,
                    message: messages
                };

                resultDiv.innerHTML = `
                    <div class="${allPassed ? 'text-green-600' : 'text-yellow-600'}">
                        ${messages}
                    </div>
                `;
            } catch (error) {
                testResults.permissionsHelper = {
                    success: false,
                    message: `❌ Lỗi: ${error.message}`
                };
                resultDiv.innerHTML = `<div class="text-red-600">${testResults.permissionsHelper.message}</div>`;
            }
            
            updateSummary();
        }

        async function testUserPermissions() {
            const resultDiv = document.getElementById('test3-result');
            const username = document.getElementById('test-username').value.trim();
            
            if (!username) {
                resultDiv.innerHTML = '<div class="text-red-600">❌ Vui lòng nhập username</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="text-green-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang kiểm tra...</div>';
            
            try {
                // Load supabase config
                if (typeof window.SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Supabase config chưa được load');
                }

                const { createClient } = supabase;
                const supabaseClient = createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );

                // Lấy user
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('username, role, permissions')
                    .eq('username', username.toLowerCase())
                    .limit(1);

                if (error) {
                    throw error;
                }

                if (!users || users.length === 0) {
                    throw new Error(`Không tìm thấy user: ${username}`);
                }

                const user = users[0];
                
                // Test permissions helper
                if (typeof getUserPermissions === 'function') {
                    const permissions = getUserPermissions(user);
                    const defaultPerms = getDefaultPermissionsByRole(user.role);
                    
                    const hasCustomPerms = user.permissions && Object.keys(user.permissions).length > 0;
                    
                    testResults.userPermissions = {
                        success: true,
                        message: `
                            ✅ Tìm thấy user: ${user.username}<br>
                            ✅ Role: ${user.role}<br>
                            ✅ Permissions từ DB: ${hasCustomPerms ? JSON.stringify(user.permissions) : '{} (dùng default)'}<br>
                            ✅ Permissions được tính: ${Object.keys(permissions).length} quyền<br>
                            ✅ Default permissions cho role: ${Object.keys(defaultPerms).length} quyền
                        `
                    };
                    
                    resultDiv.innerHTML = `<div class="text-green-600">${testResults.userPermissions.message}</div>`;
                } else {
                    throw new Error('Permissions helper functions chưa được load');
                }
            } catch (error) {
                testResults.userPermissions = {
                    success: false,
                    message: `❌ Lỗi: ${error.message}`
                };
                resultDiv.innerHTML = `<div class="text-red-600">${testResults.userPermissions.message}</div>`;
            }
            
            updateSummary();
        }

        async function testUpdatePermissions() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = '<div class="text-orange-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang kiểm tra...</div>';
            
            try {
                // Kiểm tra API có tồn tại không
                if (typeof window.callAPI === 'undefined') {
                    throw new Error('API helper chưa được load');
                }

                // Test với user session giả lập (cần login thực tế)
                resultDiv.innerHTML = `
                    <div class="text-yellow-600">
                        ⚠️ Test này cần đăng nhập với ADMIN.<br>
                        Hãy test trên ứng dụng chính:<br>
                        1. Đăng nhập với ADMIN<br>
                        2. Vào "Quản Lý Users"<br>
                        3. Click button "Quyền"<br>
                        4. Bật/tắt permissions và lưu
                    </div>
                `;

                testResults.updatePermissions = {
                    success: null,
                    message: 'Cần test trên UI thực tế'
                };
            } catch (error) {
                testResults.updatePermissions = {
                    success: false,
                    message: `❌ Lỗi: ${error.message}`
                };
                resultDiv.innerHTML = `<div class="text-red-600">${testResults.updatePermissions.message}</div>`;
            }
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const contentDiv = document.getElementById('summary-content');
            
            if (Object.keys(testResults).length === 0) {
                summaryDiv.classList.add('hidden');
                return;
            }

            summaryDiv.classList.remove('hidden');
            
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.success === true).length;
            const failed = Object.values(testResults).filter(r => r.success === false).length;
            const pending = total - passed - failed;
            
            contentDiv.innerHTML = `
                <div class="mb-2">
                    <strong>Tổng số test:</strong> ${total}<br>
                    <span class="text-green-600"><strong>✅ Thành công:</strong> ${passed}</span><br>
                    <span class="text-red-600"><strong>❌ Thất bại:</strong> ${failed}</span><br>
                    <span class="text-gray-600"><strong>⏳ Chưa test:</strong> ${pending}</span>
                </div>
            `;
        }

        // Auto run test 2 on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testPermissionsHelper();
            }, 500);
        });
    </script>
</body>
</html>
