<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√™ Duy·ªát Gi√° Xe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/client-side-templates.js"></script>
    <script src="https://unpkg.com/mustache@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; pointer-events: none; }
        .htmx-request .htmx-indicator { opacity: 1; pointer-events: auto; }
        .htmx-request.htmx-indicator { opacity: 1; pointer-events: auto; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { background-color: #1e40af; border-left: 4px solid #60a5fa; }
        .nav-mobile-item.active { color: #2563eb; }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden" hx-ext="client-side-templates">

    <div id="login-view" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">Duy·ªát Gi√° Xe</h2>
                <p class="text-gray-500 text-sm">H·ªá th·ªëng qu·∫£n tr·ªã n·ªôi b·ªô</p>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <input type="text" id="login-user" class="w-full mb-4 p-3 border rounded-lg" placeholder="Username" required>
                <input type="password" id="login-pass" class="w-full mb-6 p-3 border rounded-lg" placeholder="Password" required>
                <button type="submit" id="btn-login" class="w-full bg-blue-700 text-white font-bold py-3 rounded-lg hover:bg-blue-800">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <div id="dashboard-view" class="flex h-full hidden">
        <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold">MY AUTO</h1>
                <p class="text-xs text-slate-400 mt-1">Xin ch√†o, <span id="user-fullname" class="font-bold text-white">User</span></p>
                <span id="user-role" class="text-[10px] bg-blue-600 px-2 py-0.5 rounded mt-2 inline-block">ROLE</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="switchTab('create')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 active" id="nav-create">
                    <i class="fa-solid fa-plus-circle w-6"></i> T·∫°o T·ªù Tr√¨nh
                </button>
                <button onclick="switchTab('approval')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800" id="nav-approval">
                    <i class="fa-solid fa-list-check w-6"></i> Duy·ªát ƒê∆°n <span class="ml-auto bg-red-500 text-white text-xs px-2 rounded-full hidden" id="badge-count">!</span>
                </button>
            </nav>
            <div class="p-4"><button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-600 py-2 rounded">ƒêƒÉng xu·∫•t</button></div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 relative overflow-hidden">
            <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
                <h1 class="font-bold">Duy·ªát Gi√° Xe</h1>
                <button onclick="logout()"><i class="fa-solid fa-power-off text-red-600"></i></button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                <div id="tab-create" class="tab-content active max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-blue-800">üìù T·∫°o Y√™u C·∫ßu</h2>
                            <div class="bg-gray-100 p-1 rounded flex">
                                <button onclick="toggleCreateMode('search')" id="btn-mode-search" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold shadow">Tra C·ª©u</button>
                                <button onclick="toggleCreateMode('manual')" id="btn-mode-manual" class="px-3 py-1 text-gray-600 rounded text-sm font-bold">Nh·∫≠p Tay</button>
                            </div>
                        </div>

                        <div id="mode-search-container">
                            <div class="mb-4 relative">
                                <input type="text" id="search_code_input" class="w-full border-2 border-blue-200 p-3 rounded font-mono uppercase font-bold" placeholder="Nh·∫≠p M√£ Hƒê (VD: S10601...)"
                                       hx-post="" hx-trigger="change" hx-vals='{"action": "lookup_contract"}' hx-target="#search-result" mustache-template="tpl-lookup-result" hx-indicator="#loading">
                                <div id="loading" class="htmx-indicator absolute right-3 top-3"><i class="fa-solid fa-spinner fa-spin text-blue-600"></i></div>
                            </div>
                            <form id="form-create-request" onsubmit="handleSubmitRequest(event, 'search')">
                                <div id="search-result"><div class="text-center py-8 text-gray-400 border-2 border-dashed rounded">Nh·∫≠p m√£ ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div></div>
                                <div id="action-area" class="mt-6 hidden">
                                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700">G·ª≠i Duy·ªát Gi√°</button>
                                </div>
                            </form>
                        </div>

                        <div id="mode-manual-container" class="hidden">
                            <form id="form-manual-create" onsubmit="handleSubmitRequest(event, 'manual')">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <input name="contract_code" class="border p-2 rounded uppercase font-mono" placeholder="M√£ H·ª£p ƒê·ªìng *" required>
                                    <input name="customer_name" class="border p-2 rounded" placeholder="T√™n Kh√°ch H√†ng *" required>
                                    <input name="phone" class="border p-2 rounded" placeholder="SƒêT">
                                    <input name="car_model" class="border p-2 rounded" placeholder="D√≤ng xe">
                                </div>
                                
                                <h3 class="font-bold text-gray-700 mt-4 mb-2">Ch√≠nh s√°ch gi√°</h3>
                                <div class="bg-yellow-50 p-4 rounded border border-yellow-200 space-y-3">
                                    <input name="contract_price" class="w-full border-2 border-yellow-400 p-2 rounded font-bold" placeholder="Gi√° tr·ªã Hƒê (VNƒê) *" required>
                                    <input name="discount_amount" type="number" class="w-full border p-2 rounded" placeholder="Ti·ªÅn gi·∫£m gi√° (VNƒê)">
                                    
                                    <div class="border-t pt-2 mt-2">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-bold">Qu√† t·∫∑ng</label>
                                            <button type="button" onclick="addGiftRow()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">+ Th√™m</button>
                                        </div>
                                        <div id="gift-list-manual" class="space-y-2"></div>
                                        <input type="hidden" name="gift_json" id="hidden_gift_json_manual">
                                    </div>
                                </div>

                                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded mt-6">G·ª≠i Duy·ªát (Nh·∫≠p Tay)</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="tab-approval" class="tab-content max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4">
                        <h2 class="font-bold text-xl">Duy·ªát ƒê∆°n</h2>
                        <button onclick="loadApprovalList()" class="text-sm bg-white border px-3 py-1 rounded">L√†m m·ªõi</button>
                    </div>
                    <div id="approval-list-container" class="space-y-4"></div>
                </div>
            </div>

            <div class="bg-white border-t flex justify-around p-2 md:hidden">
                <button onclick="switchTab('create')" class="nav-mobile-item text-blue-600 flex flex-col items-center"><i class="fa-solid fa-plus-circle"></i> <span class="text-[10px]">T·∫°o</span></button>
                <button onclick="switchTab('approval')" class="nav-mobile-item text-gray-400 flex flex-col items-center"><i class="fa-solid fa-list-check"></i> <span class="text-[10px]">Duy·ªát</span></button>
            </div>
        </main>
    </div>

    <div id="modal-detail" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition" id="modal-content">
            <div id="modal-detail-body"></div>
        </div>
    </div>

    <template id="tpl-lookup-result">
        {{#success}}
        <div class="animate-fade-in-down">
            <div class="bg-green-50 text-green-800 p-3 rounded mb-4 font-bold text-sm">‚úì T√¨m th·∫•y: {{data.name}}</div>
            <input type="hidden" name="customer_name" value="{{data.name}}">
            <input type="hidden" name="contract_code" value="{{data.contractCode}}">
            <input type="hidden" name="phone" value="{{data.phone}}">
            <input type="hidden" name="address" value="{{data.address}}">
            <input type="hidden" name="car_model" value="{{data.carModel}}">
            
            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div><label class="font-bold text-gray-500">Kh√°ch h√†ng</label><div class="bg-gray-100 p-2 rounded">{{data.name}}</div></div>
                <div><label class="font-bold text-gray-500">Xe</label><div class="bg-blue-50 p-2 rounded text-blue-800 font-bold">{{data.carModel}}</div></div>
            </div>

            <div class="space-y-3 border-t pt-3">
                <input name="contract_price" class="w-full border-2 border-yellow-400 p-2 rounded font-bold" placeholder="Gi√° Hƒê (VNƒê) *" required>
                <textarea name="discount_details" class="w-full border p-2 rounded" placeholder="Chi ti·∫øt gi·∫£m gi√°"></textarea>
                <input name="discount_amount" type="number" class="w-full border p-2 rounded" placeholder="Ti·ªÅn gi·∫£m (VNƒê)">
                
                <div class="border-t pt-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-bold">Qu√† t·∫∑ng</label>
                        <button type="button" onclick="addGiftRow('gift-list-search')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">+ Th√™m</button>
                    </div>
                    <div id="gift-list-search" class="space-y-2"></div>
                    <input type="hidden" name="gift_json" id="hidden_gift_json_search">
                </div>
            </div>
            <script> 
                document.getElementById('action-area').classList.remove('hidden'); 
                addGiftRow('gift-list-search'); // Init 1 row
            </script>
        </div>
        {{/success}}
        {{^success}}
        <div class="bg-red-50 text-red-700 p-4 rounded text-center font-bold">Kh√¥ng t√¨m th·∫•y!</div>
        {{/success}}
    </template>

    <template id="tpl-pending-list">
        {{#data}}
        <div class="bg-white rounded shadow-sm border p-4 mb-3 cursor-pointer hover:bg-gray-50" onclick="openDetail('{{json_string}}')">
            <div class="flex justify-between">
                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">{{contract_code}}</span>
                <span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded">{{status_text}}</span>
            </div>
            <h3 class="font-bold mt-2">{{customer}}</h3>
            <p class="text-sm text-gray-600">{{car_model}} - {{final_price}}</p>
            <p class="text-xs text-blue-500 mt-2 underline">Xem chi ti·∫øt</p>
        </div>
        {{/data}}
        {{^data}}<div class="text-center text-gray-400 py-10">Tr·ªëng</div>{{/data}}
    </template>

    <template id="tpl-order-detail">
        <div class="relative">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0">
                <h3 class="font-bold">Chi Ti·∫øt T·ªù Tr√¨nh</h3>
                <button onclick="closeModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="border-b pb-2">
                    <p class="text-lg font-bold">{{customer}}</p>
                    <p class="text-sm text-gray-500">{{contract_code}} | {{date}}</p>
                </div>
                <div class="bg-gray-50 p-3 rounded border">
                    <p class="font-bold text-gray-700">üöô {{car_model}}</p>
                    <p class="text-xs">VIN: {{vin_no}}</p>
                </div>
                <div class="border rounded text-sm overflow-hidden">
                    <div class="flex justify-between p-2 border-b"><span>Gi√° Hƒê</span><span class="font-bold">{{contract_price}}</span></div>
                    <div class="flex justify-between p-2 border-b text-red-600"><span>(-) Gi·∫£m</span><span>{{discount_amount}}</span></div>
                    <div class="p-2 bg-gray-50 border-b">
                        <p class="font-bold mb-1">üéÅ Qu√† t·∫∑ng:</p>
                        <div class="pl-2 whitespace-pre-line text-xs">{{#gift_details}}{{gift_details}}{{/gift_details}}{{^gift_details}}Kh√¥ng c√≥{{/gift_details}}</div>
                        <div class="flex justify-between mt-1 pt-1 border-t"><span class="font-bold text-xs">T·ªïng qu√†:</span><span>{{gift_amount}}</span></div>
                    </div>
                    <div class="flex justify-between p-3 bg-blue-50 text-blue-800 font-bold text-lg"><span>GI√Å CH·ªêT</span><span>{{final_price}}</span></div>
                </div>
                <div class="bg-gray-100 p-3 rounded text-xs font-mono whitespace-pre-line">{{logs}}</div>
                <div class="flex gap-3 pt-2">
                    <button onclick="confirmAction('{{id}}', 'approve')" class="flex-1 bg-green-600 text-white py-3 rounded font-bold">Duy·ªát</button>
                    <button onclick="confirmAction('{{id}}', 'reject')" class="flex-1 bg-red-100 text-red-600 py-3 rounded font-bold">T·ª´ ch·ªëi</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // ‚ö†Ô∏è THAY URL N√ÄY B·∫∞NG WEB APP URL C·ª¶A B·∫†N
        const API_URL = "https://script.google.com/macros/s/AKfycbwTyybDq0fVwdJz0IdCM-t1uLc3EKhclv58q9ey9kiKtUd4NMvpDR-ptWbH2b34bwkR/exec";

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search_code_input');
            if (searchInput) { searchInput.setAttribute('hx-post', API_URL); htmx.process(searchInput); }
            checkSession();
            addGiftRow('gift-list-manual'); // Init manual row
        });

        // --- AUTH ---
        function checkSession() {
            const session = localStorage.getItem('user_session');
            if (session) {
                const user = JSON.parse(session);
                document.getElementById('user-fullname').textContent = user.fullname;
                document.getElementById('user-role').textContent = user.role;
                if(user.role==='SALE'||user.role==='TVBH') document.getElementById('nav-approval').classList.add('hidden');
                else switchTab('approval');
                
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('flex');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }
        }
        async function handleLogin(e) {
            e.preventDefault();
            const res = await callAPI({action:'login', username:document.getElementById('login-user').value, password:document.getElementById('login-pass').value});
            if(res.success) { localStorage.setItem('user_session', JSON.stringify(res.user)); location.reload(); }
            else Swal.fire('L·ªói', res.message, 'error');
        }
        function logout() { localStorage.removeItem('user_session'); location.reload(); }

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active');
            if(id === 'approval') loadApprovalList();
        }
        function toggleCreateMode(mode) {
            const search = document.getElementById('mode-search-container');
            const manual = document.getElementById('mode-manual-container');
            const btnS = document.getElementById('btn-mode-search');
            const btnM = document.getElementById('btn-mode-manual');
            
            if(mode==='search') { search.classList.remove('hidden'); manual.classList.add('hidden'); btnS.classList.add('bg-blue-600','text-white'); btnM.classList.remove('bg-blue-600','text-white'); }
            else { manual.classList.remove('hidden'); search.classList.add('hidden'); btnM.classList.add('bg-blue-600','text-white'); btnS.classList.remove('bg-blue-600','text-white'); }
        }

        // --- GIFT LOGIC ---
        function addGiftRow(containerId) {
            const container = document.getElementById(containerId);
            if(!container) return;
            const rowId = 'gift-'+Date.now();
            const html = `<div class="flex gap-2 mb-2 gift-row" id="${rowId}">
                <input class="gift-name flex-1 border p-1 rounded text-sm" placeholder="T√™n qu√†">
                <input class="gift-price w-24 border p-1 rounded text-sm text-right" placeholder="Ti·ªÅn" oninput="formatMoney(this)">
                <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-red-500 px-1">&times;</button>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }
        function formatMoney(el) { el.value = new Number(el.value.replace(/\D/g,'')).toLocaleString('vi-VN'); }
        function packGiftData(containerId, hiddenInputId) {
            let gifts = [];
            document.querySelectorAll(`#${containerId} .gift-row`).forEach(row => {
                let name = row.querySelector('.gift-name').value;
                let price = row.querySelector('.gift-price').value;
                if(name) gifts.push({name, price});
            });
            document.getElementById(hiddenInputId).value = JSON.stringify(gifts);
        }

        // --- SUBMIT ---
        async function handleSubmitRequest(e, mode) {
            e.preventDefault();
            const session = JSON.parse(localStorage.getItem('user_session'));
            let formId = mode === 'search' ? 'form-create-request' : 'form-manual-create';
            let giftContainer = mode === 'search' ? 'gift-list-search' : 'gift-list-manual';
            let hiddenInput = mode === 'search' ? 'hidden_gift_json_search' : 'hidden_gift_json_manual';

            packGiftData(giftContainer, hiddenInput); // Pack JSON
            
            const formData = new FormData(document.getElementById(formId));
            let payload = { action: "submit_request", requester: session.username, ...Object.fromEntries(formData.entries()) };
            if(mode==='search') payload.contract_code = document.getElementById('search_code_input').value;

            const res = await callAPI(payload);
            if(res.success) { Swal.fire('OK', res.message, 'success'); document.getElementById(formId).reset(); document.getElementById(giftContainer).innerHTML=''; addGiftRow(giftContainer); }
            else Swal.fire('L·ªói', res.message, 'error');
        }

        // --- APPROVAL ---
        async function loadApprovalList() {
            const session = JSON.parse(localStorage.getItem('user_session'));
            const res = await callAPI({action:'get_pending_list', username:session.username, role:session.role});
            if(res.success) {
                const tpl = document.getElementById('tpl-pending-list').innerHTML;
                document.getElementById('approval-list-container').innerHTML = Mustache.render(tpl, {data:res.data});
            }
        }
        function openDetail(jsonStr) {
            const data = JSON.parse(decodeURIComponent(jsonStr));
            const tpl = document.getElementById('tpl-order-detail').innerHTML;
            document.getElementById('modal-detail-body').innerHTML = Mustache.render(tpl, data);
            document.getElementById('modal-detail').classList.remove('hidden');
            document.getElementById('modal-content').classList.remove('scale-95');
        }
        function closeModal() { document.getElementById('modal-detail').classList.add('hidden'); document.getElementById('modal-content').classList.add('scale-95'); }
        
        async function confirmAction(id, decision) {
            const session = JSON.parse(localStorage.getItem('user_session'));
            const res = await callAPI({action:'approve_reject', id, username:session.username, role:session.role, decision});
            if(res.success) { Swal.fire('OK', res.message, 'success'); closeModal(); loadApprovalList(); }
        }

        async function callAPI(data) {
            try {
                const res = await fetch(API_URL, { method:'POST', body:JSON.stringify(data) });
                return await res.json();
            } catch(e) { return {success:false, message:'L·ªói k·∫øt n·ªëi'}; }
        }
    </script>
</body>
</html>
