<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Phê Duyệt Giá Xe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/client-side-templates.js"></script>
    <script src="https://unpkg.com/mustache@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; pointer-events: none; }
        .htmx-request .htmx-indicator { opacity: 1; pointer-events: auto; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { background-color: #1e40af; border-left: 4px solid #60a5fa; }
        
        /* Custom Scrollbar cho Modal */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden" hx-ext="client-side-templates">

    <div id="login-view" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fa-solid fa-car text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Duyệt Giá Xe</h2>
                <p class="text-gray-500 text-sm">Hệ thống quản trị nội bộ</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4 relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fa-solid fa-user"></i></span>
                    <input type="text" id="login-user" class="w-full pl-10 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Tên đăng nhập" required>
                </div>
                <div class="mb-6 relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                    <input type="password" id="login-pass" class="w-full pl-10 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Mật khẩu" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-700 text-white font-bold py-3 rounded-lg hover:bg-blue-800 shadow-lg transition">Đăng Nhập</button>
            </form>
        </div>
    </div>

    <div id="dashboard-view" class="flex h-full hidden">
        
        <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold tracking-wider">MY AUTO</h1>
                <p class="text-xs text-slate-400 mt-1">Xin chào, <span id="user-fullname" class="font-bold text-white">User</span></p>
                <span id="user-role" class="text-[10px] bg-blue-600 px-2 py-0.5 rounded mt-2 inline-block">ROLE</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="switchTab('create')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 active" id="nav-create">
                    <i class="fa-solid fa-file-circle-plus"></i> Tạo Tờ Trình
                </button>
                <button onclick="switchTab('my-requests')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3" id="nav-my-requests">
                    <i class="fa-solid fa-folder-open"></i> Quản lý tờ trình của tôi
                </button>
                <button onclick="switchTab('approval')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3" id="nav-approval">
                    <i class="fa-solid fa-list-check"></i> Duyệt Đơn
                </button>
                <button onclick="switchTab('profile')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 hidden" id="nav-profile">
                    <i class="fa-solid fa-id-badge"></i> Hồ sơ cá nhân
                </button>
                <button onclick="switchTab('users')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 hidden" id="nav-users">
                    <i class="fa-solid fa-users-gear"></i> Quản lý User
                </button>
            </nav>
            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-600 py-2 rounded transition flex items-center justify-center gap-2"><i class="fa-solid fa-sign-out-alt"></i> Đăng xuất</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 relative overflow-hidden">
            <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
                <h1 class="font-bold text-gray-800">Duyệt Giá Xe</h1>
                <button onclick="logout()" class="text-red-600"><i class="fa-solid fa-power-off"></i></button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                
                <div id="tab-create" class="tab-content active max-w-5xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                            <h2 class="text-lg font-bold text-blue-800"><i class="fa-solid fa-pen-to-square mr-2"></i>Tạo Yêu Cầu Mới</h2>
                            </div>
                        <div class="p-6">
                            <div id="mode-manual-container">
                                <form id="form-manual-create" onsubmit="handleSubmitRequest(event, 'manual')">
                                    
                                    <div class="mb-6">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">1. Thông tin Khách hàng</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label class="label">Mã Hợp Đồng *</label><input name="contract_code" class="input uppercase font-mono" required placeholder="S10601..."></div>
                                            <div><label class="label">Họ tên Khách hàng *</label><input name="customer_name" class="input" required></div>
                                            <div><label class="label">Số điện thoại</label><input name="phone" class="input"></div>
                                            <div><label class="label">CCCD / CMND</label><input name="cccd" class="input"></div>
                                            <div><label class="label">Email</label><input name="email" class="input"></div>
                                            <div><label class="label">Địa chỉ</label><input name="address" class="input"></div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">2. Thông tin Xe</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label class="label">Dòng Xe</label><input name="car_model" class="input" placeholder="VD: VF 5 Plus"></div>
                                            <div><label class="label">Phiên bản</label><input name="car_version" class="input" placeholder="Eco / Plus"></div>
                                            <div><label class="label">Màu sắc</label><input name="car_color" class="input"></div>
                                            <div><label class="label">Số Khung (VIN)</label><input name="vin_no" class="input uppercase"></div>
                                            <div class="md:col-span-2"><label class="label">Hình thức thanh toán</label>
                                                <select name="payment_method" class="input bg-white">
                                                    <option value="Tiền mặt">Tiền mặt</option>
                                                    <option value="Trả góp">Trả góp ngân hàng</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">3. Chính sách giá & Quà tặng</h3>
                                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                            <div class="mb-4">
                                                <label class="block text-sm font-bold text-gray-800 mb-1">Giá trị Hợp đồng (VNĐ) *</label>
                                                <input name="contract_price" type="text" class="w-full border-2 border-yellow-400 p-2 rounded text-lg font-bold text-gray-800 outline-none" oninput="formatMoneyInput(this)" required placeholder="0">
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label class="label">Chi tiết giảm giá</label>
                                                    <textarea name="discount_details" rows="2" class="input" placeholder="Diễn giải..."></textarea>
                                                </div>
                                                <div>
                                                    <label class="label">Tiền giảm giá (VNĐ)</label>
                                                    <input name="discount_amount" type="text" class="input" oninput="formatMoneyInput(this)" placeholder="0">
                                                </div>
                                            </div>

                                            <div class="border-t border-yellow-200 pt-3">
                                                <div class="flex justify-between items-center mb-3">
                                                    <div>
                                                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                                            <i class="fa-solid fa-gift text-yellow-600"></i>
                                                            Quà tặng kèm
                                                        </label>
                                                </div>
                                                    <button type="button" onclick="addGiftRow('gift-list-manual')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded font-bold hover:bg-blue-200 transition flex items-center gap-1">
                                                        <i class="fa-solid fa-plus"></i>
                                                        Thêm quà
                                                    </button>
                                                </div>
                                                <div id="gift-list-manual" class="space-y-2 min-h-[40px]">
                                                    <p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>
                                                </div>
                                                <input type="hidden" name="gift_json" id="hidden_gift_json_manual">
                                                
                                                <div class="flex justify-between items-center mt-3 pt-3 border-t border-yellow-200">
                                                    <span class="text-xs text-gray-500 italic">Tổng giá trị quà tặng:</span>
                                                    <span id="total-gift-manual" class="font-bold text-blue-600 text-sm">0 đ</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">4. Yêu cầu khác</h3>
                                        <textarea name="other_requirements" rows="3" class="input w-full" placeholder="Nhập yêu cầu khác (nếu có)..."></textarea>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">5. Chọn người duyệt</h3>
                                        <label class="label">Chọn TPKD duyệt *</label>
                                        <select name="approver_step0" id="approver_step0" class="input w-full" required>
                                            <option value="">-- Đang tải danh sách --</option>
                                        </select>
                                    </div>

                                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition transform active:scale-95">Gửi Duyệt</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-approval" class="tab-content max-w-5xl mx-auto space-y-4">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-600"></i>Danh sách cần duyệt</h2>
                            <button onclick="loadApprovalList()" class="bg-blue-50 border border-blue-200 text-blue-600 px-4 py-1.5 rounded hover:bg-blue-100 text-sm font-semibold"><i class="fa-solid fa-sync mr-1"></i>Làm mới</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase">Tìm kiếm</label>
                                <input id="approval-search" type="text" class="input" placeholder="Mã HĐ, khách hàng...">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                                <select id="approval-status-filter" class="input bg-white">
                                    <option value="all">Tất cả</option>
                                    <option value="pending">Đang chờ duyệt</option>
                                    <option value="rejected">Đã bị trả về</option>
                                    <option value="completed">Hoàn tất</option>
                                </select>
                            </div>
                            <div id="approval-summary" class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-900 flex items-center justify-between">
                                <div>
                                    <p class="text-xs uppercase text-blue-600 font-semibold">Tổng đơn</p>
                                    <p class="text-xl font-bold" id="summary-total">0</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs uppercase text-blue-600 font-semibold">Chờ duyệt</p>
                                    <p class="text-xl font-bold" id="summary-pending">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="approval-list-container" class="space-y-4"></div>
                </div>

                <div id="tab-my-requests" class="tab-content max-w-5xl mx-auto space-y-4">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-folder-open text-blue-600"></i>Quản lý tờ trình của tôi
                            </h2>
                            <button onclick="loadMyRequests()" class="bg-blue-50 border border-blue-200 text-blue-600 px-4 py-1.5 rounded hover:bg-blue-100 text-sm font-semibold">
                                <i class="fa-solid fa-sync mr-1"></i>Làm mới
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase">Tìm kiếm</label>
                                <input id="my-requests-search" type="text" class="input" placeholder="Mã HĐ, khách hàng...">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                                <select id="my-requests-status-filter" class="input bg-white">
                                    <option value="all">Tất cả</option>
                                    <option value="pending">Đang chờ duyệt</option>
                                    <option value="rejected">Đã bị trả về</option>
                                    <option value="completed">Hoàn tất</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="my-requests-list-container" class="space-y-4"></div>
                </div>

                <div id="tab-profile" class="tab-content max-w-3xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Hồ sơ tư vấn bán hàng</h2>
                                <p class="text-sm text-gray-500">Cập nhật thông tin liên hệ của bạn</p>
                            </div>
                            <button onclick="loadProfile()" class="text-sm text-blue-600 hover:text-blue-800"><i class="fa-solid fa-rotate mr-1"></i>Làm mới</button>
                        </div>
                        <form id="form-profile" class="space-y-4" onsubmit="handleProfileUpdate(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="label">Tên đăng nhập</label>
                                    <input type="text" name="profile_username" id="profile_username" class="input bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="label">Vai trò</label>
                                    <input type="text" name="profile_role" id="profile_role" class="input bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="label">Họ và tên</label>
                                    <input type="text" name="profile_fullname" id="profile_fullname" class="input" required>
                                </div>
                                <div>
                                    <label class="label">Nhóm/Bộ phận</label>
                                    <input type="text" name="profile_group" id="profile_group" class="input">
                                </div>
                                <div>
                                    <label class="label">Email</label>
                                    <input type="email" name="profile_email" id="profile_email" class="input">
                                </div>
                                <div>
                                    <label class="label">Số điện thoại</label>
                                    <input type="text" name="profile_phone" id="profile_phone" class="input">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span id="profile-status" class="text-sm text-gray-500"></span>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Lưu thay đổi</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="tab-users" class="tab-content max-w-6xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">Thêm người dùng</h2>
                            <form id="form-create-user" class="space-y-3" onsubmit="handleCreateUser(event)">
                                <div>
                                    <label class="label">Tên đăng nhập *</label>
                                    <input type="text" name="new_username" class="input" required>
                                </div>
                                <div>
                                    <label class="label">Họ tên *</label>
                                    <input type="text" name="new_fullname" class="input" required>
                                </div>
                                <div>
                                    <label class="label">Vai trò *</label>
                                    <select name="new_role" class="input bg-white" required>
                                        <option value="">-- Chọn vai trò --</option>
                                        <option value="TVBH">TVBH</option>
                                        <option value="TPKD">TPKD</option>
                                        <option value="GDKD">GDKD</option>
                                        <option value="BKS">BKS</option>
                                        <option value="BGD">BGD</option>
                                        <option value="KETOAN">KẾ TOÁN</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label">Nhóm/Bộ phận</label>
                                    <input type="text" name="new_group" class="input">
                                </div>
                                <div>
                                    <label class="label">Email</label>
                                    <input type="email" name="new_email" class="input">
                                </div>
                                <div>
                                    <label class="label">Số điện thoại</label>
                                    <input type="text" name="new_phone" class="input">
                                </div>
                                <div>
                                    <label class="label">Mật khẩu tạm</label>
                                    <input type="text" name="new_password" class="input" placeholder="Mặc định: 123456">
                                </div>
                                <div class="text-right">
                                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Thêm người dùng</button>
                                </div>
                                <p id="create-user-status" class="text-sm text-gray-500"></p>
                            </form>
                        </div>

                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-gray-800">Danh sách người dùng</h2>
                                <button onclick="loadUserManagement()" class="text-sm text-blue-600 hover:text-blue-800"><i class="fa-solid fa-rotate mr-1"></i>Làm mới</button>
                            </div>
                            <div id="user-list-container" class="overflow-x-auto">
                                <div class="text-center text-gray-500 py-6">Chọn tab để tải dữ liệu...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white border-t flex justify-around p-2 md:hidden">
                <button onclick="switchTab('create')" class="nav-mobile-item text-blue-600 flex flex-col items-center"><i class="fa-solid fa-plus-circle text-xl"></i><span class="text-[10px]">Tạo</span></button>
                <button onclick="switchTab('approval')" class="nav-mobile-item text-gray-400 flex flex-col items-center"><i class="fa-solid fa-list-check text-xl"></i><span class="text-[10px]">Duyệt</span></button>
                <button onclick="switchTab('profile')" id="nav-mobile-profile" class="nav-mobile-item text-gray-400 flex flex-col items-center hidden"><i class="fa-solid fa-id-badge text-xl"></i><span class="text-[10px]">Hồ sơ</span></button>
                <button onclick="switchTab('users')" id="nav-mobile-users" class="nav-mobile-item text-gray-400 flex flex-col items-center hidden"><i class="fa-solid fa-users-gear text-xl"></i><span class="text-[10px]">User</span></button>
            </div>
        </main>
    </div>

    <div id="modal-detail" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition" id="modal-content">
            <div id="modal-detail-body"></div>
        </div>
    </div>

    <div id="modal-edit-request" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 transition" id="modal-edit-content">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 z-10">
                <h3 class="font-bold text-lg">Sửa tờ trình</h3>
                <button onclick="closeEditModal()" class="text-2xl hover:text-red-200">&times;</button>
            </div>
            <div class="p-6">
                <form id="form-edit-request" onsubmit="handleUpdateRequest(event)">
                    <input type="hidden" name="edit_request_id" id="edit_request_id">
                    
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">1. Thông tin Khách hàng</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="label">Mã Hợp Đồng *</label><input name="edit_contract_code" id="edit_contract_code" class="input uppercase font-mono" required></div>
                            <div><label class="label">Họ tên Khách hàng *</label><input name="edit_customer_name" id="edit_customer_name" class="input" required></div>
                            <div><label class="label">Số điện thoại</label><input name="edit_phone" id="edit_phone" class="input"></div>
                            <div><label class="label">CCCD / CMND</label><input name="edit_cccd" id="edit_cccd" class="input"></div>
                            <div><label class="label">Email</label><input name="edit_email" id="edit_email" class="input"></div>
                            <div><label class="label">Địa chỉ</label><input name="edit_address" id="edit_address" class="input"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">2. Thông tin Xe</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="label">Dòng Xe</label><input name="edit_car_model" id="edit_car_model" class="input"></div>
                            <div><label class="label">Phiên bản</label><input name="edit_car_version" id="edit_car_version" class="input"></div>
                            <div><label class="label">Màu sắc</label><input name="edit_car_color" id="edit_car_color" class="input"></div>
                            <div><label class="label">Số Khung (VIN)</label><input name="edit_vin_no" id="edit_vin_no" class="input uppercase"></div>
                            <div class="md:col-span-2"><label class="label">Hình thức thanh toán</label>
                                <select name="edit_payment_method" id="edit_payment_method" class="input bg-white">
                                    <option value="Tiền mặt">Tiền mặt</option>
                                    <option value="Trả góp">Trả góp ngân hàng</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">3. Chính sách giá & Quà tặng</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-800 mb-1">Giá trị Hợp đồng (VNĐ) *</label>
                                <input name="edit_contract_price" id="edit_contract_price" type="text" class="w-full border-2 border-yellow-400 p-2 rounded text-lg font-bold text-gray-800 outline-none" oninput="formatMoneyInput(this)" required>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="label">Chi tiết giảm giá</label>
                                    <textarea name="edit_discount_details" id="edit_discount_details" rows="2" class="input"></textarea>
                                </div>
                                <div>
                                    <label class="label">Tiền giảm giá (VNĐ)</label>
                                    <input name="edit_discount_amount" id="edit_discount_amount" type="text" class="input" oninput="formatMoneyInput(this)">
                                </div>
                            </div>

                            <div class="border-t border-yellow-200 pt-3">
                                <div class="flex justify-between items-center mb-3">
                                    <div>
                                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                            <i class="fa-solid fa-gift text-yellow-600"></i>
                                            Quà tặng kèm
                                        </label>
                                    </div>
                                    <button type="button" onclick="addGiftRow('gift-list-edit')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded font-bold hover:bg-blue-200 transition flex items-center gap-1">
                                        <i class="fa-solid fa-plus"></i>
                                        Thêm quà
                                    </button>
                                </div>
                                <div id="gift-list-edit" class="space-y-2 min-h-[40px]">
                                    <p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>
                                </div>
                                <input type="hidden" name="edit_gift_json" id="hidden_gift_json_edit">
                                
                                <div class="flex justify-between items-center mt-3 pt-3 border-t border-yellow-200">
                                    <span class="text-xs text-gray-500 italic">Tổng giá trị quà tặng:</span>
                                    <span id="total-gift-edit" class="font-bold text-blue-600 text-sm">0 đ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">4. Yêu cầu khác</h3>
                        <textarea name="edit_other_requirements" id="edit_other_requirements" rows="3" class="input w-full" placeholder="Nhập yêu cầu khác (nếu có)..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-bold transition">Hủy</button>
                        <button type="button" onclick="handleUpdateAndResubmit(event)" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-paper-plane"></i>
                            <span>Lưu & Trình lại</span>
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <template id="tpl-lookup-result">
        {{#success}}
        <div class="animate-fade-in-down">
            <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6 flex items-center">
                <i class="fa-solid fa-check-circle mr-2 text-xl"></i>
                <div>
                    <p class="font-bold text-sm">Đã tìm thấy dữ liệu</p>
                    <p class="text-xs">{{data.name}}</p>
                </div>
            </div>
            
            <input type="hidden" name="customer_name" value="{{data.name}}">
            <input type="hidden" name="contract_code" id="lookup-contract-code" value="">
            <input type="hidden" name="phone" value="{{data.phone}}">
            <input type="hidden" name="cccd" value="{{data.cccd}}">
            <input type="hidden" name="address" value="{{data.address}}">
            <input type="hidden" name="email" value="{{data.email}}">
            <input type="hidden" name="car_model" value="{{data.carModel}}">
            <input type="hidden" name="car_version" value="{{data.carVersion}}">
            <input type="hidden" name="car_color" value="{{data.carColor}}">
            <input type="hidden" name="vin_no" value="">
            <input type="hidden" name="payment_method" value="{{data.payment}}">

            <div class="grid grid-cols-2 gap-4 mb-4 text-sm bg-gray-50 p-4 rounded border">
                <div><span class="text-xs text-gray-500 block">KHÁCH HÀNG</span><span class="font-bold">{{data.name}}</span></div>
                <div><span class="text-xs text-gray-500 block">DÒNG XE</span><span class="font-bold text-blue-800">{{data.carModel}} {{data.carVersion}}</span></div>
                <div><span class="text-xs text-gray-500 block">SĐT</span><span>{{data.phone}}</span></div>
                <div><span class="text-xs text-gray-500 block">ĐỊA CHỈ</span><span>{{data.address}}</span></div>
                <div><span class="text-xs text-gray-500 block">THANH TOÁN</span><span>{{data.payment}}</span></div>
                <div><span class="text-xs text-gray-500 block">MÀU XE</span><span>{{data.carColor}}</span></div>
            </div>

            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-800 mb-1">Giá trị Hợp đồng (VNĐ) *</label>
                    <input name="contract_price" type="text" class="w-full border-2 border-yellow-400 p-2 rounded text-lg font-bold text-gray-800 outline-none" oninput="formatMoneyInput(this)" required placeholder="0">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="label">Chi tiết giảm giá</label><textarea name="discount_details" rows="1" class="input"></textarea></div>
                    <div><label class="label">Tiền giảm (VNĐ)</label><input name="discount_amount" oninput="formatMoneyInput(this)" class="input" placeholder="0"></div>
                </div>
                
                <div class="border-t border-yellow-200 pt-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-bold">Quà tặng</label>
                        <button type="button" onclick="addGiftRow('gift-list-search')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">+ Thêm</button>
                    </div>
                    <div id="gift-list-search" class="space-y-2"></div>
                    <input type="hidden" name="gift_json" id="hidden_gift_json_search">
                    <div class="flex justify-end mt-2 text-sm"><span class="font-bold text-gray-600 mr-2">Tổng quà:</span><span id="total-gift-search" class="font-bold text-blue-600">0</span></div>
                </div>
            </div>

            <script> 
                (function() {
                    const actionArea = document.getElementById('action-area');
                    if (actionArea) actionArea.classList.remove('hidden');
                    if (typeof addGiftRow === 'function') {
                        addGiftRow('gift-list-search');
                    }
                })();
            </script>
        </div>
        {{/success}}
        {{^success}}
        <div class="bg-red-50 text-red-700 p-4 rounded text-center font-bold animate-bounce-short">⚠️ Không tìm thấy đơn hàng này!</div>
        {{/success}}
    </template>

    <template id="tpl-pending-list">
        {{#data}}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-3 cursor-pointer hover:shadow-lg hover:border-blue-300 transition-all relative overflow-hidden group" onclick="openDetail('{{json_string}}')">
            {{#can_resubmit}}
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-500"></div>
            {{/can_resubmit}}
            {{^can_resubmit}}
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
            {{/can_resubmit}}
            <div class="flex justify-between items-start pl-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-1 rounded uppercase">{{contract_code}}</span>
                        {{#can_resubmit}}
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-semibold">
                            <i class="fa-solid fa-exclamation-triangle mr-1"></i>Đã bị từ chối
                        </span>
                        {{/can_resubmit}}
                </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1">{{customer}}</h3>
                    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                        {{#phone}}<span><i class="fa-solid fa-phone mr-1"></i>{{phone}}</span>{{/phone}}
                        {{#email}}<span><i class="fa-solid fa-envelope mr-1"></i>{{email}}</span>{{/email}}
                </div>
            </div>
                <div class="text-right ml-4">
                    <span class="text-xs text-gray-400 block mb-2">{{date}}</span>
                    {{#can_resubmit}}
                    <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded block">{{status_text}}</span>
                    {{/can_resubmit}}
                    {{^can_resubmit}}
                    <span class="text-xs font-bold bg-blue-50 text-blue-700 px-2 py-1 rounded block border border-blue-200">{{status_text}}</span>
                    {{/can_resubmit}}
                </div>
            </div>
            <div class="pl-3 mt-3 pt-3 border-t border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <i class="fa-solid fa-car-side text-blue-600"></i>
                        <span class="font-semibold">{{car_model}}</span>
                        {{#car_version}}<span class="text-gray-500">- {{car_version}}</span>{{/car_version}}
                        {{#car_color}}<span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-600">{{car_color}}</span>{{/car_color}}
                    </div>
                </div>
                {{#payment}}
                <div class="text-xs text-gray-500 mb-2">
                    <i class="fa-solid fa-credit-card mr-1"></i>Thanh toán: {{payment}}
                </div>
                {{/payment}}
                <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                    <span class="text-xs text-gray-500">Giá chốt:</span>
                    <span class="text-blue-600 font-bold text-lg">{{final_price}}</span>
                </div>
            </div>
            <div class="pl-3 mt-3 text-xs text-center text-blue-500 group-hover:text-blue-700 font-semibold">
                <i class="fa-solid fa-arrow-right mr-1"></i>Nhấn để xem chi tiết
            </div>
        </div>
        {{/data}}
        {{^data}}
        <div class="text-center text-gray-400 py-12 bg-white rounded-lg border border-gray-200">
            <i class="fa-regular fa-folder-open text-5xl mb-3 opacity-30"></i>
            <p class="text-lg font-semibold">Không có đơn hàng nào</p>
            <p class="text-sm mt-1">Vui lòng thử lại sau hoặc kiểm tra bộ lọc</p>
        </div>
        {{/data}}
    </template>

    <template id="tpl-my-requests-list">
        {{#data}}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-3 hover:shadow-md transition relative overflow-hidden">
            {{#can_resubmit}}
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-500"></div>
            {{/can_resubmit}}
            {{^can_resubmit}}
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
            {{/can_resubmit}}
            <div class="flex justify-between items-start pl-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-1 rounded uppercase">{{contract_code}}</span>
                        {{#can_resubmit}}
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-semibold">
                            <i class="fa-solid fa-exclamation-triangle mr-1"></i>Đã bị từ chối - Cần sửa
                        </span>
                        {{/can_resubmit}}
                        {{#is_completed}}
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-semibold">
                            <i class="fa-solid fa-check-circle mr-1"></i>Hoàn tất
                        </span>
                        {{/is_completed}}
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1">{{customer}}</h3>
                    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                        {{#phone}}<span><i class="fa-solid fa-phone mr-1"></i>{{phone}}</span>{{/phone}}
                        {{#email}}<span><i class="fa-solid fa-envelope mr-1"></i>{{email}}</span>{{/email}}
                    </div>
                </div>
                <div class="text-right ml-4">
                    <span class="text-xs text-gray-400 block mb-2">{{date}}</span>
                    <span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded block text-gray-600">{{status_text}}</span>
                    {{#next_status}}
                    <span class="text-xs text-gray-500 mt-1 block">→ {{next_status}}</span>
                    {{/next_status}}
                </div>
            </div>
            <div class="pl-3 mt-3 pt-3 border-t border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <i class="fa-solid fa-car-side text-blue-600"></i>
                        <span class="font-semibold">{{car_model}}</span>
                        {{#car_version}}<span class="text-gray-500">- {{car_version}}</span>{{/car_version}}
                        {{#car_color}}<span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-600">{{car_color}}</span>{{/car_color}}
                    </div>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                    <span class="text-xs text-gray-500">Giá chốt:</span>
                    <span class="text-blue-600 font-bold text-lg">{{final_price}}</span>
                </div>
            </div>
            <div class="pl-3 mt-3 flex gap-2">
                {{#can_resubmit}}
                <button onclick="openEditRequest('{{id}}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-semibold text-sm transition">
                    <i class="fa-solid fa-edit mr-1"></i>Sửa lại
                </button>
                {{/can_resubmit}}
                <button onclick="openDetail('{{json_string}}')" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded-lg font-semibold text-sm transition border border-blue-200">
                    <i class="fa-solid fa-eye mr-1"></i>Xem chi tiết
                </button>
                {{#is_completed}}
                <button onclick="printRequest('{{id}}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold text-sm transition">
                    <i class="fa-solid fa-print mr-1"></i>In tờ trình
                </button>
                {{/is_completed}}
            </div>
        </div>
        {{/data}}
        {{^data}}
        <div class="text-center text-gray-400 py-12 bg-white rounded-lg border border-gray-200">
            <i class="fa-regular fa-folder-open text-5xl mb-3 opacity-30"></i>
            <p class="text-lg font-semibold">Chưa có tờ trình nào</p>
            <p class="text-sm mt-1">Tạo tờ trình mới để bắt đầu</p>
        </div>
        {{/data}}
    </template>

    <template id="tpl-order-detail">
        <div class="relative">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 z-10">
                <div>
                    <h3 class="font-bold text-lg">CHI TIẾT TỜ TRÌNH</h3>
                    <p class="text-xs opacity-80">Mã HĐ: {{contract_code}}</p>
                </div>
                <button onclick="closeModal()" class="text-2xl hover:text-red-200">&times;</button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Thông tin khách hàng -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user text-blue-600"></i>Thông tin khách hàng
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div>
                            <p class="text-gray-500 text-xs mb-1">Họ và tên</p>
                            <p class="font-bold text-gray-800">{{customer}}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Số điện thoại</p>
                            <p class="font-semibold text-gray-700"><i class="fa-solid fa-phone mr-1 text-blue-600"></i>{{phone}}</p>
                        </div>
                        {{#cccd}}
                        <div>
                            <p class="text-gray-500 text-xs mb-1">CCCD/CMND</p>
                            <p class="font-semibold text-gray-700">{{cccd}}</p>
                        </div>
                        {{/cccd}}
                        {{#email}}
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Email</p>
                            <p class="font-semibold text-gray-700"><i class="fa-solid fa-envelope mr-1 text-blue-600"></i>{{email}}</p>
                        </div>
                        {{/email}}
                        {{#address}}
                        <div class="md:col-span-2">
                            <p class="text-gray-500 text-xs mb-1">Địa chỉ</p>
                            <p class="font-semibold text-gray-700"><i class="fa-solid fa-map-marker-alt mr-1 text-blue-600"></i>{{address}}</p>
                        </div>
                        {{/address}}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-500">Người tạo</p>
                            <p class="text-sm font-semibold text-blue-700">{{requester}}</p>
                    </div>
                    <div class="text-right">
                            <p class="text-xs text-gray-500">Ngày tạo</p>
                            <p class="text-sm font-semibold text-gray-700">{{date}}</p>
                        </div>
                    </div>
                </div>

                <!-- Thông tin xe -->
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-car text-blue-600"></i>Thông tin xe
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Dòng xe</p>
                            <p class="font-bold text-lg text-gray-800">
                                🚙 {{car_model}}{{#car_version}} <span class="text-base">{{car_version}}</span>{{/car_version}}
                            </p>
                    </div>
                        {{#car_color}}
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Màu sắc</p>
                            <p class="font-bold text-gray-700">{{car_color}}</p>
                        </div>
                        {{/car_color}}
                        {{#vin_no}}
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Số VIN</p>
                            <p class="font-mono text-xs text-gray-700 bg-white px-2 py-1 rounded border">{{vin_no}}</p>
                        </div>
                        {{/vin_no}}
                        {{#payment}}
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Phương thức thanh toán</p>
                            <p class="font-semibold text-gray-700">{{payment}}</p>
                        </div>
                        {{/payment}}
                    </div>
                </div>

                <!-- Bảng giá -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-blue-600 text-white p-3 font-bold text-center">
                        <i class="fa-solid fa-calculator mr-2"></i>BẢNG GIÁ
                    </div>
                    <div class="divide-y divide-gray-200">
                        <div class="flex justify-between items-center p-4 hover:bg-gray-50 transition">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-file-contract text-blue-600"></i>
                                <span class="text-gray-700">Giá hợp đồng</span>
                            </div>
                            <span class="font-bold text-lg text-gray-800">{{contract_price}}</span>
                        </div>
                        <div class="p-4 bg-red-50 border-l-4 border-red-400">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-tag text-red-600"></i>
                                    <span class="text-red-700 font-semibold">(-) Giảm giá</span>
                                </div>
                                <span class="font-bold text-lg text-red-700">{{discount_amount}}</span>
                            </div>
                            {{#discount_details}}
                            <div class="mt-2 p-2 bg-white rounded border border-red-200 text-xs text-gray-700">
                                <i class="fa-solid fa-info-circle mr-1 text-red-600"></i>
                                <span class="font-medium">Lý do giảm giá:</span>
                                <p class="mt-1 italic pl-4">{{discount_details}}</p>
                            </div>
                            {{/discount_details}}
                        </div>
                        <div class="p-4 bg-yellow-50">
                            <div class="flex items-start gap-2 mb-2">
                                <i class="fa-solid fa-gift text-yellow-600 mt-1"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-700 mb-1">🎁 Quà tặng</p>
                                    <div class="bg-white rounded p-2 text-xs text-gray-600 whitespace-pre-line border border-yellow-200">
                                        {{#gift_details}}{{gift_details}}{{/gift_details}}{{^gift_details}}Không có quà tặng{{/gift_details}}
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-yellow-200">
                                <span class="text-xs font-semibold text-gray-600">Tổng giá trị quà tặng:</span>
                                <span class="font-bold text-gray-800">{{gift_amount}}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                            <span class="font-bold text-lg flex items-center gap-2">
                                <i class="fa-solid fa-check-circle"></i>
                                GIÁ CHỐT CUỐI CÙNG
                            </span>
                            <span class="font-bold text-2xl">{{final_price}}</span>
                        </div>
                    </div>
                </div>

                <!-- Yêu cầu khác -->
                {{#other_requirements}}
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-list text-blue-600"></i>Yêu cầu khác
                    </h4>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 text-sm text-gray-700 whitespace-pre-line">
                        {{other_requirements}}
                    </div>
                </div>
                {{/other_requirements}}

                <!-- Phân bổ chi phí bán hàng (chỉ hiển thị khi có dữ liệu hoặc là admin) -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-blue-600"></i>Phân bổ chi phí bán hàng
                    </h4>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Mức chi phí giảm tối đa (%)</p>
                                <div class="flex gap-2 items-center">
                                    {{#is_admin}}
                                    <input type="text" id="detail-max-cost-rate" value="{{max_cost_rate}}" 
                                           class="flex-1 border p-2 rounded text-sm" 
                                           placeholder="Nhập %" 
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                                    <button onclick="saveMaxCostRate('{{id}}')" 
                                            class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition">
                                        <i class="fa-solid fa-save"></i>
                                    </button>
                                    {{/is_admin}}
                                    {{^is_admin}}
                                    <input type="text" id="detail-max-cost-rate" value="{{max_cost_rate}}" 
                                           class="flex-1 border p-2 rounded text-sm" 
                                           placeholder="Nhập %" 
                                           readonly>
                                    {{/is_admin}}
                                </div>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Lương năng suất (VNĐ)</p>
                                <p class="font-semibold text-gray-800">{{#productivity_bonus}}{{productivity_bonus}}{{/productivity_bonus}}{{^productivity_bonus}}Chưa nhập{{/productivity_bonus}}</p>
                            </div>
                        </div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Chi phí bán hàng:</span>
                                <span class="font-semibold text-gray-800">{{total_cost}}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-gray-600">Tỷ lệ (%):</span>
                                <span class="font-semibold text-gray-800">{{cost_percentage}}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái hiện tại -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-info-circle text-blue-600"></i>Trạng thái phê duyệt
                    </h4>
                    <div class="space-y-3">
                <div>
                            <p class="text-xs text-gray-500 mb-1">Trạng thái hiện tại:</p>
                            <span class="px-4 py-2 rounded-lg font-bold text-sm inline-block {{#can_resubmit}}bg-yellow-100 text-yellow-800{{/can_resubmit}}{{^can_resubmit}}{{#is_completed}}bg-green-100 text-green-800{{/is_completed}}{{^is_completed}}bg-blue-100 text-blue-800{{/is_completed}}{{/can_resubmit}}">
                                {{#can_resubmit}}
                                <i class="fa-solid fa-exclamation-triangle mr-1"></i>Đã bị trả về - Cần chỉnh sửa
                                {{/can_resubmit}}
                                {{^can_resubmit}}
                                {{#is_completed}}
                                <i class="fa-solid fa-check-circle mr-1"></i>Hoàn tất phê duyệt
                                {{/is_completed}}
                                {{^is_completed}}
                                {{status_text}}
                                {{/is_completed}}
                                {{/can_resubmit}}
                            </span>
                </div>
                        {{#next_status}}
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Bước duyệt tiếp theo:</p>
                            <span class="px-4 py-2 rounded-lg font-semibold text-sm inline-block bg-gray-100 text-gray-700 border border-gray-300">
                                <i class="fa-solid fa-arrow-right mr-1 text-blue-600"></i>{{next_status}}
                            </span>
                        </div>
                        {{/next_status}}
                    </div>
                </div>

                <!-- Lịch sử phê duyệt -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-history text-blue-600"></i>Lịch sử phê duyệt
                    </h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        {{#log_entries}}
                        {{#.}}
                        <div class="border-l-4 pl-4 py-3 rounded-r-lg {{#is_approve}}border-green-500 bg-green-50{{/is_approve}}{{#is_reject}}border-red-500 bg-red-50{{/is_reject}}{{^is_approve}}{{^is_reject}}border-gray-400 bg-gray-50{{/is_reject}}{{/is_approve}}">
                            <div class="flex items-start justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    {{#is_approve}}
                                    <i class="fa-solid fa-check-circle text-green-600"></i>
                                    {{/is_approve}}
                                    {{#is_reject}}
                                    <i class="fa-solid fa-times-circle text-red-600"></i>
                                    {{/is_reject}}
                                    {{^is_approve}}{{^is_reject}}
                                    <i class="fa-solid fa-clock text-gray-500"></i>
                                    {{/is_reject}}{{/is_approve}}
                                    <span class="font-bold text-xs text-gray-600">{{time}}</span>
                </div>
                                {{#user}}
                                <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border">
                                    {{user}}{{#role}} <span class="text-gray-400">({{role}})</span>{{/role}}
                                </span>
                                {{/user}}
                            </div>
                            <div class="mt-2">
                                <span class="font-semibold text-sm {{#is_approve}}text-green-700{{/is_approve}}{{#is_reject}}text-red-700{{/is_reject}}{{^is_approve}}{{^is_reject}}text-gray-700{{/is_reject}}{{/is_approve}}">
                                    {{action}}
                                </span>
                                {{#comment}}
                                <div class="mt-2 p-2 bg-white rounded border border-gray-200 text-xs text-gray-700 flex items-start">
                                    <i class="fa-solid fa-comment-dots mr-2 mt-0.5 text-blue-600"></i>
                                    <span class="flex-1 italic">{{comment}}</span>
                                </div>
                                {{/comment}}
                            </div>
                        </div>
                        {{/.}}
                        {{/log_entries}}
                        {{^log_entries}}
                        {{#logs}}
                        <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <div class="whitespace-pre-line text-gray-600 font-mono text-xs">{{logs}}</div>
                        </div>
                        {{/logs}}
                        {{^logs}}
                        <div class="text-center py-6 text-gray-400 italic">
                            <i class="fa-solid fa-inbox text-3xl mb-2 block"></i>
                            Chưa có lịch sử phê duyệt
                        </div>
                        {{/logs}}
                        {{/log_entries}}
                    </div>
                </div>

                <!-- Nút hành động -->
                <div class="bg-gray-50 border-t border-gray-200 -mx-6 -mb-6 p-4 rounded-b-lg">
                    {{#can_resubmit}}
                    <button onclick="resubmitRequest('{{id}}')" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i>
                        <span>Gửi lại để duyệt</span>
                    </button>
                    {{/can_resubmit}}
                    {{^can_resubmit}}
                    {{#is_completed}}
                    <button onclick="printRequest('{{id}}')" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-print"></i>
                        <span>In tờ trình</span>
                    </button>
                    {{/is_completed}}
                    {{^is_completed}}
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="confirmAction('{{id}}', 'approve')" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check-circle"></i>
                            <span>Duyệt</span>
                        </button>
                        <button onclick="confirmAction('{{id}}', 'reject')" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-times-circle"></i>
                            <span>Từ chối</span>
                        </button>
                    </div>
                    {{/is_completed}}
                    {{/can_resubmit}}
                </div>
            </div>
        </div>
    </template>

    <script>
/**
 * Hệ Thống Phê Duyệt Giá Xe - Main Application Script
 * Single Page Application - All code in one file
 */

// ===================================
// CONFIGURATION
// ===================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwTyybDq0fVwdJz0IdCM-t1uLc3EKhclv58q9ey9kiKtUd4NMvpDR-ptWbH2b34bwkR/exec";

// ===================================
// UTILITY FUNCTIONS
// ===================================
const $ = (id) => document.getElementById(id);
const $$ = (selector) => document.querySelectorAll(selector);
let cachedUsers = [];
let approvalData = [];
let approvalFilters = { search: '', status: 'all' };

function getSession() {
    const sessionStr = localStorage.getItem('user_session');
    if (!sessionStr) return null;
    try {
        return JSON.parse(sessionStr);
    } catch (e) {
        console.error('Invalid session data', e);
        localStorage.removeItem('user_session');
        return null;
    }
}

// ===================================
// INITIALIZATION
// ===================================
        // Load TPKD users when page loads
        async function loadTPKDUsers() {
            try {
                const res = await callAPI({ action: 'get_users_by_role', role: 'TPKD' });
                if (res.success && res.users) {
                    const select = $('approver_step0');
                    if (select) {
                        select.innerHTML = '<option value="">-- Chọn TPKD --</option>';
                        res.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.username;
                            option.textContent = `${user.fullname} (${user.username})${user.group ? ' - ' + user.group : ''}`;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading TPKD users:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTPKDUsers();
            checkSession();
            addGiftRow('gift-list-manual');
    initContractLookup();

    const approvalSearch = $('approval-search');
    if (approvalSearch) {
        approvalSearch.addEventListener('input', (e) => setApprovalFilter('search', e.target.value));
    }
    const approvalStatus = $('approval-status-filter');
    if (approvalStatus) {
        approvalStatus.addEventListener('change', (e) => setApprovalFilter('status', e.target.value));
    }
});

// ===================================
// CONTRACT LOOKUP INITIALIZATION
// ===================================
function initContractLookup() {
    const searchInput = $('search_code_input');
    if (!searchInput) return;
    
    // Set hx-post URL
    searchInput.setAttribute('hx-post', API_URL);
    
    // Process with htmx if available
    if (typeof htmx !== 'undefined') {
        htmx.process(searchInput);
        
        // Override htmx request to send JSON with search_code (backend expects search_code)
        searchInput.addEventListener('htmx:configRequest', (event) => {
            const searchCode = searchInput.value.trim().toUpperCase();
            if (!searchCode) {
                event.preventDefault();
                return;
            }
            
            // Override to send JSON instead of form data
            event.detail.headers['Content-Type'] = 'application/json';
            // Clear parameters and set body as JSON string
            event.detail.parameters = {};
            const requestBody = {
                action: 'lookup_contract',
                search_code: searchCode  // Backend expects 'search_code', not 'contract_code'
            };
            event.detail.body = JSON.stringify(requestBody);
            
            console.log('Sending lookup request:', requestBody);
        });
        
        // Handle response for debugging
        searchInput.addEventListener('htmx:afterRequest', (event) => {
            console.log('Response status:', event.detail.xhr.status);
            if (event.detail.xhr.status === 200) {
                try {
                    const response = JSON.parse(event.detail.xhr.responseText);
                    console.log('Response data:', response);
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
            }
        });
        
        // Handle successful response after swap
        searchInput.addEventListener('htmx:afterSwap', (event) => {
            // Wait a bit for DOM to update
            setTimeout(() => {
                const actionArea = $('action-area');
                if (actionArea) actionArea.classList.remove('hidden');
                
                // Store contract_code in the hidden field
                const contractCode = searchInput.value.trim().toUpperCase();
                const hiddenContractCode = $('lookup-contract-code') || 
                                          document.querySelector('#form-create-request input[name="contract_code"]');
                
                if (hiddenContractCode) {
                    hiddenContractCode.value = contractCode;
                } else {
                    // Create hidden field if not exists
                    const form = $('form-create-request');
                    if (form) {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'contract_code';
                        hiddenInput.id = 'lookup-contract-code';
                        hiddenInput.value = contractCode;
                        form.appendChild(hiddenInput);
                    }
                }
                
                // Initialize gift row if template rendered successfully
                if (typeof addGiftRow === 'function') {
                    const giftList = $('gift-list-search');
                    if (giftList && giftList.children.length === 0) {
                        addGiftRow('gift-list-search');
                    }
                }
            }, 100);
        });
    }
}

// ===================================
// AUTHENTICATION
// ===================================
        function checkSession() {
    const user = getSession();
    const login = $('login-view');
    const dash = $('dashboard-view');
    
    if (user) {
        // Kiểm tra nếu cần đổi mật khẩu
        if (user.need_change_pass) {
            login?.classList.remove('hidden');
            dash?.classList.add('hidden');
            dash?.classList.remove('flex');
            // Hiển thị modal đổi mật khẩu
            showChangePasswordModal(user, true);
            return;
        }
        
        $('user-fullname').textContent = user.fullname || 'User';
        $('user-role').textContent = user.role || 'ROLE';
        
        $('nav-profile')?.classList.remove('hidden');
        $('nav-mobile-profile')?.classList.remove('hidden');
        
        if (user.role === 'ADMIN') {
            $('nav-users')?.classList.remove('hidden');
            $('nav-mobile-users')?.classList.remove('hidden');
            } else {
            $('nav-users')?.classList.add('hidden');
            $('nav-mobile-users')?.classList.add('hidden');
        }
        
        loadProfile();
        
        const navApproval = $('nav-approval');
        if (user.role === 'SALE' || user.role === 'TVBH') {
            navApproval?.classList.add('hidden');
        } else {
            switchTab('approval');
        }
        
        login?.classList.add('hidden');
        dash?.classList.remove('hidden');
        dash?.classList.add('flex');
    } else {
        showLogin();
    }
}

function showLogin() {
    const login = $('login-view');
    const dash = $('dashboard-view');
    login?.classList.remove('hidden');
    dash?.classList.add('hidden');
    dash?.classList.remove('flex');
}

        async function handleLogin(e) {
            e.preventDefault();
    const username = $('login-user')?.value;
    const password = $('login-pass')?.value;
    
    if (!username || !password) {
        Swal.fire('Lỗi', 'Vui lòng nhập đầy đủ thông tin', 'error');
        return;
    }
    
    try {
        const res = await callAPI({ action: 'login', username, password });
        if (res.success && res.user) {
            // Kiểm tra nếu cần đổi mật khẩu
            if (res.user.need_change_pass) {
                // Hiển thị modal yêu cầu đổi mật khẩu
                await showChangePasswordModal(res.user, true);
            } else {
                // Đăng nhập bình thường
                localStorage.setItem('user_session', JSON.stringify(res.user));
                location.reload();
            }
        } else {
            Swal.fire('Lỗi', res.message || 'Đăng nhập thất bại', 'error');
        }
    } catch (error) {
        Swal.fire('Lỗi', 'Không thể kết nối đến server', 'error');
    }
}

async function showChangePasswordModal(user, isFirstLogin = false) {
    const title = isFirstLogin 
        ? 'Yêu cầu đổi mật khẩu' 
        : 'Đổi mật khẩu';
    const message = isFirstLogin
        ? 'Đây là lần đăng nhập đầu tiên. Vui lòng đổi mật khẩu để tiếp tục.'
        : 'Vui lòng đổi mật khẩu của bạn.';
    
    const result = await Swal.fire({
        title: title,
        html: `
            <div style="text-align: left;">
                <p style="margin-bottom: 15px; color: #666;">${message}</p>
                ${!isFirstLogin ? `
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mật khẩu cũ:</label>
                <input id="swal-old-pass" type="password" class="swal2-input" placeholder="Nhập mật khẩu cũ" style="margin-bottom: 15px;" required>
                ` : ''}
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mật khẩu mới:</label>
                <input id="swal-new-pass" type="password" class="swal2-input" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" style="margin-bottom: 15px;" required>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Xác nhận mật khẩu mới:</label>
                <input id="swal-confirm-pass" type="password" class="swal2-input" placeholder="Nhập lại mật khẩu mới" required>
            </div>
        `,
        showCancelButton: false,
        confirmButtonText: 'Đổi mật khẩu',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const newPassInput = Swal.getPopup().querySelector('#swal-new-pass');
            if (newPassInput) newPassInput.focus();
        },
        preConfirm: () => {
            const oldPassInput = Swal.getPopup().querySelector('#swal-old-pass');
            const newPassInput = Swal.getPopup().querySelector('#swal-new-pass');
            const confirmPassInput = Swal.getPopup().querySelector('#swal-confirm-pass');
            
            const oldPass = oldPassInput ? oldPassInput.value : '';
            const newPass = newPassInput ? newPassInput.value : '';
            const confirmPass = confirmPassInput ? confirmPassInput.value : '';
            
            if (!newPass || newPass.length < 6) {
                Swal.showValidationMessage('Mật khẩu mới phải có ít nhất 6 ký tự');
                return false;
            }
            
            if (newPass !== confirmPass) {
                Swal.showValidationMessage('Mật khẩu xác nhận không khớp');
                return false;
            }
            
            if (!isFirstLogin && !oldPass) {
                Swal.showValidationMessage('Vui lòng nhập mật khẩu cũ');
                return false;
            }
            
            return { oldPass, newPass };
        }
    });
    
    if (result.isConfirmed && result.value) {
        try {
            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const changeRes = await callAPI({
                action: 'change_password',
                username: user.username,
                old_pass: result.value.oldPass || '',
                new_pass: result.value.newPass
            });
            
            if (changeRes.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: changeRes.message || 'Đã đổi mật khẩu thành công',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Cập nhật user session với thông tin mới
                    if (changeRes.user) {
                        localStorage.setItem('user_session', JSON.stringify(changeRes.user));
                    } else {
                        // Nếu không có user mới, cập nhật need_change_pass = false
                        user.need_change_pass = false;
                        localStorage.setItem('user_session', JSON.stringify(user));
                    }
                    location.reload();
                });
            } else {
                Swal.fire('Lỗi', changeRes.message || 'Đổi mật khẩu thất bại', 'error');
                // Nếu là lần đăng nhập đầu tiên, hiển thị lại modal
                if (isFirstLogin) {
                    await showChangePasswordModal(user, true);
                }
            }
        } catch (error) {
            Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
            // Nếu là lần đăng nhập đầu tiên, hiển thị lại modal
            if (isFirstLogin) {
                await showChangePasswordModal(user, true);
            }
        }
    }
}

function logout() {
    localStorage.removeItem('user_session');
    location.reload();
}

// ===================================
// NAVIGATION
// ===================================
        function switchTab(id) {
    $$('.tab-content').forEach(el => el.classList.remove('active'));
    $$('.nav-item').forEach(el => el.classList.remove('active'));
    
    const tab = $(`tab-${id}`);
    const nav = $(`nav-${id}`);
    
    if (tab) tab.classList.add('active');
    if (nav) nav.classList.add('active');
    
    if (id === 'approval') loadApprovalList();
    if (id === 'my-requests') loadMyRequests();
    if (id === 'profile') loadProfile();
    if (id === 'users') loadUserManagement();
}


// ===================================
// MONEY & GIFT LOGIC
// ===================================
        function formatMoneyInput(el) {
    if (!el) return;
            let val = el.value.replace(/\D/g, '');
    el.value = val ? Number(val).toLocaleString('vi-VN') : '';
    
    const containerId = el.closest('#mode-search-container') 
        ? 'gift-list-search' 
        : 'gift-list-manual';
            calcGiftTotal(containerId);
        }

        function addGiftRow(containerId) {
    const container = $(containerId);
    if (!container) return;
    
    // Xóa message "Chưa có quà tặng" nếu đây là quà đầu tiên
    if (container.querySelectorAll('.gift-row').length === 0) {
        container.innerHTML = '';
    }
    
    const rowId = `gift-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const html = `
        <div class="flex gap-2 mb-2 gift-row items-center bg-gray-50 p-2 rounded border border-gray-200" id="${rowId}">
            <input class="gift-name flex-1 border p-1.5 rounded text-sm outline-none focus:border-blue-500 bg-white" 
                   placeholder="Nhập tên quà tặng">
            <input class="gift-price w-32 border p-1.5 rounded text-sm text-right outline-none focus:border-blue-500 bg-white" 
                   placeholder="0" 
                   oninput="formatMoneyInput(this); calcGiftTotal('${containerId}')">
            <button type="button" 
                    onclick="removeGiftRow('${rowId}','${containerId}')" 
                    class="text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeGiftRow(rowId, containerId) {
    const row = $(rowId);
    if (row) {
        row.remove();
            calcGiftTotal(containerId);
        
        // Kiểm tra nếu không còn quà nào thì hiển thị message
        const container = $(containerId);
        if (container && container.querySelectorAll('.gift-row').length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>';
        }
    }
}

        function calcGiftTotal(containerId) {
    const container = $(containerId);
    if (!container) return;
    
            let total = 0;
    container.querySelectorAll('.gift-row').forEach(row => {
        const priceInput = row.querySelector('.gift-price');
        if (priceInput) {
            const val = parseInt(priceInput.value.replace(/\./g, '')) || 0;
                total += val;
        }
    });
    
    const displayId = containerId === 'gift-list-search' 
        ? 'total-gift-search' 
        : (containerId === 'gift-list-edit' ? 'total-gift-edit' : 'total-gift-manual');
    const displayEl = $(displayId);
    if (displayEl) {
        displayEl.textContent = total.toLocaleString('vi-VN') + ' đ';
    }
}

        function packGiftData(containerId, hiddenInputId) {
    const container = $(containerId);
    const hiddenInput = $(hiddenInputId);
    if (!container || !hiddenInput) {
        console.error('packGiftData: Container or hiddenInput not found', { containerId, hiddenInputId });
        return;
    }
    
    const gifts = [];
    container.querySelectorAll('.gift-row').forEach(row => {
        const nameInput = row.querySelector('.gift-name');
        const priceInput = row.querySelector('.gift-price');
        const name = nameInput?.value.trim();
        
        if (name) {
            // Loại bỏ dấu chấm và các ký tự không phải số từ giá trị
            const priceValue = (priceInput?.value || '0').toString().replace(/\./g, '').replace(/[^\d]/g, '');
            gifts.push({
                name,
                price: priceValue || '0'
            });
        }
    });
    
    hiddenInput.value = JSON.stringify(gifts);
    console.log('packGiftData result:', hiddenInput.value);
}

// ===================================
// FORM SUBMISSION
// ===================================
        async function handleSubmitRequest(e, mode) {
            e.preventDefault();
    
    const sessionStr = localStorage.getItem('user_session');
    if (!sessionStr) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    let session;
    try {
        session = JSON.parse(sessionStr);
    } catch (e) {
        Swal.fire('Lỗi', 'Dữ liệu phiên không hợp lệ', 'error');
        logout();
        return;
    }
    
    const formId = mode === 'search' ? 'form-create-request' : 'form-manual-create';
    const giftContainer = mode === 'search' ? 'gift-list-search' : 'gift-list-manual';
    const hiddenInput = mode === 'search' ? 'hidden_gift_json_search' : 'hidden_gift_json_manual';
    
    // Pack gift data trước khi submit
    packGiftData(giftContainer, hiddenInput);
    
    const form = $(formId);
    if (!form) {
        Swal.fire('Lỗi', 'Không tìm thấy form', 'error');
        return;
    }
    
    const formData = new FormData(form);
    const payload = {
        action: "submit_request",
        requester: session.username,
        ...Object.fromEntries(formData.entries()),
        approver_step0: formData.get('approver_step0') || ''
    };
    
    // Validate approver_step0
    if (!payload.approver_step0) {
        Swal.fire('Lỗi', 'Vui lòng chọn TPKD duyệt', 'error');
        return;
    }
    
    // Đảm bảo gift_json được gửi lên (lấy từ hidden input)
    const giftJsonValue = $(hiddenInput)?.value || '[]';
    if (giftJsonValue) {
        payload.gift_json = giftJsonValue;
    }
    
    console.log('Submit payload:', payload);
    
    if (mode === 'search') {
        const contractCode = $('search_code_input')?.value;
        if (contractCode) payload.contract_code = contractCode;
    }
    
    const btn = form.querySelector('button[type="submit"]');
    if (!btn) return;
    
            const orgHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang gửi...';
    btn.disabled = true;

    try {
            const res = await callAPI(payload);
        if (res.success) {
            Swal.fire('Thành công', res.message || 'Đã gửi thành công', 'success');
            form.reset();
            
            // Xóa quà tặng khỏi form sau khi submit
            const giftContainerEl = mode === 'search' ? $('gift-list-search') : $('gift-list-manual');
            if (giftContainerEl) {
                giftContainerEl.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>';
            }
            
            const totalEl = $(mode === 'search' ? 'total-gift-search' : 'total-gift-manual');
            if (totalEl) totalEl.textContent = '0';
            
            if (mode === 'search') {
                const searchResult = $('search-result');
                const searchInput = $('search_code_input');
                const actionArea = $('action-area');
                
                if (searchResult) {
                    searchResult.innerHTML = '<div class="text-center py-12 text-gray-400 border-2 border-dashed rounded-lg bg-gray-50"><p>Đã gửi xong.</p></div>';
                }
                if (searchInput) searchInput.value = '';
                if (actionArea) actionArea.classList.add('hidden');
                }
            } else {
            Swal.fire('Lỗi', res.message || 'Gửi thất bại', 'error');
        }
    } catch (error) {
        Swal.fire('Lỗi', 'Không thể kết nối đến server', 'error');
    } finally {
        btn.innerHTML = orgHtml;
        btn.disabled = false;
    }
}

// ===================================
// APPROVAL
// ===================================
        async function loadApprovalList() {
    const sessionStr = localStorage.getItem('user_session');
    if (!sessionStr) {
        const container = $('approval-list-container');
        if (container) {
            container.innerHTML = '<p class="text-red-500 text-center">Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.</p>';
        }
        return;
    }
    
    let session;
    try {
        session = JSON.parse(sessionStr);
    } catch (e) {
        console.error('Error parsing session:', e);
        const container = $('approval-list-container');
        if (container) {
            container.innerHTML = '<p class="text-red-500 text-center">Lỗi dữ liệu phiên đăng nhập</p>';
        }
        return;
    }
    
    const container = $('approval-list-container');
    if (!container) {
        console.error('approval-list-container not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl"></i><p class="mt-2 text-gray-500">Đang tải danh sách...</p></div>';
    
    try {
        const res = await callAPI({
            action: 'get_pending_list',
            username: session.username,
            role: session.role
        });
        
        console.log('loadApprovalList response:', res);
        
        if (res.success && res.data) {
            approvalData = res.data;
            renderApprovalSummary();
            renderApprovalList();
        } else {
            const errorMsg = res.message || 'Không có dữ liệu hoặc lỗi không xác định';
            console.error('API returned error:', errorMsg);
            container.innerHTML = `<p class="text-red-500 text-center">${errorMsg}</p>`;
        }
    } catch (error) {
        console.error('Error in loadApprovalList:', error);
        container.innerHTML = `<p class="text-red-500 text-center">Lỗi kết nối: ${error.message || 'Không thể kết nối đến server'}</p>`;
    }
}

function setApprovalFilter(key, value) {
    approvalFilters[key] = value;
    renderApprovalSummary();
    renderApprovalList();
}

function getApprovalStatus(item) {
    if (item.can_resubmit) return 'rejected';
    if (item.status_text && /từ chối|trả về/i.test(item.status_text)) return 'rejected';
    if (item.status_text && /hoàn tất|chờ in/i.test(item.status_text)) return 'completed';
    return 'pending';
}

function filterApprovalData() {
    const search = (approvalFilters.search || '').trim().toLowerCase();
    const status = approvalFilters.status || 'all';
    return approvalData.filter(item => {
        const statusMatch = status === 'all' || getApprovalStatus(item) === status;
        if (!statusMatch) return false;
        if (!search) return true;
        const haystack = [
            item.contract_code,
            item.customer,
            item.phone,
            item.requester,
            item.status_text
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(search);
    });
}

function renderApprovalSummary() {
    const summaryTotal = $('summary-total');
    const summaryPending = $('summary-pending');
    if (!summaryTotal || !summaryPending) return;
    const filtered = filterApprovalData();
    const pendingCount = approvalData.filter(item => getApprovalStatus(item) === 'pending').length;
    summaryTotal.textContent = approvalData.length.toString();
    summaryPending.textContent = pendingCount.toString();
}

function renderApprovalList() {
    const container = $('approval-list-container');
    if (!container) return;
    const tpl = $('tpl-pending-list')?.innerHTML;
    if (!tpl || typeof Mustache === 'undefined') {
        container.innerHTML = '<p class="text-red-500 text-center">Template không khả dụng.</p>';
        return;
    }
    const filtered = filterApprovalData();
    if (!filtered.length) {
        container.innerHTML = '<div class="text-center text-gray-400 py-12"><i class="fa-regular fa-folder-open text-4xl mb-2 opacity-30"></i><p>Không có đơn phù hợp bộ lọc.</p></div>';
        return;
    }
    container.innerHTML = Mustache.render(tpl, { data: filtered });
}

// ===================================
// MODAL
// ===================================
        function openDetail(jsonStr) {
    try {
        if (!jsonStr) {
            console.error('jsonStr is empty or undefined');
            Swal.fire('Lỗi', 'Không có dữ liệu để hiển thị', 'error');
            return;
        }
        
        let data;
        try {
            // Thử decode và parse JSON
            const decoded = decodeURIComponent(jsonStr);
            data = JSON.parse(decoded);
        } catch (parseError) {
            console.error('Error parsing JSON:', parseError);
            console.error('jsonStr value:', jsonStr);
            Swal.fire('Lỗi', 'Dữ liệu không hợp lệ. Vui lòng thử lại.', 'error');
            return;
        }
        
        if (!data || typeof data !== 'object') {
            console.error('Invalid data format:', data);
            Swal.fire('Lỗi', 'Dữ liệu không đúng định dạng', 'error');
            return;
        }
        
        // Đảm bảo các trường mới có giá trị mặc định
        data.other_requirements = data.other_requirements || '';
        data.max_cost_rate = data.max_cost_rate || '';
        data.productivity_bonus = data.productivity_bonus || '';
        
        const sessionStr = localStorage.getItem('user_session');
        let session = null;
        
        if (sessionStr) {
            try {
                session = JSON.parse(sessionStr);
                // Kiểm tra xem có thể gửi lại không (step = 0 và là người tạo)
                data.can_resubmit = (data.step === 0 && 
                                    session && 
                                    (session.role === 'TVBH' || session.role === 'SALE') &&
                                    data.requester && 
                                    data.requester.toLowerCase() === session.username.toLowerCase());
                
                // Thêm is_admin flag
                data.is_admin = (session && session.role === 'ADMIN');
                
                // Tính toán chi phí và tỷ lệ
                const discountAmount = parseInt((data.discount_amount || '').replace(/[^\d]/g, '')) || 0;
                const giftAmount = parseInt((data.gift_amount || '').replace(/[^\d]/g, '')) || 0;
                const totalCost = discountAmount + giftAmount;
                const contractPrice = parseInt((data.contract_price || '').replace(/[^\d]/g, '')) || 0;
                const costPercentage = contractPrice > 0 ? ((totalCost / contractPrice) * 100).toFixed(2) : '0.00';
                data.total_cost = totalCost.toLocaleString('vi-VN');
                data.cost_percentage = costPercentage;
                
                // Tính next_status và is_completed nếu chưa có
                // Step 4 (Kế Toán) là bước cuối, sau đó có thể in (step >= 6)
                if (!data.next_status && !data.is_completed) {
                    const workflow = [
                        { step: 0, next: 1, label: 'Chờ TPKD duyệt' },
                        { step: 1, next: 2, label: 'Chờ GĐKD duyệt' },
                        { step: 2, next: 3, label: 'Chờ Ban Kiểm Soát' },
                        { step: 3, next: 4, label: 'Chờ Ban Giám Đốc' },
                        { step: 4, next: 6, label: 'Chờ Kế Toán kiểm tra' } // next: 6 = Hoàn tất
                    ];
                    const stepConfig = workflow.find(w => w.step === data.step);
                    if (data.step >= 6 || (stepConfig && stepConfig.next >= 6)) {
                        data.is_completed = true;
                    } else if (stepConfig && stepConfig.next < 6) {
                        const nextConfig = workflow.find(w => w.step === stepConfig.next);
                        if (nextConfig) {
                            data.next_status = nextConfig.label;
                        }
                    }
                }
            } catch (e) {
                console.error('Error parsing session:', e);
            }
        }
        
        const tpl = $('tpl-order-detail');
        const modalBody = $('modal-detail-body');
        const modal = $('modal-detail');
        
        if (!tpl) {
            console.error('Template tpl-order-detail not found');
            Swal.fire('Lỗi', 'Template không tìm thấy', 'error');
            return;
        }
        
        if (!modalBody) {
            console.error('modal-detail-body not found');
            Swal.fire('Lỗi', 'Modal body không tìm thấy', 'error');
            return;
        }
        
        if (!modal) {
            console.error('modal-detail not found');
            Swal.fire('Lỗi', 'Modal không tìm thấy', 'error');
            return;
        }
        
        if (typeof Mustache === 'undefined') {
            console.error('Mustache is not loaded');
            modalBody.innerHTML = '<p class="p-4 text-red-500">Lỗi: Mustache không được tải. Vui lòng tải lại trang.</p>';
            modal.classList.remove('hidden');
            return;
        }
        
        try {
            modalBody.innerHTML = Mustache.render(tpl.innerHTML, data);
        } catch (renderError) {
            console.error('Error rendering template:', renderError);
            Swal.fire('Lỗi', 'Không thể render template: ' + renderError.message, 'error');
            return;
        }
        
        modal.classList.remove('hidden');
        
        setTimeout(() => {
            const modalContent = $('modal-content');
            if (modalContent) {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }
        }, 10);
    } catch (e) {
        console.error('Error opening detail:', e);
        console.error('Stack trace:', e.stack);
        Swal.fire('Lỗi', 'Không thể mở chi tiết: ' + (e.message || 'Lỗi không xác định'), 'error');
    }
}

        function closeModal() {
    const modal = $('modal-detail');
    const modalContent = $('modal-content');
    
    if (modalContent) {
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
    }
    
    setTimeout(() => {
        if (modal) modal.classList.add('hidden');
    }, 200);
}

async function resubmitRequest(id) {
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    // Xác nhận trước khi gửi lại
    const confirmResult = await Swal.fire({
        title: 'Gửi lại đơn?',
        text: 'Đơn sẽ được gửi lại để duyệt từ đầu',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Gửi lại',
        cancelButtonText: 'Hủy'
    });
    
    if (!confirmResult.isConfirmed) {
        return;
    }
    
    try {
        const res = await callAPI({
            action: 'resubmit',
            id,
            username: session.username,
            role: session.role
        });
        
        if (res.success) {
            Swal.fire('Thành công', res.message || 'Đã gửi lại đơn thành công', 'success');
            closeModal();
            loadApprovalList();
        } else {
            Swal.fire('Lỗi', res.message || 'Gửi lại thất bại', 'error');
        }
    } catch (error) {
        console.error('Error in resubmitRequest:', error);
        Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
    }
}

        async function confirmAction(id, decision) {
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    // Get request detail to know next step
    let nextRole = null;
    let nextStep = null;
    try {
        const detailRes = await callAPI({ action: 'get_request_detail', id, username: session.username });
        if (detailRes.success && detailRes.data) {
            const workflow = [
                { step: 0, next: 1, role: 'TPKD' },
                { step: 1, next: 2, role: 'GDKD' },
                { step: 2, next: 3, role: 'BKS' },
                { step: 3, next: 4, role: 'BGD' },
                { step: 4, next: 6, role: 'KETOAN' }
            ];
            const currentStep = detailRes.data.step || 0;
            const stepConfig = workflow.find(w => w.step === currentStep);
            if (stepConfig && stepConfig.next < 6) {
                const nextConfig = workflow.find(w => w.step === stepConfig.next);
                if (nextConfig) {
                    nextRole = nextConfig.role;
                    nextStep = stepConfig.next;
                }
            }
        }
    } catch (e) {
        console.error('Error getting request detail:', e);
    }
    
    // Prompt for comment for both approve and reject
    let comment = '';
    let productivityBonus = '';
    let nextApprover = '';
    try {
        if (decision === 'approve') {
            // Load users for next role if available
            let usersHtml = '';
            if (nextRole) {
                try {
                    const usersRes = await callAPI({ action: 'get_users_by_role', role: nextRole });
                    if (usersRes.success && usersRes.users && usersRes.users.length > 0) {
                        usersHtml = `
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Chọn người duyệt tiếp theo (${nextRole}):</label>
                            <select id="swal-next-approver" class="swal2-select" style="width: 100%; margin-bottom: 15px; padding: 8px;">
                                <option value="">-- Chọn người duyệt --</option>
                        `;
                        usersRes.users.forEach(user => {
                            usersHtml += `<option value="${user.username}">${user.fullname} (${user.username})${user.group ? ' - ' + user.group : ''}</option>`;
                        });
                        usersHtml += '</select>';
                    }
                } catch (e) {
                    console.error('Error loading users:', e);
                }
            }
            
            // For approve: show form with comment, productivity bonus, and next approver
            const result = await Swal.fire({
                title: 'Duyệt tờ trình',
                html: `
                    <div style="text-align: left;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lý do duyệt (tùy chọn):</label>
                        <textarea id="swal-comment" class="swal2-textarea" placeholder="Ví dụ: Đã kiểm tra và đồng ý..." style="width: 100%; min-height: 60px; margin-bottom: 15px;"></textarea>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lương năng suất (VNĐ) - TVBH đề xuất:</label>
                        <input id="swal-productivity" type="text" class="swal2-input" placeholder="0" style="text-align: right; margin-bottom: 15px;" oninput="this.value = this.value.replace(/[^0-9]/g, ''); if (this.value) this.value = parseInt(this.value).toLocaleString('vi-VN');">
                        ${usersHtml}
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                allowOutsideClick: false,
                allowEscapeKey: true,
                didOpen: () => {
                    const commentInput = Swal.getPopup().querySelector('#swal-comment');
                    if (commentInput) commentInput.focus();
                }
            });
            
            if (result.dismiss === Swal.DismissReason.cancel || result.dismiss === Swal.DismissReason.esc) {
                return;
            }
            
            const commentInput = Swal.getPopup().querySelector('#swal-comment');
            const productivityInput = Swal.getPopup().querySelector('#swal-productivity');
            const nextApproverInput = Swal.getPopup().querySelector('#swal-next-approver');
            comment = commentInput ? commentInput.value : '';
            productivityBonus = productivityInput ? productivityInput.value.replace(/\./g, '') : '';
            nextApprover = nextApproverInput ? nextApproverInput.value : '';
        } else {
            // For reject: only comment required
            const title = 'Lý do từ chối';
            const label = 'Nhập lý do từ chối (khuyến nghị)';
            const placeholder = 'Ví dụ: Giá không phù hợp, thiếu thông tin...';
            
            const result = await Swal.fire({
                title: title,
                input: 'textarea',
                inputLabel: label,
                inputPlaceholder: placeholder,
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                allowOutsideClick: false,
                allowEscapeKey: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'Vui lòng nhập lý do từ chối';
                    }
                    return null;
                }
            });
            
            if (result.dismiss === Swal.DismissReason.cancel || result.dismiss === Swal.DismissReason.esc) {
                return;
            }
            
            comment = result.value || '';
            
            if (!comment.trim()) {
                Swal.fire('Lỗi', 'Vui lòng nhập lý do từ chối', 'error');
                return;
            }
        }
    } catch (e) {
        console.error('Error getting input:', e);
        if (decision === 'reject') {
            Swal.fire('Lỗi', 'Vui lòng nhập lý do từ chối', 'error');
            return;
        }
        comment = '';
        productivityBonus = '';
    }
    
    try {
        const res = await callAPI({
            action: 'approve_reject',
            id,
            username: session.username,
            role: session.role,
            decision,
            comment: comment || '',
            productivity_bonus: productivityBonus || '',
            next_approver: nextApprover || ''
        });
        
        if (res.success) {
            Swal.fire('OK', res.message || 'Thành công', 'success');
            closeModal();
            loadApprovalList();
        } else {
            Swal.fire('Lỗi', res.message || 'Thất bại', 'error');
        }
    } catch (error) {
        console.error('Error in confirmAction:', error);
        Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
    }
}

// ===================================
// MY REQUESTS MANAGEMENT
// ===================================

let myRequestsData = [];
let myRequestsFilters = { search: '', status: 'all' };

async function loadMyRequests() {
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    const container = $('my-requests-list-container');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl"></i><p class="mt-2 text-gray-500">Đang tải danh sách...</p></div>';
    
    try {
        const res = await callAPI({
            action: 'get_my_requests',
            username: session.username,
            role: session.role
        });
        
        if (res.success && res.data) {
            myRequestsData = res.data;
            renderMyRequestsList();
        } else {
            container.innerHTML = `<p class="text-red-500 text-center">${res.message || 'Không có dữ liệu'}</p>`;
        }
    } catch (error) {
        console.error('Error in loadMyRequests:', error);
        container.innerHTML = `<p class="text-red-500 text-center">Lỗi kết nối: ${error.message || 'Không thể kết nối đến server'}</p>`;
    }
}

function filterMyRequestsData() {
    const search = (myRequestsFilters.search || '').trim().toLowerCase();
    const status = myRequestsFilters.status || 'all';
    return myRequestsData.filter(item => {
        const statusMatch = status === 'all' || getMyRequestStatus(item) === status;
        if (!statusMatch) return false;
        if (!search) return true;
        const haystack = [
            item.contract_code,
            item.customer,
            item.phone,
            item.status_text
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(search);
    });
}

function getMyRequestStatus(item) {
    if (item.can_resubmit) return 'rejected';
    if (item.status_text && /từ chối|trả về/i.test(item.status_text)) return 'rejected';
    if (item.is_completed) return 'completed';
    return 'pending';
}

function renderMyRequestsList() {
    const container = $('my-requests-list-container');
    if (!container) return;
    const tpl = $('tpl-my-requests-list')?.innerHTML;
    if (!tpl || typeof Mustache === 'undefined') {
        container.innerHTML = '<p class="text-red-500 text-center">Template không khả dụng.</p>';
        return;
    }
    const filtered = filterMyRequestsData();
    container.innerHTML = Mustache.render(tpl, { data: filtered });
}

// Setup filters
document.addEventListener('DOMContentLoaded', () => {
    const myRequestsSearch = $('my-requests-search');
    if (myRequestsSearch) {
        myRequestsSearch.addEventListener('input', (e) => {
            myRequestsFilters.search = e.target.value;
            renderMyRequestsList();
        });
    }
    const myRequestsStatus = $('my-requests-status-filter');
    if (myRequestsStatus) {
        myRequestsStatus.addEventListener('change', (e) => {
            myRequestsFilters.status = e.target.value;
            renderMyRequestsList();
        });
    }
});

async function openEditRequest(id) {
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    try {
        const res = await callAPI({
            action: 'get_request_detail',
            id,
            username: session.username
        });
        
        if (!res.success || !res.data) {
            Swal.fire('Lỗi', res.message || 'Không tìm thấy tờ trình', 'error');
            return;
        }
        
        const data = res.data;
        
        // Fill form
        $('edit_request_id').value = data.id;
        $('edit_contract_code').value = data.contract_code || '';
        $('edit_customer_name').value = data.customer || '';
        $('edit_phone').value = data.phone || '';
        $('edit_cccd').value = data.cccd || '';
        $('edit_email').value = data.email || '';
        $('edit_address').value = data.address || '';
        $('edit_car_model').value = data.car_model || '';
        $('edit_car_version').value = data.car_version || '';
        $('edit_car_color').value = data.car_color || '';
        $('edit_vin_no').value = data.vin_no || '';
        $('edit_payment_method').value = data.payment || '';
        $('edit_contract_price').value = (data.contract_price || '').replace(/[^\d]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        $('edit_discount_details').value = data.discount_details || '';
        $('edit_discount_amount').value = (data.discount_amount || '').replace(/[^\d]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Load gifts từ data
        const giftList = $('gift-list-edit');
        if (giftList) giftList.innerHTML = '';
        try {
            const gifts = JSON.parse(data.gift_json || '[]');
            if (Array.isArray(gifts) && gifts.length > 0) {
                gifts.forEach(gift => {
                    addGiftRow('gift-list-edit');
                    const rows = giftList.querySelectorAll('.gift-row');
                    const lastRow = rows[rows.length - 1];
                    if (lastRow) {
                        lastRow.querySelector('.gift-name').value = gift.name || '';
                        const priceValue = (gift.price || '0').toString().replace(/[^\d]/g, '');
                        lastRow.querySelector('.gift-price').value = priceValue ? Number(priceValue).toLocaleString('vi-VN') : '';
                    }
                });
            } else {
                giftList.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>';
            }
        } catch (e) {
            console.error('Error parsing gifts:', e);
            if (giftList) {
                giftList.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-2">Chưa có quà tặng. Nhấn "Thêm quà" để thêm.</p>';
            }
        }
        calcGiftTotal('gift-list-edit');
        
        // Show modal
        const modal = $('modal-edit-request');
        const modalContent = $('modal-edit-content');
        if (modal && modalContent) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }
    } catch (error) {
        console.error('Error in openEditRequest:', error);
        Swal.fire('Lỗi', error.message || 'Không thể tải dữ liệu', 'error');
    }
}

function closeEditModal() {
    const modal = $('modal-edit-request');
    const modalContent = $('modal-edit-content');
    
    if (modalContent) {
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
    }
    
    setTimeout(() => {
        if (modal) modal.classList.add('hidden');
    }, 200);
}

async function handleUpdateRequest(event) {
    event.preventDefault();
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Pack gift data trước khi submit
    packGiftData('gift-list-edit', 'hidden_gift_json_edit');
    const giftJson = $('hidden_gift_json_edit')?.value || '[]';
    
    const data = {
        action: 'update_request',
        id: formData.get('edit_request_id'),
        username: session.username,
        contract_code: formData.get('edit_contract_code'),
        customer_name: formData.get('edit_customer_name'),
        phone: formData.get('edit_phone'),
        cccd: formData.get('edit_cccd'),
        email: formData.get('edit_email'),
        address: formData.get('edit_address'),
        car_model: formData.get('edit_car_model'),
        car_version: formData.get('edit_car_version'),
        car_color: formData.get('edit_car_color'),
        vin_no: formData.get('edit_vin_no'),
        payment_method: formData.get('edit_payment_method'),
        contract_price: formData.get('edit_contract_price')?.replace(/\./g, '') || '0',
        discount_details: formData.get('edit_discount_details'),
        discount_amount: formData.get('edit_discount_amount')?.replace(/\./g, '') || '0',
        gift_json: giftJson,
        other_requirements: formData.get('edit_other_requirements') || ''
    };
    
    try {
        Swal.fire({
            title: 'Đang xử lý...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const res = await callAPI(data);
        
        if (res.success) {
            Swal.fire('Thành công', res.message || 'Đã cập nhật tờ trình thành công', 'success');
            closeEditModal();
            loadMyRequests();
            if (typeof loadApprovalList === 'function') loadApprovalList();
        } else {
            Swal.fire('Lỗi', res.message || 'Cập nhật thất bại', 'error');
        }
    } catch (error) {
        console.error('Error in handleUpdateRequest:', error);
        Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
    }
}

async function handleUpdateAndResubmit(event) {
    event.preventDefault();
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    // Xác nhận trước khi trình lại
    const confirmResult = await Swal.fire({
        title: 'Lưu và trình lại?',
        text: 'Tờ trình sẽ được lưu thay đổi và gửi lại để duyệt từ đầu',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Xác nhận',
        cancelButtonText: 'Hủy'
    });
    
    if (!confirmResult.isConfirmed) {
        return;
    }
    
    const form = $('form-edit-request');
    if (!form) {
        Swal.fire('Lỗi', 'Không tìm thấy form', 'error');
        return;
    }
    
    const formData = new FormData(form);
    
    // Pack gift data trước khi submit
    packGiftData('gift-list-edit', 'hidden_gift_json_edit');
    const giftJson = $('hidden_gift_json_edit')?.value || '[]';
    
    const updateData = {
        action: 'update_request',
        id: formData.get('edit_request_id'),
        username: session.username,
        contract_code: formData.get('edit_contract_code'),
        customer_name: formData.get('edit_customer_name'),
        phone: formData.get('edit_phone'),
        cccd: formData.get('edit_cccd'),
        email: formData.get('edit_email'),
        address: formData.get('edit_address'),
        car_model: formData.get('edit_car_model'),
        car_version: formData.get('edit_car_version'),
        car_color: formData.get('edit_car_color'),
        vin_no: formData.get('edit_vin_no'),
        payment_method: formData.get('edit_payment_method'),
        contract_price: formData.get('edit_contract_price')?.replace(/\./g, '') || '0',
        discount_details: formData.get('edit_discount_details'),
        discount_amount: formData.get('edit_discount_amount')?.replace(/\./g, '') || '0',
        gift_json: giftJson
    };
    
    try {
        Swal.fire({
            title: 'Đang xử lý...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Bước 1: Cập nhật tờ trình
        const updateRes = await callAPI(updateData);
        
        if (!updateRes.success) {
            Swal.fire('Lỗi', updateRes.message || 'Cập nhật thất bại', 'error');
            return;
        }
        
        // Bước 2: Gửi lại để duyệt
        const resubmitRes = await callAPI({
            action: 'resubmit',
            id: formData.get('edit_request_id'),
            username: session.username,
            role: session.role
        });
        
        if (resubmitRes.success) {
            Swal.fire('Thành công', 'Đã lưu thay đổi và trình lại tờ trình thành công', 'success');
            closeEditModal();
            loadMyRequests();
            if (typeof loadApprovalList === 'function') loadApprovalList();
        } else {
            Swal.fire('Lỗi', resubmitRes.message || 'Trình lại thất bại', 'error');
        }
    } catch (error) {
        console.error('Error in handleUpdateAndResubmit:', error);
        Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
    }
}

function printRequest(id) {
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        logout();
        return;
    }
    
    // Open print window with template
    const printWindow = window.open('', '_blank');
    const today = new Date();
    const day = today.getDate();
    const month = today.getMonth() + 1;
    const year = today.getFullYear();
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>PHIẾU TRÌNH ĐỀ XUẤT CHƯƠNG TRÌNH BÁN HÀNG</title>
            <meta charset="UTF-8">
            <style>
                @media print {
                    @page { margin: 1cm; size: A4; }
                }
                body { 
                    font-family: "Times New Roman", serif; 
                    font-size: 10pt; 
                    padding: 10px; 
                    line-height: 1.3;
                    margin: 0;
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 10px; 
                }
                .header h1 { 
                    font-size: 13pt; 
                    font-weight: bold; 
                    text-transform: uppercase; 
                    margin-bottom: 5px;
                }
                .header-info {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 5px;
                    font-size: 9pt;
                }
                .section { 
                    margin-bottom: 8px; 
                }
                .section-title { 
                    font-weight: bold; 
                    font-size: 10pt; 
                    margin-bottom: 5px; 
                    text-transform: uppercase;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-bottom: 8px; 
                    font-size: 9pt;
                }
                table, table td, table th { 
                    border: 1px solid #000; 
                }
                table td, table th { 
                    padding: 3px 5px; 
                    text-align: left;
                    vertical-align: top;
                }
                table th {
                    background: #f0f0f0;
                    font-weight: bold;
                    text-align: center;
                    font-size: 9pt;
                }
                .label { 
                    font-weight: bold; 
                    background: #f5f5f5; 
                    width: 30%;
                    font-size: 9pt;
                }
                .text-right {
                    text-align: right;
                }
                .total { 
                    font-weight: bold; 
                    font-size: 10pt; 
                }
                .signature-section {
                    margin-top: 15px;
                    display: flex;
                    justify-content: space-around;
                }
                .signature-box {
                    text-align: center;
                    width: 150px;
                }
                .signature-box-title {
                    font-weight: bold;
                    margin-bottom: 40px;
                    font-size: 9pt;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>PHIẾU TRÌNH ĐỀ XUẤT CHƯƠNG TRÌNH BÁN HÀNG</h1>
                <div class="header-info">
                    <div>Ngày <span id="print-day">${day}</span> tháng <span id="print-month">${month}</span> năm <span id="print-year">${year}</span></div>
                    <div>Số hợp đồng: <span id="print-contract-code"></span></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">I. THÔNG TIN KHÁCH HÀNG</div>
                <table>
                    <tr>
                        <td class="label">Tên khách hàng:</td>
                        <td id="print-customer"></td>
                    </tr>
                    <tr>
                        <td class="label">Địa chỉ:</td>
                        <td id="print-address"></td>
                    </tr>
                    <tr>
                        <td class="label">CMND/CCCD:</td>
                        <td id="print-cccd"></td>
                    </tr>
                    <tr>
                        <td class="label">Số điện thoại:</td>
                        <td id="print-phone"></td>
                    </tr>
                    <tr>
                        <td class="label">Email:</td>
                        <td id="print-email"></td>
                    </tr>
                    <tr>
                        <td class="label">Người đại diện (đối với tổ chức):</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="label">Chức vụ (nếu có):</td>
                        <td></td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">II. THÔNG TIN XE</div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">STT</th>
                            <th style="width: 50%;">Mặt hàng</th>
                            <th style="width: 20%;">Số khung</th>
                            <th style="width: 25%;" class="text-right">Giá trị hợp đồng</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: center;">1</td>
                            <td>
                                <div><strong>XE Ô TÔ CON</strong></div>
                                <div>Nhãn hiệu: <span id="print-car-brand">VinFast</span></div>
                                <div>Ký hiệu xe: <span id="print-car-model"></span><span id="print-car-version"></span></div>
                                <div>Màu sơn: <span id="print-car-color"></span></div>
                                <div>Số chỗ ngồi: 5</div>
                                <div>Năm SX: <span id="print-car-year">2025</span></div>
                            </td>
                            <td id="print-vin"></td>
                            <td class="text-right" id="print-contract-price"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="label">Tổng giá trị hợp đồng (A):</td>
                            <td class="text-right total" id="print-total-contract"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">III. CHI PHÍ BÁN HÀNG</div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">Nội dung</th>
                            <th style="width: 50%;">Diễn giải chi tiết</th>
                            <th style="width: 25%;" class="text-right">Tổng giá trị quy đổi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="label">Giảm giá tiền mặt</td>
                            <td id="print-discount-details"></td>
                            <td class="text-right" id="print-discount-amount"></td>
                        </tr>
                        <tr>
                            <td class="label">Quà tặng</td>
                            <td id="print-gift-details"></td>
                            <td class="text-right" id="print-gift-amount"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="label">Tổng chi phí (B):</td>
                            <td class="text-right total" id="print-total-cost"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">IV. GIÁ TRỊ HỢP ĐỒNG SAU ƯU ĐÃI</div>
                <table>
                    <tr>
                        <td class="label" style="width: 70%;">(A) - (B):</td>
                        <td class="text-right total" id="print-final-price"></td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">V. PHÂN BỔ CHI PHÍ BÁN HÀNG</div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30%;">Nội dung</th>
                            <th style="width: 20%;" class="text-right">Mức chi phí giảm tối đa (%)</th>
                            <th style="width: 20%;" class="text-right">Chi phí bán hàng (VNĐ)</th>
                            <th style="width: 15%;" class="text-right">Tỷ lệ (%)</th>
                            <th style="width: 15%;" class="text-right">Lương năng suất (VNĐ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="label">Chi phí bán hàng</td>
                            <td class="text-right" id="print-max-cost-rate"></td>
                            <td class="text-right" id="print-sales-cost"></td>
                            <td class="text-right" id="print-cost-percentage"></td>
                            <td class="text-right" id="print-productivity-bonus"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">VI. YÊU CẦU KHÁC</div>
                <table>
                    <tr>
                        <td style="width: 30%;" class="label">Nội dung:</td>
                        <td id="print-other-requirements"></td>
                    </tr>
                    <tr>
                        <td class="label">Người thực hiện:</td>
                        <td id="print-requester"></td>
                    </tr>
                </table>
            </div>
            
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-box-title">Ban Giám đốc</div>
                </div>
                <div class="signature-box">
                    <div class="signature-box-title">Kiểm soát</div>
                </div>
                <div class="signature-box">
                    <div class="signature-box-title">Kế toán</div>
                </div>
                <div class="signature-box">
                    <div class="signature-box-title">Phòng Kinh doanh</div>
                </div>
            </div>
        </body>
        </html>
    `);
    
    // Load data and fill template
    callAPI({
        action: 'get_request_detail',
        id,
        username: session.username
    }).then(res => {
        if (res.success && res.data) {
            const d = res.data;
            
            // Header
            printWindow.document.getElementById('print-contract-code').textContent = d.contract_code || '';
            
            // I. THÔNG TIN KHÁCH HÀNG
            printWindow.document.getElementById('print-customer').textContent = d.customer || '';
            printWindow.document.getElementById('print-address').textContent = d.address || '';
            printWindow.document.getElementById('print-cccd').textContent = d.cccd || '';
            printWindow.document.getElementById('print-phone').textContent = d.phone || '';
            printWindow.document.getElementById('print-email').textContent = d.email || '';
            
            // II. THÔNG TIN XE
            const carModelFull = (d.car_model || '') + (d.car_version ? ' ' + d.car_version : '');
            printWindow.document.getElementById('print-car-model').textContent = carModelFull;
            printWindow.document.getElementById('print-car-color').textContent = d.car_color || '';
            printWindow.document.getElementById('print-vin').textContent = d.vin_no || '';
            const contractPrice = (d.contract_price || '').replace(/[^\d]/g, '');
            printWindow.document.getElementById('print-contract-price').textContent = contractPrice ? Number(contractPrice).toLocaleString('vi-VN') : '0';
            printWindow.document.getElementById('print-total-contract').textContent = contractPrice ? Number(contractPrice).toLocaleString('vi-VN') : '0';
            
            // III. CHI PHÍ BÁN HÀNG
            printWindow.document.getElementById('print-discount-details').textContent = d.discount_details || '';
            const discountAmount = (d.discount_amount || '').replace(/[^\d]/g, '');
            printWindow.document.getElementById('print-discount-amount').textContent = discountAmount ? Number(discountAmount).toLocaleString('vi-VN') : '0';
            
            // Quà tặng - format từ gift_details
            const giftDetails = d.gift_details || '';
            printWindow.document.getElementById('print-gift-details').textContent = giftDetails || 'Không có';
            const giftAmount = (d.gift_amount || '').replace(/[^\d]/g, '');
            printWindow.document.getElementById('print-gift-amount').textContent = giftAmount ? Number(giftAmount).toLocaleString('vi-VN') : '0';
            
            // Tổng chi phí (B) = Giảm giá + Quà tặng
            const totalCost = (parseInt(discountAmount) || 0) + (parseInt(giftAmount) || 0);
            printWindow.document.getElementById('print-total-cost').textContent = totalCost.toLocaleString('vi-VN');
            
            // IV. GIÁ TRỊ HỢP ĐỒNG SAU ƯU ĐÃI
            const finalPrice = (d.final_price || '').replace(/[^\d]/g, '');
            printWindow.document.getElementById('print-final-price').textContent = finalPrice ? Number(finalPrice).toLocaleString('vi-VN') : '0';
            
            // V. PHÂN BỔ CHI PHÍ BÁN HÀNG
            const maxCostRate = d.max_cost_rate || '';
            const salesCost = totalCost; // Chi phí bán hàng = Tổng chi phí (B)
            const contractPriceNum = parseInt(contractPrice) || 0;
            const costPercentage = contractPriceNum > 0 ? ((salesCost / contractPriceNum) * 100).toFixed(2) : '0.00';
            const productivityBonus = (d.productivity_bonus || '').replace(/[^\d]/g, '');
            
            printWindow.document.getElementById('print-max-cost-rate').textContent = maxCostRate ? maxCostRate + '%' : '';
            printWindow.document.getElementById('print-sales-cost').textContent = salesCost.toLocaleString('vi-VN');
            printWindow.document.getElementById('print-cost-percentage').textContent = costPercentage + '%';
            printWindow.document.getElementById('print-productivity-bonus').textContent = productivityBonus ? Number(productivityBonus).toLocaleString('vi-VN') : '';
            
            // VI. YÊU CẦU KHÁC
            printWindow.document.getElementById('print-other-requirements').textContent = d.other_requirements || '';
            printWindow.document.getElementById('print-requester').textContent = d.requester || '';
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        } else {
            printWindow.close();
            Swal.fire('Lỗi', res.message || 'Không thể tải dữ liệu để in', 'error');
        }
    }).catch(error => {
        printWindow.close();
        Swal.fire('Lỗi', error.message || 'Không thể kết nối đến server', 'error');
    });
}

// ===================================
// PROFILE MANAGEMENT
// ===================================

async function loadProfile() {
    const form = $('form-profile');
    if (!form) return;
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        return;
    }

    const statusEl = $('profile-status');
    statusEl.textContent = 'Đang tải...';
    form.classList.add('opacity-70');

    try {
        const res = await callAPI({ action: 'get_profile', username: session.username });
        if (res.success && res.profile) {
            const profile = res.profile;
            $('profile_username').value = profile.username || '';
            $('profile_role').value = profile.role || '';
            $('profile_fullname').value = profile.fullname || '';
            $('profile_email').value = profile.email || '';
            $('profile_phone').value = profile.phone || '';
            $('profile_group').value = profile.group || '';
            statusEl.textContent = 'Đã tải dữ liệu.';
        } else {
            statusEl.textContent = res.message || 'Không thể tải hồ sơ.';
        }
    } catch (error) {
        console.error(error);
        statusEl.textContent = 'Lỗi kết nối.';
    } finally {
        form.classList.remove('opacity-70');
    }
}

async function handleProfileUpdate(e) {
    e.preventDefault();
    const session = getSession();
    if (!session) {
        Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn', 'error');
        return;
    }

    const statusEl = $('profile-status');
    statusEl.textContent = 'Đang lưu...';

    try {
        const res = await callAPI({
            action: 'update_profile',
            username: session.username,
            fullname: $('profile_fullname').value,
            email: $('profile_email').value,
            phone: $('profile_phone').value,
            group: $('profile_group').value
        });
        if (res.success) {
            statusEl.textContent = res.message || 'Đã lưu thay đổi.';
            const stored = getSession() || {};
            stored.fullname = $('profile_fullname').value;
            stored.email = $('profile_email').value;
            stored.phone = $('profile_phone').value;
            stored.group = $('profile_group').value;
            localStorage.setItem('user_session', JSON.stringify(stored));
            $('user-fullname').textContent = stored.fullname || 'User';
        } else {
            statusEl.textContent = res.message || 'Lưu thất bại.';
        }
    } catch (error) {
        console.error(error);
        statusEl.textContent = 'Lỗi kết nối.';
    }
}

// ===================================
// USER MANAGEMENT (ADMIN)
// ===================================

async function loadUserManagement() {
    const container = $('user-list-container');
    if (!container) return;
    const session = getSession();
    if (!session || session.role !== 'ADMIN') {
        container.innerHTML = '<div class="text-center text-red-500 py-6">Chỉ ADMIN mới được truy cập chức năng này.</div>';
        return;
    }

    container.innerHTML = '<div class="text-center text-gray-500 py-6"><i class="fa-solid fa-spinner fa-spin text-xl mb-2"></i><p>Đang tải danh sách...</p></div>';

    try {
        const res = await callAPI({ action: 'list_users', username: session.username, role: session.role });
        if (res.success) {
            cachedUsers = res.users || [];
            container.innerHTML = renderUserTable(cachedUsers);
        } else {
            container.innerHTML = `<div class="text-center text-red-500 py-6">${res.message || 'Không thể tải danh sách người dùng.'}</div>`;
        }
    } catch (error) {
        console.error(error);
        container.innerHTML = '<div class="text-center text-red-500 py-6">Lỗi kết nối đến server.</div>';
    }
}

function renderUserTable(users) {
    if (!users.length) {
        return '<div class="text-center text-gray-500 py-6">Chưa có người dùng nào.</div>';
    }

    let rows = users.map(user => {
        const encoded = encodeURIComponent(user.username);
        return `
            <tr class="border-b hover:bg-gray-50 text-sm">
                <td class="py-2 px-3 font-mono">${user.username}</td>
                <td class="py-2 px-3">${user.fullname || ''}</td>
                <td class="py-2 px-3 font-bold">${user.role || ''}</td>
                <td class="py-2 px-3">${user.email || ''}</td>
                <td class="py-2 px-3">${user.phone || ''}</td>
                <td class="py-2 px-3">${user.group || ''}</td>
                <td class="py-2 px-3">
                    <span class="px-2 py-1 text-xs rounded ${user.active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}">
                        ${user.active ? 'Đang hoạt động' : 'Bị khóa'}
                    </span>
                </td>
                <td class="py-2 px-3 space-x-2">
                    <button onclick="openEditUserModal('${encoded}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold">Sửa</button>
                    <button onclick="resetUserPasswordPrompt('${encoded}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Reset MK</button>
                </td>
            </tr>
        `;
    }).join('');

    return `
        <div class="overflow-x-auto">
            <table class="min-w-full text-left">
                <thead class="bg-gray-100 text-xs uppercase text-gray-500">
                    <tr>
                        <th class="py-2 px-3">Username</th>
                        <th class="py-2 px-3">Họ tên</th>
                        <th class="py-2 px-3">Vai trò</th>
                        <th class="py-2 px-3">Email</th>
                        <th class="py-2 px-3">SĐT</th>
                        <th class="py-2 px-3">Nhóm</th>
                        <th class="py-2 px-3">Trạng thái</th>
                        <th class="py-2 px-3">Hành động</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}

async function handleCreateUser(e) {
    e.preventDefault();
    const session = getSession();
    if (!session || session.role !== 'ADMIN') {
        Swal.fire('Lỗi', 'Bạn không có quyền thực hiện thao tác này', 'error');
        return;
    }
    const form = e.target;
    const statusEl = $('create-user-status');
    statusEl.textContent = 'Đang tạo người dùng...';

    const payload = {
        action: 'create_user',
        username: session.username,
        role: session.role,
        new_username: form.new_username.value.trim(),
        new_fullname: form.new_fullname.value.trim(),
        new_role: form.new_role.value.trim(),
        new_group: form.new_group.value.trim(),
        new_email: form.new_email.value.trim(),
        new_phone: form.new_phone.value.trim(),
        new_password: form.new_password.value.trim()
    };

    try {
        const res = await callAPI(payload);
        if (res.success) {
            statusEl.textContent = res.message || 'Đã tạo người dùng.';
            form.reset();
            loadUserManagement();
        } else {
            statusEl.textContent = res.message || 'Không thể tạo người dùng.';
        }
    } catch (error) {
        console.error(error);
        statusEl.textContent = 'Lỗi kết nối.';
    }
}

async function openEditUserModal(encodedUsername) {
    const username = decodeURIComponent(encodedUsername);
    const target = cachedUsers.find(u => u.username === username);
    if (!target) {
        Swal.fire('Lỗi', 'Không tìm thấy người dùng', 'error');
        return;
    }

    const { value: formValues } = await Swal.fire({
        title: `Chỉnh sửa: ${username}`,
        html: `
            <div class="text-left space-y-3">
                <div>
                    <label class="text-xs font-semibold text-gray-500">Họ tên</label>
                    <input id="swal-fullname" class="swal2-input" value="${target.fullname || ''}">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-500">Vai trò</label>
                    <select id="swal-role" class="swal2-input">
                        ${['TVBH','TPKD','GDKD','BKS','BGD','KETOAN','ADMIN'].map(role => `<option value="${role}" ${target.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-500">Nhóm</label>
                    <input id="swal-group" class="swal2-input" value="${target.group || ''}">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-500">Email</label>
                    <input id="swal-email" class="swal2-input" value="${target.email || ''}">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-500">Số điện thoại</label>
                    <input id="swal-phone" class="swal2-input" value="${target.phone || ''}">
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="swal-active" ${target.active ? 'checked' : ''}>
                    <label for="swal-active">Đang hoạt động</label>
                </div>
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Lưu',
        cancelButtonText: 'Hủy',
        preConfirm: () => {
            return {
                fullname: document.getElementById('swal-fullname').value.trim(),
                role: document.getElementById('swal-role').value,
                group: document.getElementById('swal-group').value.trim(),
                email: document.getElementById('swal-email').value.trim(),
                phone: document.getElementById('swal-phone').value.trim(),
                active: document.getElementById('swal-active').checked
            };
        }
    });

    if (!formValues) return;

    const session = getSession();
    try {
        const res = await callAPI({
            action: 'update_user',
            username: session.username,
            role: session.role,
            target_username: username,
            fullname: formValues.fullname,
            user_role: formValues.role,
            group: formValues.group,
            email: formValues.email,
            phone: formValues.phone,
            active: formValues.active
        });
        if (res.success) {
            Swal.fire('Thành công', res.message || 'Đã cập nhật người dùng', 'success');
            loadUserManagement();
        } else {
            Swal.fire('Lỗi', res.message || 'Không thể cập nhật người dùng', 'error');
        }
    } catch (error) {
        console.error(error);
        Swal.fire('Lỗi', 'Không thể kết nối đến server', 'error');
    }
}

async function resetUserPasswordPrompt(encodedUsername) {
    const username = decodeURIComponent(encodedUsername);
    const session = getSession();
    if (!session || session.role !== 'ADMIN') {
        Swal.fire('Lỗi', 'Bạn không có quyền thực hiện thao tác này', 'error');
        return;
    }

    const { value: newPass } = await Swal.fire({
        title: `Reset mật khẩu cho ${username}`,
        input: 'text',
        inputLabel: 'Nhập mật khẩu mới (để trống = 123456)',
        showCancelButton: true,
        confirmButtonText: 'Reset',
        cancelButtonText: 'Hủy'
    });

    if (newPass === undefined) return;

    try {
        const res = await callAPI({
            action: 'reset_user_password',
            username: session.username,
            role: session.role,
            target_username: username,
            new_password: newPass
        });
        if (res.success) {
            Swal.fire('Thành công', res.message || 'Đã reset mật khẩu', 'success');
        } else {
            Swal.fire('Lỗi', res.message || 'Không thể reset mật khẩu', 'error');
        }
    } catch (error) {
        console.error(error);
        Swal.fire('Lỗi', 'Không thể kết nối đến server', 'error');
    }
}

// ===================================
// API CALLER
// ===================================
        async function callAPI(data) {
            try {
        console.log('Calling API:', data.action, data);
        
        // Sử dụng FormData để tránh CORS preflight request
        // Google Apps Script Web App xử lý FormData tốt hơn JSON và không trigger preflight
        const formData = new FormData();
        Object.keys(data).forEach(key => {
            const value = data[key];
            if (value !== null && value !== undefined) {
                formData.append(key, typeof value === 'object' ? JSON.stringify(value) : String(value));
            }
        });
        
        const res = await fetch(API_URL, {
            method: 'POST',
            mode: 'cors', // Giữ cors mode
            body: formData
            // Không set Content-Type header để browser tự set với boundary cho FormData
            // Điều này giúp tránh preflight request
        });
        
        console.log('API Response status:', res.status, res.statusText);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('API Error Response:', errorText);
            throw new Error(`HTTP error! status: ${res.status} - ${errorText}`);
        }
        
        const responseText = await res.text();
        console.log('API Response text:', responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            console.error('JSON Parse Error:', parseError, 'Response:', responseText);
            throw new Error('Invalid JSON response from server');
        }
        
        console.log('API Result:', result);
        return result;
    } catch (e) {
        console.error('API call error:', e);
        return { 
            success: false, 
            message: e.message || 'Lỗi kết nối đến server. Vui lòng kiểm tra kết nối mạng.' 
        };
    }
}

// ===================================
// CSS HELPER
// ===================================
(function() {
    if (!document.getElementById('app-dynamic-styles')) {
        const style = document.createElement('style');
        style.id = 'app-dynamic-styles';
        style.innerHTML = `
            .label { 
                display: block; 
                font-size: 0.875rem; 
                font-weight: 700; 
                color: #374151; 
                margin-bottom: 0.25rem; 
            }
            .input { 
                width: 100%; 
                border: 1px solid #d1d5db; 
                padding: 0.5rem; 
                border-radius: 0.5rem; 
                outline: none; 
            }
            .input:focus { 
                border-color: #2563eb; 
                box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); 
            }
        `;
        document.head.appendChild(style);
    }
})();
    </script>
</body>
</html>
