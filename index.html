<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√™ Duy·ªát Gi√°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/client-side-templates.js"></script>
    <script src="https://unpkg.com/mustache@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Hi·ªáu ·ª©ng Loading cho HTMX */
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; pointer-events: none; }
        .htmx-request .htmx-indicator { opacity: 1; pointer-events: auto; }
        .htmx-request.htmx-indicator { opacity: 1; pointer-events: auto; }
        
        /* ·∫®n hi·ªán Tab */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar active state */
        .nav-item.active { background-color: #1e40af; border-left: 4px solid #60a5fa; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden" hx-ext="client-side-templates">

    <div id="login-view" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fa-solid fa-car text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Duy·ªát Gi√° Xe</h2>
                <p class="text-gray-500 text-sm">H·ªá th·ªëng qu·∫£n tr·ªã n·ªôi b·ªô</p>
            </div>

            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500"><i class="fa-solid fa-user"></i></span>
                        <input type="text" id="login-user" class="w-full pl-10 pr-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Username" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="login-pass" class="w-full pl-10 pr-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-700 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition shadow-md">
                    ƒêƒÉng Nh·∫≠p
                </button>
            </form>
        </div>
    </div>

    <div id="dashboard-view" class="flex h-full hidden">
        
        <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold tracking-wider">MY AUTO</h1>
                <p class="text-xs text-slate-400 mt-1">Xin ch√†o, <span id="user-fullname" class="font-bold text-white">User</span></p>
                <span id="user-role" class="text-[10px] bg-blue-600 px-2 py-0.5 rounded mt-2 inline-block">ROLE</span>
            </div>

            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="switchTab('create')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center group active" id="nav-create">
                    <i class="fa-solid fa-plus-circle w-6 text-gray-400 group-hover:text-white"></i>
                    <span>T·∫°o T·ªù Tr√¨nh</span>
                </button>
                
                <button onclick="switchTab('approval')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center group" id="nav-approval">
                    <i class="fa-solid fa-list-check w-6 text-gray-400 group-hover:text-white"></i>
                    <span>Duy·ªát ƒê∆°n</span>
                    <span class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full" id="badge-count">!</span>
                </button>

                <button onclick="switchTab('history')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center group" id="nav-history">
                    <i class="fa-solid fa-clock-rotate-left w-6 text-gray-400 group-hover:text-white"></i>
                    <span>L·ªãch s·ª≠</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-600 text-white py-2 rounded transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 relative overflow-hidden">
            
            <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
                <h1 class="font-bold text-gray-800">Duy·ªát Gi√° Xe</h1>
                <button onclick="logout()" class="text-red-600"><i class="fa-solid fa-power-off"></i></button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                
                <div id="tab-create" class="tab-content active max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-blue-800">üìù T·∫°o Y√™u C·∫ßu M·ªõi</h2>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-6 relative">
                                <label class="block text-gray-700 text-sm font-bold mb-2">1. Nh·∫≠p M√£ ƒê∆°n H√†ng / H·ª£p ƒê·ªìng</label>
                                <div class="flex gap-2">
                                    <input type="text" 
                                           id="search_code_input"
                                           class="flex-1 border-2 border-gray-300 p-3 rounded-lg focus:border-blue-500 outline-none uppercase font-mono font-bold text-gray-700"
                                           placeholder="VD: S10601-25-0663"
                                           
                                           hx-post="" 
                                           hx-trigger="change" 
                                           hx-vals='{"action": "lookup_contract"}'
                                           hx-target="#search-result"
                                           mustache-template="tpl-lookup-result"
                                           hx-indicator="#loading-lookup">
                                    
                                    <div id="loading-lookup" class="htmx-indicator flex items-center justify-center px-4">
                                        <i class="fa-solid fa-spinner fa-spin text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">* Nh·∫•n Enter ho·∫∑c click ra ngo√†i ƒë·ªÉ t√¨m ki·∫øm</p>
                            </div>

                            <form id="form-create-request" onsubmit="handleSubmitRequest(event)">
                                <div id="search-result">
                                    <div class="text-center py-10 text-gray-400 border-2 border-dashed rounded-lg bg-gray-50">
                                        <i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-30"></i>
                                        <p>Vui l√≤ng nh·∫≠p m√£ ƒë·ªÉ t·∫£i d·ªØ li·ªáu kh√°ch h√†ng</p>
                                    </div>
                                </div>

                                <div id="action-area" class="mt-8 hidden">
                                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-4 rounded-lg hover:bg-green-700 shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-paper-plane"></i> G·ª≠i Duy·ªát Gi√°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="tab-approval" class="tab-content max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Danh s√°ch c·∫ßn duy·ªát</h2>
                        <button onclick="loadApprovalList()" class="bg-white border text-gray-600 px-3 py-1 rounded hover:bg-gray-50 text-sm">
                            <i class="fa-solid fa-sync"></i> L√†m m·ªõi
                        </button>
                    </div>

                    <div id="approval-list-container" class="space-y-4">
                        <div class="text-center py-10 text-gray-400">ƒêang t·∫£i danh s√°ch...</div>
                    </div>
                </div>

                <div id="tab-history" class="tab-content">
                     <div class="bg-white p-10 rounded-xl shadow text-center">
                         <i class="fa-solid fa-person-digging text-4xl text-yellow-500 mb-4"></i>
                         <h3 class="text-lg font-bold text-gray-700">T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn</h3>
                         <p class="text-gray-500">Vui l√≤ng quay l·∫°i sau.</p>
                     </div>
                </div>

            </div>

            <div class="bg-white border-t flex justify-around p-2 md:hidden">
                <button onclick="switchTab('create')" class="flex flex-col items-center p-2 text-blue-600 nav-mobile-item active" id="mob-create">
                    <i class="fa-solid fa-plus-circle text-xl"></i> <span class="text-[10px]">T·∫°o</span>
                </button>
                <button onclick="switchTab('approval')" class="flex flex-col items-center p-2 text-gray-400 nav-mobile-item" id="mob-approval">
                    <i class="fa-solid fa-list-check text-xl"></i> <span class="text-[10px]">Duy·ªát</span>
                </button>
                <button onclick="switchTab('history')" class="flex flex-col items-center p-2 text-gray-400 nav-mobile-item" id="mob-history">
                    <i class="fa-solid fa-clock text-xl"></i> <span class="text-[10px]">L·ªãch s·ª≠</span>
                </button>
            </div>

        </main>
    </div>

    <template id="tpl-lookup-result">
        {{#success}}
            <div class="animate-fade-in-down">
                <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6 flex items-center">
                    <i class="fa-solid fa-check-circle mr-2 text-xl"></i>
                    <div>
                        <p class="font-bold text-sm">ƒê√£ t√¨m th·∫•y d·ªØ li·ªáu</p>
                        <p class="text-xs">{{data.name}} - {{data.phone}}</p>
                    </div>
                </div>
                
                <input type="hidden" name="customer_name" value="{{data.name}}">
                <input type="hidden" name="contract_code" value="{{data.contractCode}}"> <input type="hidden" name="phone" value="{{data.phone}}">
                <input type="hidden" name="cccd" value="{{data.cccd}}">
                <input type="hidden" name="address" value="{{data.address}}">
                <input type="hidden" name="car_model" value="{{data.carModel}}">
                <input type="hidden" name="vin_no" value=""> 

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Kh√°ch h√†ng</label>
                        <div class="p-2 bg-gray-100 rounded border border-gray-200 text-gray-800 font-medium">
                            {{data.name}}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">D√≤ng Xe / Phi√™n b·∫£n</label>
                        <div class="p-2 bg-blue-50 rounded border border-blue-200 text-blue-800 font-bold">
                            {{data.carModel}} - {{data.carVersion}}
                        </div>
                    </div>
                </div>

                <div class="space-y-4 border-t pt-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Gi√° tr·ªã h·ª£p ƒë·ªìng (VNƒê) <span class="text-red-500">*</span></label>
                        <input name="contract_price" type="text" class="w-full border-2 border-yellow-400 p-3 rounded-lg focus:ring-2 focus:ring-yellow-200 outline-none font-medium" placeholder="VD: 500,000,000" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Chi ti·∫øt gi·∫£m gi√°</label>
                        <textarea name="discount_details" rows="2" class="w-full border border-gray-300 p-2 rounded-lg focus:border-blue-500 outline-none" placeholder="VD: Gi·∫£m ti·ªÅn m·∫∑t, Voucher..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="text-xs font-bold text-gray-500">Ti·ªÅn gi·∫£m gi√°</label>
                            <input name="discount_amount" type="number" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="0">
                         </div>
                         <div>
                            <label class="text-xs font-bold text-gray-500">Ti·ªÅn qu√† t·∫∑ng</label>
                            <input name="gift_amount" type="number" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="0">
                         </div>
                    </div>
                </div>

                <script> document.getElementById('action-area').classList.remove('hidden'); </script>
            </div>
        {{/success}}

        {{^success}}
            <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg text-center animate-bounce-short">
                <i class="fa-solid fa-triangle-exclamation text-2xl mb-2"></i>
                <p class="font-bold">Kh√¥ng t√¨m th·∫•y!</p>
                <p class="text-sm">{{message}}</p>
                <script> document.getElementById('action-area').classList.add('hidden'); </script>
            </div>
        {{/success}}
    </template>

    <template id="tpl-pending-list">
        {{#data}}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 relative overflow-hidden transition hover:shadow-md" id="card-{{id}}">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
            
            <div class="flex justify-between items-start mb-2 pl-3">
                <div>
                    <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">{{contract_code}}</span>
                    <h3 class="font-bold text-gray-800 text-lg mt-1">{{customer}}</h3>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-400 block">{{date}}</span>
                    <span class="text-xs font-bold text-gray-600 bg-gray-100 px-2 py-0.5 rounded">{{status_text}}</span>
                </div>
            </div>

            <div class="pl-3 grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                <p><i class="fa-solid fa-car mr-1 opacity-50"></i> {{car_model}}</p>
                <p><i class="fa-solid fa-user-tie mr-1 opacity-50"></i> {{requester}}</p>
                <p class="col-span-2 font-medium text-gray-800 border-t pt-2 mt-1 flex justify-between">
                    <span>Gi√° ch·ªët:</span> 
                    <span class="text-blue-600 font-bold text-base">{{final_price}}</span>
                </p>
            </div>

            {{#logs}}
            <div class="pl-3 mb-4">
                 <details class="text-xs text-gray-500">
                     <summary class="cursor-pointer hover:text-blue-600">Xem l·ªãch s·ª≠ duy·ªát</summary>
                     <div class="mt-1 p-2 bg-gray-50 rounded whitespace-pre-line border border-gray-100">{{logs}}</div>
                 </details>
            </div>
            {{/logs}}

            <div class="pl-3 flex gap-2">
                <button onclick="confirmAction('{{id}}', 'approve')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg font-bold text-sm transition flex items-center justify-center gap-1">
                    <i class="fa-solid fa-check"></i> Duy·ªát
                </button>
                <button onclick="confirmAction('{{id}}', 'reject')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 py-2.5 rounded-lg font-bold text-sm transition flex items-center justify-center gap-1">
                    <i class="fa-solid fa-xmark"></i> T·ª´ ch·ªëi
                </button>
            </div>
        </div>
        {{/data}}

        {{^data}}
        <div class="text-center py-12 text-gray-400">
            <i class="fa-regular fa-folder-open text-4xl mb-2 opacity-30"></i>
            <p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o c·∫ßn x·ª≠ l√Ω.</p>
        </div>
        {{/data}}
    </template>

    <script>
        // ==========================================================
// C·∫§U H√åNH H·ªÜ TH·ªêNG
// ==========================================================
// ‚ö†Ô∏è Thay URL n√†y b·∫±ng Web App URL b·∫°n copy t·ª´ Apps Script (Deploy > Anyone)
const API_URL = "https://script.google.com/macros/s/AKfycbwTyybDq0fVwdJz0IdCM-t1uLc3EKhclv58q9ey9kiKtUd4NMvpDR-ptWbH2b34bwkR/exec";

// ==========================================================
// 1. QU·∫¢N L√ù SESSION & INIT
// ==========================================================

document.addEventListener('DOMContentLoaded', () => {
    // 1. Setup HTMX cho √¥ t√¨m ki·∫øm
    const searchInput = document.getElementById('search_code_input');
    if (searchInput) {
        searchInput.setAttribute('hx-post', API_URL);
        htmx.process(searchInput);
    }

    // 2. Check Login
    checkSession();
});

// H√†m ki·ªÉm tra xem user ƒë√£ login ch∆∞a
function checkSession() {
    const session = localStorage.getItem('user_session');
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    
    if (session) {
        const user = JSON.parse(session);
        // Hi·ªÉn th·ªã th√¥ng tin user l√™n Sidebar
        document.getElementById('user-fullname').textContent = user.fullname;
        document.getElementById('user-role').textContent = user.role;
        
        // Logic hi·ªÉn th·ªã menu theo Role
        if(user.role === 'SALE' || user.role === 'TVBH') {
            document.getElementById('nav-approval').classList.add('hidden'); // Sale kh√¥ng c·∫ßn n√∫t Duy·ªát
            if(document.getElementById('mob-approval')) document.getElementById('mob-approval').classList.add('hidden');
        } else {
            // S·∫øp th√¨ v√†o th·∫≥ng tab duy·ªát
            switchTab('approval');
        }

        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        dashboardView.classList.add('flex'); // Quan tr·ªçng ƒë·ªÉ flex layout ho·∫°t ƒë·ªông
    } else {
        loginView.classList.remove('hidden');
        dashboardView.classList.add('hidden');
        dashboardView.classList.remove('flex');
    }
}

// ==========================================================
// 2. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T
// ==========================================================

async function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-login');
    const userInp = document.getElementById('login-user');
    const passInp = document.getElementById('login-pass');

    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
    btn.disabled = true;

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "login",
                username: userInp.value,
                password: passInp.value
            })
        });
        const result = await response.json();

        if (result.success) {
            localStorage.setItem('user_session', JSON.stringify(result.user));
            Swal.fire({
                icon: 'success',
                title: 'Xin ch√†o ' + result.user.fullname,
                toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
            });
            checkSession();
        } else {
            Swal.fire('L·ªói', result.message, 'error');
        }
    } catch (err) {
        Swal.fire('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ g·ªçi t·ªõi Server GAS', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function logout() {
    Swal.fire({
        title: 'ƒêƒÉng xu·∫•t?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ƒê·ªìng √Ω',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem('user_session');
            location.reload();
        }
    });
}

// ==========================================================
// 3. ƒêI·ªÄU H∆Ø·ªöNG TAB
// ==========================================================

function switchTab(tabId) {
    // 1. ·∫®n t·∫•t c·∫£ n·ªôi dung tab
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    // 2. B·ªè active style ·ªü Sidebar buttons
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    // 3. B·ªè active style ·ªü Mobile buttons
    document.querySelectorAll('.nav-mobile-item').forEach(el => {
        el.classList.remove('active', 'text-blue-600');
        el.classList.add('text-gray-400');
    });

    // 4. Active tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById('tab-' + tabId).classList.add('active');
    
    // 5. Active button t∆∞∆°ng ·ª©ng
    const navBtn = document.getElementById('nav-' + tabId);
    if(navBtn) navBtn.classList.add('active');

    const mobBtn = document.getElementById('mob-' + tabId);
    if(mobBtn) {
        mobBtn.classList.remove('text-gray-400');
        mobBtn.classList.add('active', 'text-blue-600');
    }

    // Logic ri√™ng cho t·ª´ng tab
    if (tabId === 'approval') {
        loadApprovalList();
    }
}

// ==========================================================
// 4. LOGIC: T·∫†O Y√äU C·∫¶U (SUBMIT FORM)
// ==========================================================

async function handleSubmitRequest(e) {
    e.preventDefault();
    
    // L·∫•y Session
    const session = JSON.parse(localStorage.getItem('user_session'));
    const formData = new FormData(document.getElementById('form-create-request'));
    const data = Object.fromEntries(formData.entries());
    
    // D·ªØ li·ªáu b·ªï sung
    const payload = {
        action: "submit_request",
        requester: session.username,
        contract_code: document.getElementById('search_code_input').value, // L·∫•y t·ª´ √¥ search
        ...data
    };

    // UI Loading
    const btn = document.querySelector('#action-area button');
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang g·ª≠i...';
    btn.disabled = true;

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.success) {
            Swal.fire('Th√†nh c√¥ng', result.message, 'success');
            // Reset form
            document.getElementById('form-create-request').reset();
            document.getElementById('search-result').innerHTML = '<div class="text-center py-10 text-gray-400 border-2 border-dashed rounded-lg bg-gray-50"><p>ƒê√£ g·ª≠i xong. Nh·∫≠p m√£ m·ªõi ƒë·ªÉ ti·∫øp t·ª•c.</p></div>';
            document.getElementById('search_code_input').value = '';
            document.getElementById('action-area').classList.add('hidden');
        } else {
            Swal.fire('Th·∫•t b·∫°i', result.message, 'error');
        }
    } catch (err) {
        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server', 'error');
    } finally {
        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> G·ª≠i Duy·ªát Gi√°';
        btn.disabled = false;
    }
}

// ==========================================================
// 5. LOGIC: DUY·ªÜT ƒê∆†N (APPROVAL LIST)
// ==========================================================

async function loadApprovalList() {
    const session = JSON.parse(localStorage.getItem('user_session'));
    const container = document.getElementById('approval-list-container');
    
    container.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl"></i></div>';

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "get_pending_list",
                username: session.username,
                role: session.role
            })
        });
        const result = await response.json();

        if (result.success) {
            // Render b·∫±ng Mustache th·ªß c√¥ng (v√¨ h√†m n√†y g·ªçi b·∫±ng JS thu·∫ßn)
            const template = document.getElementById('tpl-pending-list').innerHTML;
            const rendered = Mustache.render(template, { data: result.data });
            container.innerHTML = rendered;
            
            // C·∫≠p nh·∫≠t Badge s·ªë l∆∞·ª£ng
            const count = result.data.length;
            const badge = document.getElementById('badge-count');
            if(badge) {
                badge.textContent = count > 0 ? count : '!';
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }

        } else {
            container.innerHTML = '<p class="text-red-500 text-center">L·ªói t·∫£i d·ªØ li·ªáu</p>';
        }
    } catch (err) {
        container.innerHTML = '<p class="text-red-500 text-center">L·ªói k·∫øt n·ªëi</p>';
    }
}

// X·ª≠ l√Ω n√∫t Duy·ªát / T·ª´ ch·ªëi
function confirmAction(id, decision) {
    const session = JSON.parse(localStorage.getItem('user_session'));
    const actionText = decision === 'approve' ? 'Duy·ªát' : 'T·ª´ ch·ªëi';
    const actionColor = decision === 'approve' ? '#16a34a' : '#dc2626';

    Swal.fire({
        title: `X√°c nh·∫≠n ${actionText}?`,
        input: 'text',
        inputPlaceholder: 'Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)...',
        showCancelButton: true,
        confirmButtonText: actionText,
        confirmButtonColor: actionColor,
        cancelButtonText: 'H·ªßy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            // G·ªçi API
            const card = document.getElementById(`card-${id}`);
            card.style.opacity = '0.5';
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "approve_reject",
                        id: id,
                        username: session.username,
                        role: session.role,
                        decision: decision,
                        comment: result.value
                    })
                });
                const apiRes = await response.json();
                
                if (apiRes.success) {
                    Swal.fire('ƒê√£ x·ª≠ l√Ω', apiRes.message, 'success');
                    // X√≥a card kh·ªèi danh s√°ch
                    card.remove();
                    // Load l·∫°i list ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                    loadApprovalList();
                } else {
                    Swal.fire('L·ªói', apiRes.message, 'error');
                    card.style.opacity = '1';
                }
            } catch (e) {
                Swal.fire('L·ªói', 'M·∫•t k·∫øt n·ªëi', 'error');
                card.style.opacity = '1';
            }
        }
    });
}




      
    </script>
</body>
</html>
