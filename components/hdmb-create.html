<div id="tab-hdmb-create" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-5xl mx-auto">
        <div class="bg-purple-50 px-4 py-3 md:px-6 md:py-4 border-b border-purple-100">
            <h2 class="text-base md:text-lg font-bold text-purple-800">
                <i class="fa-solid fa-file-contract mr-2"></i>Tạo Hợp Đồng Mua Bán (HĐMB)
            </h2>
        </div>
        <div class="p-3 md:p-6">
            <form id="form-hdmb-create" onsubmit="submitHDMBCreateForm(event)">
                <!-- Tìm kiếm đơn hàng (optional) -->
                <div class="mb-4 md:mb-6 bg-gray-50 p-3 md:p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xs md:text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-purple-600"></i>
                        Tìm kiếm đơn hàng (tùy chọn - để tự động điền thông tin)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <input 
                                type="text" 
                                id="hdmb-search-order" 
                                class="input text-sm md:text-base w-full" 
                                placeholder="Nhập mã hợp đồng hoặc tên khách hàng..."
                                onkeypress="if(event.key === 'Enter') searchOrderForHDMB(event)"
                            >
                        </div>
                        <div>
                            <button 
                                type="button" 
                                onclick="searchOrderForHDMB(event)" 
                                class="w-full bg-purple-600 text-white font-bold py-2.5 md:py-2 rounded-lg hover:bg-purple-700 active:bg-purple-800 transition touch-manipulation text-sm md:text-base"
                            >
                                <i class="fa-solid fa-search mr-2"></i>Tìm kiếm
                            </button>
                        </div>
                    </div>
                    <div id="hdmb-order-search-result" class="mt-3 hidden"></div>
                </div>

                <!-- Thông tin khách hàng -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">1. Thông tin Khách hàng</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Họ tên Khách hàng *</label>
                            <input name="khach_hang" id="hdmb-create-khach_hang" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Số CCCD</label>
                            <input name="so_cccd" id="hdmb-create-so_cccd" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Số điện thoại</label>
                            <input name="sdt" id="hdmb-create-sdt" type="tel" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Email</label>
                            <input name="email" id="hdmb-create-email" type="email" class="input text-sm md:text-base w-full">
                        </div>
                        <div class="md:col-span-2">
                            <label class="label text-xs md:text-sm mb-1 block">Địa chỉ</label>
                            <textarea name="dia_chi" id="hdmb-create-dia_chi" rows="2" class="input text-sm md:text-base w-full"></textarea>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Ngày cấp CCCD</label>
                            <input name="ngay_cap" id="hdmb-create-ngay_cap" type="date" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Nơi cấp CCCD</label>
                            <input name="noi_cap" id="hdmb-create-noi_cap" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Mã số thuế</label>
                            <input name="ma_so_thue" id="hdmb-create-ma_so_thue" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Người đại diện</label>
                            <input name="nguoi_dai_dien" id="hdmb-create-nguoi_dai_dien" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Chức vụ</label>
                            <input name="chuc_vu" id="hdmb-create-chuc_vu" class="input text-sm md:text-base w-full">
                        </div>
                    </div>
                </div>

                <!-- Thông tin hợp đồng -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">2. Thông tin Hợp đồng</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Số hợp đồng *</label>
                            <input name="so_hop_dong" id="hdmb-create-so_hop_dong" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Ngày ký *</label>
                            <input name="ngay_ky" id="hdmb-create-ngay_ky" type="date" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Loại xe</label>
                            <input name="loai_xe" id="hdmb-create-loai_xe" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Phiên bản</label>
                            <input name="phien_ban" id="hdmb-create-phien_ban" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Màu xe</label>
                            <input name="mau_xe" id="hdmb-create-mau_xe" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Số lượng</label>
                            <input name="so_luong" id="hdmb-create-so_luong" type="number" class="input text-sm md:text-base w-full" value="1" min="1" oninput="calculateHDMBCreateTotal()">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Đơn giá (VNĐ)</label>
                            <input name="don_gia" id="hdmb-create-don_gia" type="text" class="input text-sm md:text-base w-full" placeholder="0" oninput="if(window.formatMoneyInput)window.formatMoneyInput(this); calculateHDMBCreateTotal()">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Tổng tiền (VNĐ)</label>
                            <input name="tong_tien" id="hdmb-create-tong_tien" type="text" class="input text-sm md:text-base w-full bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Tiền cọc (VNĐ)</label>
                            <input name="tien_coc" id="hdmb-create-tien_coc" type="text" class="input text-sm md:text-base w-full" placeholder="0" oninput="if(window.formatMoneyInput)window.formatMoneyInput(this)">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Tiền đợt 2 (Trả thẳng) - VNĐ</label>
                            <input name="tien_dot_2_TT" id="hdmb-create-tien_dot_2_TT" type="text" class="input text-sm md:text-base w-full" placeholder="0" oninput="if(window.formatMoneyInput)window.formatMoneyInput(this)">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Tiền đợt 2 (Trả góp) - VNĐ</label>
                            <input name="tien_dot_2_TG" id="hdmb-create-tien_dot_2_TG" type="text" class="input text-sm md:text-base w-full" placeholder="0" oninput="if(window.formatMoneyInput)window.formatMoneyInput(this)">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Tiền đợt 3 - VNĐ</label>
                            <input name="tien_dot_3" id="hdmb-create-tien_dot_3" type="text" class="input text-sm md:text-base w-full" placeholder="0" oninput="if(window.formatMoneyInput)window.formatMoneyInput(this)">
                        </div>
                        <div class="md:col-span-2">
                            <label class="label text-xs md:text-sm mb-1 block">Chính sách bán hàng</label>
                            <div id="hdmb-create-policies-container" class="border border-gray-200 rounded-lg p-3 md:p-4 bg-gray-50 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500 text-sm">
                                    <i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tải chính sách...
                                </div>
                            </div>
                            <textarea name="chinh_sach_ban_hang" id="hdmb-create-chinh_sach_ban_hang" class="input mt-3 hidden" rows="2" placeholder="Chính sách đã chọn sẽ hiển thị ở đây..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button 
                        type="submit" 
                        class="flex-1 bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 shadow-lg transition transform active:scale-95"
                    >
                        <i class="fa-solid fa-file-contract mr-2"></i>Tạo HĐMB
                    </button>
                    <button 
                        type="button" 
                        onclick="resetHDMBCreateForm()" 
                        class="px-6 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition"
                    >
                        <i class="fa-solid fa-rotate-left mr-2"></i>Làm mới
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Load sales policies
async function loadSalesPoliciesForHDMBCreate() {
    const container = document.getElementById('hdmb-create-policies-container');
    if (!container) {
        setTimeout(loadSalesPoliciesForHDMBCreate, 500);
        return;
    }

    try {
        const result = await window.callAPI({
            action: 'get_active_sales_policies'
        });

        if (result && result.success && Array.isArray(result.data)) {
            renderHDMBCreatePoliciesCheckboxes(result.data);
        } else {
            container.innerHTML = `
                <div class="text-center py-4 text-red-500 text-sm">
                    <i class="fa-solid fa-exclamation-circle mr-2"></i>
                    ${result?.message || 'Không thể tải chính sách'}
                </div>
            `;
        }
    } catch (error) {
        console.error('[HDMB Create] Error loading policies:', error);
        container.innerHTML = `
            <div class="text-center py-4 text-red-500 text-sm">
                <i class="fa-solid fa-exclamation-circle mr-2"></i>
                Lỗi tải chính sách: ${error.message}
            </div>
        `;
    }
}

function renderHDMBCreatePoliciesCheckboxes(policies) {
    const container = document.getElementById('hdmb-create-policies-container');
    if (!container || !policies || policies.length === 0) {
        if (container) container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">Chưa có chính sách nào</div>';
        return;
    }

    let html = '<div class="space-y-2">';
    policies.forEach((policy) => {
        if (!policy || !policy.id) return;
        const policyId = 'hdmb-create-policy-' + policy.id;
        const policyName = (policy.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const policyDesc = (policy.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        html += '<div class="policy-item flex items-start gap-2 p-2 rounded hover:bg-purple-50 transition">';
        html += `<input type="checkbox" id="${policyId}" name="hdmb_create_policy" value="${policyDesc}" class="mt-1 w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" data-policy-name="${policyName}" onchange="updateHDMBCreatePoliciesText()">`;
        html += `<label for="${policyId}" class="flex-1 text-xs md:text-sm cursor-pointer"><span class="font-medium">${policyName}</span></label>`;
        html += '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateHDMBCreatePoliciesText() {
    const textarea = document.getElementById('hdmb-create-chinh_sach_ban_hang');
    if (!textarea) return;

    const checkboxes = document.querySelectorAll('#hdmb-create-policies-container input[type="checkbox"]:checked');
    const selectedPolicies = Array.from(checkboxes).map(cb => cb.value);
    textarea.value = selectedPolicies.join('\n');
}

// Search order for HDMB
async function searchOrderForHDMB(event) {
    if (event) {
        event.preventDefault();
    }
    
    console.log('[HDMB Create] searchOrderForHDMB called');
    const searchInput = document.getElementById('hdmb-search-order');
    if (!searchInput) {
        console.error('[HDMB Create] Search input not found');
        return;
    }
    
    const searchTerm = searchInput.value.trim();
    console.log('[HDMB Create] Search term:', searchTerm);
    
    if (!searchTerm) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng nhập mã hợp đồng hoặc tên khách hàng', 'warning');
        }
        return;
    }

    const resultDiv = document.getElementById('hdmb-order-search-result');
    if (resultDiv) {
        resultDiv.innerHTML = '<div class="text-center py-2"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tìm kiếm...</div>';
        resultDiv.classList.remove('hidden');
    }

    try {
        const session = JSON.parse(localStorage.getItem('user_session') || '{}');
        if (!session || !session.username) {
            if (typeof window.showToast === 'function') {
                window.showToast('Vui lòng đăng nhập lại', 'danger');
            }
            return;
        }

        console.log('[HDMB Create] Calling API get_my_orders...');
        const result = await window.callAPI({
            action: 'get_my_orders',
            username: session.username
        });

        console.log('[HDMB Create] API result:', result);
        
        if (result.success && result.data && Array.isArray(result.data)) {
            console.log('[HDMB Create] Found', result.data.length, 'orders');
            
            // Nếu không có đơn hàng nào
            if (result.data.length === 0) {
                console.log('[HDMB Create] No orders found for this user');
                if (resultDiv) {
                    resultDiv.className = 'mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-yellow-700">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Bạn chưa có đơn hàng nào. Vui lòng tạo đơn hàng trước hoặc nhập thông tin thủ công.
                        </p>
                    `;
                    resultDiv.classList.remove('hidden');
                }
                return;
            }
            
            const order = result.data.find(o => {
                const contractMatch = o.contract_code?.toLowerCase().includes(searchTerm.toLowerCase());
                const nameMatch = o.customers?.name?.toLowerCase().includes(searchTerm.toLowerCase());
                const cccdMatch = o.customers?.cccd?.toLowerCase().includes(searchTerm.toLowerCase());
                return contractMatch || nameMatch || cccdMatch;
            });

            if (order) {
                console.log('[HDMB Create] Order found:', order);
                const customer = order.customers || {};
                
                // Fill form với dữ liệu từ order
                const khachHangEl = document.getElementById('hdmb-create-khach_hang');
                const soCccdEl = document.getElementById('hdmb-create-so_cccd');
                const sdtEl = document.getElementById('hdmb-create-sdt');
                const emailEl = document.getElementById('hdmb-create-email');
                const diaChiEl = document.getElementById('hdmb-create-dia_chi');
                const ngayCapEl = document.getElementById('hdmb-create-ngay_cap');
                const noiCapEl = document.getElementById('hdmb-create-noi_cap');
                const soHopDongEl = document.getElementById('hdmb-create-so_hop_dong');
                const ngayKyEl = document.getElementById('hdmb-create-ngay_ky');
                const loaiXeEl = document.getElementById('hdmb-create-loai_xe');
                const phienBanEl = document.getElementById('hdmb-create-phien_ban');
                const mauXeEl = document.getElementById('hdmb-create-mau_xe');
                
                if (khachHangEl) khachHangEl.value = customer.name || '';
                if (soCccdEl) soCccdEl.value = customer.cccd || '';
                if (sdtEl) sdtEl.value = customer.phone || '';
                if (emailEl) emailEl.value = customer.email || '';
                if (diaChiEl) diaChiEl.value = customer.address || '';
                if (ngayCapEl) ngayCapEl.value = customer.issue_date ? new Date(customer.issue_date).toISOString().split('T')[0] : '';
                if (noiCapEl) noiCapEl.value = customer.issue_place || '';
                if (soHopDongEl) soHopDongEl.value = order.contract_code || '';
                if (ngayKyEl) ngayKyEl.value = new Date().toISOString().split('T')[0];
                if (loaiXeEl) loaiXeEl.value = order.car_model || '';
                if (phienBanEl) phienBanEl.value = order.car_version || '';
                if (mauXeEl) mauXeEl.value = order.car_color || '';
                
                if (resultDiv) {
                    resultDiv.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded-lg';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-green-700">
                            <i class="fa-solid fa-check-circle mr-2"></i>
                            Đã tìm thấy đơn hàng: <strong>${order.contract_code || 'Chưa có mã'}</strong> - <strong>${customer.name || ''}</strong>
                        </p>
                    `;
                    resultDiv.classList.remove('hidden');
                }
                
                if (typeof window.showToast === 'function') {
                    window.showToast('Đã tìm thấy và điền thông tin đơn hàng!', 'success');
                }
            } else {
                console.log('[HDMB Create] Order not found matching search term');
                if (resultDiv) {
                    resultDiv.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-blue-700">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Không tìm thấy đơn hàng với từ khóa "<strong>${searchTerm}</strong>". Bạn có ${result.data.length} đơn hàng. Vui lòng nhập thông tin thủ công hoặc thử từ khóa khác.
                        </p>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            }
        } else {
            console.warn('[HDMB Create] API result format unexpected:', result);
            if (resultDiv) {
                resultDiv.className = 'mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg';
                resultDiv.innerHTML = `
                    <p class="text-sm text-yellow-700">
                        <i class="fa-solid fa-exclamation-triangle mr-2"></i>
                        ${result.message || 'Không thể tải danh sách đơn hàng. Vui lòng thử lại.'}
                    </p>
                `;
                resultDiv.classList.remove('hidden');
            }
        }
    } catch (error) {
        console.error('[HDMB Create] Error searching order:', error);
        if (resultDiv) {
            resultDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded-lg';
            resultDiv.innerHTML = `
                <p class="text-sm text-red-700">
                    <i class="fa-solid fa-exclamation-circle mr-2"></i>
                    Lỗi: ${error.message || 'Không thể tìm kiếm đơn hàng'}
                </p>
            `;
            resultDiv.classList.remove('hidden');
        }
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi tìm kiếm đơn hàng: ' + error.message, 'danger');
        }
    }
}

function calculateHDMBCreateTotal() {
    const soLuong = parseFloat(document.getElementById('hdmb-create-so_luong').value) || 0;
    const donGiaStr = document.getElementById('hdmb-create-don_gia').value.replace(/\./g, '').replace(/\D/g, '');
    const donGia = parseFloat(donGiaStr) || 0;
    const tongTien = soLuong * donGia;
    document.getElementById('hdmb-create-tong_tien').value = tongTien.toLocaleString('vi-VN');
}

async function submitHDMBCreateForm(event) {
    event.preventDefault();
    
    const formData = {
        so_hop_dong: document.getElementById('hdmb-create-so_hop_dong').value.trim(),
        ngay_ky: document.getElementById('hdmb-create-ngay_ky').value,
        khach_hang: document.getElementById('hdmb-create-khach_hang').value.trim(),
        dia_chi: document.getElementById('hdmb-create-dia_chi').value.trim(),
        sdt: document.getElementById('hdmb-create-sdt').value.trim(),
        email: document.getElementById('hdmb-create-email').value.trim(),
        so_cccd: document.getElementById('hdmb-create-so_cccd').value.trim(),
        ngay_cap: document.getElementById('hdmb-create-ngay_cap').value || '',
        noi_cap: document.getElementById('hdmb-create-noi_cap').value.trim(),
        ma_so_thue: document.getElementById('hdmb-create-ma_so_thue').value.trim(),
        nguoi_dai_dien: document.getElementById('hdmb-create-nguoi_dai_dien').value.trim(),
        chuc_vu: document.getElementById('hdmb-create-chuc_vu').value.trim(),
        loai_xe: document.getElementById('hdmb-create-loai_xe').value.trim(),
        phien_ban: document.getElementById('hdmb-create-phien_ban').value.trim(),
        mau_xe: document.getElementById('hdmb-create-mau_xe').value.trim(),
        chinh_sach_ban_hang: document.getElementById('hdmb-create-chinh_sach_ban_hang').value.trim(),
        so_luong: parseInt(document.getElementById('hdmb-create-so_luong').value) || 1,
        don_gia: parseFloat(document.getElementById('hdmb-create-don_gia').value.replace(/\./g, '').replace(/\D/g, '')) || 0,
        tien_coc: parseFloat(document.getElementById('hdmb-create-tien_coc').value.replace(/\./g, '').replace(/\D/g, '')) || 0,
        tien_dot_2_TT: parseFloat(document.getElementById('hdmb-create-tien_dot_2_TT').value.replace(/\./g, '').replace(/\D/g, '')) || 0,
        tien_dot_2_TG: parseFloat(document.getElementById('hdmb-create-tien_dot_2_TG').value.replace(/\./g, '').replace(/\D/g, '')) || 0,
        tien_dot_3: parseFloat(document.getElementById('hdmb-create-tien_dot_3').value.replace(/\./g, '').replace(/\D/g, '')) || 0
    };

    if (!formData.so_hop_dong || !formData.ngay_ky || !formData.khach_hang) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
        }
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tạo...';

    try {
        const result = await window.googleDocsAPI.createHDMB(formData);
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;

        if (result.success) {
            // Lưu thông tin file vào database
            try {
                const session = JSON.parse(localStorage.getItem('user_session') || '{}');
                if (session && session.username) {
                    await window.callAPI({
                        action: 'save_document_file',
                        document_type: 'HDMB',
                        file_url: result.fileUrl || '',
                        file_id: result.fileId || null,
                        file_name: result.fileName || formData.so_hop_dong,
                        contract_code: formData.so_hop_dong,
                        customer_name: formData.khach_hang,
                        created_by: session.username
                    });
                }
            } catch (saveError) {
                console.error('[HDMB Create] Failed to save document file to database:', saveError);
                // Không cần hiển thị lỗi vì file đã tạo thành công
            }
            
            if (typeof window.showToast === 'function') {
                window.showToast('Tạo HĐMB thành công!', 'success');
            }
            resetHDMBCreateForm();
            
            if (result.fileUrl) {
                setTimeout(() => {
                    window.open(result.fileUrl, '_blank');
                }, 500);
            }
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể tạo HĐMB'), 'danger');
            }
        }
    } catch (error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        console.error('Error creating HDMB:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + (error.message || 'Không thể tạo HĐMB'), 'danger');
        }
    }
}

function resetHDMBCreateForm() {
    document.getElementById('form-hdmb-create').reset();
    document.getElementById('hdmb-order-search-result').classList.add('hidden');
    const checkboxes = document.querySelectorAll('#hdmb-create-policies-container input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateHDMBCreatePoliciesText();
    document.getElementById('hdmb-create-ngay_ky').value = new Date().toISOString().split('T')[0];
}

// Expose functions to window
if (typeof window !== 'undefined') {
    window.searchOrderForHDMB = searchOrderForHDMB;
    window.submitHDMBCreateForm = submitHDMBCreateForm;
    window.resetHDMBCreateForm = resetHDMBCreateForm;
    window.calculateHDMBCreateTotal = calculateHDMBCreateTotal;
    window.updateHDMBCreatePoliciesText = updateHDMBCreatePoliciesText;
    
    // Load policies when component is loaded
    setTimeout(() => {
        if (document.getElementById('hdmb-create-policies-container')) {
            loadSalesPoliciesForHDMBCreate();
        }
    }, 500);
}
</script>

<style>
.policy-item {
    transition: background-color 0.2s ease;
}
.policy-item:hover {
    background-color: #f3e8ff;
}
.policy-item input[type="checkbox"]:checked + label {
    color: #9333ea;
    font-weight: 600;
}
</style>
