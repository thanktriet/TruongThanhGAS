<!-- Modal tạo HĐMB -->
<div id="modal-create-hdmb" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div class="bg-purple-600 text-white px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-file-contract mr-2"></i>Tạo Hợp Đồng Mua Bán (HĐMB)
            </h2>
            <button onclick="closeHDMBModal()" class="text-2xl hover:text-red-200">&times;</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <form id="form-hdmb" onsubmit="submitHDMBForm(event)">
                <!-- Thông tin khách hàng (read-only, từ order) -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">Thông tin khách hàng</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Khách hàng:</span>
                            <span class="font-bold ml-2" id="hdmb-customer-name"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">CCCD:</span>
                            <span class="font-bold ml-2" id="hdmb-customer-cccd"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">SĐT:</span>
                            <span class="font-bold ml-2" id="hdmb-customer-phone"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">Email:</span>
                            <span class="font-bold ml-2" id="hdmb-customer-email"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-500">Địa chỉ:</span>
                            <span class="font-bold ml-2" id="hdmb-customer-address"></span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin hợp đồng -->
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-3 border-b pb-1">Thông tin hợp đồng</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="label">Số hợp đồng *</label>
                            <input type="text" id="hdmb-so_hop_dong" class="input" required>
                        </div>
                        <div>
                            <label class="label">Ngày ký *</label>
                            <input type="date" id="hdmb-ngay_ky" class="input" required>
                        </div>
                        <div>
                            <label class="label">Loại xe</label>
                            <input type="text" id="hdmb-loai_xe" class="input">
                        </div>
                        <div>
                            <label class="label">Phiên bản</label>
                            <input type="text" id="hdmb-phien_ban" class="input">
                        </div>
                        <div>
                            <label class="label">Màu xe</label>
                            <input type="text" id="hdmb-mau_xe" class="input">
                        </div>
                        <div>
                            <label class="label">Ngày cấp CCCD</label>
                            <input type="date" id="hdmb-ngay_cap" class="input">
                        </div>
                        <div>
                            <label class="label">Nơi cấp CCCD</label>
                            <input type="text" id="hdmb-noi_cap" class="input">
                        </div>
                        <div>
                            <label class="label">Số lượng</label>
                            <input type="number" id="hdmb-so_luong" class="input" value="1" min="1" oninput="calculateHDMBTotal()">
                        </div>
                        <div>
                            <label class="label">Đơn giá (VNĐ)</label>
                            <input type="number" id="hdmb-don_gia" class="input" min="0" oninput="calculateHDMBTotal()">
                        </div>
                        <div>
                            <label class="label">Tổng tiền (VNĐ)</label>
                            <input type="text" id="hdmb-tong_tien" class="input bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="label">Tiền cọc (VNĐ)</label>
                            <input type="number" id="hdmb-tien_coc" class="input" min="0">
                        </div>
                        <div>
                            <label class="label">Mã số thuế</label>
                            <input type="text" id="hdmb-ma_so_thue" class="input">
                        </div>
                        <div>
                            <label class="label">Người đại diện</label>
                            <input type="text" id="hdmb-nguoi_dai_dien" class="input">
                        </div>
                        <div>
                            <label class="label">Chức vụ</label>
                            <input type="text" id="hdmb-chuc_vu" class="input">
                        </div>
                        <div class="md:col-span-2">
                            <label class="label mb-2 block">Chính sách bán hàng (chọn một hoặc nhiều)</label>
                            <div id="hdmb-policies-container" class="border border-gray-200 rounded-lg p-3 md:p-4 bg-gray-50 max-h-60 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500 text-sm">
                                    <i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tải chính sách...
                                </div>
                            </div>
                            <textarea id="hdmb-chinh_sach_ban_hang" class="input mt-3 hidden" rows="2" placeholder="Chính sách đã chọn sẽ hiển thị ở đây..."></textarea>
                        </div>
                        <div>
                            <label class="label">Tiền đợt 2 (Trả thẳng) - VNĐ</label>
                            <input type="number" id="hdmb-tien_dot_2_TT" class="input" min="0">
                        </div>
                        <div>
                            <label class="label">Tiền đợt 2 (Trả góp) - VNĐ</label>
                            <input type="number" id="hdmb-tien_dot_2_TG" class="input" min="0">
                        </div>
                        <div>
                            <label class="label">Tiền đợt 3 - VNĐ</label>
                            <input type="number" id="hdmb-tien_dot_3" class="input" min="0">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="border-t p-4 bg-gray-50 flex justify-end gap-3">
            <button onclick="closeHDMBModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition font-bold">
                Hủy
            </button>
            <button onclick="document.getElementById('form-hdmb').dispatchEvent(new Event('submit'))" class="px-6 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition font-bold">
                <i class="fa-solid fa-file-contract mr-2"></i>Tạo HĐMB
            </button>
        </div>
    </div>
</div>

<script>
let currentOrderForHDMB = null;

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load sales policies for HĐMB form
async function loadSalesPoliciesForHDMB(retryCount = 0) {
    console.log('[HDMB Policies] loadSalesPoliciesForHDMB called, retryCount:', retryCount);
    
    const maxRetries = 5;
    const container = document.getElementById('hdmb-policies-container');
    
    if (!container) {
        console.warn('[HDMB Policies] Container not found, current retry:', retryCount);
        if (retryCount < maxRetries) {
            console.log(`[HDMB Policies] Container not found, retrying... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => {
                if (typeof loadSalesPoliciesForHDMB === 'function') {
                    loadSalesPoliciesForHDMB(retryCount + 1);
                } else {
                    console.error('[HDMB Policies] Function not available for retry!');
                }
            }, 500);
            return;
        } else {
            console.error('[HDMB Policies] Container not found after', maxRetries, 'retries');
            return;
        }
    }

    console.log('[HDMB Policies] Container found! Loading sales policies...');
    console.log('[HDMB Policies] Container innerHTML before load:', container.innerHTML.substring(0, 100));
    
    try {
        if (typeof window.callAPI !== 'function') {
            console.error('[HDMB Policies] window.callAPI is not a function!', typeof window.callAPI);
            throw new Error('callAPI function not found');
        }

        console.log('[HDMB Policies] Calling API with action: get_active_sales_policies');
        const result = await window.callAPI({
            action: 'get_active_sales_policies'
        });

        console.log('[HDMB Policies] API result:', result);

        if (result && result.success && Array.isArray(result.data)) {
            console.log('[HDMB Policies] Loaded', result.data.length, 'policies');
            console.log('[HDMB Policies] First policy sample:', result.data[0]);
            renderSalesPoliciesCheckboxes(result.data);
        } else {
            console.error('[HDMB Policies] API error:', result?.message || 'Không thể tải chính sách');
            container.innerHTML = `
                <div class="text-center py-4 text-red-500 text-sm">
                    <i class="fa-solid fa-exclamation-circle mr-2"></i>
                    ${result?.message || 'Không thể tải chính sách'}
                    <button 
                        onclick="loadSalesPoliciesForHDMB()" 
                        class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-xs"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Thử lại
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('[HDMB Policies] Error loading policies:', error);
        const container = document.getElementById('hdmb-policies-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-4 text-red-500 text-sm">
                    <i class="fa-solid fa-exclamation-circle mr-2"></i>
                    Lỗi tải chính sách: ${error.message}
                    <button 
                        onclick="loadSalesPoliciesForHDMB()" 
                        class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-xs"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Thử lại
                    </button>
                </div>
            `;
        }
    }
}

// Render sales policies as checkboxes
function renderSalesPoliciesCheckboxes(policies) {
    const container = document.getElementById('hdmb-policies-container');
    if (!container) {
        console.error('[HDMB Policies] Container not found in renderSalesPoliciesCheckboxes');
        return;
    }

    console.log('[HDMB Policies] Rendering', policies ? policies.length : 0, 'policies');

    if (!policies || policies.length === 0) {
        console.warn('[HDMB Policies] No policies to render');
        container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">Chưa có chính sách nào</div>';
        return;
    }

    let html = '<div class="space-y-2">';
    
    try {
        policies.forEach((policy, index) => {
            try {
                if (!policy || !policy.id) {
                    console.warn('[HDMB Policies] Invalid policy at index', index, policy);
                    return;
                }
                
                const policyId = 'hdmb-policy-' + policy.id;
                const policyName = escapeHtml(policy.name || '');
                const policyDesc = escapeHtml(policy.description || '');
                
                html += '<div class="policy-item flex items-start gap-2 p-2 rounded hover:bg-blue-50 active:bg-blue-100 transition">';
                html += '<input type="checkbox" id="' + policyId + '" name="hdmb_policy" value="' + policyDesc + '" class="mt-1 w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500 touch-manipulation" data-policy-name="' + policyName + '" onchange="if(typeof window.updateHDMBSalesPoliciesText === \'function\') window.updateHDMBSalesPoliciesText();">';
                html += '<label for="' + policyId + '" class="flex-1 text-xs md:text-sm cursor-pointer"><span class="font-medium">' + policyName + '</span></label>';
                html += '</div>';
            } catch (policyError) {
                console.error('[HDMB Policies] Error rendering policy at index', index, policyError, policy);
            }
        });
        html += '</div>';
        
        console.log('[HDMB Policies] Generated HTML length:', html.length);
        container.innerHTML = html;
        console.log('[HDMB Policies] Rendered', policies.length, 'policies successfully');
        
        // Verify DOM was updated
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        console.log('[HDMB Policies] Found', checkboxes.length, 'checkboxes in DOM after render');
    } catch (renderError) {
        console.error('[HDMB Policies] Error in render function:', renderError);
        container.innerHTML = '<div class="text-center py-4 text-red-500 text-sm">Lỗi render: ' + escapeHtml(renderError.message) + '</div>';
    }
}

// Update textarea with selected policies
function updateHDMBSalesPoliciesText() {
    const textarea = document.getElementById('hdmb-chinh_sach_ban_hang');
    if (!textarea) return;

    const checkboxes = document.querySelectorAll('#hdmb-policies-container input[type="checkbox"]:checked');
    const selectedPolicies = Array.from(checkboxes).map(cb => cb.value);
    
    textarea.value = selectedPolicies.join('\n');
}

async function openHDMBModal(orderId) {
    console.log('[HDMB] openHDMBModal called with orderId:', orderId);
    
    // Try to find order from window.allOrders or fetch it
    let order = null;
    if (typeof window !== 'undefined' && window.allOrders && Array.isArray(window.allOrders)) {
        order = window.allOrders.find(o => o.id === orderId);
        console.log('[HDMB] Order found in window.allOrders:', !!order);
    }
    
    // If not found, try to fetch order
    if (!order) {
        try {
            const session = JSON.parse(localStorage.getItem('user_session') || '{}');
            if (session && session.username) {
                const result = await window.callAPI({
                    action: 'get_my_orders',
                    username: session.username
                });
                if (result.success && result.data) {
                    order = result.data.find(o => o.id === orderId);
                    // Update window.allOrders
                    if (typeof window !== 'undefined') {
                        window.allOrders = result.data;
                    }
                }
            }
        } catch (e) {
            console.error('Error fetching order:', e);
        }
    }
    
    if (!order) {
        if (typeof window.showToast === 'function') {
            window.showToast('Không tìm thấy đơn hàng', 'danger');
        } else {
            alert('Không tìm thấy đơn hàng');
        }
        return;
    }

    currentOrderForHDMB = order;
    const customer = order.customers || {};

    // Fill customer info (read-only)
    document.getElementById('hdmb-customer-name').textContent = customer.name || '';
    document.getElementById('hdmb-customer-cccd').textContent = customer.cccd || '';
    document.getElementById('hdmb-customer-phone').textContent = customer.phone || '';
    document.getElementById('hdmb-customer-email').textContent = customer.email || '';
    document.getElementById('hdmb-customer-address').textContent = customer.address || '';

    // Fill form với dữ liệu từ order
    document.getElementById('hdmb-so_hop_dong').value = order.contract_code || '';
    document.getElementById('hdmb-ngay_ky').value = new Date().toISOString().split('T')[0];
    document.getElementById('hdmb-loai_xe').value = order.car_model || '';
    document.getElementById('hdmb-phien_ban').value = order.car_version || '';
    document.getElementById('hdmb-mau_xe').value = order.car_color || '';
    document.getElementById('hdmb-so_luong').value = 1;
    
    // Set customer data vào form fields
    document.getElementById('hdmb-ngay_cap').value = customer.issue_date ? new Date(customer.issue_date).toISOString().split('T')[0] : '';
    document.getElementById('hdmb-noi_cap').value = customer.issue_place || '';

    // Show modal first
    const modal = document.getElementById('modal-create-hdmb');
    if (!modal) {
        console.error('[HDMB] Modal element not found!');
        return;
    }
    
    console.log('[HDMB] Modal element found, showing modal...');
    modal.classList.remove('hidden');
    console.log('[HDMB] Modal opened, preparing to load policies...');
    
    // Verify container exists
    const container = document.getElementById('hdmb-policies-container');
    console.log('[HDMB] Policies container found:', !!container);
    if (container) {
        console.log('[HDMB] Container current content:', container.innerHTML.substring(0, 100));
    }
    
    // Load sales policies after modal is visible (delay để đảm bảo DOM ready)
    // Thử nhiều lần với delay tăng dần
    setTimeout(() => {
        console.log('[HDMB] Attempt 1: Loading policies after 300ms...');
        console.log('[HDMB] typeof loadSalesPoliciesForHDMB:', typeof loadSalesPoliciesForHDMB);
        console.log('[HDMB] typeof window.loadSalesPoliciesForHDMB:', typeof window.loadSalesPoliciesForHDMB);
        
        if (typeof window.loadSalesPoliciesForHDMB === 'function') {
            console.log('[HDMB] Calling window.loadSalesPoliciesForHDMB()...');
            window.loadSalesPoliciesForHDMB();
        } else if (typeof loadSalesPoliciesForHDMB === 'function') {
            console.log('[HDMB] Calling loadSalesPoliciesForHDMB() (local)...');
            loadSalesPoliciesForHDMB();
        } else {
            console.error('[HDMB] loadSalesPoliciesForHDMB function not found! Available functions:', Object.keys(window).filter(k => k.includes('Policy')));
        }
    }, 300);
    
    // Backup: thử lại sau 1 giây
    setTimeout(() => {
        const containerCheck = document.getElementById('hdmb-policies-container');
        if (containerCheck && containerCheck.innerHTML.includes('Đang tải chính sách')) {
            console.log('[HDMB] Attempt 2: Retrying after 1s (still loading...)');
            if (typeof window.loadSalesPoliciesForHDMB === 'function') {
                window.loadSalesPoliciesForHDMB();
            } else if (typeof loadSalesPoliciesForHDMB === 'function') {
                loadSalesPoliciesForHDMB();
            }
        }
    }, 1000);
}

function closeHDMBModal() {
    document.getElementById('modal-create-hdmb').classList.add('hidden');
    document.getElementById('form-hdmb').reset();
    // Clear checkboxes
    const checkboxes = document.querySelectorAll('#hdmb-policies-container input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateHDMBSalesPoliciesText();
    currentOrderForHDMB = null;
}

function calculateHDMBTotal() {
    const soLuong = parseFloat(document.getElementById('hdmb-so_luong').value) || 0;
    const donGia = parseFloat(document.getElementById('hdmb-don_gia').value) || 0;
    const tongTien = soLuong * donGia;
    document.getElementById('hdmb-tong_tien').value = tongTien.toLocaleString('vi-VN');
}

async function submitHDMBForm(event) {
    event.preventDefault();
    
    if (!currentOrderForHDMB) {
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: Không tìm thấy đơn hàng', 'danger');
        }
        return;
    }

    const customer = currentOrderForHDMB.customers || {};
    
    const formData = {
        so_hop_dong: document.getElementById('hdmb-so_hop_dong').value.trim(),
        ngay_ky: document.getElementById('hdmb-ngay_ky').value,
        khach_hang: customer.name || '',
        dia_chi: customer.address || '',
        sdt: customer.phone || '',
        email: customer.email || '',
        so_cccd: customer.cccd || '',
        ngay_cap: document.getElementById('hdmb-ngay_cap').value || customer.issue_date || '',
        noi_cap: document.getElementById('hdmb-noi_cap').value || customer.issue_place || '',
        ma_so_thue: document.getElementById('hdmb-ma_so_thue').value.trim() || '',
        nguoi_dai_dien: document.getElementById('hdmb-nguoi_dai_dien').value.trim() || '',
        chuc_vu: document.getElementById('hdmb-chuc_vu').value.trim() || '',
        loai_xe: document.getElementById('hdmb-loai_xe').value.trim(),
        phien_ban: document.getElementById('hdmb-phien_ban').value.trim(),
        mau_xe: document.getElementById('hdmb-mau_xe').value.trim(),
        chinh_sach_ban_hang: document.getElementById('hdmb-chinh_sach_ban_hang').value.trim() || '',
        so_luong: parseInt(document.getElementById('hdmb-so_luong').value) || 1,
        don_gia: parseFloat(document.getElementById('hdmb-don_gia').value) || 0,
        tien_coc: parseFloat(document.getElementById('hdmb-tien_coc').value) || 0,
        tien_dot_2_TT: parseFloat(document.getElementById('hdmb-tien_dot_2_TT').value) || 0,
        tien_dot_2_TG: parseFloat(document.getElementById('hdmb-tien_dot_2_TG').value) || 0,
        tien_dot_3: parseFloat(document.getElementById('hdmb-tien_dot_3').value) || 0
    };

    // Validate
    if (!formData.so_hop_dong || !formData.ngay_ky) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
        }
        return;
    }

    // Get submit button - try multiple ways
    let submitBtn = null;
    const modal = document.getElementById('modal-create-hdmb');
    
    if (modal) {
        // Try to find button by text or class
        const buttons = modal.querySelectorAll('button');
        for (let btn of buttons) {
            if (btn.textContent.includes('Tạo HĐMB') || btn.textContent.includes('Đang tạo')) {
                submitBtn = btn;
                break;
            }
        }
    }
    
    // Fallback: try from event target
    if (!submitBtn && event.target) {
        if (event.target.tagName === 'BUTTON') {
            submitBtn = event.target;
        } else {
            const closestBtn = event.target.closest('button');
            if (closestBtn) {
                submitBtn = closestBtn;
            }
        }
    }
    
    // Final fallback: get from form's parent
    if (!submitBtn) {
        const form = document.getElementById('form-hdmb');
        if (form) {
            const modalFooter = form.closest('.bg-white')?.querySelector('.bg-gray-50');
            if (modalFooter) {
                const buttons = modalFooter.querySelectorAll('button');
                // Get the button that contains "Tạo HĐMB"
                for (let btn of buttons) {
                    if (btn.textContent.includes('Tạo HĐMB')) {
                        submitBtn = btn;
                        break;
                    }
                }
            }
        }
    }
    
    if (!submitBtn) {
        console.error('Cannot find submit button');
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: Không tìm thấy nút submit', 'danger');
        }
        return;
    }
    
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang tạo...';

    try {
        const result = await window.googleDocsAPI.createHDMB(formData);
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('Tạo HĐMB thành công!', 'success');
            }
            closeHDMBModal();
            
            // Mở file trong tab mới
            if (result.fileUrl) {
                setTimeout(() => {
                    window.open(result.fileUrl, '_blank');
                }, 500);
            }
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể tạo HĐMB'), 'danger');
            }
        }
    } catch (error) {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
        console.error('Error creating HDMB:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + (error.message || 'Không thể tạo HĐMB'), 'danger');
        }
    }
}

// Expose functions globally
if (typeof window !== 'undefined') {
    window.openHDMBModal = openHDMBModal;
    window.closeHDMBModal = closeHDMBModal;
    window.loadSalesPoliciesForHDMB = loadSalesPoliciesForHDMB;
    window.renderSalesPoliciesCheckboxes = renderSalesPoliciesCheckboxes;
    window.updateHDMBSalesPoliciesText = updateHDMBSalesPoliciesText;
}
</script>

<style>
/* Policy items styling */
.policy-item {
    transition: background-color 0.2s ease;
}
.policy-item:hover {
    background-color: #e0e7ff;
}
.policy-item input[type="checkbox"]:checked + label {
    color: #6366f1;
    font-weight: 600;
}
</style>

