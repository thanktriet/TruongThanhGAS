<div id="tab-reports-dashboard" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-indigo-50 px-4 py-3 md:px-6 md:py-4 border-b border-indigo-100">
            <h2 class="text-base md:text-lg font-bold text-indigo-800">
                <i class="fa-solid fa-chart-line mr-2"></i>Dashboard Báo Cáo
            </h2>
            <p class="text-xs md:text-sm text-gray-600 mt-1">Báo cáo ngày và MTD tổng hợp theo tháng</p>
        </div>
        <div class="p-3 md:p-6">
            <!-- Filter -->
            <div class="mb-4 space-y-3 md:space-y-0 md:flex md:gap-3 md:items-end md:flex-wrap">
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">Chọn ngày báo cáo:</label>
                    <input 
                        type="date" 
                        id="dashboard-date-filter" 
                        class="input bg-white w-full text-sm md:text-base" 
                        onchange="loadReportsDashboard()"
                    >
                </div>
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">Chọn tháng (cho MTD):</label>
                    <input 
                        type="month" 
                        id="dashboard-month-filter" 
                        class="input bg-white w-full text-sm md:text-base" 
                        onchange="loadReportsDashboard()"
                    >
                </div>
                <button 
                    onclick="loadReportsDashboard()" 
                    class="w-full md:w-auto bg-indigo-600 text-white font-bold px-6 py-2.5 md:py-2 rounded-lg hover:bg-indigo-700 transition touch-manipulation text-sm md:text-base"
                >
                    <i class="fa-solid fa-filter mr-2"></i>Lọc
                </button>
            </div>

            <!-- Loading -->
            <div id="dashboard-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <!-- Reports Content -->
            <div id="dashboard-content" class="space-y-6">
                <p class="text-center text-gray-500 py-12">
                    <i class="fa-solid fa-info-circle mr-2"></i>
                    Tính năng Dashboard đang được phát triển. Vui lòng quay lại sau.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Render báo cáo ngày dưới dạng Cards (mobile-friendly)
 */
function createDailyCards(dataArray, reportedTvbhSet = null) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    const headers = dataArray[0];
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[0] === 'TỔNG CỘNG';
        const tvbhName = row[1];
        const stt = row[0];
        
        // Kiểm tra nếu TVBH chưa báo cáo
        let isNotReported = false;
        if (!isTotal && reportedTvbhSet && tvbhName) {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            isNotReported = !reportedTvbhSet.has(tvbhName) && !hasData;
        }
        
        // Card styling
        const cardBg = isTotal 
            ? 'bg-gradient-to-br from-indigo-100 to-indigo-50 border-indigo-300' 
            : isNotReported 
                ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300' 
                : 'bg-white border-gray-200';
        
        const titleColor = isTotal 
            ? 'text-indigo-900' 
            : isNotReported 
                ? 'text-red-700' 
                : 'text-gray-800';
        
        html += `<div class="border-2 ${cardBg} rounded-xl p-4 shadow-sm hover:shadow-md transition ${isTotal ? 'md:col-span-2 lg:col-span-3' : ''}">`;
        
        // Card header
        html += `<div class="flex items-center justify-between mb-4 pb-3 border-b ${isTotal ? 'border-indigo-300' : isNotReported ? 'border-red-300' : 'border-gray-200'}">`;
        html += `<div class="flex items-center gap-2">`;
        if (isTotal) {
            html += `<i class="fa-solid fa-calculator text-indigo-600 text-lg"></i>`;
        } else if (isNotReported) {
            html += `<i class="fa-solid fa-exclamation-circle text-red-600 text-lg"></i>`;
        } else {
            html += `<span class="text-sm font-bold text-gray-500">${stt}</span>`;
        }
        html += `<h4 class="font-bold ${titleColor} text-base md:text-lg">${tvbhName || stt}</h4>`;
        html += `</div>`;
        if (isNotReported) {
            html += `<span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded-full font-semibold">Chưa báo cáo</span>`;
        }
        html += `</div>`;
        
        // Card body - metrics
        html += `<div class="grid grid-cols-2 gap-3">`;
        for (let idx = 2; idx < headers.length && idx < row.length; idx++) {
            const header = headers[idx];
            const value = row[idx];
            const formattedValue = typeof value === 'number' ? value.toLocaleString('vi-VN') : value;
            
            // Icon mapping
            const iconMap = {
                'KHTN': 'fa-users',
                'Hợp đồng': 'fa-file-contract',
                'Xuất HĐ': 'fa-file-export',
                'Doanh thu': 'fa-money-bill-wave'
            };
            const icon = iconMap[header] || 'fa-chart-bar';
            
            html += `<div class="bg-white/60 rounded-lg p-3 border border-gray-100">`;
            html += `<div class="flex items-center gap-2 mb-1">`;
            html += `<i class="fa-solid ${icon} text-indigo-500 text-sm"></i>`;
            html += `<span class="text-xs text-gray-600 font-medium">${header}</span>`;
            html += `</div>`;
            html += `<div class="text-lg font-bold ${titleColor}">${formattedValue}</div>`;
            html += `</div>`;
        }
        html += `</div>`;
        
        html += `</div>`;
    }
    html += '</div>';
    
    return html;
}

/**
 * Render bảng Báo cáo Ngày (desktop view)
 * @param {Array} dataArray - Mảng chứa headers và data rows
 * @param {Set} reportedTvbhSet - Set chứa các TVBH đã báo cáo (để tô đỏ những TVBH chưa báo cáo)
 */
function createDailyTable(dataArray, reportedTvbhSet = null) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    let html = '<div class="hidden lg:block overflow-x-auto border border-gray-200 rounded-lg" style="-webkit-overflow-scrolling: touch;">';
    html += '<table class="min-w-full divide-y divide-gray-200 text-sm">';
    
    // Header
    html += '<thead class="bg-indigo-50 sticky top-0 z-10">';
    html += '<tr>';
    dataArray[0].forEach((header, idx) => {
        const isNumeric = idx >= 2;
        html += `<th class="px-4 py-3 text-left text-xs font-bold text-indigo-800 uppercase whitespace-nowrap ${isNumeric ? 'text-right' : ''}">${header}</th>`;
    });
    html += '</tr>';
    html += '</thead>';
    
    // Body
    html += '<tbody class="bg-white divide-y divide-gray-200">';
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[0] === 'TỔNG CỘNG';
        const tvbhName = row[1];
        
        let isNotReported = false;
        if (!isTotal && reportedTvbhSet && tvbhName) {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            isNotReported = !reportedTvbhSet.has(tvbhName) && !hasData;
        }
        
        const rowClass = isTotal 
            ? 'bg-indigo-100 font-bold' 
            : isNotReported 
                ? 'bg-red-50 hover:bg-red-100' 
                : 'hover:bg-gray-50';
        
        html += `<tr class="${rowClass}">`;
        row.forEach((cell, idx) => {
            const isNumeric = idx >= 2;
            let cellValue = typeof cell === 'number' ? cell.toLocaleString('vi-VN') : cell;
            const cellClass = isTotal 
                ? 'font-bold text-indigo-900' 
                : isNotReported 
                    ? 'text-red-600 font-medium' 
                    : 'text-gray-700';
            html += `<td class="px-4 py-3 text-sm whitespace-nowrap ${isNumeric ? 'text-right' : ''} ${cellClass}">${cellValue}</td>`;
        });
        html += '</tr>';
    }
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    return html;
}

/**
 * Render bảng MTD Tổng
 */
function createMtdTotalTable(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    let html = '<div class="overflow-x-auto border border-gray-200 rounded-lg -mx-1 md:mx-0" style="-webkit-overflow-scrolling: touch;">';
    html += '<table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">';
    
    // Header
    html += '<thead class="bg-indigo-50 sticky top-0 z-10">';
    html += '<tr>';
    dataArray[0].forEach((header, idx) => {
        const isNumeric = idx >= 3; // Các cột từ cột 4 trở đi là số
        html += `<th class="px-1.5 py-2 md:px-3 md:py-3 text-left text-[9px] md:text-xs font-bold text-indigo-800 uppercase whitespace-nowrap ${isNumeric ? 'text-right' : ''}">${header}</th>`;
    });
    html += '</tr>';
    html += '</thead>';
    
    // Body
    html += '<tbody class="bg-white divide-y divide-gray-200">';
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[1] === 'TỔNG CỘNG';
        html += `<tr class="${isTotal ? 'bg-indigo-100 font-bold' : 'active:bg-gray-50'}">`;
        row.forEach((cell, idx) => {
            const isNumeric = idx >= 3;
            let cellValue = cell;
            if (typeof cell === 'number') {
                cellValue = cell.toLocaleString('vi-VN');
            }
            // Truncate long text on mobile
            if (idx === 2 && typeof cellValue === 'string' && cellValue.length > 10) {
                cellValue = `<span title="${cellValue}">${cellValue.substring(0, 8)}...</span>`;
            }
            // Highlight phần trăm >= 100%
            if (typeof cell === 'string' && cell.includes('%')) {
                const percent = parseFloat(cell);
                const highlightClass = percent >= 100 ? 'text-green-600 font-bold' : percent >= 80 ? 'text-yellow-600' : 'text-gray-700';
                html += `<td class="px-1.5 py-2 md:px-3 md:py-3 text-[10px] md:text-sm text-right whitespace-nowrap ${highlightClass} ${isTotal ? 'font-bold' : ''}">${cellValue}</td>`;
            } else {
                html += `<td class="px-1.5 py-2 md:px-3 md:py-3 text-[10px] md:text-sm ${isNumeric ? 'text-right' : ''} whitespace-nowrap ${isTotal ? 'font-bold text-indigo-900' : 'text-gray-700'}">${cellValue}</td>`;
            }
        });
        html += '</tr>';
    }
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    return html;
}

async function loadReportsDashboard() {
    const filterDate = document.getElementById('dashboard-date-filter').value || null;
    const filterMonth = document.getElementById('dashboard-month-filter').value || null;
    
    const loadingEl = document.getElementById('dashboard-loading');
    const contentEl = document.getElementById('dashboard-content');
    
    if (!loadingEl || !contentEl) {
        console.error('[Dashboard] Elements not found');
        return;
    }
    
    loadingEl.classList.remove('hidden');
    contentEl.innerHTML = '';

    try {
        const result = await window.callAPI({
            action: 'get_dashboard_data',
            filterDate: filterDate,
            filterMonth: filterMonth
        });

        loadingEl.classList.add('hidden');

        if (result.success && result.data) {
            const { daily, mtdTotal, reportedTvbhSet } = result.data;
            
            // Format date string for display
            let dateDisplay = 'Hôm Nay';
            if (filterDate) {
                const date = new Date(filterDate);
                dateDisplay = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            
            let html = '';
            
            // Bảng 1: Báo cáo Ngày
            html += '<div class="mb-6 md:mb-8">';
            html += '<h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4 flex items-center gap-2 flex-wrap">';
            html += '<i class="fa-solid fa-calendar-day text-indigo-600"></i>';
            html += `<span class="break-words">Báo Cáo Ngày (${dateDisplay})</span>`;
            html += '</h3>';
            
            // Convert reportedTvbhSet to Set if it's an array
            const reportedSet = reportedTvbhSet 
                ? (reportedTvbhSet instanceof Set ? reportedTvbhSet : new Set(reportedTvbhSet))
                : null;
            
            // Mobile: Cards view, Desktop: Table view
            html += '<div class="lg:hidden">';
            html += createDailyCards(daily, reportedSet);
            html += '</div>';
            html += createDailyTable(daily, reportedSet);
            html += '<p class="text-xs text-gray-500 mt-3 px-1"><i class="fa-solid fa-info-circle mr-1"></i>TVBH được tô đỏ là những người chưa thực hiện báo cáo trong ngày này</p>';
            html += '</div>';
            
            // Bảng 2: MTD Tổng
            html += '<div>';
            html += '<h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4 flex items-center gap-2 flex-wrap">';
            html += '<i class="fa-solid fa-chart-line text-indigo-600"></i>';
            html += '<span class="break-words">Báo Cáo MTD Tổng Hợp (Từ Đầu Tháng)</span>';
            html += '</h3>';
            html += createMtdTotalTable(mtdTotal);
            html += '</div>';
            
            contentEl.innerHTML = html;
        } else {
            contentEl.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="font-bold">Lỗi: ${result.message || 'Không thể tải dữ liệu'}</p>
                </div>
            `;
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể tải dữ liệu'), 'danger');
            }
        }
    } catch (error) {
        console.error('[Dashboard] Error loading dashboard:', error);
        loadingEl.classList.add('hidden');
        contentEl.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">Lỗi: ${error.message || 'Không thể tải dữ liệu'}</p>
            </div>
        `;
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
    }
}

// Expose functions globally
if (typeof window !== 'undefined') {
    window.loadReportsDashboard = loadReportsDashboard;
    window.createDailyTable = createDailyTable;
    window.createDailyCards = createDailyCards;
    window.createMtdTotalTable = createMtdTotalTable;
}

// Set default date and month to current and load on tab active
if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
        const dateInput = document.getElementById('dashboard-date-filter');
        const monthInput = document.getElementById('dashboard-month-filter');
        
        // Set default date to today
        if (dateInput && !dateInput.value) {
            const now = new Date();
            dateInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        
        // Set default month to current month
        if (monthInput && !monthInput.value) {
            const now = new Date();
            monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        // Load dashboard when tab becomes active
        const observer = new MutationObserver((mutations) => {
            const tab = document.getElementById('tab-reports-dashboard');
            if (tab && tab.classList.contains('active')) {
                const contentEl = document.getElementById('dashboard-content');
                if (contentEl && contentEl.innerHTML.includes('đang được phát triển')) {
                    loadReportsDashboard();
                }
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container && container.parentElement) {
            observer.observe(container.parentElement, {
                attributes: true,
                attributeFilter: ['class'],
                subtree: true
            });
        }
    });
}
</script>

