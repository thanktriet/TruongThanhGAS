<div id="tab-reports-dashboard" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-indigo-50 px-4 py-3 md:px-6 md:py-4 border-b border-indigo-100">
            <h2 class="text-base md:text-lg font-bold text-indigo-800">
                <i class="fa-solid fa-chart-line mr-2"></i>Dashboard Báo Cáo
            </h2>
            <p class="text-xs md:text-sm text-gray-600 mt-1">Báo cáo ngày và MTD tổng hợp theo tháng</p>
        </div>
        <div class="p-3 md:p-6">
            <!-- Filter -->
            <!-- Filter cho Báo cáo Ngày -->
            <div class="mb-4 space-y-3 md:space-y-0 md:flex md:gap-3 md:items-end md:flex-wrap">
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">Chọn ngày báo cáo:</label>
                    <div class="flex gap-2">
                        <input 
                            type="date" 
                            id="dashboard-date-filter" 
                            class="input bg-white w-full text-sm md:text-base flex-1" 
                            onchange="loadReportsDashboard()"
                        >
                        <button 
                            onclick="setTodayDate()" 
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap flex items-center gap-1"
                            title="Chọn hôm nay"
                        >
                            <i class="fa-solid fa-calendar-day"></i>
                            <span class="hidden md:inline">Hôm nay</span>
                        </button>
                    </div>
                </div>
                <button 
                    onclick="loadReportsDashboard()" 
                    class="w-full md:w-auto bg-indigo-600 text-white font-bold px-6 py-2.5 md:py-2 rounded-lg hover:bg-indigo-700 transition touch-manipulation text-sm md:text-base"
                >
                    <i class="fa-solid fa-filter mr-2"></i>Lọc
                </button>
            </div>

            <!-- Filter cho MTD -->
            <div class="mb-4 space-y-3 md:space-y-0 md:flex md:gap-3 md:items-end md:flex-wrap bg-gray-50 p-3 rounded-lg border border-gray-200">
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">Chọn tháng (cho MTD):</label>
                    <input 
                        type="month" 
                        id="dashboard-month-filter" 
                        class="input bg-white w-full text-sm md:text-base" 
                        onchange="loadReportsDashboard()"
                    >
                </div>
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">Nhóm (MTD):</label>
                    <select 
                        id="dashboard-mtd-group-filter" 
                        class="input bg-white w-full text-sm md:text-base" 
                        onchange="loadReportsDashboard()"
                    >
                        <option value="">Tất cả nhóm</option>
                    </select>
                </div>
                <div class="flex-1 w-full md:max-w-xs">
                    <label class="label text-xs mb-1 block">TVBH (MTD):</label>
                    <select 
                        id="dashboard-mtd-tvbh-filter" 
                        class="input bg-white w-full text-sm md:text-base" 
                        onchange="loadReportsDashboard()"
                    >
                        <option value="">Tất cả TVBH</option>
                    </select>
                </div>
            </div>

            <!-- Loading -->
            <div id="dashboard-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <!-- Reports Content -->
            <div id="dashboard-content" class="space-y-6">
                <!-- Content will be loaded by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Render báo cáo ngày dưới dạng Cards (mobile-friendly)
 */
function createDailyCards(dataArray, reportedTvbhSet = null) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    const headers = dataArray[0];
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[0] === 'TỔNG CỘNG';
        const tvbhName = row[1];
        const stt = row[0];
        
        // Kiểm tra nếu TVBH chưa báo cáo
        let isNotReported = false;
        if (!isTotal && reportedTvbhSet && tvbhName) {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            isNotReported = !reportedTvbhSet.has(tvbhName) && !hasData;
        }
        
        // Card styling
        const cardBg = isTotal 
            ? 'bg-gradient-to-br from-indigo-100 to-indigo-50 border-indigo-300' 
            : isNotReported 
                ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300' 
                : 'bg-white border-gray-200';
        
        const titleColor = isTotal 
            ? 'text-indigo-900' 
            : isNotReported 
                ? 'text-red-700' 
                : 'text-gray-800';
        
        html += `<div class="border-2 ${cardBg} rounded-xl p-4 shadow-sm hover:shadow-md transition ${isTotal ? 'md:col-span-2 lg:col-span-3' : ''}">`;
        
        // Card header
        html += `<div class="flex items-center justify-between mb-4 pb-3 border-b ${isTotal ? 'border-indigo-300' : isNotReported ? 'border-red-300' : 'border-gray-200'}">`;
        html += `<div class="flex items-center gap-2">`;
        if (isTotal) {
            html += `<i class="fa-solid fa-calculator text-indigo-600 text-lg"></i>`;
        } else if (isNotReported) {
            html += `<i class="fa-solid fa-exclamation-circle text-red-600 text-lg"></i>`;
        } else {
            html += `<span class="text-sm font-bold text-gray-500">${stt}</span>`;
        }
        html += `<h4 class="font-bold ${titleColor} text-base md:text-lg">${tvbhName || stt}</h4>`;
        html += `</div>`;
        if (isNotReported) {
            html += `<span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded-full font-semibold">Chưa báo cáo</span>`;
        }
        html += `</div>`;
        
        // Card body - metrics
        html += `<div class="grid grid-cols-2 gap-3">`;
        for (let idx = 2; idx < headers.length && idx < row.length; idx++) {
            const header = headers[idx];
            const value = row[idx];
            const formattedValue = typeof value === 'number' ? value.toLocaleString('vi-VN') : value;
            
            // Icon mapping
            const iconMap = {
                'KHTN': 'fa-users',
                'Hợp đồng': 'fa-file-contract',
                'Xuất HĐ': 'fa-file-export',
                'Doanh thu': 'fa-money-bill-wave'
            };
            const icon = iconMap[header] || 'fa-chart-bar';
            
            html += `<div class="bg-white/60 rounded-lg p-3 border border-gray-100">`;
            html += `<div class="flex items-center gap-2 mb-1">`;
            html += `<i class="fa-solid ${icon} text-indigo-500 text-sm"></i>`;
            html += `<span class="text-xs text-gray-600 font-medium">${header}</span>`;
            html += `</div>`;
            html += `<div class="text-lg font-bold ${titleColor}">${formattedValue}</div>`;
            html += `</div>`;
        }
        html += `</div>`;
        
        html += `</div>`;
    }
    html += '</div>';
    
    return html;
}

/**
 * Render bảng Báo cáo Ngày (desktop view)
 * @param {Array} dataArray - Mảng chứa headers và data rows
 * @param {Set} reportedTvbhSet - Set chứa các TVBH đã báo cáo (để tô đỏ những TVBH chưa báo cáo)
 */
function createDailyTable(dataArray, reportedTvbhSet = null) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    let html = '<div class="hidden lg:block overflow-x-auto border border-gray-200 rounded-lg" style="-webkit-overflow-scrolling: touch;">';
    html += '<table class="min-w-full divide-y divide-gray-200 text-sm">';
    
    // Header
    html += '<thead class="bg-indigo-50 sticky top-0 z-10">';
    html += '<tr>';
    dataArray[0].forEach((header, idx) => {
        const isNumeric = idx >= 2;
        html += `<th class="px-4 py-3 text-left text-xs font-bold text-indigo-800 uppercase whitespace-nowrap ${isNumeric ? 'text-right' : ''}">${header}</th>`;
    });
    html += '</tr>';
    html += '</thead>';
    
    // Body
    html += '<tbody class="bg-white divide-y divide-gray-200">';
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[0] === 'TỔNG CỘNG';
        const tvbhName = row[1];
        
        let isNotReported = false;
        if (!isTotal && reportedTvbhSet && tvbhName) {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            isNotReported = !reportedTvbhSet.has(tvbhName) && !hasData;
        }
        
        const rowClass = isTotal 
            ? 'bg-indigo-100 font-bold' 
            : isNotReported 
                ? 'bg-red-50 hover:bg-red-100' 
                : 'hover:bg-gray-50';
        
        html += `<tr class="${rowClass}">`;
        row.forEach((cell, idx) => {
            const isNumeric = idx >= 2;
            let cellValue = typeof cell === 'number' ? cell.toLocaleString('vi-VN') : cell;
            const cellClass = isTotal 
                ? 'font-bold text-indigo-900' 
                : isNotReported 
                    ? 'text-red-600 font-medium' 
                    : 'text-gray-700';
            html += `<td class="px-4 py-3 text-sm whitespace-nowrap ${isNumeric ? 'text-right' : ''} ${cellClass}">${cellValue}</td>`;
        });
        html += '</tr>';
    }
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    return html;
}

/**
 * Render MTD Total dưới dạng Cards (mobile-friendly)
 */
function createMtdTotalCards(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    const headers = dataArray[0];
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[1] === 'TỔNG CỘNG';
        const tvbhName = row[2] || row[1];
        const stt = row[0];
        
        // Card styling
        const cardBg = isTotal 
            ? 'bg-gradient-to-br from-indigo-100 to-indigo-50 border-indigo-300' 
            : 'bg-white border-gray-200';
        
        const titleColor = isTotal 
            ? 'text-indigo-900' 
            : 'text-gray-800';
        
        html += `<div class="border-2 ${cardBg} rounded-xl p-4 shadow-sm hover:shadow-md transition ${isTotal ? 'md:col-span-2 lg:col-span-3' : ''}">`;
        
        // Card header
        html += `<div class="flex items-center justify-between mb-4 pb-3 border-b ${isTotal ? 'border-indigo-300' : 'border-gray-200'}">`;
        html += `<div class="flex items-center gap-2">`;
        if (isTotal) {
            html += `<i class="fa-solid fa-calculator text-indigo-600 text-lg"></i>`;
        } else {
            html += `<span class="text-sm font-bold text-gray-500">${stt}</span>`;
        }
        html += `<h4 class="font-bold ${titleColor} text-base md:text-lg">${tvbhName}</h4>`;
        html += `</div>`;
        html += `</div>`;
        
        // Card body - metrics
        html += `<div class="space-y-3">`;
        for (let idx = 3; idx < headers.length && idx < row.length; idx++) {
            const header = headers[idx];
            const value = row[idx];
            let formattedValue = value;
            if (typeof value === 'number') {
                formattedValue = value.toLocaleString('vi-VN');
            }
            
            // Check if it's a percentage
            const isPercent = typeof value === 'string' && value.includes('%');
            const percent = isPercent ? parseFloat(value) : null;
            
            // Color based on percentage
            let valueColor = titleColor;
            let bgColor = 'bg-gray-50';
            if (isPercent && percent !== null) {
                if (percent >= 100) {
                    valueColor = 'text-green-600';
                    bgColor = 'bg-green-50';
                } else if (percent >= 80) {
                    valueColor = 'text-yellow-600';
                    bgColor = 'bg-yellow-50';
                }
            }
            
            // Icon mapping
            const iconMap = {
                'KHTN': 'fa-users',
                'Hợp đồng': 'fa-file-contract',
                'Xuất HĐ': 'fa-file-export',
                'Doanh thu': 'fa-money-bill-wave',
                'Thực tế': 'fa-chart-line',
                'Chỉ tiêu': 'fa-bullseye',
                'Đạt': 'fa-percent'
            };
            const icon = iconMap[header] || 'fa-chart-bar';
            
            html += `<div class="${bgColor} rounded-lg p-3 border border-gray-100">`;
            html += `<div class="flex items-center justify-between">`;
            html += `<div class="flex items-center gap-2 flex-1 min-w-0">`;
            html += `<i class="fa-solid ${icon} text-indigo-500 text-sm flex-shrink-0"></i>`;
            html += `<span class="text-xs text-gray-600 font-medium truncate">${header}</span>`;
            html += `</div>`;
            html += `<div class="text-base md:text-lg font-bold ${valueColor} ml-2">${formattedValue}</div>`;
            html += `</div>`;
            html += `</div>`;
        }
        html += `</div>`;
        
        html += `</div>`;
    }
    html += '</div>';
    
    return html;
}

/**
 * Render bảng MTD Tổng (desktop view)
 */
function createMtdTotalTable(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        return '<p class="text-center text-gray-500 py-8 text-sm md:text-base">Không có dữ liệu</p>';
    }

    let html = '<div class="hidden lg:block overflow-x-auto border border-gray-200 rounded-lg" style="-webkit-overflow-scrolling: touch;">';
    html += '<table class="min-w-full divide-y divide-gray-200 text-sm">';
    
    // Header
    html += '<thead class="bg-indigo-50 sticky top-0 z-10">';
    html += '<tr>';
    dataArray[0].forEach((header, idx) => {
        const isNumeric = idx >= 3;
        html += `<th class="px-3 py-3 text-left text-xs font-bold text-indigo-800 uppercase whitespace-nowrap ${isNumeric ? 'text-right' : ''}">${header}</th>`;
    });
    html += '</tr>';
    html += '</thead>';
    
    // Body
    html += '<tbody class="bg-white divide-y divide-gray-200">';
    for (let i = 1; i < dataArray.length; i++) {
        const row = dataArray[i];
        const isTotal = row[1] === 'TỔNG CỘNG';
        html += `<tr class="${isTotal ? 'bg-indigo-100 font-bold hover:bg-indigo-200' : 'hover:bg-gray-50'}">`;
        row.forEach((cell, idx) => {
            const isNumeric = idx >= 3;
            let cellValue = cell;
            if (typeof cell === 'number') {
                cellValue = cell.toLocaleString('vi-VN');
            }
            // Highlight phần trăm >= 100%
            if (typeof cell === 'string' && cell.includes('%')) {
                const percent = parseFloat(cell);
                const highlightClass = percent >= 100 ? 'text-green-600 font-bold' : percent >= 80 ? 'text-yellow-600' : 'text-gray-700';
                html += `<td class="px-3 py-3 text-sm text-right whitespace-nowrap ${highlightClass} ${isTotal ? 'font-bold' : ''}">${cellValue}</td>`;
            } else {
                html += `<td class="px-3 py-3 text-sm ${isNumeric ? 'text-right' : ''} whitespace-nowrap ${isTotal ? 'font-bold text-indigo-900' : 'text-gray-700'}">${cellValue}</td>`;
            }
        });
        html += '</tr>';
    }
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    return html;
}

/**
 * Tạo Summary Cards hiển thị tổng hợp
 */
function createSummaryCards(daily, reportedTvbhSet) {
    if (!daily || daily.length === 0) {
        return '';
    }
    
    // Đếm tổng số TVBH (bỏ qua dòng TỔNG CỘNG)
    const totalTvbh = daily.length - 2; // -2 vì có header và TỔNG CỘNG
    
    // Convert reportedTvbhSet to Set nếu cần
    const reportedSet = reportedTvbhSet 
        ? (reportedTvbhSet instanceof Set ? reportedTvbhSet : new Set(reportedTvbhSet))
        : new Set();
    
    // Đếm số TVBH đã báo cáo
    let reportedCount = 0;
    for (let i = 1; i < daily.length - 1; i++) { // Bỏ qua header và TỔNG CỘNG
        const row = daily[i];
        const tvbhName = row[1];
        if (tvbhName && tvbhName !== 'TỔNG CỘNG') {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            if (reportedSet.has(tvbhName) || hasData) {
                reportedCount++;
            }
        }
    }
    
    const notReportedCount = totalTvbh - reportedCount;
    const reportRate = totalTvbh > 0 ? ((reportedCount / totalTvbh) * 100).toFixed(1) : 0;
    
    let html = '<div class="mb-6 md:mb-8">';
    html += '<h3 class="text-base md:text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">';
    html += '<i class="fa-solid fa-chart-bar text-indigo-600"></i>';
    html += '<span>Tổng Quan</span>';
    html += '</h3>';
    html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';
    
    // Card 1: Tổng số TVBH
    html += '<div class="bg-gradient-to-br from-indigo-50 to-indigo-100 border-2 border-indigo-200 rounded-xl p-4 shadow-sm hover:shadow-md transition">';
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<p class="text-xs text-indigo-600 font-medium mb-1">Tổng số TVBH</p>';
    html += `<p class="text-2xl md:text-3xl font-bold text-indigo-900">${totalTvbh}</p>`;
    html += '</div>';
    html += '<i class="fa-solid fa-users text-indigo-400 text-3xl"></i>';
    html += '</div>';
    html += '</div>';
    
    // Card 2: Đã báo cáo
    html += '<div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-4 shadow-sm hover:shadow-md transition">';
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<p class="text-xs text-green-600 font-medium mb-1">Đã báo cáo</p>';
    html += `<p class="text-2xl md:text-3xl font-bold text-green-900">${reportedCount}</p>`;
    html += '</div>';
    html += '<i class="fa-solid fa-check-circle text-green-400 text-3xl"></i>';
    html += '</div>';
    html += '</div>';
    
    // Card 3: Chưa báo cáo
    html += '<div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-xl p-4 shadow-sm hover:shadow-md transition">';
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<p class="text-xs text-red-600 font-medium mb-1">Chưa báo cáo</p>';
    html += `<p class="text-2xl md:text-3xl font-bold text-red-900">${notReportedCount}</p>`;
    html += '</div>';
    html += '<i class="fa-solid fa-exclamation-triangle text-red-400 text-3xl"></i>';
    html += '</div>';
    html += '</div>';
    
    // Card 4: Tỷ lệ báo cáo
    const rateColor = reportRate >= 80 ? 'text-green-600' : reportRate >= 50 ? 'text-yellow-600' : 'text-red-600';
    const rateBg = reportRate >= 80 ? 'from-green-50 to-green-100 border-green-200' : reportRate >= 50 ? 'from-yellow-50 to-yellow-100 border-yellow-200' : 'from-red-50 to-red-100 border-red-200';
    html += `<div class="bg-gradient-to-br ${rateBg} border-2 rounded-xl p-4 shadow-sm hover:shadow-md transition">`;
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<p class="text-xs text-gray-600 font-medium mb-1">Tỷ lệ báo cáo</p>';
    html += `<p class="text-2xl md:text-3xl font-bold ${rateColor}">${reportRate}%</p>`;
    html += '</div>';
    html += '<i class="fa-solid fa-chart-pie text-gray-400 text-3xl"></i>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    
    return html;
}

/**
 * Tạo bảng danh sách TVBH chưa báo cáo
 */
function createNotReportedTable(daily, reportedTvbhSet) {
    if (!daily || daily.length === 0) {
        return '';
    }
    
    // Convert reportedTvbhSet to Set nếu cần
    const reportedSet = reportedTvbhSet 
        ? (reportedTvbhSet instanceof Set ? reportedTvbhSet : new Set(reportedTvbhSet))
        : new Set();
    
    // Lọc danh sách TVBH chưa báo cáo
    const notReportedList = [];
    for (let i = 1; i < daily.length - 1; i++) { // Bỏ qua header và TỔNG CỘNG
        const row = daily[i];
        const tvbhName = row[1];
        const group = row[0];
        
        if (tvbhName && tvbhName !== 'TỔNG CỘNG') {
            const hasData = row.slice(2).some(val => {
                if (typeof val === 'number') return val > 0;
                if (typeof val === 'string') {
                    const numVal = parseFloat(val.replace(/[^0-9.-]/g, ''));
                    return !isNaN(numVal) && numVal > 0;
                }
                return false;
            });
            
            if (!reportedSet.has(tvbhName) && !hasData) {
                notReportedList.push({
                    group: group || '',
                    tvbh: tvbhName
                });
            }
        }
    }
    
    if (notReportedList.length === 0) {
        return '<div class="mb-6 md:mb-8 bg-green-50 border-2 border-green-200 rounded-xl p-6 text-center">' +
               '<i class="fa-solid fa-check-circle text-green-500 text-4xl mb-3"></i>' +
               '<p class="text-green-800 font-bold text-lg">Tất cả TVBH đã báo cáo!</p>' +
               '<p class="text-green-600 text-sm mt-2">Không có TVBH nào chưa báo cáo trong ngày này.</p>' +
               '</div>';
    }
    
    let html = '<div class="mb-6 md:mb-8">';
    html += '<h3 class="text-base md:text-lg font-bold text-red-800 mb-3 md:mb-4 flex items-center gap-2">';
    html += '<i class="fa-solid fa-exclamation-triangle text-red-600"></i>';
    html += `<span>Danh Sách TVBH Chưa Báo Cáo (${notReportedList.length} người)</span>`;
    html += '</h3>';
    
    // Mobile: Cards view
    html += '<div class="lg:hidden">';
    html += '<div class="grid grid-cols-1 gap-3">';
    notReportedList.forEach((item, index) => {
        html += '<div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-md transition">';
        html += '<div class="flex items-center justify-between">';
        html += '<div class="flex items-center gap-3">';
        html += `<span class="text-sm font-bold text-gray-500">${index + 1}</span>`;
        html += '<div>';
        html += `<p class="font-bold text-red-800">${item.tvbh}</p>`;
        if (item.group) {
            html += `<p class="text-xs text-gray-600">${item.group}</p>`;
        }
        html += '</div>';
        html += '</div>';
        html += '<span class="bg-red-200 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">Chưa báo cáo</span>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    html += '</div>';
    
    // Desktop: Table view
    html += '<div class="hidden lg:block overflow-x-auto border-2 border-red-200 rounded-lg">';
    html += '<table class="min-w-full divide-y divide-red-200 text-sm">';
    html += '<thead class="bg-red-100 sticky top-0 z-10">';
    html += '<tr>';
    html += '<th class="px-4 py-3 text-left text-xs font-bold text-red-800 uppercase">STT</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-bold text-red-800 uppercase">Nhóm</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-bold text-red-800 uppercase">TVBH</th>';
    html += '<th class="px-4 py-3 text-center text-xs font-bold text-red-800 uppercase">Trạng thái</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody class="bg-white divide-y divide-red-100">';
    notReportedList.forEach((item, index) => {
        html += '<tr class="hover:bg-red-50">';
        html += `<td class="px-4 py-3 text-sm font-medium text-gray-700">${index + 1}</td>`;
        html += `<td class="px-4 py-3 text-sm text-gray-700">${item.group || '-'}</td>`;
        html += `<td class="px-4 py-3 text-sm font-bold text-red-700">${item.tvbh}</td>`;
        html += '<td class="px-4 py-3 text-center">';
        html += '<span class="bg-red-200 text-red-800 text-xs font-semibold px-3 py-1 rounded-full">Chưa báo cáo</span>';
        html += '</td>';
        html += '</tr>';
    });
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    html += '</div>';
    
    return html;
}

/**
 * Filter MTD data theo nhóm và TVBH
 */
function filterMtdData(mtdTotal, filterGroup, filterTvbh) {
    if (!mtdTotal || mtdTotal.length === 0) {
        return mtdTotal;
    }
    
    const headers = mtdTotal[0];
    const filtered = [headers];
    const hasFilter = (filterGroup && filterGroup !== '') || (filterTvbh && filterTvbh !== '');
    
    for (let i = 1; i < mtdTotal.length; i++) {
        const row = mtdTotal[i];
        const isTotal = row[1] === 'TỔNG CỘNG';
        const group = row[1] || '';
        const tvbh = row[2] || '';
        
        // Ẩn dòng TỔNG CỘNG nếu có filter (vì tổng không còn chính xác)
        if (isTotal) {
            if (!hasFilter) {
                filtered.push(row);
            }
            continue;
        }
        
        // Filter theo nhóm
        if (filterGroup && filterGroup !== '' && group !== filterGroup) {
            continue;
        }
        
        // Filter theo TVBH
        if (filterTvbh && filterTvbh !== '' && tvbh !== filterTvbh) {
            continue;
        }
        
        filtered.push(row);
    }
    
    return filtered;
}

async function loadReportsDashboard() {
    const filterDate = document.getElementById('dashboard-date-filter').value || null;
    const filterMonth = document.getElementById('dashboard-month-filter').value || null;
    const filterGroup = document.getElementById('dashboard-mtd-group-filter')?.value || null;
    const filterTvbh = document.getElementById('dashboard-mtd-tvbh-filter')?.value || null;
    
    const loadingEl = document.getElementById('dashboard-loading');
    const contentEl = document.getElementById('dashboard-content');
    
    if (!loadingEl || !contentEl) {
        console.error('[Dashboard] Elements not found');
        return;
    }
    
    loadingEl.classList.remove('hidden');
    contentEl.innerHTML = '';

    try {
        const result = await window.callAPI({
            action: 'get_dashboard_data',
            filterDate: filterDate,
            filterMonth: filterMonth
        });

        loadingEl.classList.add('hidden');

        if (result.success && result.data) {
            const { daily, mtdTotal, reportedTvbhSet } = result.data;
            
            // Format date string for display
            let dateDisplay = 'Hôm Nay';
            if (filterDate) {
                const date = new Date(filterDate);
                dateDisplay = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            
            // Convert reportedTvbhSet to Set if it's an array
            const reportedSet = reportedTvbhSet 
                ? (reportedTvbhSet instanceof Set ? reportedTvbhSet : new Set(reportedTvbhSet))
                : null;
            
            // Populate filter dropdowns từ dữ liệu
            populateMtdFilters(daily, mtdTotal, filterGroup, filterTvbh);
            
            // Filter MTD data
            const filteredMtdTotal = filterMtdData(mtdTotal, filterGroup, filterTvbh);
            
            let html = '';
            
            // PHẦN MỚI: Summary Cards
            html += createSummaryCards(daily, reportedSet);
            
            // PHẦN MỚI: Bảng TVBH chưa báo cáo
            html += createNotReportedTable(daily, reportedSet);
            
            // Bảng 1: Báo cáo Ngày
            html += '<div class="mb-6 md:mb-8">';
            html += '<h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4 flex items-center gap-2 flex-wrap">';
            html += '<i class="fa-solid fa-calendar-day text-indigo-600"></i>';
            html += `<span class="break-words">Báo Cáo Ngày (${dateDisplay})</span>`;
            html += '</h3>';
            
            // Mobile: Cards view, Desktop: Table view
            html += '<div class="lg:hidden">';
            html += createDailyCards(daily, reportedSet);
            html += '</div>';
            html += createDailyTable(daily, reportedSet);
            html += '<p class="text-xs text-gray-500 mt-3 px-1"><i class="fa-solid fa-info-circle mr-1"></i>TVBH được tô đỏ là những người chưa thực hiện báo cáo trong ngày này</p>';
            html += '</div>';
            
            // Bảng 2: MTD Tổng
            html += '<div>';
            html += '<h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4 flex items-center gap-2 flex-wrap">';
            html += '<i class="fa-solid fa-chart-line text-indigo-600"></i>';
            html += '<span class="break-words">Báo Cáo MTD Tổng Hợp (Từ Đầu Tháng)</span>';
            if (filterGroup || filterTvbh) {
                html += '<span class="text-xs text-gray-500 ml-2">(Đã lọc)</span>';
            }
            html += '</h3>';
            // Mobile: Cards view, Desktop: Table view
            html += '<div class="lg:hidden">';
            html += createMtdTotalCards(filteredMtdTotal);
            html += '</div>';
            html += createMtdTotalTable(filteredMtdTotal);
            html += '</div>';
            
            contentEl.innerHTML = html;
        } else {
            contentEl.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="font-bold">Lỗi: ${result.message || 'Không thể tải dữ liệu'}</p>
                </div>
            `;
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể tải dữ liệu'), 'danger');
            }
        }
    } catch (error) {
        console.error('[Dashboard] Error loading dashboard:', error);
        loadingEl.classList.add('hidden');
        contentEl.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">Lỗi: ${error.message || 'Không thể tải dữ liệu'}</p>
            </div>
        `;
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
    }
}

/**
 * Set ngày về hôm nay và reload dashboard
 */
function setTodayDate() {
    const dateInput = document.getElementById('dashboard-date-filter');
    if (dateInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
        loadReportsDashboard();
    }
}

/**
 * Populate filter dropdowns cho MTD
 */
function populateMtdFilters(daily, mtdTotal, selectedGroup, selectedTvbh) {
    // Lấy danh sách nhóm và TVBH từ mtdTotal data
    const groups = new Set();
    const tvbhs = new Set();
    
    if (mtdTotal && mtdTotal.length > 1) {
        for (let i = 1; i < mtdTotal.length; i++) {
            const row = mtdTotal[i];
            const isTotal = row[1] === 'TỔNG CỘNG';
            if (isTotal) continue;
            
            const group = row[1] || '';
            const tvbh = row[2] || '';
            
            if (group && group !== '') {
                groups.add(group);
            }
            if (tvbh && tvbh !== '') {
                tvbhs.add({ value: tvbh, text: tvbh, group: group });
            }
        }
    }
    
    // Fallback: nếu mtdTotal không có dữ liệu, lấy từ daily
    if (groups.size === 0 && daily && daily.length > 1) {
        for (let i = 1; i < daily.length - 1; i++) {
            const row = daily[i];
            if (row[0] && row[0] !== 'TỔNG CỘNG') {
                groups.add(row[0]);
            }
            if (row[1] && row[1] !== 'TỔNG CỘNG') {
                tvbhs.add({ value: row[1], text: row[1], group: row[0] });
            }
        }
    }
    
    // Populate group filter
    const groupSelect = document.getElementById('dashboard-mtd-group-filter');
    if (groupSelect) {
        const currentValue = groupSelect.value;
        groupSelect.innerHTML = '<option value="">Tất cả nhóm</option>';
        Array.from(groups).sort().forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            if (group === selectedGroup || (!selectedGroup && group === currentValue)) {
                option.selected = true;
            }
            groupSelect.appendChild(option);
        });
    }
    
    // Populate TVBH filter
    const tvbhSelect = document.getElementById('dashboard-mtd-tvbh-filter');
    if (tvbhSelect) {
        const currentValue = tvbhSelect.value;
        tvbhSelect.innerHTML = '<option value="">Tất cả TVBH</option>';
        Array.from(tvbhs).sort((a, b) => {
            if (a.group !== b.group) {
                return (a.group || '').localeCompare(b.group || '');
            }
            return a.text.localeCompare(b.text);
        }).forEach(tvbh => {
            const option = document.createElement('option');
            option.value = tvbh.value;
            option.textContent = `${tvbh.text}${tvbh.group ? ' (' + tvbh.group + ')' : ''}`;
            if (tvbh.value === selectedTvbh || (!selectedTvbh && tvbh.value === currentValue)) {
                option.selected = true;
            }
            tvbhSelect.appendChild(option);
        });
    }
}

// Expose functions globally
if (typeof window !== 'undefined') {
    window.loadReportsDashboard = loadReportsDashboard;
    window.createDailyTable = createDailyTable;
    window.createDailyCards = createDailyCards;
    window.createMtdTotalTable = createMtdTotalTable;
    window.createMtdTotalCards = createMtdTotalCards;
    window.createSummaryCards = createSummaryCards;
    window.createNotReportedTable = createNotReportedTable;
    window.filterMtdData = filterMtdData;
    window.populateMtdFilters = populateMtdFilters;
    window.setTodayDate = setTodayDate;
}

// Set default date and month to current and load on tab active
if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
        const dateInput = document.getElementById('dashboard-date-filter');
        const monthInput = document.getElementById('dashboard-month-filter');
        
        // Set default date to today
        if (dateInput && !dateInput.value) {
            const now = new Date();
            dateInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        
        // Set max date to today (không cho chọn ngày tương lai)
        if (dateInput) {
            const now = new Date();
            const maxDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            dateInput.setAttribute('max', maxDate);
        }
        
        // Set default month to current month
        if (monthInput && !monthInput.value) {
            const now = new Date();
            monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        // Load dashboard when tab becomes active
        const observer = new MutationObserver((mutations) => {
            const tab = document.getElementById('tab-reports-dashboard');
            if (tab && tab.classList.contains('active')) {
                const contentEl = document.getElementById('dashboard-content');
                if (contentEl && (!contentEl.innerHTML || contentEl.innerHTML.trim() === '' || contentEl.innerHTML.includes('đang được phát triển'))) {
                    loadReportsDashboard();
                }
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container && container.parentElement) {
            observer.observe(container.parentElement, {
                attributes: true,
                attributeFilter: ['class'],
                subtree: true
            });
        }
    });
}
</script>

