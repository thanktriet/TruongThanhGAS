<!-- Modal Đổi Mật Khẩu -->
<div id="modal-change-password" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white bg-opacity-20 rounded-full p-2">
                        <i class="fa-solid fa-key text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Đổi Mật Khẩu</h3>
                        <p class="text-blue-100 text-sm">Bảo vệ tài khoản của bạn</p>
                    </div>
                </div>
                <button onclick="closeChangePasswordModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="p-6">
            <form id="form-change-password" onsubmit="handleChangePasswordSubmit(event)" class="space-y-5">
                <!-- Mật khẩu cũ -->
                <div id="old-password-section">
                    <label for="old-password" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fa-solid fa-lock mr-2 text-gray-500"></i>
                        Mật khẩu hiện tại
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="old-password" 
                            name="old-password"
                            class="input w-full pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Nhập mật khẩu hiện tại"
                            required
                        >
                        <button 
                            type="button" 
                            onclick="togglePasswordVisibility('old-password', 'old-password-toggle')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            id="old-password-toggle"
                        >
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Mật khẩu mới -->
                <div>
                    <label for="new-password" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fa-solid fa-key mr-2 text-gray-500"></i>
                        Mật khẩu mới
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="new-password" 
                            name="new-password"
                            class="input w-full pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Tối thiểu 6 ký tự"
                            minlength="6"
                            required
                        >
                        <button 
                            type="button" 
                            onclick="togglePasswordVisibility('new-password', 'new-password-toggle')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            id="new-password-toggle"
                        >
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <div id="password-strength" class="mt-2 hidden">
                        <div class="flex items-center gap-2 text-xs">
                            <div class="flex-1 h-1 bg-gray-200 rounded-full overflow-hidden">
                                <div id="password-strength-bar" class="h-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="password-strength-text" class="text-gray-600"></span>
                        </div>
                    </div>
                </div>

                <!-- Xác nhận mật khẩu mới -->
                <div>
                    <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fa-solid fa-check-double mr-2 text-gray-500"></i>
                        Xác nhận mật khẩu mới
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="confirm-password" 
                            name="confirm-password"
                            class="input w-full pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Nhập lại mật khẩu mới"
                            required
                        >
                        <button 
                            type="button" 
                            onclick="togglePasswordVisibility('confirm-password', 'confirm-password-toggle')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            id="confirm-password-toggle"
                        >
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <div id="password-match" class="mt-2 text-sm hidden">
                        <i class="fa-solid fa-check-circle text-green-500 mr-1"></i>
                        <span class="text-green-600">Mật khẩu khớp</span>
                    </div>
                </div>

                <!-- Error message -->
                <div id="change-password-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 text-red-700">
                        <i class="fa-solid fa-exclamation-circle"></i>
                        <span id="change-password-error-text" class="text-sm"></span>
                    </div>
                </div>

                <!-- Success message -->
                <div id="change-password-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 text-green-700">
                        <i class="fa-solid fa-check-circle"></i>
                        <span id="change-password-success-text" class="text-sm"></span>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-2">
                    <button 
                        type="button" 
                        onclick="closeChangePasswordModal()"
                        class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 active:bg-gray-300 transition"
                    >
                        Hủy
                    </button>
                    <button 
                        type="submit" 
                        id="change-password-submit"
                        class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 active:from-blue-800 active:to-indigo-800 transition shadow-md hover:shadow-lg"
                    >
                        <span id="change-password-submit-text">
                            <i class="fa-solid fa-key mr-2"></i>Đổi Mật Khẩu
                        </span>
                        <span id="change-password-submit-loading" class="hidden">
                            <i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang xử lý...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Toggle password visibility
function togglePasswordVisibility(inputId, toggleId) {
    const input = document.getElementById(inputId);
    const toggle = document.getElementById(toggleId);
    
    if (input.type === 'password') {
        input.type = 'text';
        toggle.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
    } else {
        input.type = 'password';
        toggle.innerHTML = '<i class="fa-solid fa-eye"></i>';
    }
}

// Check password strength
function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = '';
    
    if (password.length >= 6) strength++;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    const strengthLabels = ['Rất yếu', 'Yếu', 'Trung bình', 'Mạnh', 'Rất mạnh'];
    const strengthColors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];
    
    if (strength > 0) {
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        const strengthDiv = document.getElementById('password-strength');
        
        if (strengthBar && strengthText && strengthDiv) {
            strengthDiv.classList.remove('hidden');
            const percentage = (strength / 5) * 100;
            strengthBar.style.width = percentage + '%';
            strengthBar.className = `h-full transition-all duration-300 ${strengthColors[strength - 1]}`;
            strengthText.textContent = strengthLabels[strength - 1];
        }
    } else {
        const strengthDiv = document.getElementById('password-strength');
        if (strengthDiv) strengthDiv.classList.add('hidden');
    }
}

// Check password match
function checkPasswordMatch() {
    const newPassword = document.getElementById('new-password')?.value || '';
    const confirmPassword = document.getElementById('confirm-password')?.value || '';
    const matchDiv = document.getElementById('password-match');
    
    if (confirmPassword && newPassword === confirmPassword) {
        if (matchDiv) {
            matchDiv.classList.remove('hidden');
            matchDiv.innerHTML = '<i class="fa-solid fa-check-circle text-green-500 mr-1"></i><span class="text-green-600">Mật khẩu khớp</span>';
        }
    } else if (confirmPassword && newPassword !== confirmPassword) {
        if (matchDiv) {
            matchDiv.classList.remove('hidden');
            matchDiv.innerHTML = '<i class="fa-solid fa-times-circle text-red-500 mr-1"></i><span class="text-red-600">Mật khẩu không khớp</span>';
        }
    } else {
        if (matchDiv) matchDiv.classList.add('hidden');
    }
}

// Close modal
function closeChangePasswordModal() {
    const modal = document.getElementById('modal-change-password');
    if (modal) {
        modal.classList.add('hidden');
        // Reset form
        const form = document.getElementById('form-change-password');
        if (form) form.reset();
        // Hide messages
        document.getElementById('change-password-error')?.classList.add('hidden');
        document.getElementById('change-password-success')?.classList.add('hidden');
        document.getElementById('password-strength')?.classList.add('hidden');
        document.getElementById('password-match')?.classList.add('hidden');
    }
}

// Open modal (can be called from profile page)
function openChangePasswordModal(isFirstLogin = false) {
    const modal = document.getElementById('modal-change-password');
    const oldPasswordSection = document.getElementById('old-password-section');
    
    if (modal) {
        // Hide old password section if first login
        if (isFirstLogin && oldPasswordSection) {
            oldPasswordSection.classList.add('hidden');
            const oldPasswordInput = document.getElementById('old-password');
            if (oldPasswordInput) oldPasswordInput.removeAttribute('required');
        } else if (oldPasswordSection) {
            oldPasswordSection.classList.remove('hidden');
            const oldPasswordInput = document.getElementById('old-password');
            if (oldPasswordInput) oldPasswordInput.setAttribute('required', 'required');
        }
        
        modal.classList.remove('hidden');
        // Focus on first input
        setTimeout(() => {
            const firstInput = isFirstLogin 
                ? document.getElementById('new-password')
                : document.getElementById('old-password');
            if (firstInput) firstInput.focus();
        }, 100);
    }
}

// Handle form submit
async function handleChangePasswordSubmit(event) {
    event.preventDefault();
    
    const oldPassword = document.getElementById('old-password')?.value || '';
    const newPassword = document.getElementById('new-password')?.value || '';
    const confirmPassword = document.getElementById('confirm-password')?.value || '';
    const errorDiv = document.getElementById('change-password-error');
    const errorText = document.getElementById('change-password-error-text');
    const successDiv = document.getElementById('change-password-success');
    const submitBtn = document.getElementById('change-password-submit');
    const submitText = document.getElementById('change-password-submit-text');
    const submitLoading = document.getElementById('change-password-submit-loading');
    
    // Hide previous messages
    if (errorDiv) errorDiv.classList.add('hidden');
    if (successDiv) successDiv.classList.add('hidden');
    
    // Validation
    if (!newPassword || newPassword.length < 6) {
        if (errorDiv && errorText) {
            errorText.textContent = 'Mật khẩu mới phải có ít nhất 6 ký tự';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    if (newPassword !== confirmPassword) {
        if (errorDiv && errorText) {
            errorText.textContent = 'Mật khẩu xác nhận không khớp';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    // Check if old password is required (not first login)
    const oldPasswordSection = document.getElementById('old-password-section');
    const isFirstLogin = oldPasswordSection?.classList.contains('hidden');
    
    if (!isFirstLogin && !oldPassword) {
        if (errorDiv && errorText) {
            errorText.textContent = 'Vui lòng nhập mật khẩu hiện tại';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    // Disable submit button
    if (submitBtn) submitBtn.disabled = true;
    if (submitText) submitText.classList.add('hidden');
    if (submitLoading) submitLoading.classList.remove('hidden');
    
    try {
        const session = typeof getSession === 'function' ? getSession() : (() => {
            try {
                const sessionStr = localStorage.getItem('user_session');
                return sessionStr ? JSON.parse(sessionStr) : null;
            } catch (e) {
                return null;
            }
        })();
        
        if (!session || !session.username) {
            throw new Error('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
        }
        
        const result = await window.callAPI({
            action: 'change_password',
            username: session.username,
            old_pass: oldPassword,
            new_pass: newPassword
        });
        
        if (result.success) {
            // Show success message
            if (successDiv) {
                const successText = document.getElementById('change-password-success-text');
                if (successText) successText.textContent = result.message || 'Đã đổi mật khẩu thành công';
                successDiv.classList.remove('hidden');
            }
            
            // Update session if user data returned
            if (result.user) {
                const updatedSession = {
                    ...session,
                    ...result.user,
                    login_time: session.login_time || new Date().toISOString()
                };
                localStorage.setItem('user_session', JSON.stringify(updatedSession));
            } else {
                // Update need_change_pass to false
                session.need_change_pass = false;
                localStorage.setItem('user_session', JSON.stringify(session));
            }
            
            // Close modal after 1.5 seconds
            setTimeout(() => {
                closeChangePasswordModal();
                if (isFirstLogin) {
                    // Reload page if first login
                    location.reload();
                }
            }, 1500);
        } else {
            // Show error
            if (errorDiv && errorText) {
                errorText.textContent = result.message || 'Đổi mật khẩu thất bại';
                errorDiv.classList.remove('hidden');
            }
        }
    } catch (error) {
        console.error('Change password error:', error);
        if (errorDiv && errorText) {
            errorText.textContent = error.message || 'Không thể kết nối đến server';
            errorDiv.classList.remove('hidden');
        }
    } finally {
        // Re-enable submit button
        if (submitBtn) submitBtn.disabled = false;
        if (submitText) submitText.classList.remove('hidden');
        if (submitLoading) submitLoading.classList.add('hidden');
    }
}

// Setup event listeners for password strength and match checking
if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', () => {
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', (e) => {
                checkPasswordStrength(e.target.value);
                checkPasswordMatch();
            });
        }
        
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        }
    });
    
    // Export functions to window
    window.openChangePasswordModal = openChangePasswordModal;
    window.closeChangePasswordModal = closeChangePasswordModal;
    window.handleChangePasswordSubmit = handleChangePasswordSubmit;
    window.togglePasswordVisibility = togglePasswordVisibility;
}
</script>

