<div id="tab-my-orders" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
            <h2 class="text-lg font-bold text-blue-800">
                <i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng Của Tôi
            </h2>
        </div>
        <div class="p-6">
            <!-- Filter -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                    <label class="label text-xs">Lọc theo trạng thái:</label>
                    <select id="filter-status" class="input bg-white text-sm" onchange="loadMyOrders()">
                        <option value="">Tất cả</option>
                        <option value="pending">Chưa có mã</option>
                        <option value="assigned">Đã có mã</option>
                    </select>
                </div>
                <div>
                    <label class="label text-xs">Tìm kiếm:</label>
                    <input 
                        type="text" 
                        id="search-orders" 
                        class="input text-sm" 
                        placeholder="Tên KH, CCCD, mã đơn..."
                        onkeyup="filterOrders()"
                    >
                </div>
                <div class="md:col-span-2 flex items-end">
                    <button 
                        onclick="loadMyOrders()" 
                        class="bg-blue-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Làm mới
                    </button>
                </div>
            </div>

            <!-- Orders List -->
            <div id="orders-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <div id="orders-list" class="space-y-3">
                <!-- Orders will be loaded here -->
            </div>

            <div id="orders-empty" class="text-center py-12 hidden">
                <i class="fa-solid fa-inbox text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">Chưa có đơn hàng nào</p>
            </div>
        </div>
    </div>
</div>

<script>
let allOrders = [];

// Expose allOrders to window for modals to access
if (typeof window !== 'undefined') {
    window.allOrders = allOrders;
    Object.defineProperty(window, 'allOrders', {
        get: () => allOrders,
        set: (value) => { allOrders = value; },
        enumerable: true,
        configurable: true
    });
}

// Load my orders
async function loadMyOrders() {
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        showToast('Vui lòng đăng nhập lại', 'danger');
        return;
    }

    document.getElementById('orders-loading').classList.remove('hidden');
    document.getElementById('orders-list').innerHTML = '';
    document.getElementById('orders-empty').classList.add('hidden');

    const filterStatus = document.getElementById('filter-status').value;
    const filters = {};
    
    if (filterStatus === 'pending') {
        filters.has_contract_code = false;
    } else if (filterStatus === 'assigned') {
        filters.has_contract_code = true;
    }

    const result = await window.callAPI({
        action: 'get_my_orders',
        username: session.username,
        filters: filters
    });

    document.getElementById('orders-loading').classList.add('hidden');

    if (result.success && result.data && result.data.length > 0) {
        allOrders = result.data;
        // Update window.allOrders
        if (typeof window !== 'undefined') {
            Object.defineProperty(window, 'allOrders', {
                get: () => allOrders,
                set: (value) => { allOrders = value; },
                enumerable: true,
                configurable: true
            });
        }
        renderOrders(allOrders);
        document.getElementById('orders-empty').classList.add('hidden');
    } else {
        allOrders = [];
        if (typeof window !== 'undefined') {
            Object.defineProperty(window, 'allOrders', {
                get: () => allOrders,
                set: (value) => { allOrders = value; },
                enumerable: true,
                configurable: true
            });
        }
        document.getElementById('orders-list').innerHTML = '';
        document.getElementById('orders-empty').classList.remove('hidden');
    }
}

// Render orders
function renderOrders(orders) {
    const container = document.getElementById('orders-list');
    container.innerHTML = '';

    orders.forEach(order => {
        const customer = order.customers || {};
        const hasContractCode = order.contract_code && order.contract_code.trim();
        
        const orderCard = document.createElement('div');
        orderCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition';
        orderCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="font-bold text-gray-800 text-lg">${customer.name || 'Chưa có tên'}</h3>
                        ${hasContractCode ? `
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">
                                <i class="fa-solid fa-check-circle mr-1"></i>Đã có mã
                            </span>
                        ` : `
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">
                                <i class="fa-solid fa-clock mr-1"></i>Chờ cấp mã
                            </span>
                        `}
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600">
                        <div>
                            <span class="font-medium">CCCD:</span> ${customer.cccd || '-'}
                        </div>
                        <div>
                            <span class="font-medium">SĐT:</span> ${customer.phone || '-'}
                        </div>
                        <div>
                            <span class="font-medium">Xe:</span> ${order.car_model || '-'} ${order.car_version ? `(${order.car_version})` : ''}
                        </div>
                        <div>
                            <span class="font-medium">Màu:</span> ${order.car_color || '-'}
                        </div>
                        ${hasContractCode ? `
                            <div class="md:col-span-2">
                                <span class="font-medium">Mã đơn hàng:</span> 
                                <span class="font-bold text-blue-600">${order.contract_code}</span>
                            </div>
                        ` : ''}
                        <div class="md:col-span-2">
                            <span class="font-medium">Ngày tạo:</span> ${formatDate(order.created_at)}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 pt-3 border-t border-gray-200">
                <button 
                    onclick="viewOrderDetail('${order.id}')" 
                    class="flex-1 bg-blue-600 text-white font-bold px-4 py-2 rounded hover:bg-blue-700 transition text-sm"
                >
                    <i class="fa-solid fa-eye mr-2"></i>Xem chi tiết
                </button>
                ${hasContractCode ? `
                    <button 
                        onclick="createApprovalFromOrder('${order.id}')" 
                        class="flex-1 bg-green-600 text-white font-bold px-4 py-2 rounded hover:bg-green-700 transition text-sm"
                    >
                        <i class="fa-solid fa-file-circle-plus mr-2"></i>Tạo tờ trình
                    </button>
                    <button 
                        onclick="createContractFromOrder('${order.id}')" 
                        class="flex-1 bg-purple-600 text-white font-bold px-4 py-2 rounded hover:bg-purple-700 transition text-sm"
                    >
                        <i class="fa-solid fa-file-contract mr-2"></i>Tạo HĐMB
                    </button>
                    <button 
                        onclick="createAgreementFromOrder('${order.id}')" 
                        class="flex-1 bg-indigo-600 text-white font-bold px-4 py-2 rounded hover:bg-indigo-700 transition text-sm"
                    >
                        <i class="fa-solid fa-handshake mr-2"></i>Thỏa thuận
                    </button>
                    <button 
                        onclick="createDeNghiFromOrder('${order.id}')" 
                        class="flex-1 bg-orange-600 text-white font-bold px-4 py-2 rounded hover:bg-orange-700 transition text-sm"
                    >
                        <i class="fa-solid fa-file-invoice-dollar mr-2"></i>Đề nghị
                    </button>
                ` : `
                    <div class="flex-1 text-xs text-gray-500 flex items-center justify-center">
                        Chờ SaleAdmin cấp mã đơn hàng
                    </div>
                `}
            </div>
        `;
        container.appendChild(orderCard);
    });
}

// Filter orders
function filterOrders() {
    const searchTerm = document.getElementById('search-orders').value.toLowerCase();
    if (!searchTerm) {
        renderOrders(allOrders);
        return;
    }

    const filtered = allOrders.filter(order => {
        const customer = order.customers || {};
        const searchText = `${customer.name || ''} ${customer.cccd || ''} ${order.contract_code || ''}`.toLowerCase();
        return searchText.includes(searchTerm);
    });

    renderOrders(filtered);
}

// View order detail
async function viewOrderDetail(orderId) {
    if (typeof window.openOrderDetailModal === 'function') {
        await window.openOrderDetailModal(orderId, false);
    } else {
        if (typeof window.showToast === 'function') {
            window.showToast('Modal chưa được load. Vui lòng reload trang.', 'warning');
        } else {
            alert('Modal chưa được load. Vui lòng reload trang.');
        }
    }
}

// Create approval from order
function createApprovalFromOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    // Chuyển sang tab tạo tờ trình và fill dữ liệu từ đơn hàng
    if (window.switchTab) {
        window.switchTab('create');
        
        // Đợi form load xong rồi auto-fill
        setTimeout(() => {
            autoFillApprovalFormFromOrder(order);
        }, 500);
    }
}

// Auto-fill approval form from order
function autoFillApprovalFormFromOrder(order) {
    const customer = order.customers || {};
    const form = document.getElementById('form-manual-create');
    if (!form) {
        showToast('Form chưa sẵn sàng. Vui lòng thử lại.', 'warning');
        return;
    }

    // Fill customer info
    const contractCodeInput = form.querySelector('input[name="contract_code"]');
    const customerNameInput = form.querySelector('input[name="customer_name"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const cccdInput = form.querySelector('input[name="cccd"]');
    const emailInput = form.querySelector('input[name="email"]');
    const addressInput = form.querySelector('input[name="address"]');
    
    if (contractCodeInput) contractCodeInput.value = order.contract_code || '';
    if (customerNameInput) customerNameInput.value = customer.name || '';
    if (phoneInput) phoneInput.value = customer.phone || '';
    if (cccdInput) cccdInput.value = customer.cccd || '';
    if (emailInput) emailInput.value = customer.email || '';
    if (addressInput) addressInput.value = customer.address || '';

    // Fill car info
    const carModelInput = form.querySelector('input[name="car_model"]');
    const carVersionInput = form.querySelector('input[name="car_version"]');
    const carColorInput = form.querySelector('input[name="car_color"]');
    const paymentMethodSelect = form.querySelector('select[name="payment_method"]');
    
    if (carModelInput) carModelInput.value = order.car_model || '';
    if (carVersionInput) carVersionInput.value = order.car_version || '';
    if (carColorInput) carColorInput.value = order.car_color || '';
    if (paymentMethodSelect && order.payment_method) {
        paymentMethodSelect.value = order.payment_method;
    }

    showToast('Đã điền sẵn thông tin từ đơn hàng. Vui lòng kiểm tra và điền thêm!', 'success');
}

// Create contract from order
function createContractFromOrder(orderId) {
    if (typeof openHDMBModal === 'function') {
        openHDMBModal(orderId);
    } else {
        showToast('Modal chưa được load. Vui lòng reload trang.', 'warning');
    }
}

// Create agreement from order
function createAgreementFromOrder(orderId) {
    if (typeof openThoaThuanModal === 'function') {
        openThoaThuanModal(orderId);
    } else {
        showToast('Modal chưa được load. Vui lòng reload trang.', 'warning');
    }
}

// Create de nghi from order
function createDeNghiFromOrder(orderId) {
    if (typeof openDeNghiModal === 'function') {
        openDeNghiModal(orderId);
    } else {
        showToast('Modal chưa được load. Vui lòng reload trang.', 'warning');
    }
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

// Auto load when tab is shown
if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
        // Load orders when tab is activated
        const observer = new MutationObserver((mutations) => {
            const myOrdersTab = document.getElementById('tab-my-orders');
            if (myOrdersTab && myOrdersTab.classList.contains('active')) {
                loadMyOrders();
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container) {
            observer.observe(container.parentElement, { 
                attributes: true, 
                attributeFilter: ['class'],
                subtree: true 
            });
        }
    });
}
</script>

