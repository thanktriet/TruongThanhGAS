<div id="tab-my-orders" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-blue-50 px-4 py-3 md:px-6 md:py-4 border-b border-blue-100">
            <h2 class="text-base md:text-lg font-bold text-blue-800">
                <i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng Của Tôi
            </h2>
        </div>
        <div class="p-3 md:p-6">
            <!-- Filter -->
            <div class="mb-4 space-y-3 md:space-y-0 md:grid md:grid-cols-4 md:gap-3">
                <div>
                    <label class="label text-xs mb-1 block">Lọc theo trạng thái:</label>
                    <select id="filter-status" class="input bg-white text-sm md:text-base w-full" onchange="loadMyOrders()">
                        <option value="">Tất cả</option>
                        <option value="pending">Chưa có mã</option>
                        <option value="assigned">Đã có mã</option>
                    </select>
                </div>
                <div>
                    <label class="label text-xs mb-1 block">Tìm kiếm:</label>
                    <input 
                        type="text" 
                        id="search-orders" 
                        class="input text-sm md:text-base w-full" 
                        placeholder="Tên KH, CCCD, mã đơn..."
                        onkeyup="filterOrders()"
                    >
                </div>
                <div class="md:col-span-2 flex items-end">
                    <button 
                        onclick="loadMyOrders()" 
                        class="w-full md:w-auto bg-blue-600 text-white font-bold px-4 py-2.5 md:py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition touch-manipulation text-sm md:text-base"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Làm mới
                    </button>
                </div>
            </div>

            <!-- Orders List -->
            <div id="orders-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <div id="orders-list" class="space-y-3">
                <!-- Orders will be loaded here -->
            </div>

            <div id="orders-empty" class="text-center py-12 hidden">
                <i class="fa-solid fa-inbox text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">Chưa có đơn hàng nào</p>
            </div>
        </div>
    </div>
</div>

<script>
let allOrders = [];

// Expose allOrders to window for modals to access
if (typeof window !== 'undefined') {
    window.allOrders = allOrders;
    Object.defineProperty(window, 'allOrders', {
        get: () => allOrders,
        set: (value) => { allOrders = value; },
        enumerable: true,
        configurable: true
    });
}

// Check if user has permission to view all orders
function hasViewAllOrdersPermission() {
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.role) {
        return false;
    }
    
    // ADMIN luôn có quyền xem tất cả
    if (session.role === 'ADMIN') {
        return true;
    }
    
    // Check permission từ session
    if (session.permissions && typeof session.permissions === 'object') {
        // Nếu có custom permissions và view_all_orders = true
        if (session.permissions.view_all_orders === true) {
            return true;
        }
        // Nếu permissions là empty object {}, dùng default theo role
        if (Object.keys(session.permissions).length === 0) {
            // Dùng default permissions theo role
            return ['ADMIN', 'SALEADMIN'].includes(session.role);
        }
    }
    
    // Check permission function nếu có
    const hasPermissionFunc = window.hasPermission || (typeof hasPermission !== 'undefined' ? hasPermission : null);
    if (hasPermissionFunc && typeof hasPermissionFunc === 'function') {
        try {
            const hasViewAll = hasPermissionFunc(session, 'view_all_orders');
            if (hasViewAll) {
                return true;
            }
        } catch (e) {
            console.error('Error checking permission:', e);
        }
    }
    
    // Fallback: Check role
    return ['ADMIN', 'SALEADMIN'].includes(session.role);
}

// Load my orders (or all orders if user has permission)
async function loadMyOrders() {
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng đăng nhập lại', 'danger');
        }
        return;
    }

    document.getElementById('orders-loading').classList.remove('hidden');
    document.getElementById('orders-list').innerHTML = '';
    document.getElementById('orders-empty').classList.add('hidden');

    const filterStatus = document.getElementById('filter-status')?.value || '';
    const canViewAll = hasViewAllOrdersPermission();
    
    console.log('loadMyOrders: canViewAll =', canViewAll, 'session.role =', session.role);
    
    // Update title based on permission
    const titleElement = document.querySelector('#tab-my-orders h2');
    if (titleElement) {
        if (canViewAll) {
            titleElement.innerHTML = '<i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng';
        } else {
            titleElement.innerHTML = '<i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng Của Tôi';
        }
    }

    let result;
    if (canViewAll) {
        console.log('loadMyOrders: Loading ALL orders (admin mode)');
        // Load all orders
        const filters = {};
        if (filterStatus === 'pending') {
            filters.status = 'pending';
        } else if (filterStatus === 'assigned') {
            filters.status = 'assigned';
        }
        
        result = await window.callAPI({
            action: 'get_orders_for_saleadmin',
            filters: filters
        });
    } else {
        console.log('loadMyOrders: Loading MY orders only');
        // Load my orders only
        const filters = {};
        if (filterStatus === 'pending') {
            filters.has_contract_code = false;
        } else if (filterStatus === 'assigned') {
            filters.has_contract_code = true;
        }
        
        result = await window.callAPI({
            action: 'get_my_orders',
            username: session.username,
            filters: filters
        });
    }
    
    console.log('loadMyOrders: API result =', result);

    document.getElementById('orders-loading').classList.add('hidden');

    if (result.success && result.data && result.data.length > 0) {
        allOrders = result.data;
        // Update window.allOrders
        if (typeof window !== 'undefined') {
            Object.defineProperty(window, 'allOrders', {
                get: () => allOrders,
                set: (value) => { allOrders = value; },
                enumerable: true,
                configurable: true
            });
        }
        renderOrders(allOrders);
        document.getElementById('orders-empty').classList.add('hidden');
    } else {
        allOrders = [];
        if (typeof window !== 'undefined') {
            Object.defineProperty(window, 'allOrders', {
                get: () => allOrders,
                set: (value) => { allOrders = value; },
                enumerable: true,
                configurable: true
            });
        }
        document.getElementById('orders-list').innerHTML = '';
        document.getElementById('orders-empty').classList.remove('hidden');
    }
}

// Render orders
function renderOrders(orders) {
    const container = document.getElementById('orders-list');
    container.innerHTML = '';

    orders.forEach(order => {
        const customer = order.customers || {};
        const hasContractCode = order.contract_code && order.contract_code.trim();
        
        const orderCard = document.createElement('div');
        orderCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-3 md:p-4 active:shadow-md transition';
        orderCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1 min-w-0">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                        <h3 class="font-bold text-gray-800 text-base md:text-lg truncate">${customer.name || 'Chưa có tên'}</h3>
                        ${hasContractCode ? `
                            <span class="bg-green-100 text-green-800 text-[10px] md:text-xs font-bold px-2 py-1 rounded whitespace-nowrap">
                                <i class="fa-solid fa-check-circle mr-1"></i>Đã có mã
                            </span>
                        ` : `
                            <span class="bg-yellow-100 text-yellow-800 text-[10px] md:text-xs font-bold px-2 py-1 rounded whitespace-nowrap">
                                <i class="fa-solid fa-clock mr-1"></i>Chờ cấp mã
                            </span>
                        `}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 text-xs md:text-sm text-gray-600">
                        <div>
                            <span class="font-medium">CCCD:</span> <span class="break-all">${customer.cccd || '-'}</span>
                        </div>
                        <div>
                            <span class="font-medium">SĐT:</span> <span class="break-all">${customer.phone || '-'}</span>
                        </div>
                        <div>
                            <span class="font-medium">Xe:</span> ${order.car_model || '-'} ${order.car_version ? `(${order.car_version})` : ''}
                        </div>
                        <div>
                            <span class="font-medium">Màu:</span> ${order.car_color || '-'}
                        </div>
                        ${hasContractCode ? `
                            <div class="sm:col-span-2 md:col-span-2">
                                <span class="font-medium">Mã đơn hàng:</span> 
                                <span class="font-bold text-blue-600 break-all">${order.contract_code}</span>
                            </div>
                        ` : ''}
                        <div class="sm:col-span-2 md:col-span-2">
                            <span class="font-medium">Ngày tạo:</span> ${formatDate(order.created_at)}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-200">
                <button 
                    onclick="viewOrderDetail('${order.id}')" 
                    class="flex-1 min-w-[120px] bg-blue-600 text-white font-bold px-3 md:px-4 py-2.5 md:py-2 rounded hover:bg-blue-700 active:bg-blue-800 transition touch-manipulation text-xs md:text-sm"
                >
                    <i class="fa-solid fa-eye mr-1 md:mr-2"></i><span class="hidden sm:inline">Xem </span>Chi tiết
                </button>
                ${hasContractCode ? `
                    <button 
                        onclick="createApprovalFromOrder('${order.id}')" 
                        class="flex-1 min-w-[120px] bg-green-600 text-white font-bold px-3 md:px-4 py-2.5 md:py-2 rounded hover:bg-green-700 active:bg-green-800 transition touch-manipulation text-xs md:text-sm"
                    >
                        <i class="fa-solid fa-file-circle-plus mr-1 md:mr-2"></i><span class="hidden sm:inline">Tạo </span>Tờ trình
                    </button>
                    <button 
                        onclick="createContractFromOrder('${order.id}')" 
                        class="flex-1 min-w-[120px] bg-purple-600 text-white font-bold px-3 md:px-4 py-2.5 md:py-2 rounded hover:bg-purple-700 active:bg-purple-800 transition touch-manipulation text-xs md:text-sm"
                    >
                        <i class="fa-solid fa-file-contract mr-1 md:mr-2"></i><span class="hidden sm:inline">Tạo </span>HĐMB
                    </button>
                    <button 
                        onclick="createAgreementFromOrder('${order.id}')" 
                        class="flex-1 min-w-[120px] bg-indigo-600 text-white font-bold px-3 md:px-4 py-2.5 md:py-2 rounded hover:bg-indigo-700 active:bg-indigo-800 transition touch-manipulation text-xs md:text-sm"
                    >
                        <i class="fa-solid fa-handshake mr-1 md:mr-2"></i><span class="hidden md:inline">Thỏa </span>Thuận
                    </button>
                    <button 
                        onclick="createDeNghiFromOrder('${order.id}')" 
                        class="flex-1 min-w-[120px] bg-orange-600 text-white font-bold px-3 md:px-4 py-2.5 md:py-2 rounded hover:bg-orange-700 active:bg-orange-800 transition touch-manipulation text-xs md:text-sm"
                    >
                        <i class="fa-solid fa-file-invoice-dollar mr-1 md:mr-2"></i><span class="hidden sm:inline">Đề </span>Nghị
                    </button>
                ` : `
                    <div class="flex-1 text-[10px] md:text-xs text-gray-500 flex items-center justify-center py-2">
                        Chờ SaleAdmin cấp mã đơn hàng
                    </div>
                `}
            </div>
        `;
        container.appendChild(orderCard);
    });
}

// Filter orders
function filterOrders() {
    const searchTerm = document.getElementById('search-orders').value.toLowerCase();
    if (!searchTerm) {
        renderOrders(allOrders);
        return;
    }

    const filtered = allOrders.filter(order => {
        const customer = order.customers || {};
        const searchText = `${customer.name || ''} ${customer.cccd || ''} ${order.contract_code || ''}`.toLowerCase();
        return searchText.includes(searchTerm);
    });

    renderOrders(filtered);
}

// View order detail
async function viewOrderDetail(orderId) {
    if (typeof window.openOrderDetailModal === 'function') {
        await window.openOrderDetailModal(orderId, false);
    } else {
        if (typeof window.showToast === 'function') {
            window.showToast('Modal chưa được load. Vui lòng reload trang.', 'warning');
        } else {
            alert('Modal chưa được load. Vui lòng reload trang.');
        }
    }
}

// Create approval from order
function createApprovalFromOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    // Chuyển sang tab tạo tờ trình và fill dữ liệu từ đơn hàng
    if (window.switchTab) {
        window.switchTab('create');
        
        // Đợi form load xong rồi auto-fill
        setTimeout(() => {
            autoFillApprovalFormFromOrder(order);
        }, 500);
    }
}

// Auto-fill approval form from order
function autoFillApprovalFormFromOrder(order) {
    const customer = order.customers || {};
    const form = document.getElementById('form-manual-create');
    if (!form) {
        showToast('Form chưa sẵn sàng. Vui lòng thử lại.', 'warning');
        return;
    }

    // Fill customer info
    const contractCodeInput = form.querySelector('input[name="contract_code"]');
    const customerNameInput = form.querySelector('input[name="customer_name"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const cccdInput = form.querySelector('input[name="cccd"]');
    const emailInput = form.querySelector('input[name="email"]');
    const addressInput = form.querySelector('input[name="address"]');
    
    if (contractCodeInput) contractCodeInput.value = order.contract_code || '';
    if (customerNameInput) customerNameInput.value = customer.name || '';
    if (phoneInput) phoneInput.value = customer.phone || '';
    if (cccdInput) cccdInput.value = customer.cccd || '';
    if (emailInput) emailInput.value = customer.email || '';
    if (addressInput) addressInput.value = customer.address || '';

    // Fill car info
    const carModelInput = form.querySelector('input[name="car_model"]');
    const carVersionInput = form.querySelector('input[name="car_version"]');
    const carColorInput = form.querySelector('input[name="car_color"]');
    const paymentMethodSelect = form.querySelector('select[name="payment_method"]');
    
    if (carModelInput) carModelInput.value = order.car_model || '';
    if (carVersionInput) carVersionInput.value = order.car_version || '';
    if (carColorInput) carColorInput.value = order.car_color || '';
    if (paymentMethodSelect && order.payment_method) {
        paymentMethodSelect.value = order.payment_method;
    }

    showToast('Đã điền sẵn thông tin từ đơn hàng. Vui lòng kiểm tra và điền thêm!', 'success');
}

// Create contract from order
function createContractFromOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    // Chuyển sang tab tạo HĐMB và fill dữ liệu từ đơn hàng
    if (window.switchTab) {
        window.switchTab('hdmb-create');
        
        // Đợi form load xong rồi auto-fill
        setTimeout(() => {
            autoFillHDMBFormFromOrder(order);
        }, 500);
    }
}

// Auto-fill HDMB form from order
function autoFillHDMBFormFromOrder(order) {
    const customer = order.customers || {};
    const form = document.getElementById('form-hdmb-create');
    if (!form) {
        if (typeof window.showToast === 'function') {
            window.showToast('Form chưa sẵn sàng. Vui lòng thử lại.', 'warning');
        }
        return;
    }

    // Fill customer info
    document.getElementById('hdmb-create-khach_hang').value = customer.name || '';
    document.getElementById('hdmb-create-so_cccd').value = customer.cccd || '';
    document.getElementById('hdmb-create-sdt').value = customer.phone || '';
    document.getElementById('hdmb-create-email').value = customer.email || '';
    document.getElementById('hdmb-create-dia_chi').value = customer.address || '';
    document.getElementById('hdmb-create-ngay_cap').value = customer.issue_date ? new Date(customer.issue_date).toISOString().split('T')[0] : '';
    document.getElementById('hdmb-create-noi_cap').value = customer.issue_place || '';
    
    // Fill contract info
    document.getElementById('hdmb-create-so_hop_dong').value = order.contract_code || '';
    document.getElementById('hdmb-create-ngay_ky').value = new Date().toISOString().split('T')[0];
    document.getElementById('hdmb-create-loai_xe').value = order.car_model || '';
    document.getElementById('hdmb-create-phien_ban').value = order.car_version || '';
    document.getElementById('hdmb-create-mau_xe').value = order.car_color || '';

    if (typeof window.showToast === 'function') {
        window.showToast('Đã điền sẵn thông tin từ đơn hàng. Vui lòng kiểm tra và điền thêm!', 'success');
    }
}

// Create agreement from order
function createAgreementFromOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    // Chuyển sang tab tạo Thỏa Thuận và fill dữ liệu từ đơn hàng
    if (window.switchTab) {
        window.switchTab('thoa-thuan-create');
        
        // Đợi form load xong rồi auto-fill
        setTimeout(() => {
            autoFillThoaThuanFormFromOrder(order);
        }, 500);
    }
}

// Auto-fill Thoa Thuan form from order
function autoFillThoaThuanFormFromOrder(order) {
    const customer = order.customers || {};
    const form = document.getElementById('form-thoa-thuan-create');
    if (!form) {
        if (typeof window.showToast === 'function') {
            window.showToast('Form chưa sẵn sàng. Vui lòng thử lại.', 'warning');
        }
        return;
    }

    // Fill customer info
    document.getElementById('tt-create-ten_khach_hang').value = customer.name || '';
    document.getElementById('tt-create-cccd').value = customer.cccd || '';
    document.getElementById('tt-create-dien_thoai').value = customer.phone || '';
    document.getElementById('tt-create-dia_chi').value = customer.address || '';
    document.getElementById('tt-create-ngay_cap').value = customer.issue_date ? new Date(customer.issue_date).toISOString().split('T')[0] : '';
    document.getElementById('tt-create-noi_cap').value = customer.issue_place || '';
    
    // Fill contract info
    document.getElementById('tt-create-so_hop_dong').value = order.contract_code || '';
    document.getElementById('tt-create-loai_xe').value = order.car_model || '';

    if (typeof window.showToast === 'function') {
        window.showToast('Đã điền sẵn thông tin từ đơn hàng. Vui lòng kiểm tra và điền thêm!', 'success');
    }
}

// Create de nghi from order
function createDeNghiFromOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    // Chuyển sang tab tạo Đề Nghị và fill dữ liệu từ đơn hàng
    if (window.switchTab) {
        window.switchTab('de-nghi-create');
        
        // Đợi form load xong rồi auto-fill
        setTimeout(() => {
            autoFillDeNghiFormFromOrder(order);
        }, 500);
    }
}

// Auto-fill De Nghi form from order
function autoFillDeNghiFormFromOrder(order) {
    const customer = order.customers || {};
    const form = document.getElementById('form-de-nghi-create');
    if (!form) {
        if (typeof window.showToast === 'function') {
            window.showToast('Form chưa sẵn sàng. Vui lòng thử lại.', 'warning');
        }
        return;
    }

    // Fill customer info
    document.getElementById('dngn-create-ten_khach_hang').value = customer.name || '';
    document.getElementById('dngn-create-so_hop_dong').value = order.contract_code || '';
    document.getElementById('dngn-create-loai_xe').value = order.car_model || '';
    document.getElementById('dngn-create-ngay_captbcv').value = new Date().toISOString().split('T')[0];

    if (typeof window.showToast === 'function') {
        window.showToast('Đã điền sẵn thông tin từ đơn hàng. Vui lòng kiểm tra và điền thêm!', 'success');
    }
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

// Update title based on permission
function updateTitleBasedOnPermission() {
    const canViewAll = hasViewAllOrdersPermission();
    const titleElement = document.querySelector('#tab-my-orders h2');
    if (titleElement) {
        if (canViewAll) {
            titleElement.innerHTML = '<i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng';
        } else {
            titleElement.innerHTML = '<i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đơn Hàng Của Tôi';
        }
    }
}

// Auto load when tab is shown
if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
        // Update title first
        updateTitleBasedOnPermission();
        
        // Load orders when tab is activated
        const observer = new MutationObserver((mutations) => {
            const myOrdersTab = document.getElementById('tab-my-orders');
            if (myOrdersTab && myOrdersTab.classList.contains('active')) {
                loadMyOrders();
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container) {
            observer.observe(container.parentElement, { 
                attributes: true, 
                attributeFilter: ['class'],
                subtree: true 
            });
        }
    });
    
    // Also update title when component is loaded
    updateTitleBasedOnPermission();
}
</script>

