<!-- Modal Cấp COC -->
<div id="modal-coc-issue" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-certificate mr-2"></i>Cấp COC
            </h2>
            <button onclick="closeCocIssueModal()" class="text-white hover:text-gray-200">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>

        <form id="form-coc-issue" onsubmit="submitCocIssue(event)" class="p-6">
            <!-- Thông tin request (readonly) -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-3">Thông tin đề nghị</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">Mã đơn hàng:</span>
                        <span id="issue-contract-code" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Khách hàng:</span>
                        <span id="issue-customer-name" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Loại xe:</span>
                        <span id="issue-car-model" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ngày đề nghị:</span>
                        <span id="issue-request-date" class="font-bold ml-2"></span>
                    </div>
                </div>
            </div>

            <!-- Thông tin tài chính -->
            <div class="mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <h3 class="font-bold text-gray-700 mb-3">Thông tin tài chính</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">Số PO:</span>
                        <span id="issue-po-number" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Giá nhập:</span>
                        <span id="issue-import-price" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Phương thức thanh toán:</span>
                        <span id="issue-payment-method" class="font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ngân hàng bảo lãnh:</span>
                        <span id="issue-guarantee-bank" class="font-bold ml-2"></span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-600">Số tiền tính lãi:</span>
                        <span id="issue-principal-amount" class="font-bold ml-2 text-blue-600"></span>
                    </div>
                </div>
            </div>

            <!-- Ngày cấp thực tế -->
            <div class="mb-4">
                <label class="label block mb-2">
                    <i class="fa-solid fa-calendar mr-2 text-blue-600"></i>
                    Ngày cấp thực tế <span class="text-red-500">*</span>
                </label>
                <input 
                    type="date" 
                    id="issue-actual-date" 
                    name="actual_issue_date"
                    class="input w-full" 
                    required
                    onchange="calculateCocInterest()"
                >
            </div>

            <!-- Upload ảnh COC (BẮT BUỘC) -->
            <div class="mb-4">
                <label class="label block mb-2">
                    <i class="fa-solid fa-image mr-2 text-blue-600"></i>
                    Ảnh COC <span class="text-red-500">*</span>
                </label>
                <input 
                    type="file" 
                    id="issue-coc-image" 
                    name="coc_image"
                    accept="image/*"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                    required
                    onchange="handleCocImageSelect(this)"
                >
                <div id="issue-coc-image-preview" class="mt-2 hidden">
                    <img src="" alt="COC Image Preview" class="max-w-full h-auto rounded border border-gray-300 max-h-64">
                </div>
            </div>

            <!-- Upload biên bản bàn giao (BẮT BUỘC) -->
            <div class="mb-4">
                <label class="label block mb-2">
                    <i class="fa-solid fa-file-pdf mr-2 text-blue-600"></i>
                    Biên bản bàn giao <span class="text-red-500">*</span>
                </label>
                <input 
                    type="file" 
                    id="issue-handover-doc" 
                    name="handover_document"
                    accept="image/*,.pdf"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                    required
                    onchange="handleHandoverDocSelect(this)"
                >
                <div id="issue-handover-doc-preview" class="mt-2 hidden">
                    <p class="text-sm text-blue-600">
                        <i class="fa-solid fa-file-pdf mr-1"></i>File đã chọn: <span id="issue-handover-doc-name"></span>
                    </p>
                </div>
            </div>

            <!-- Thông tin tính toán (auto) -->
            <div class="mb-6 bg-orange-50 p-4 rounded-lg border border-orange-200">
                <h3 class="font-bold text-gray-700 mb-3">Thông tin tính toán</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">Số ngày trễ (sau +5 ngày làm việc):</span>
                        <span id="issue-delayed-days" class="font-bold ml-2 text-orange-600">0</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Số tiền lãi:</span>
                        <span id="issue-interest-amount" class="font-bold ml-2 text-orange-600">0 VNĐ</span>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button 
                    type="submit" 
                    class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition"
                >
                    <i class="fa-solid fa-check mr-2"></i>Cấp COC
                </button>
                <button 
                    type="button" 
                    onclick="closeCocIssueModal()" 
                    class="px-6 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition"
                >
                    Hủy
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentCocRequestId = null;
let cocRequestData = null;
let currentPrincipalAmount = 0;

// Handle image select
function handleCocImageSelect(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('issue-coc-image-preview');
            const img = preview.querySelector('img');
            if (img) {
                img.src = e.target.result;
            }
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

// Handle document select
function handleHandoverDocSelect(input) {
    const file = input.files[0];
    if (file) {
        const preview = document.getElementById('issue-handover-doc-preview');
        const nameSpan = document.getElementById('issue-handover-doc-name');
        if (nameSpan) {
            nameSpan.textContent = file.name;
        }
        if (preview) {
            preview.classList.remove('hidden');
        }
    }
}

// Calculate interest
async function calculateCocInterest() {
    if (!cocRequestData) return;
    
    const actualDate = document.getElementById('issue-actual-date').value;
    if (!actualDate) return;

    const delayedDays = typeof window.calculateDelayedBusinessDays === 'function'
        ? window.calculateDelayedBusinessDays(cocRequestData.request_date, actualDate)
        : 0;

    const principalAmount = currentPrincipalAmount || 
                           cocRequestData.principal_amount || 
                           cocRequestData.import_price || 
                           0;
    
    const interest = typeof window.calculateInterest === 'function'
        ? window.calculateInterest(principalAmount, delayedDays, cocRequestData.interest_rate || 8.0)
        : 0;

    const delayedDaysEl = document.getElementById('issue-delayed-days');
    const interestAmountEl = document.getElementById('issue-interest-amount');
    
    if (delayedDaysEl) delayedDaysEl.textContent = delayedDays;
    if (interestAmountEl) {
        interestAmountEl.textContent = interest.toLocaleString('vi-VN') + ' VNĐ';
    }
}

// Submit issue COC
async function submitCocIssue(event) {
    event.preventDefault();

    const form = event.target;
    const actualDate = document.getElementById('issue-actual-date').value;
    const cocImageFile = document.getElementById('issue-coc-image').files[0];
    const handoverDocFile = document.getElementById('issue-handover-doc').files[0];

    // Validate
    if (!cocImageFile || !handoverDocFile) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng upload đầy đủ ảnh COC và biên bản bàn giao', 'warning');
        }
        return;
    }

    // Get session
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng đăng nhập lại', 'danger');
        }
        return;
    }

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang xử lý...';

    try {
        // Upload files to Google Drive
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(cocImageFile);
        dataTransfer.items.add(handoverDocFile);

        if (!window.googleDocsAPI || !window.googleDocsAPI.uploadFiles) {
            throw new Error('Google Drive API chưa được cấu hình');
        }

        const uploadResult = await window.googleDocsAPI.uploadFiles(dataTransfer.files);
        
        if (!uploadResult.success || !uploadResult.urls || uploadResult.urls.length < 2) {
            throw new Error('Lỗi upload file. Vui lòng thử lại.');
        }

        // Map files: first = COC image, second = handover doc
        const cocImage = uploadResult.urls[0];
        const handoverDoc = uploadResult.urls[1];

        // Call API to issue COC
        const result = await window.callAPI({
            action: 'issue_coc_request',
            coc_request_id: currentCocRequestId,
            actual_issue_date: actualDate,
            coc_image_url: cocImage.url || cocImage,
            coc_image_id: cocImage.id || null,
            handover_document_url: handoverDoc.url || handoverDoc,
            handover_document_id: handoverDoc.id || null,
            issuer: session.username
        });

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('Cấp COC thành công!', 'success');
            }
            closeCocIssueModal();
            // Reload COC requests list
            if (typeof loadCocRequests === 'function') {
                loadCocRequests();
            }
        } else {
            throw new Error(result.message || 'Không thể cấp COC');
        }
    } catch (error) {
        console.error('Error issuing COC:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
}

// Open modal
function openCocIssueModal(cocRequestIdOrObject) {
    let cocRequest = null;
    
    // Handle different input types
    if (typeof cocRequestIdOrObject === 'string') {
        // Find from allCocRequests
        if (typeof window.allCocRequests !== 'undefined' && window.allCocRequests) {
            cocRequest = window.allCocRequests.find(r => r.id === cocRequestIdOrObject);
        }
        if (!cocRequest) {
            console.error('COC request not found:', cocRequestIdOrObject);
            if (typeof window.showToast === 'function') {
                window.showToast('Không tìm thấy đề nghị COC', 'danger');
            }
            return;
        }
    } else if (typeof cocRequestIdOrObject === 'object' && cocRequestIdOrObject !== null) {
        cocRequest = cocRequestIdOrObject;
    } else {
        console.error('Invalid cocRequest parameter:', cocRequestIdOrObject);
        return;
    }
    
    currentCocRequestId = cocRequest.id;
    cocRequestData = cocRequest;
    
    // Fill form
    document.getElementById('issue-contract-code').textContent = cocRequest.contract_code || '-';
    document.getElementById('issue-customer-name').textContent = cocRequest.customer_name || '-';
    document.getElementById('issue-car-model').textContent = (cocRequest.car_model || '-') + ' ' + (cocRequest.car_version || '') + ' ' + (cocRequest.car_color || '');
    document.getElementById('issue-request-date').textContent = cocRequest.request_date 
        ? new Date(cocRequest.request_date).toLocaleDateString('vi-VN')
        : '-';
    
    // Fill financial info
    document.getElementById('issue-po-number').textContent = cocRequest.po_number || '-';
    document.getElementById('issue-import-price').textContent = cocRequest.import_price 
        ? parseFloat(cocRequest.import_price).toLocaleString('vi-VN') + ' VNĐ' 
        : '-';
    document.getElementById('issue-payment-method').textContent = cocRequest.payment_method || '-';
    document.getElementById('issue-guarantee-bank').textContent = cocRequest.guarantee_bank || '-';
    
    currentPrincipalAmount = cocRequest.principal_amount || cocRequest.import_price || 0;
    document.getElementById('issue-principal-amount').textContent = 
        parseFloat(currentPrincipalAmount).toLocaleString('vi-VN') + ' VNĐ';
    
    // Reset form
    document.getElementById('form-coc-issue').reset();
    document.getElementById('issue-coc-image-preview').classList.add('hidden');
    document.getElementById('issue-handover-doc-preview').classList.add('hidden');
    document.getElementById('issue-delayed-days').textContent = '0';
    document.getElementById('issue-interest-amount').textContent = '0 VNĐ';
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issue-actual-date').value = today;
    
    // Show modal
    document.getElementById('modal-coc-issue').classList.remove('hidden');
}

// Close modal
function closeCocIssueModal() {
    document.getElementById('modal-coc-issue').classList.add('hidden');
    currentCocRequestId = null;
    cocRequestData = null;
    currentPrincipalAmount = 0;
}

// Expose to window
if (typeof window !== 'undefined') {
    window.openCocIssueModal = openCocIssueModal;
    window.closeCocIssueModal = closeCocIssueModal;
    window.handleCocImageSelect = handleCocImageSelect;
    window.handleHandoverDocSelect = handleHandoverDocSelect;
    window.calculateCocInterest = calculateCocInterest;
    window.submitCocIssue = submitCocIssue;
}
</script>

