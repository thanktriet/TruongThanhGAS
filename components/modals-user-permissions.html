<!-- Modal Quản Lý Quyền User -->
<div id="modal-user-permissions" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-purple-600 px-6 py-4 flex justify-between items-center flex-shrink-0">
            <h2 class="text-xl font-bold text-white">
                <i class="fa-solid fa-key mr-2"></i>Quản Lý Quyền - <span id="perm-username-display"></span>
            </h2>
            <button 
                onclick="closeUserPermissionsModal()" 
                class="text-white hover:text-gray-200 transition"
            >
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Loading -->
            <div id="permissions-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600"></div>
                <p class="mt-4 text-gray-600">Đang tải...</p>
            </div>

            <!-- Permissions Content -->
            <div id="permissions-content" class="hidden">
                <!-- User Info -->
                <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Username:</label>
                            <p class="text-gray-800 font-semibold" id="perm-user-username">-</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Họ tên:</label>
                            <p class="text-gray-800" id="perm-user-fullname">-</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Vai trò:</label>
                            <p class="text-gray-800 font-bold" id="perm-user-role">-</p>
                        </div>
                    </div>
                </div>

                <!-- Permissions by Group -->
                <div id="permissions-groups" class="space-y-6">
                    <!-- Permissions will be loaded here -->
                </div>

                <!-- Actions -->
                <div class="mt-6 flex gap-3 justify-between items-center bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <button 
                        onclick="applyDefaultPermissions()" 
                        class="px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition"
                    >
                        <i class="fa-solid fa-rotate-left mr-2"></i>Áp dụng quyền mặc định theo role
                    </button>
                    <div class="text-xs text-gray-600">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        Quyền mặc định sẽ được khôi phục theo role của user
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end gap-3 flex-shrink-0">
            <button 
                onclick="closeUserPermissionsModal()" 
                class="px-6 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition"
            >
                Hủy
            </button>
            <button 
                id="btn-save-permissions"
                onclick="saveUserPermissions()" 
                class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition"
            >
                <i class="fa-solid fa-save mr-2"></i>Lưu Quyền
            </button>
        </div>
    </div>
</div>

<script>
let currentPermissionUser = null;
let currentPermissions = {};
let savedTargetUsername = null; // Backup username để tránh mất dữ liệu

async function openUserPermissionsModal(username) {
    if (!username) {
        if (typeof window.showToast === 'function') {
            window.showToast('Không có username', 'danger');
        }
        return;
    }

    currentPermissionUser = null;
    currentPermissions = {};
    savedTargetUsername = username.toLowerCase(); // Lưu username ngay từ đầu

    // Show modal
    const modal = document.getElementById('modal-user-permissions');
    modal.setAttribute('data-target-username', savedTargetUsername); // Lưu vào data attribute
    modal.classList.remove('hidden');

    // Show loading
    document.getElementById('permissions-loading').classList.remove('hidden');
    document.getElementById('permissions-content').classList.add('hidden');

    try {
        // Get user info
        const session = JSON.parse(localStorage.getItem('user_session') || '{}');
        if (!session || session.role !== 'ADMIN') {
            if (typeof window.showToast === 'function') {
                window.showToast('Chỉ ADMIN mới có quyền quản lý permissions', 'danger');
            }
            closeUserPermissionsModal();
            return;
        }

        // Load users list to get user info
        const result = await window.callAPI({
            action: 'list_users',
            username: session.username,
            role: session.role
        });

        if (!result.success || !result.users) {
            throw new Error(result.message || 'Không thể tải thông tin user');
        }

        const user = result.users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (!user) {
            throw new Error('Không tìm thấy user');
        }

        currentPermissionUser = user;
        savedTargetUsername = user.username.toLowerCase(); // Đảm bảo username được lưu

        // Display user info
        document.getElementById('perm-username-display').textContent = user.username;
        document.getElementById('perm-user-username').textContent = user.username;
        document.getElementById('perm-user-fullname').textContent = user.fullname || '-';
        document.getElementById('perm-user-role').textContent = user.role || '-';
        
        // Lưu username vào data attribute của modal
        const modal = document.getElementById('modal-user-permissions');
        if (modal) {
            modal.setAttribute('data-target-username', savedTargetUsername);
        }

        // Load permissions
        await loadUserPermissions(user);

        // Hide loading, show content
        document.getElementById('permissions-loading').classList.add('hidden');
        document.getElementById('permissions-content').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading user permissions:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
        closeUserPermissionsModal();
    }
}

async function loadUserPermissions(user) {
    // Get permissions từ user (nếu có) hoặc default theo role
    let permissions = {};
    
    if (user.permissions) {
        if (typeof user.permissions === 'string') {
            try {
                const parsed = JSON.parse(user.permissions);
                if (parsed && typeof parsed === 'object' && Object.keys(parsed).length > 0) {
                    permissions = parsed;
                } else {
                    // Empty object, use defaults
                    permissions = window.Permissions ? window.Permissions.getDefaultPermissionsByRole(user.role) : {};
                }
            } catch (e) {
                console.error('Error parsing permissions:', e);
                permissions = window.Permissions ? window.Permissions.getDefaultPermissionsByRole(user.role) : {};
            }
        } else if (typeof user.permissions === 'object') {
            if (Object.keys(user.permissions).length > 0) {
                permissions = user.permissions;
            } else {
                permissions = window.Permissions ? window.Permissions.getDefaultPermissionsByRole(user.role) : {};
            }
        }
    } else {
        // No permissions, use defaults
        permissions = window.Permissions ? window.Permissions.getDefaultPermissionsByRole(user.role) : {};
    }

    currentPermissions = { ...permissions };

    // Render permissions by group
    renderPermissionsByGroup(permissions);
}

function renderPermissionsByGroup(permissions) {
    if (!window.Permissions) {
        console.error('Permissions helper not loaded');
        return;
    }

    const groups = window.Permissions.getPermissionsByGroup();
    const groupOrder = ['approval', 'orders', 'documents', 'coc', 'reports', 'system'];
    const container = document.getElementById('permissions-groups');
    container.innerHTML = '';

    groupOrder.forEach(groupKey => {
        if (!groups[groupKey]) return;

        const groupInfo = window.Permissions.PERMISSION_GROUPS[groupKey];
        if (!groupInfo) return;

        const groupDiv = document.createElement('div');
        groupDiv.className = 'bg-gray-50 rounded-lg p-5 border border-gray-200';
        groupDiv.innerHTML = `
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid ${groupInfo.icon} mr-2 text-purple-600"></i>${groupInfo.label}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${groups[groupKey].map(perm => {
                    const isChecked = permissions[perm.key] === true;
                    return `
                        <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition">
                            <input 
                                type="checkbox" 
                                class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"
                                data-permission="${perm.key}"
                                ${isChecked ? 'checked' : ''}
                                onchange="togglePermission('${perm.key}', this.checked)"
                            >
                            <span class="ml-3 text-sm text-gray-700 font-medium">${perm.label}</span>
                        </label>
                    `;
                }).join('')}
            </div>
        `;
        container.appendChild(groupDiv);
    });
}

function togglePermission(permissionKey, enabled) {
    currentPermissions[permissionKey] = enabled;
}

function applyDefaultPermissions() {
    if (!currentPermissionUser || !window.Permissions) {
        return;
    }

    const defaultPerms = window.Permissions.getDefaultPermissionsByRole(currentPermissionUser.role);
    currentPermissions = { ...defaultPerms };
    renderPermissionsByGroup(currentPermissions);

    if (typeof window.showToast === 'function') {
        window.showToast('Đã áp dụng quyền mặc định theo role', 'success');
    }
}

async function saveUserPermissions() {
    try {
        // Get username từ nhiều nguồn để đảm bảo không bị mất
        let targetUsername = null;
        
        // Ưu tiên 1: Từ currentPermissionUser
        if (currentPermissionUser && typeof currentPermissionUser === 'object' && currentPermissionUser.username) {
            targetUsername = String(currentPermissionUser.username).trim();
        }
        // Ưu tiên 2: Từ savedTargetUsername
        else if (savedTargetUsername && typeof savedTargetUsername === 'string') {
            targetUsername = String(savedTargetUsername).trim();
        }
        // Ưu tiên 3: Từ data attribute của modal
        else {
            try {
                const modal = document.getElementById('modal-user-permissions');
                if (modal) {
                    const usernameFromAttr = modal.getAttribute('data-target-username');
                    if (usernameFromAttr && typeof usernameFromAttr === 'string') {
                        targetUsername = String(usernameFromAttr).trim();
                    }
                }
            } catch (e) {
                console.error('Error getting username from modal attribute:', e);
            }
        }
        
        // Nếu vẫn không có username, báo lỗi
        if (!targetUsername || targetUsername.length === 0) {
            console.error('Cannot get target username. currentPermissionUser:', currentPermissionUser, 'savedTargetUsername:', savedTargetUsername);
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: Không có thông tin user để lưu. Vui lòng đóng và mở lại modal.', 'danger');
            }
            return;
        }

        // Get session với validation
        let session = null;
        try {
            const sessionStr = localStorage.getItem('user_session');
            if (sessionStr) {
                session = JSON.parse(sessionStr);
            }
        } catch (e) {
            console.error('Error parsing session:', e);
        }
        
        if (!session || typeof session !== 'object' || session.role !== 'ADMIN') {
            if (typeof window.showToast === 'function') {
                window.showToast('Chỉ ADMIN mới có quyền lưu permissions', 'danger');
            }
            return;
        }

        // Validate session.username
        if (!session.username || typeof session.username !== 'string') {
            console.error('Invalid session.username:', session.username);
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: Session không hợp lệ. Vui lòng đăng nhập lại.', 'danger');
            }
            return;
        }

        // Normalize username
        targetUsername = targetUsername.toLowerCase();
        const sessionUsername = String(session.username).toLowerCase();
        const isCurrentUser = sessionUsername === targetUsername;

        // Show loading - Get button from DOM by ID
        const saveBtn = document.getElementById('btn-save-permissions');
        let originalText = '';
        if (saveBtn) {
            originalText = saveBtn.innerHTML;
            saveBtn.setAttribute('data-original-text', originalText); // Lưu original text
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang lưu...';
        }

        // Validate currentPermissions
        const permissionsToSave = currentPermissions && typeof currentPermissions === 'object' ? currentPermissions : {};
        
        // Call API
        const result = await window.callAPI({
            action: 'update_user_permissions',
            username: sessionUsername,
            role: session.role,
            target_username: targetUsername,
            permissions: permissionsToSave
        });

        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('Đã lưu quyền thành công!', 'success');
            }
            
            // Reload user list if on users page
            if (typeof loadUserManagement === 'function') {
                setTimeout(() => {
                    loadUserManagement();
                }, 500);
            }
            
            // Nếu đang quản lý quyền của chính user đang đăng nhập, refresh menu items
            if (isCurrentUser) {
                // Refresh session và menu items
                if (typeof window.refreshUserSessionAndMenu === 'function') {
                    setTimeout(() => {
                        window.refreshUserSessionAndMenu();
                    }, 500);
                } else if (typeof window.updateMenuVisibility === 'function') {
                    // Update menu với user mới (cần reload session trước)
                    try {
                        const updatedSessionStr = localStorage.getItem('user_session');
                        if (updatedSessionStr) {
                            const updatedSession = JSON.parse(updatedSessionStr);
                            if (updatedSession && typeof updatedSession === 'object') {
                                // Reload lại user info để lấy permissions mới
                                const reloadResult = await window.callAPI({
                                    action: 'list_users',
                                    username: sessionUsername,
                                    role: session.role
                                });
                                if (reloadResult && reloadResult.success && reloadResult.users && Array.isArray(reloadResult.users)) {
                                    const updatedUser = reloadResult.users.find(u => u && u.username && String(u.username).toLowerCase() === targetUsername);
                                    if (updatedUser) {
                                        // Update session với permissions mới
                                        updatedSession.permissions = updatedUser.permissions || {};
                                        localStorage.setItem('user_session', JSON.stringify(updatedSession));
                                        if (typeof window.updateMenuVisibility === 'function') {
                                            window.updateMenuVisibility(updatedSession);
                                        }
                                    }
                                }
                            }
                        }
                    } catch (reloadError) {
                        console.error('Error reloading user session:', reloadError);
                    }
                } else {
                    // Fallback: reload page để cập nhật menu
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
            
            // Đóng modal sau khi đã xử lý xong
            closeUserPermissionsModal();
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể lưu permissions'), 'danger');
            }
        }
    } catch (error) {
        // Reset button state
        const saveBtn = document.getElementById('btn-save-permissions');
        if (saveBtn) {
            const originalText = saveBtn.getAttribute('data-original-text');
            saveBtn.disabled = false;
            if (originalText) {
                saveBtn.innerHTML = originalText;
            } else {
                saveBtn.innerHTML = '<i class="fa-solid fa-save mr-2"></i>Lưu Quyền';
            }
        }
        
        console.error('Error saving permissions:', error);
        console.error('Error stack:', error.stack);
        console.error('Error details:', {
            message: error.message,
            name: error.name,
            currentPermissionUser: currentPermissionUser,
            savedTargetUsername: savedTargetUsername,
            currentPermissions: currentPermissions
        });
        
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + (error.message || 'Không thể lưu permissions. Vui lòng thử lại.'), 'danger');
        }
    }
}

function closeUserPermissionsModal() {
    const modal = document.getElementById('modal-user-permissions');
    if (modal) {
        modal.classList.add('hidden');
        modal.removeAttribute('data-target-username');
    }
    currentPermissionUser = null;
    currentPermissions = {};
    savedTargetUsername = null;
}

// Expose to window
if (typeof window !== 'undefined') {
    window.openUserPermissionsModal = openUserPermissionsModal;
    window.closeUserPermissionsModal = closeUserPermissionsModal;
    window.togglePermission = togglePermission;
    window.applyDefaultPermissions = applyDefaultPermissions;
    window.saveUserPermissions = saveUserPermissions;
}
</script>

