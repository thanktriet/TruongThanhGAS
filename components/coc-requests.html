<div id="tab-coc-requests" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-blue-50 px-4 py-3 md:px-6 md:py-4 border-b border-blue-100">
            <h2 class="text-base md:text-lg font-bold text-blue-800">
                <i class="fa-solid fa-list-check mr-2"></i>Quản Lý Đề Nghị Cấp COC
            </h2>
            <p class="text-xs text-gray-600 mt-1">Quản lý các đề nghị cấp COC (Giấy chứng nhận xuất xưởng)</p>
        </div>
        
        <div class="p-3 md:p-6">
            <!-- Filters -->
            <div class="mb-4 md:mb-6 bg-gray-50 p-3 md:p-4 rounded-lg border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <label class="label text-xs md:text-sm mb-1 block">Trạng thái</label>
                        <select id="filter-coc-status" class="input text-sm md:text-base w-full" onchange="filterCocRequests()">
                            <option value="">Tất cả</option>
                            <option value="pending">Chờ cấp</option>
                            <option value="issued">Đã cấp</option>
                            <option value="disbursed">Đã giải ngân</option>
                            <option value="closed">Đã đóng</option>
                        </select>
                    </div>
                    <div>
                        <label class="label text-xs md:text-sm mb-1 block">Mã hợp đồng</label>
                        <input type="text" id="filter-coc-contract-code" class="input text-sm md:text-base w-full" placeholder="Tìm theo mã..." onkeyup="filterCocRequests()">
                    </div>
                    <div>
                        <label class="label text-xs md:text-sm mb-1 block">Khách hàng</label>
                        <input type="text" id="filter-coc-customer" class="input text-sm md:text-base w-full" placeholder="Tìm theo tên..." onkeyup="filterCocRequests()">
                    </div>
                    <div>
                        <label class="label text-xs md:text-sm mb-1 block">Ngày đề nghị</label>
                        <input type="date" id="filter-coc-date" class="input text-sm md:text-base w-full" onchange="filterCocRequests()">
                    </div>
                </div>
            </div>

            <!-- Requests List -->
            <div id="coc-requests-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <div id="coc-requests-list" class="space-y-3">
                <!-- Requests will be rendered here -->
            </div>

            <div id="coc-requests-empty" class="text-center py-12 hidden">
                <i class="fa-solid fa-certificate text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">Chưa có đề nghị nào</p>
            </div>
        </div>
    </div>
</div>

<script>
let allCocRequests = [];
let filteredCocRequests = [];
let isLoadingCocRequests = false;
let cocRequestsObserver = null;

// Status labels and colors
const COC_STATUS = {
    'pending': { label: 'Chờ cấp', color: 'yellow', bgColor: 'yellow-100', textColor: 'yellow-800' },
    'issued': { label: 'Đã cấp', color: 'blue', bgColor: 'blue-100', textColor: 'blue-800' },
    'disbursed': { label: 'Đã giải ngân', color: 'orange', bgColor: 'orange-100', textColor: 'orange-800' },
    'closed': { label: 'Đã đóng', color: 'green', bgColor: 'green-100', textColor: 'green-800' }
};

async function loadCocRequests() {
    console.log('[COC Requests] loadCocRequests called');
    
    // Prevent multiple simultaneous calls
    if (isLoadingCocRequests) {
        console.log('[COC Requests] Already loading, skipping...');
        return;
    }
    
    console.log('[COC Requests] Checking session...');
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    console.log('[COC Requests] Session:', session);
    
    if (!session || !session.username) {
        console.warn('[COC Requests] No session or username, showing toast');
        if (typeof window.showToast === 'function') {
            window.showToast('Vui lòng đăng nhập lại', 'danger');
        }
        return;
    }
    
    console.log('[COC Requests] Session valid, proceeding with API call...');

    isLoadingCocRequests = true;
    const loadingDiv = document.getElementById('coc-requests-loading');
    const listDiv = document.getElementById('coc-requests-list');
    const emptyDiv = document.getElementById('coc-requests-empty');

    if (loadingDiv) loadingDiv.classList.remove('hidden');
    if (listDiv) listDiv.innerHTML = '';
    if (emptyDiv) emptyDiv.classList.add('hidden');

    try {
        console.log('[COC Requests] Loading requests for user:', session.username, 'role:', session.role);
        const result = await window.callAPI({
            action: 'get_coc_requests',
            username: session.username,
            role: session.role
        });

        console.log('[COC Requests] API result:', result);
        console.log('[COC Requests] API result.success:', result.success);
        console.log('[COC Requests] API result.data type:', typeof result.data, 'isArray:', Array.isArray(result.data));
        console.log('[COC Requests] API result.data value:', result.data);
        console.log('[COC Requests] API result.message:', result.message);
        
        // Check if there are any errors or warnings
        if (result && !result.success) {
            console.error('[COC Requests] API call failed:', result.message || 'Unknown error');
        }

        if (result.success) {
            allCocRequests = Array.isArray(result.data) ? result.data : [];
            console.log('[COC Requests] Loaded', allCocRequests.length, 'requests');
            console.log('[COC Requests] allCocRequests after assignment:', allCocRequests);
            
            if (allCocRequests.length > 0) {
                console.log('[COC Requests] First request:', allCocRequests[0]);
                console.log('[COC Requests] First request keys:', Object.keys(allCocRequests[0]));
            } else {
                console.warn('[COC Requests] No requests found');
                console.warn('[COC Requests] result.data:', result.data);
                console.warn('[COC Requests] Check: RLS policies, user role, query filters');
            }
            
            // Force a small delay to ensure state is updated
            await new Promise(resolve => setTimeout(resolve, 100));
            filterCocRequests();
        } else {
            console.error('[COC Requests] API returned error:', result.message);
            throw new Error(result.message || 'Không thể tải danh sách đề nghị COC');
        }
    } catch (error) {
        console.error('Load COC requests error:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
        if (listDiv) listDiv.innerHTML = '<div class="text-center py-8 text-red-600">Lỗi tải dữ liệu</div>';
    } finally {
        if (loadingDiv) loadingDiv.classList.add('hidden');
        isLoadingCocRequests = false;
    }
}

function filterCocRequests() {
    console.log('[COC Requests] filterCocRequests called');
    console.log('[COC Requests] allCocRequests count:', allCocRequests.length);
    
    // Don't filter if we haven't loaded data yet
    console.log('[COC Requests] Checking if need to load data:', {
        allCocRequestsLength: allCocRequests.length,
        isLoadingCocRequests: isLoadingCocRequests,
        shouldLoad: allCocRequests.length === 0 && !isLoadingCocRequests
    });
    
    if (allCocRequests.length === 0 && !isLoadingCocRequests) {
        console.warn('[COC Requests] No data loaded yet, calling loadCocRequests first...');
        if (typeof window.loadCocRequests === 'function') {
            console.log('[COC Requests] window.loadCocRequests exists, calling...');
            window.loadCocRequests();
            return; // Exit early, loadCocRequests will call filterCocRequests after loading
        } else {
            console.error('[COC Requests] window.loadCocRequests function not found!');
        }
    } else {
        console.log('[COC Requests] Skipping auto-load:', {
            reason: allCocRequests.length > 0 ? 'has data' : 'is loading'
        });
    }
    
    console.log('[COC Requests] allCocRequests data:', allCocRequests);
    
    const statusFilter = document.getElementById('filter-coc-status')?.value || '';
    const contractCodeFilter = (document.getElementById('filter-coc-contract-code')?.value || '').trim().toLowerCase();
    const customerFilter = (document.getElementById('filter-coc-customer')?.value || '').trim().toLowerCase();
    const dateFilter = document.getElementById('filter-coc-date')?.value || '';

    console.log('[COC Requests] Filters:', { statusFilter, contractCodeFilter, customerFilter, dateFilter });

    filteredCocRequests = allCocRequests.filter(request => {
        // Status filter
        if (statusFilter && request.status !== statusFilter) return false;
        
        // Contract code filter
        if (contractCodeFilter && !(request.contract_code || '').toLowerCase().includes(contractCodeFilter)) return false;
        
        // Customer name filter
        if (customerFilter && !(request.customer_name || '').toLowerCase().includes(customerFilter)) return false;
        
        // Date filter
        if (dateFilter) {
            const requestDate = new Date(request.request_date).toISOString().split('T')[0];
            if (requestDate !== dateFilter) return false;
        }
        
        return true;
    });

    renderCocRequests();
}

function renderCocRequests() {
    console.log('[COC Requests] renderCocRequests called, filtered count:', filteredCocRequests.length);
    
    const listDiv = document.getElementById('coc-requests-list');
    const emptyDiv = document.getElementById('coc-requests-empty');

    if (!listDiv) {
        console.error('[COC Requests] listDiv not found');
        return;
    }

    try {
        if (filteredCocRequests.length === 0) {
            listDiv.innerHTML = '';
            if (emptyDiv) emptyDiv.classList.remove('hidden');
            return;
        }

        if (emptyDiv) emptyDiv.classList.add('hidden');

        const session = JSON.parse(localStorage.getItem('user_session') || '{}');
        const userRole = session.role || '';
        const username = session.username || '';

        // Check permissions using hasPermission function
        const hasIssuePermission = typeof window.hasPermission === 'function' 
            ? window.hasPermission(session, 'issue_coc') 
            : (userRole === 'SALEADMIN' || userRole === 'ADMIN');
        
        const hasDisbursePermission = typeof window.hasPermission === 'function'
            ? window.hasPermission(session, 'disburse_coc')
            : (userRole === 'KETOAN' || userRole === 'ADMIN');
        
        // SaleAdmin có thể cập nhật thông tin tài chính (dùng cùng permission với issue_coc)
        const hasUpdateFinancialPermission = hasIssuePermission;

        listDiv.innerHTML = filteredCocRequests.map(request => {
            const statusInfo = COC_STATUS[request.status] || COC_STATUS.pending;
            const canIssue = hasIssuePermission && request.status === 'pending';
            const canDisburse = hasDisbursePermission && request.status === 'issued';
            const canUpdateFinancial = hasUpdateFinancialPermission && request.status === 'pending';
            const canView = true; // All roles can view (if they have view_coc_requests permission)

            // Use explicit class names instead of template strings for Tailwind
            const statusClass = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'issued': 'bg-blue-100 text-blue-800',
                'disbursed': 'bg-orange-100 text-orange-800',
                'closed': 'bg-green-100 text-green-800'
            }[request.status] || 'bg-yellow-100 text-yellow-800';

            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">
                                    ${statusInfo.label}
                                </span>
                                <span class="font-bold text-gray-800">${escapeHtml(request.contract_code || 'N/A')}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                <div><strong>Khách hàng:</strong> ${escapeHtml(request.customer_name || '-')}</div>
                                <div><strong>Xe:</strong> ${escapeHtml(request.car_model || '-')} ${escapeHtml(request.car_version || '')} ${escapeHtml(request.car_color || '')}</div>
                                <div><strong>Ngày đề nghị:</strong> ${request.request_date ? new Date(request.request_date).toLocaleDateString('vi-VN') : '-'}</div>
                                ${request.actual_issue_date ? `<div><strong>Ngày cấp:</strong> ${new Date(request.actual_issue_date).toLocaleDateString('vi-VN')}</div>` : ''}
                                ${request.po_number ? `<div><strong>PO:</strong> ${escapeHtml(request.po_number)}</div>` : ''}
                                ${request.import_price ? `<div><strong>Giá nhập:</strong> ${parseFloat(request.import_price).toLocaleString('vi-VN')} VNĐ</div>` : ''}
                                ${request.business_days_delayed > 0 ? `<div><strong>Số ngày trễ:</strong> ${request.business_days_delayed} ngày làm việc</div>` : ''}
                                ${request.interest_amount > 0 ? `<div><strong>Lãi:</strong> ${parseFloat(request.interest_amount).toLocaleString('vi-VN')} VNĐ</div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${canView ? `<button onclick="viewCocRequestDetail('${request.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                                <i class="fa-solid fa-eye mr-1"></i>Xem
                            </button>` : ''}
                            ${canUpdateFinancial ? `<button onclick="openCocFinancialModal('${request.id}')" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-sm">
                                <i class="fa-solid fa-coins mr-1"></i>Cập nhật tài chính
                            </button>` : ''}
                            ${canIssue ? `<button onclick="openCocIssueModal('${request.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                                <i class="fa-solid fa-certificate mr-1"></i>Cấp COC
                            </button>` : ''}
                            ${canDisburse ? `<button onclick="openCocDisburseModal('${request.id}')" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition text-sm">
                                <i class="fa-solid fa-upload mr-1"></i>Giải ngân
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('[COC Requests] Rendering completed');
    } catch (error) {
        console.error('[COC Requests] Render error:', error);
        listDiv.innerHTML = '<div class="text-center py-8 text-red-600">Lỗi hiển thị dữ liệu: ' + escapeHtml(error.message) + '</div>';
    }
}

function viewCocRequestDetail(requestId) {
    if (typeof window.openCocDetailModal === 'function') {
        window.openCocDetailModal(requestId);
    } else {
        // Fallback: show alert if modal not loaded
        const request = allCocRequests.find(r => r.id === requestId);
        if (!request) return;
        alert(`Chi tiết đề nghị COC:\n\nMã HĐ: ${request.contract_code}\nKhách hàng: ${request.customer_name}\nTrạng thái: ${COC_STATUS[request.status].label}`);
    }
}

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Expose functions to window
if (typeof window !== 'undefined') {
    window.loadCocRequests = loadCocRequests;
    window.filterCocRequests = filterCocRequests;
    window.viewCocRequestDetail = viewCocRequestDetail;
    // openCocIssueModal is defined in modals-coc-issue.html
    // openCocDisburseModal is defined in modals-coc-disburse.html
    
    // Expose allCocRequests for modals
    Object.defineProperty(window, 'allCocRequests', {
        get: () => allCocRequests,
        configurable: true
    });
    
    console.log('✅ COC requests functions exposed to window');
    
    // Also try to load immediately if tab is active (as a fallback)
    setTimeout(() => {
        const tab = document.getElementById('tab-coc-requests');
        if (tab && tab.classList.contains('active')) {
            console.log('[COC Requests] Tab is active after component load, calling loadCocRequests');
            loadCocRequests();
        }
    }, 1500);
}

// Auto-load when tab is active
if (typeof document !== 'undefined') {
    // Check if tab is already active when component loads
    const checkAndLoad = () => {
        const tab = document.getElementById('tab-coc-requests');
        console.log('[COC Requests] Checking tab state:', {
            tabExists: !!tab,
            hasActiveClass: tab ? tab.classList.contains('active') : false,
            tabClasses: tab ? Array.from(tab.classList) : []
        });
        
        if (tab && tab.classList.contains('active')) {
            console.log('[COC Requests] Tab is already active on load, calling loadCocRequests');
            if (typeof window.loadCocRequests === 'function') {
                console.log('[COC Requests] window.loadCocRequests exists, calling...');
                window.loadCocRequests();
            } else {
                console.error('[COC Requests] window.loadCocRequests function not found');
            }
        } else {
            console.log('[COC Requests] Tab is not active, waiting for navigation.js to call loadCocRequests');
        }
    };
    
    // Check immediately if DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkAndLoad, 1000); // Delay to ensure components are loaded
        });
    } else {
        // Delay to ensure tab rendering is complete
        setTimeout(checkAndLoad, 1000);
    }
}
</script>

