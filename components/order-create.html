<div id="tab-order-create" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-5xl mx-auto">
        <div class="bg-blue-50 px-4 py-3 md:px-6 md:py-4 border-b border-blue-100">
            <h2 class="text-base md:text-lg font-bold text-blue-800">
                <i class="fa-solid fa-file-circle-plus mr-2"></i>Nh·∫≠p Li·ªáu ƒê∆°n H√†ng
            </h2>
        </div>
        <div class="p-3 md:p-6">
            <form id="form-create-order" onsubmit="handleCreateOrder(event)">
                <!-- T√¨m ki·∫øm kh√°ch h√†ng theo CCCD -->
                <div class="mb-4 md:mb-6 bg-gray-50 p-3 md:p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xs md:text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-blue-600"></i>
                        T√¨m ki·∫øm kh√°ch h√†ng (theo CCCD)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <input 
                                type="text" 
                                id="search-cccd" 
                                class="input text-sm md:text-base w-full" 
                                placeholder="Nh·∫≠p s·ªë CCCD ƒë·ªÉ t√¨m ki·∫øm kh√°ch h√†ng..."
                                onkeypress="if(event.key === 'Enter') searchCustomerByCCCD(event)"
                            >
                        </div>
                        <div>
                            <button 
                                type="button" 
                                onclick="searchCustomerByCCCD(event)" 
                                class="w-full bg-blue-600 text-white font-bold py-2.5 md:py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition touch-manipulation text-sm md:text-base"
                            >
                                <i class="fa-solid fa-search mr-2"></i>T√¨m ki·∫øm
                            </button>
                        </div>
                    </div>
                    <div id="customer-search-result" class="mt-3 hidden"></div>
                </div>

                <!-- Th√¥ng tin Kh√°ch h√†ng -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">
                        1. Th√¥ng tin Kh√°ch h√†ng
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">H·ªç t√™n Kh√°ch h√†ng *</label>
                            <input name="customer_name" id="customer_name" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">S·ªë CCCD / CMND *</label>
                            <input name="cccd" id="cccd" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input name="phone" id="phone" type="tel" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Email</label>
                            <input name="email" id="email" type="email" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Ng√†y c·∫•p CCCD</label>
                            <input name="issue_date" id="issue_date" type="date" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">N∆°i c·∫•p CCCD</label>
                            <input name="issue_place" id="issue_place" class="input text-sm md:text-base w-full">
                        </div>
                        <div class="md:col-span-2">
                            <label class="label text-xs md:text-sm mb-1 block">ƒê·ªãa ch·ªâ</label>
                            <textarea name="address" id="address" rows="2" class="input text-sm md:text-base w-full"></textarea>
                        </div>
                    </div>

                    <!-- Upload file CCCD -->
                    <div class="mt-4">
                        <label class="label">H√¨nh ·∫£nh CCCD</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    M·∫∑t tr∆∞·ªõc CCCD *
                                </label>
                                <div class="flex items-center gap-3">
                                    <input 
                                        type="file" 
                                        id="cccd_front" 
                                        name="cccd_front" 
                                        accept="image/*" 
                                        class="hidden"
                                        onchange="handleFileSelect(this, 'cccd_front_preview')"
                                    >
                                    <label 
                                        for="cccd_front" 
                                        class="flex-1 cursor-pointer bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-100 transition"
                                    >
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-600">Ch·ªçn file ·∫£nh</p>
                                    </label>
                                </div>
                                <div id="cccd_front_preview" class="mt-2 hidden">
                                    <img src="" alt="CCCD Front" class="max-w-full h-32 object-contain border rounded">
                                    <button 
                                        type="button" 
                                        onclick="removeFile('cccd_front', 'cccd_front_preview')" 
                                        class="mt-1 text-xs text-red-600 hover:text-red-800"
                                    >
                                        X√≥a
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    M·∫∑t sau CCCD *
                                </label>
                                <div class="flex items-center gap-3">
                                    <input 
                                        type="file" 
                                        id="cccd_back" 
                                        name="cccd_back" 
                                        accept="image/*" 
                                        class="hidden"
                                        onchange="handleFileSelect(this, 'cccd_back_preview')"
                                    >
                                    <label 
                                        for="cccd_back" 
                                        class="flex-1 cursor-pointer bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-100 transition"
                                    >
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-600">Ch·ªçn file ·∫£nh</p>
                                    </label>
                                </div>
                                <div id="cccd_back_preview" class="mt-2 hidden">
                                    <img src="" alt="CCCD Back" class="max-w-full h-32 object-contain border rounded">
                                    <button 
                                        type="button" 
                                        onclick="removeFile('cccd_back', 'cccd_back_preview')" 
                                        class="mt-1 text-xs text-red-600 hover:text-red-800"
                                    >
                                        X√≥a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th√¥ng tin ƒê∆°n h√†ng -->
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">
                        2. Th√¥ng tin ƒê∆°n h√†ng
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">D√≤ng Xe</label>
                            <input name="car_model" id="car_model" class="input" placeholder="VD: VF 5 Plus">
                        </div>
                        <div>
                            <label class="label">Phi√™n b·∫£n</label>
                            <input name="car_version" id="car_version" class="input" placeholder="Eco / Plus">
                        </div>
                        <div>
                            <label class="label">M√†u s·∫Øc</label>
                            <input name="car_color" id="car_color" class="input">
                        </div>
                        <div class="md:col-span-3">
                            <label class="label">H√¨nh th·ª©c thanh to√°n</label>
                            <select name="payment_method" id="payment_method" class="input bg-white">
                                <option value="">-- Ch·ªçn h√¨nh th·ª©c --</option>
                                <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                                <option value="Tr·∫£ g√≥p">Tr·∫£ g√≥p ng√¢n h√†ng</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label">Ghi ch√∫</label>
                            <textarea name="notes" id="notes" rows="2" class="input" placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition transform active:scale-95"
                    >
                        <i class="fa-solid fa-floppy-disk mr-2"></i>L∆∞u ƒê∆°n H√†ng
                    </button>
                    <button 
                        type="button" 
                        onclick="resetOrderForm()" 
                        class="px-6 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition"
                    >
                        <i class="fa-solid fa-rotate-left mr-2"></i>L√†m m·ªõi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Search customer by CCCD
async function searchCustomerByCCCD(event) {
    event.preventDefault();
    const cccdInput = document.getElementById('search-cccd');
    const cccd = cccdInput.value.trim();
    
    if (!cccd) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng nh·∫≠p s·ªë CCCD', 'warning');
        }
        return;
    }

    const result = await window.callAPI({
        action: 'search_customer_by_cccd',
        cccd: cccd
    });

    const resultDiv = document.getElementById('customer-search-result');
    
    if (result.success && result.data) {
        // Fill form v·ªõi d·ªØ li·ªáu kh√°ch h√†ng
        document.getElementById('customer_name').value = result.data.name || '';
        document.getElementById('cccd').value = result.data.cccd || '';
        document.getElementById('phone').value = result.data.phone || '';
        document.getElementById('email').value = result.data.email || '';
        document.getElementById('address').value = result.data.address || '';
        document.getElementById('issue_date').value = result.data.issue_date || '';
        document.getElementById('issue_place').value = result.data.issue_place || '';
        
        resultDiv.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded-lg';
        resultDiv.innerHTML = `
            <p class="text-sm text-green-700">
                <i class="fa-solid fa-check-circle mr-2"></i>
                ƒê√£ t√¨m th·∫•y kh√°ch h√†ng: <strong>${result.data.name}</strong>
            </p>
        `;
        resultDiv.classList.remove('hidden');
    } else {
        resultDiv.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg';
        resultDiv.innerHTML = `
            <p class="text-sm text-blue-700">
                <i class="fa-solid fa-info-circle mr-2"></i>
                Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng. Vui l√≤ng nh·∫≠p th√¥ng tin m·ªõi.
            </p>
        `;
        resultDiv.classList.remove('hidden');
    }
}

// Handle file select
function handleFileSelect(input, previewId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(previewId);
            if (preview) {
                const img = preview.querySelector('img');
                if (img) {
                    img.src = e.target.result;
                }
                preview.classList.remove('hidden');
            }
        };
        reader.onerror = function(error) {
            console.error('Error reading file:', error);
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
            }
        };
        reader.readAsDataURL(file);
    }
}

// Remove file
function removeFile(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (input) {
        input.value = '';
    }
    if (preview) {
        preview.classList.add('hidden');
    }
}

// Handle create order
async function handleCreateOrder(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Validate required fields
    if (!formData.get('customer_name') || !formData.get('cccd')) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng', 'warning');
        }
        return;
    }

    // Get session
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'danger');
        }
        return;
    }

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang x·ª≠ l√Ω...';

    // Upload files to Google Drive first
    const cccdFront = document.getElementById('cccd_front').files[0];
    const cccdBack = document.getElementById('cccd_back').files[0];
    
    let cccdFrontUrl = null;
    let cccdBackUrl = null;
    const attachments = [];

    // Upload files if available
    if (cccdFront || cccdBack) {
        try {
            console.log('üì§ Starting file upload...');
            console.log('Front file:', cccdFront?.name);
            console.log('Back file:', cccdBack?.name);
            
            // Try upload - Priority: Supabase Storage (no CORS) > Google Drive
            let uploadResult = null;
            
            // Method 1: Try Supabase Storage first (no CORS issues)
            if (window.supabaseStorageAPI && window.supabaseStorageAPI.uploadFiles) {
                console.log('üîÑ Trying Supabase Storage upload...');
                
                const dataTransfer = new DataTransfer();
                const fileMapping = [];
                
                if (cccdFront) {
                    dataTransfer.items.add(cccdFront);
                    fileMapping.push({ file: cccdFront, type: 'front' });
                }
                
                if (cccdBack) {
                    dataTransfer.items.add(cccdBack);
                    fileMapping.push({ file: cccdBack, type: 'back' });
                }
                
                uploadResult = await window.supabaseStorageAPI.uploadFiles(
                    dataTransfer.files,
                    'order-files',
                    'cccd'
                );
                
                if (uploadResult.success) {
                    console.log('‚úÖ Upload successful via Supabase Storage:', uploadResult.urls);
                } else {
                    console.warn('‚ö†Ô∏è Supabase Storage upload failed, trying Google Drive...');
                }
            }
            
            // Method 2: Fallback to Google Drive if Supabase failed or not available
            if (!uploadResult || !uploadResult.success) {
                if (window.googleDocsAPI && window.googleDocsAPI.uploadFiles) {
                    console.log('üîÑ Trying Google Drive upload...');
                    
                    // Create FileList from files
                    const dataTransfer = new DataTransfer();
                    const fileMapping = []; // Track which file is front/back
                    
                    if (cccdFront) {
                        const newName = `CCCD_Front_${formData.get('cccd').trim()}_${Date.now()}.${cccdFront.name.split('.').pop()}`;
                        const renamedFile = new File([cccdFront], newName, { type: cccdFront.type });
                        dataTransfer.items.add(renamedFile);
                        fileMapping.push({ file: renamedFile, type: 'front', original: cccdFront });
                    }
                    
                    if (cccdBack) {
                        const newName = `CCCD_Back_${formData.get('cccd').trim()}_${Date.now()}.${cccdBack.name.split('.').pop()}`;
                        const renamedFile = new File([cccdBack], newName, { type: cccdBack.type });
                        dataTransfer.items.add(renamedFile);
                        fileMapping.push({ file: renamedFile, type: 'back', original: cccdBack });
                    }
                    
                    uploadResult = await window.googleDocsAPI.uploadFiles(dataTransfer.files);
                    
                    if (uploadResult.success && uploadResult.urls && uploadResult.urls.length > 0) {
                        console.log('‚úÖ Upload successful via Google Drive:', uploadResult.urls);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Neither Supabase Storage nor Google Drive API available');
                }
            }
            
            // Process upload result
            // Check if upload was successful (even if response format is off)
            console.log('üìã Upload result:', uploadResult);
            
            if (uploadResult) {
                // Check multiple ways to determine success
                const hasUrls = uploadResult.urls && Array.isArray(uploadResult.urls) && uploadResult.urls.length > 0;
                const hasSuccessFlag = uploadResult.success === true;
                const hasNoError = !uploadResult.error && !uploadResult.corsError;
                
                // If we have URLs or success flag, consider it successful
                if ((hasUrls || hasSuccessFlag) && hasNoError) {
                    console.log('‚úÖ Upload successful:', uploadResult.urls || 'No URLs but success flag is true');
                    
                    // Map files to front/back based on order if URLs available
                    if (hasUrls) {
                        uploadResult.urls.forEach((uploadedFile, index) => {
                            if (index === 0 && cccdFront) {
                                cccdFrontUrl = uploadedFile.url || uploadedFile;
                            } else if (index === 1 && cccdBack) {
                                cccdBackUrl = uploadedFile.url || uploadedFile;
                            }
                            attachments.push({
                                name: uploadedFile.name || `File ${index + 1}`,
                                url: uploadedFile.url || uploadedFile
                            });
                        });
                    } else {
                        // File uploaded but no URLs in response - still continue
                        console.log('‚ö†Ô∏è Upload successful but no URLs in response. Files should be in Drive folder.');
                        if (typeof window.showToast === 'function') {
                            window.showToast('File ƒë√£ ƒë∆∞·ª£c upload (ki·ªÉm tra Google Drive folder)', 'success');
                        }
                    }
                    
                    if (typeof window.showToast === 'function' && hasUrls) {
                        window.showToast('ƒê√£ upload file th√†nh c√¥ng!', 'success');
                    }
                } else {
                    // Check if it's just a warning (file might still be uploaded)
                    console.warn('‚ö†Ô∏è Upload response warning:', uploadResult);
                    
                    // Even if response says failed, check if we should continue
                    // (file might be uploaded but response parsing failed)
                    const shouldContinue = !uploadResult.corsError && !uploadResult.error;
                    
                    if (shouldContinue) {
                        console.log('‚ÑπÔ∏è Upload may have succeeded despite response. Continuing...');
                        if (typeof window.showToast === 'function') {
                            window.showToast('File c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c upload. Ki·ªÉm tra Google Drive folder.', 'info');
                        }
                    } else {
                        const errorMsg = uploadResult.corsError 
                            ? 'L·ªói CORS v·ªõi Google Drive. ƒê√£ th·ª≠ Supabase Storage nh∆∞ng c≈©ng th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh.'
                            : 'L∆∞u √Ω: Upload file th·∫•t b·∫°i: ' + (uploadResult.message || uploadResult.error || 'Unknown error');
                        
                        if (typeof window.showToast === 'function') {
                            window.showToast(errorMsg, uploadResult.corsError ? 'danger' : 'warning');
                        } else {
                            console.error(errorMsg);
                        }
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è No upload result received');
                if (typeof window.showToast === 'function') {
                    window.showToast('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server. File c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c upload.', 'warning');
                }
            }
        } catch (uploadError) {
            console.error('‚ùå Upload files error:', uploadError);
            showToast('L∆∞u √Ω: Upload file th·∫•t b·∫°i, ti·∫øp t·ª•c l∆∞u ƒë∆°n h√†ng kh√¥ng c√≥ file: ' + uploadError.message, 'warning');
        }
    }

    // Prepare customer data
    const customerData = {
        cccd: formData.get('cccd').trim(),
        name: formData.get('customer_name').trim(),
        phone: formData.get('phone') || null,
        email: formData.get('email') || null,
        address: formData.get('address') || null,
        issue_date: formData.get('issue_date') || null,
        issue_place: formData.get('issue_place') || null,
        cccd_front_image_url: cccdFrontUrl,
        cccd_back_image_url: cccdBackUrl
    };

    // Upsert customer
    const customerResult = await window.callAPI({
        action: 'upsert_customer',
        ...customerData
    });

    if (!customerResult.success) {
        // Restore button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói l∆∞u th√¥ng tin kh√°ch h√†ng: ' + customerResult.message, 'danger');
        }
        console.error('Customer upsert error:', customerResult);
        return;
    }

    console.log('‚úÖ Customer saved successfully:', customerResult.data);

    // Prepare order data
    const orderData = {
        requester: session.username,
        customer_cccd: customerData.cccd,
        car_model: formData.get('car_model') || null,
        car_version: formData.get('car_version') || null,
        car_color: formData.get('car_color') || null,
        payment_method: formData.get('payment_method') || null,
        notes: formData.get('notes') || null,
        attachments: attachments.length > 0 ? attachments : []
    };

    console.log('üì¶ Creating order with data:', orderData);

    // Create order
    const orderResult = await window.callAPI({
        action: 'create_order',
        ...orderData
    });

    // Restore button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;

    if (orderResult.success) {
        console.log('‚úÖ Order created successfully:', orderResult.data);
        if (typeof window.showToast === 'function') {
            window.showToast('ƒê√£ t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
        }
        resetOrderForm();
        // C√≥ th·ªÉ chuy·ªÉn sang trang danh s√°ch ƒë∆°n h√†ng
        setTimeout(() => {
            if (window.switchTab) {
                window.switchTab('my-orders');
            }
        }, 1500);
    } else {
        console.error('‚ùå Order creation error:', orderResult);
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói t·∫°o ƒë∆°n h√†ng: ' + orderResult.message, 'danger');
        }
    }
}

// Reset form
function resetOrderForm() {
    document.getElementById('form-create-order').reset();
    document.getElementById('customer-search-result').classList.add('hidden');
    document.getElementById('cccd_front_preview').classList.add('hidden');
    document.getElementById('cccd_back_preview').classList.add('hidden');
    document.getElementById('search-cccd').value = '';
}

// Expose functions to window for inline event handlers
// This must be at the end of the script, after all functions are defined
if (typeof window !== 'undefined') {
    window.handleFileSelect = handleFileSelect;
    window.removeFile = removeFile;
    window.searchCustomerByCCCD = searchCustomerByCCCD;
    window.handleCreateOrder = handleCreateOrder;
    window.resetOrderForm = resetOrderForm;
    
    console.log('‚úÖ Order create functions exposed to window');
}
</script>

