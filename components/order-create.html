<div id="tab-order-create" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-5xl mx-auto">
        <div class="bg-blue-50 px-4 py-3 md:px-6 md:py-4 border-b border-blue-100">
            <h2 class="text-base md:text-lg font-bold text-blue-800">
                <i class="fa-solid fa-file-circle-plus mr-2"></i>Nh·∫≠p Li·ªáu ƒê∆°n H√†ng
            </h2>
        </div>
        <div class="p-3 md:p-6">
            <form id="form-create-order" onsubmit="handleCreateOrder(event)">
                <!-- T√¨m ki·∫øm kh√°ch h√†ng theo CCCD -->
                <div class="mb-4 md:mb-6 bg-gray-50 p-3 md:p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xs md:text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-blue-600"></i>
                        T√¨m ki·∫øm kh√°ch h√†ng (theo CCCD)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <input 
                                type="text" 
                                id="search-cccd" 
                                class="input text-sm md:text-base w-full" 
                                placeholder="Nh·∫≠p s·ªë CCCD ƒë·ªÉ t√¨m ki·∫øm kh√°ch h√†ng..."
                                onkeypress="if(event.key === 'Enter') searchCustomerByCCCD(event)"
                            >
                        </div>
                        <div>
                            <button 
                                type="button" 
                                onclick="searchCustomerByCCCD(event)" 
                                class="w-full bg-blue-600 text-white font-bold py-2.5 md:py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition touch-manipulation text-sm md:text-base"
                            >
                                <i class="fa-solid fa-search mr-2"></i>T√¨m ki·∫øm
                            </button>
                        </div>
                    </div>
                    <div id="customer-search-result" class="mt-3 hidden"></div>
                </div>

                <!-- Th√¥ng tin Kh√°ch h√†ng -->
                <div class="mb-4 md:mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">
                        1. Th√¥ng tin Kh√°ch h√†ng
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">H·ªç t√™n Kh√°ch h√†ng *</label>
                            <input name="customer_name" id="customer_name" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">S·ªë CCCD / CMND *</label>
                            <input name="cccd" id="cccd" class="input text-sm md:text-base w-full" required>
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input name="phone" id="phone" type="tel" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Email</label>
                            <input name="email" id="email" type="email" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">Ng√†y c·∫•p CCCD</label>
                            <input name="issue_date" id="issue_date" type="date" class="input text-sm md:text-base w-full">
                        </div>
                        <div>
                            <label class="label text-xs md:text-sm mb-1 block">N∆°i c·∫•p CCCD</label>
                            <input name="issue_place" id="issue_place" class="input text-sm md:text-base w-full">
                        </div>
                        <div class="md:col-span-2">
                            <label class="label text-xs md:text-sm mb-1 block">ƒê·ªãa ch·ªâ</label>
                            <textarea name="address" id="address" rows="2" class="input text-sm md:text-base w-full"></textarea>
                        </div>
                    </div>

                    <!-- Upload CCCD Images -->
                    <div class="mt-4">
                        <label class="label">H√¨nh ·∫£nh ƒë√≠nh k√®m</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fa-solid fa-asterisk text-red-500 text-xs mr-1"></i>VNeid <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="file" 
                                    id="cccd_front" 
                                    name="cccd_front" 
                                    accept="image/*" 
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                    required
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fa-solid fa-asterisk text-red-500 text-xs mr-1"></i>UNC(ƒë·∫∑t c·ªçc) <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="file" 
                                    id="cccd_back" 
                                    name="cccd_back" 
                                    accept="image/*" 
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                    required
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th√¥ng tin ƒê∆°n h√†ng -->
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-1">
                        2. Th√¥ng tin ƒê∆°n h√†ng
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">D√≤ng Xe</label>
                            <input name="car_model" id="car_model" class="input" placeholder="VD: VF 5 Plus">
                        </div>
                        <div>
                            <label class="label">Phi√™n b·∫£n</label>
                            <input name="car_version" id="car_version" class="input" placeholder="Eco / Plus">
                        </div>
                        <div>
                            <label class="label">M√†u s·∫Øc</label>
                            <input name="car_color" id="car_color" class="input">
                        </div>
                        <div class="md:col-span-3">
                            <label class="label">H√¨nh th·ª©c thanh to√°n</label>
                            <select name="payment_method" id="payment_method" class="input bg-white">
                                <option value="">-- Ch·ªçn h√¨nh th·ª©c --</option>
                                <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                                <option value="Tr·∫£ g√≥p">Tr·∫£ g√≥p ng√¢n h√†ng</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label">Ghi ch√∫</label>
                            <textarea name="notes" id="notes" rows="2" class="input" placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition transform active:scale-95"
                    >
                        <i class="fa-solid fa-floppy-disk mr-2"></i>L∆∞u ƒê∆°n H√†ng
                    </button>
                    <button 
                        type="button" 
                        onclick="resetOrderForm()" 
                        class="px-6 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition"
                    >
                        <i class="fa-solid fa-rotate-left mr-2"></i>L√†m m·ªõi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Search customer by CCCD
async function searchCustomerByCCCD(event) {
    event.preventDefault();
    const cccdInput = document.getElementById('search-cccd');
    const cccd = cccdInput.value.trim();
    
    if (!cccd) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng nh·∫≠p s·ªë CCCD', 'warning');
        }
        return;
    }

    const result = await window.callAPI({
        action: 'search_customer_by_cccd',
        cccd: cccd
    });

    const resultDiv = document.getElementById('customer-search-result');
    
    if (result.success && result.data) {
        // Fill form v·ªõi d·ªØ li·ªáu kh√°ch h√†ng
        document.getElementById('customer_name').value = result.data.name || '';
        document.getElementById('cccd').value = result.data.cccd || '';
        document.getElementById('phone').value = result.data.phone || '';
        document.getElementById('email').value = result.data.email || '';
        document.getElementById('address').value = result.data.address || '';
        document.getElementById('issue_date').value = result.data.issue_date || '';
        document.getElementById('issue_place').value = result.data.issue_place || '';
        
        resultDiv.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded-lg';
        resultDiv.innerHTML = `
            <p class="text-sm text-green-700">
                <i class="fa-solid fa-check-circle mr-2"></i>
                ƒê√£ t√¨m th·∫•y kh√°ch h√†ng: <strong>${result.data.name}</strong>
            </p>
        `;
        resultDiv.classList.remove('hidden');
    } else {
        resultDiv.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg';
        resultDiv.innerHTML = `
            <p class="text-sm text-blue-700">
                <i class="fa-solid fa-info-circle mr-2"></i>
                Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng. Vui l√≤ng nh·∫≠p th√¥ng tin m·ªõi.
            </p>
        `;
        resultDiv.classList.remove('hidden');
    }
}

// Handle file select
function handleFileSelect(input, previewId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(previewId);
            if (preview) {
                const img = preview.querySelector('img');
                if (img) {
                    img.src = e.target.result;
                }
                preview.classList.remove('hidden');
            }
        };
        reader.onerror = function(error) {
            console.error('Error reading file:', error);
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
            }
        };
        reader.readAsDataURL(file);
    }
}

// Remove file
function removeFile(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (input) {
        input.value = '';
    }
    if (preview) {
        preview.classList.add('hidden');
    }
}

// Handle create order
async function handleCreateOrder(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Validate required fields
    if (!formData.get('customer_name') || !formData.get('cccd')) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng', 'warning');
        }
        return;
    }

    // Validate required CCCD images
    const cccdFront = document.getElementById('cccd_front').files[0];
    const cccdBack = document.getElementById('cccd_back').files[0];
    
    if (!cccdFront) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒë√≠nh k√®m h√¨nh VNeid', 'warning');
        }
        document.getElementById('cccd_front').focus();
        return;
    }
    
    if (!cccdBack) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒë√≠nh k√®m h√¨nh UNC(ƒë·∫∑t c·ªçc)', 'warning');
        }
        document.getElementById('cccd_back').focus();
        return;
    }

    // Get session
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        if (typeof window.showToast === 'function') {
            window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'danger');
        }
        return;
    }

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang x·ª≠ l√Ω...';
    
    let cccdFrontUrl = null;
    let cccdBackUrl = null;

    // Upload files to Google Drive
    try {
        console.log('üì§ Starting file upload to Google Drive...');
        console.log('CCCD Front:', cccdFront?.name);
        console.log('CCCD Back:', cccdBack?.name);
        
        // Upload to Google Drive
        let uploadResult = null;
        const allFiles = [
            { file: cccdFront, type: 'cccd_front' },
            { file: cccdBack, type: 'cccd_back' }
        ];
        
        // Upload to Google Drive
        if (window.googleDocsAPI && window.googleDocsAPI.uploadFiles) {
            console.log('üîÑ Uploading to Google Drive...');
            
            const dataTransfer = new DataTransfer();
            const cccd = formData.get('cccd').trim();
            const timestamp = Date.now();
            
            allFiles.forEach(({ file, type }) => {
                const ext = file.name.split('.').pop();
                const prefix = type === 'cccd_front' ? 'CCCD_Front' : 'CCCD_Back';
                const newName = `${prefix}_${cccd}_${timestamp}.${ext}`;
                const renamedFile = new File([file], newName, { type: file.type });
                dataTransfer.items.add(renamedFile);
            });
            
            uploadResult = await window.googleDocsAPI.uploadFiles(dataTransfer.files);
            
            if (uploadResult.success && uploadResult.urls && uploadResult.urls.length > 0) {
                console.log('‚úÖ Upload successful via Google Drive:', uploadResult.urls);
            }
        } else {
            // Restore button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói: Google Drive API ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh', 'danger');
            }
            return;
        }
        
        // Process upload result
        console.log('üìã Upload result:', uploadResult);
        
        if (uploadResult && uploadResult.success) {
            const hasUrls = uploadResult.urls && Array.isArray(uploadResult.urls) && uploadResult.urls.length > 0;
            
            if (hasUrls) {
                console.log('‚úÖ Upload successful, mapping files to URLs...');
                
                // Map files to URLs based on filename
                console.log('üìã Processing uploaded files. Total:', uploadResult.urls.length);
                console.log('üìã Upload result URLs:', uploadResult.urls);
                
                uploadResult.urls.forEach((uploadedFile, index) => {
                    console.log(`Processing file ${index + 1}/${uploadResult.urls.length}:`, uploadedFile);
                    
                    const fileUrl = uploadedFile.url || uploadedFile;
                    const fileName = (uploadedFile.name || '').toLowerCase();
                    
                    // Match file by filename
                    if (fileName.includes('cccd_front')) {
                        cccdFrontUrl = fileUrl;
                        console.log('‚úÖ CCCD Front URL:', fileUrl);
                    } else if (fileName.includes('cccd_back')) {
                        cccdBackUrl = fileUrl;
                        console.log('‚úÖ CCCD Back URL:', fileUrl);
                    } else {
                        // Fallback to index if filename doesn't match
                        if (index === 0) {
                            cccdFrontUrl = fileUrl;
                            console.log('‚ö†Ô∏è Using index fallback for CCCD Front:', fileUrl);
                        } else if (index === 1) {
                            cccdBackUrl = fileUrl;
                            console.log('‚ö†Ô∏è Using index fallback for CCCD Back:', fileUrl);
                        }
                    }
                });
                
                console.log('\nüìä FINAL URLs:');
                console.log('  - cccdFrontUrl:', cccdFrontUrl);
                console.log('  - cccdBackUrl:', cccdBackUrl);
                
                if (!cccdFrontUrl || !cccdBackUrl) {
                    console.error('\n‚ùå ERROR: Missing URLs after upload!');
                } else {
                    console.log('\n‚úÖ SUCCESS: Both files uploaded successfully!');
                }
                
                if (typeof window.showToast === 'function') {
                    window.showToast('ƒê√£ upload file th√†nh c√¥ng!', 'success');
                }
            } else {
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                if (typeof window.showToast === 'function') {
                    window.showToast('L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c link t·ª´ Google Drive', 'danger');
                }
                return;
            }
        } else {
            // Restore button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            const errorMsg = uploadResult?.corsError 
                ? 'L·ªói CORS v·ªõi Google Drive. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh Google Apps Script.'
                : uploadResult?.message || uploadResult?.error || 'Kh√¥ng th·ªÉ upload file l√™n Google Drive';
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói upload file: ' + errorMsg, 'danger');
            }
            console.error('‚ùå Upload failed:', uploadResult);
            return;
        }
    } catch (uploadError) {
        // Restore button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        console.error('‚ùå Upload files error:', uploadError);
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói upload file: ' + uploadError.message, 'danger');
        }
        return;
    }

    // Prepare customer data
    const customerData = {
        cccd: formData.get('cccd').trim(),
        name: formData.get('customer_name').trim(),
        phone: formData.get('phone') || null,
        email: formData.get('email') || null,
        address: formData.get('address') || null,
        issue_date: formData.get('issue_date') || null,
        issue_place: formData.get('issue_place') || null,
        cccd_front_image_url: cccdFrontUrl,
        cccd_back_image_url: cccdBackUrl
    };

    console.log('üë§ Customer data to save:', customerData);

    // Upsert customer
    const customerResult = await window.callAPI({
        action: 'upsert_customer',
        ...customerData
    });

    console.log('üë§ Customer upsert result:', customerResult);

    if (!customerResult.success) {
        // Restore button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói l∆∞u th√¥ng tin kh√°ch h√†ng: ' + customerResult.message, 'danger');
        }
        console.error('Customer upsert error:', customerResult);
        return;
    }

    console.log('‚úÖ Customer saved successfully:', customerResult.data);

    // Prepare order data
    const orderData = {
        requester: session.username,
        customer_cccd: customerData.cccd,
        car_model: formData.get('car_model') || null,
        car_version: formData.get('car_version') || null,
        car_color: formData.get('car_color') || null,
        payment_method: formData.get('payment_method') || null,
        notes: formData.get('notes') || null
    };

    console.log('üì¶ Creating order with data:', orderData);

    // Create order
    const orderResult = await window.callAPI({
        action: 'create_order',
        ...orderData
    });

    // Restore button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;

    if (orderResult.success) {
        console.log('‚úÖ Order created successfully:', orderResult.data);
        if (typeof window.showToast === 'function') {
            window.showToast('ƒê√£ t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
        }
        resetOrderForm();
        // C√≥ th·ªÉ chuy·ªÉn sang trang danh s√°ch ƒë∆°n h√†ng
        setTimeout(() => {
            if (window.switchTab) {
                window.switchTab('my-orders');
            }
        }, 1500);
    } else {
        console.error('‚ùå Order creation error:', orderResult);
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói t·∫°o ƒë∆°n h√†ng: ' + orderResult.message, 'danger');
        }
    }
}

// Reset form
function resetOrderForm() {
    document.getElementById('form-create-order').reset();
    document.getElementById('customer-search-result').classList.add('hidden');
    document.getElementById('search-cccd').value = '';
}

// Expose functions to window for inline event handlers
// This must be at the end of the script, after all functions are defined
if (typeof window !== 'undefined') {
    window.searchCustomerByCCCD = searchCustomerByCCCD;
    window.handleCreateOrder = handleCreateOrder;
    window.resetOrderForm = resetOrderForm;
    
    console.log('‚úÖ Order create functions exposed to window');
}
</script>

