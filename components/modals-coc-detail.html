<!-- Modal Chi tiết COC Request -->
<div id="modal-coc-detail" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-certificate mr-2"></i>Chi Tiết Đề Nghị Cấp COC
            </h2>
            <button onclick="closeCocDetailModal()" class="text-white hover:text-gray-200">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>

        <div id="coc-detail-content" class="p-6">
            <!-- Loading state -->
            <div id="coc-detail-loading" class="text-center py-8">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Đang tải thông tin...</p>
            </div>

            <!-- Content -->
            <div id="coc-detail-body" class="hidden">
                <!-- Thông tin đề nghị -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-blue-600"></i>
                        Thông Tin Đề Nghị
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Mã đơn hàng:</span>
                            <span id="detail-contract-code" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Khách hàng:</span>
                            <span id="detail-customer-name" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số điện thoại:</span>
                            <span id="detail-customer-phone" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Email:</span>
                            <span id="detail-customer-email" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số CCCD/CMND:</span>
                            <span id="detail-customer-cccd" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Địa chỉ:</span>
                            <span id="detail-customer-address" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Loại xe:</span>
                            <span id="detail-car-model" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phiên bản:</span>
                            <span id="detail-car-version" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Màu sắc:</span>
                            <span id="detail-car-color" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số khung (VIN):</span>
                            <span id="detail-vin-number" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Người đề nghị:</span>
                            <span id="detail-requester" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày đề nghị:</span>
                            <span id="detail-request-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin tài chính -->
                <div class="mb-6 bg-yellow-50 p-5 rounded-lg border border-yellow-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-coins mr-2 text-yellow-600"></i>
                        Thông Tin Tài Chính
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Số PO:</span>
                            <span id="detail-po-number" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Giá nhập:</span>
                            <span id="detail-import-price" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phương thức thanh toán:</span>
                            <span id="detail-payment-method" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngân hàng bảo lãnh COC:</span>
                            <span id="detail-guarantee-bank-coc" class="font-bold ml-2 text-purple-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Số tiền tính lãi:</span>
                            <span id="detail-principal-amount" class="font-bold ml-2 text-blue-600 text-lg"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Lãi suất (%/năm):</span>
                            <span id="detail-interest-rate" class="font-bold ml-2 text-gray-800">8.0%</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ (nếu có):</span>
                            <span id="detail-delayed-days-preview" class="font-bold ml-2 text-orange-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cấp COC -->
                <div id="detail-issue-section" class="mb-6 bg-blue-50 p-5 rounded-lg border border-blue-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-certificate mr-2 text-blue-600"></i>
                        Thông Tin Cấp COC
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người cấp:</span>
                            <span id="detail-issuer" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày cấp thực tế:</span>
                            <span id="detail-actual-issue-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ:</span>
                            <span id="detail-delayed-days" class="font-bold ml-2 text-orange-600"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số tiền lãi:</span>
                            <span id="detail-interest-amount" class="font-bold ml-2 text-red-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Ảnh COC:</span>
                            <div id="detail-coc-image" class="mt-2">
                                <a id="detail-coc-image-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-image mr-2"></i>
                                    <span>Xem ảnh COC</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Biên bản bàn giao:</span>
                            <div id="detail-handover-doc" class="mt-2">
                                <a id="detail-handover-doc-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-pdf mr-2"></i>
                                    <span>Xem biên bản bàn giao</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin giải ngân -->
                <div id="detail-disburse-section" class="mb-6 bg-orange-50 p-5 rounded-lg border border-orange-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-upload mr-2 text-orange-600"></i>
                        Thông Tin Giải Ngân
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người giải ngân:</span>
                            <span id="detail-accountant" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">File giải ngân:</span>
                            <div id="detail-disbursement-file" class="mt-2">
                                <a id="detail-disbursement-file-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-upload mr-2"></i>
                                    <span>Xem file giải ngân</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-gray-600"></i>
                        Trạng Thái
                    </h3>
                    <div class="flex items-center gap-3">
                        <span id="detail-status-badge" class="px-4 py-2 rounded-full text-sm font-bold"></span>
                        <span id="detail-status-label" class="text-gray-700"></span>
                    </div>
                </div>

                <!-- Ghi chú -->
                <div id="detail-notes-section" class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-sticky-note mr-2 text-gray-600"></i>
                        Ghi Chú
                    </h3>
                    <p id="detail-notes" class="text-gray-700 whitespace-pre-wrap"></p>
                </div>
            </div>

            <!-- Error state -->
            <div id="coc-detail-error" class="hidden text-center py-8">
                <i class="fa-solid fa-exclamation-circle text-3xl text-red-600 mb-4"></i>
                <p class="text-red-600" id="coc-detail-error-message">Không thể tải thông tin chi tiết</p>
            </div>
        </div>

        <!-- Footer buttons -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
            <button 
                onclick="closeCocDetailModal()" 
                class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition font-bold"
            >
                Đóng
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ======================================================
    // SAFE ACCESS HELPERS - Using optional chaining & nullish coalescing
    // ======================================================

    /**
     * Safe get nested property with fallback
     */
    function safeGet(obj, ...paths) {
        if (!obj || typeof obj !== 'object') return null;
        
        for (const path of paths) {
            if (!path) continue;
            const keys = path.split('.');
            let value = obj;
            
            for (const key of keys) {
                value = value?.[key];
                if (value === null || value === undefined) break;
            }
            
            if (value !== null && value !== undefined && value !== '') {
                return value;
            }
        }
        return null;
    }

    /**
     * Safe string conversion with default
     */
    function safeString(value, defaultValue = '-') {
        if (value === null || value === undefined || value === '') return defaultValue;
        const str = String(value).trim();
        return str || defaultValue;
    }

    /**
     * Safe number conversion
     */
    function safeNumber(value, defaultValue = 0) {
        if (value === null || value === undefined || value === '') return defaultValue;
        const num = Number(value);
        return isNaN(num) ? defaultValue : num;
    }

    /**
     * Format date safely
     */
    function formatDate(dateValue) {
        if (!dateValue) return '-';
        try {
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) {
                console.warn('[COC Detail] Invalid date:', dateValue);
                return '-';
            }
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch (e) {
            console.warn('[COC Detail] Date format error:', e);
            return '-';
        }
    }

    /**
     * Format currency safely
     */
    function formatCurrency(amount) {
        const num = safeNumber(amount);
        if (num === 0 && amount !== 0) return '-';
        try {
            return num.toLocaleString('vi-VN') + ' VNĐ';
        } catch (e) {
            console.warn('[COC Detail] Currency format error:', e);
            return '-';
        }
    }

    /**
     * Safe DOM element setter
     * Uses multiple strategies to ensure value is set and persists
     */
    function setText(id, value) {
        try {
            const el = document.getElementById(id);
            if (!el) {
                console.warn('[COC Detail] Element not found:', id);
                return false;
            }
            const displayValue = safeString(value);
            
            // Skip if value is default '-' and element is already empty (don't override empty with '-')
            if (displayValue === '-' && (!el.textContent || el.textContent.trim() === '')) {
                return true; // Already empty, no need to set '-'
            }
            
            // Strategy 1: Clear first to ensure clean state
            el.textContent = '';
            el.innerText = '';
            
            // Strategy 2: Set textContent (primary method)
            el.textContent = displayValue;
            
            // Strategy 3: Also set innerText (for compatibility)
            el.innerText = displayValue;
            
            // Strategy 4: If still not working, use innerHTML (but only if needed)
            const actualValue = el.textContent || el.innerText || '';
            if (actualValue !== displayValue && displayValue !== '-') {
                // Escape HTML to prevent XSS
                const tempDiv = document.createElement('div');
                tempDiv.textContent = displayValue;
                el.innerHTML = tempDiv.innerHTML;
            }
            
            // Force browser reflow to ensure update
            void el.offsetHeight;
            
            // Final verification
            const finalValue = el.textContent || el.innerText || '';
            if (finalValue !== displayValue && displayValue !== '-') {
                console.error(`[COC Detail] ⚠ FAILED to set ${id}. Expected: "${displayValue}", Got: "${finalValue}"`);
                return false;
            } else if (displayValue !== '-') {
                console.log(`[COC Detail] ✓ Set ${id} to:`, displayValue, '(verified:', finalValue === displayValue, ')');
            }
            
            return true;
        } catch (e) {
            console.error(`[COC Detail] Error setting ${id}:`, e);
            return false;
        }
    }

    // ======================================================
    // DATA TRANSFORMATION - Single source of truth
    // ======================================================

    /**
     * Transform raw COC request data to display format
     * All null/undefined handling in one place
     */
    function transformCocData(rawData) {
        if (!rawData || typeof rawData !== 'object') {
            console.warn('[COC Detail] Invalid rawData');
            return null;
        }

        // Log raw data structure for debugging
        console.log('[COC Detail] Raw data structure:', {
            hasOrders: !!rawData.orders,
            ordersType: Array.isArray(rawData.orders) ? 'array' : typeof rawData.orders,
            hasCustomers: !!(rawData.orders?.customers),
            contractCode: rawData.contract_code,
            customerName: rawData.customer_name,
            carModel: rawData.car_model,
            requester: rawData.requester
        });

        // Handle orders - could be object, array, or null
        let order = null;
        if (rawData.orders) {
            if (Array.isArray(rawData.orders) && rawData.orders.length > 0) {
                order = rawData.orders[0]; // Take first order if array
            } else if (typeof rawData.orders === 'object') {
                order = rawData.orders;
            }
        }

        // Handle customers - could be object, array, or null
        let customer = null;
        if (order?.customers) {
            if (Array.isArray(order.customers) && order.customers.length > 0) {
                customer = order.customers[0]; // Take first customer if array
            } else if (typeof order.customers === 'object') {
                customer = order.customers;
            }
        }

        // Request Info - prioritize direct fields, then nested ones
        const requestInfo = {
            // Contract code: directly from coc_requests
            contractCode: safeString(rawData.contract_code),
            
            // Customer name: directly from coc_requests, fallback to customers.name
            customerName: safeString(rawData.customer_name || customer?.name),
            
            // Customer details: from customers object
            customerPhone: safeString(customer?.phone),
            customerEmail: safeString(customer?.email),
            customerCccd: safeString(customer?.cccd),
            customerAddress: safeString(customer?.address),
            
            // Car info: directly from coc_requests (these fields exist in coc_requests table)
            carModel: safeString(rawData.car_model),
            carVersion: safeString(rawData.car_version),
            carColor: safeString(rawData.car_color),
            vinNumber: safeString(rawData.vin_number),
            
            // Requester: directly from coc_requests
            requester: getRequesterName(rawData.requester),
            
            // Request date: directly from coc_requests
            requestDate: formatDate(rawData.request_date)
        };

        // Financial Info
        const financialInfo = {
            poNumber: safeString(rawData.po_number),
            importPrice: formatCurrency(rawData.import_price),
            // Payment method: from orders if available, otherwise null (coc_requests doesn't have this field directly)
            paymentMethod: safeString(order?.payment_method),
            guaranteeBank: safeString(rawData.guarantee_bank_coc),
            principalAmount: formatCurrency(rawData.principal_amount ?? rawData.import_price ?? 0),
            interestRate: `${safeNumber(rawData.interest_rate, 8.0)}%`,
            delayedDaysPreview: calculateDelayedDays(rawData)
        };

        // Issue Info (if applicable)
        const issueInfo = (['issued', 'disbursed', 'closed'].includes(rawData.status))
            ? {
                issuer: safeString(rawData.issuer),
                actualIssueDate: formatDate(rawData.actual_issue_date),
                delayedDays: formatDelayedDays(rawData.business_days_delayed),
                interestAmount: formatCurrency(rawData.interest_amount ?? 0),
                cocImageUrl: safeString(rawData.coc_image_url) !== '-' ? rawData.coc_image_url : null,
                handoverDocUrl: safeString(rawData.handover_document_url) !== '-' ? rawData.handover_document_url : null
            }
            : null;

        // Disbursement Info (if closed)
        const disbursementInfo = (rawData.status === 'closed')
            ? {
                accountant: safeString(rawData.accountant),
                disbursementFileUrl: safeString(rawData.disbursement_file_url) !== '-' ? rawData.disbursement_file_url : null
            }
            : null;

        return {
            requestInfo,
            financialInfo,
            issueInfo,
            disbursementInfo,
            status: safeString(rawData.status, 'pending'),
            notes: safeString(rawData.notes)
        };
    }

    /**
     * Get requester display name
     */
    function getRequesterName(requester) {
        if (!requester) return '-';
        
        const cachedUsers = window?.cachedUsers;
        if (Array.isArray(cachedUsers)) {
            const user = cachedUsers.find(u => u?.username === requester);
            if (user?.fullname) {
                return `${user.fullname} (${requester})`;
            }
        }
        return requester;
    }

    /**
     * Calculate delayed days preview
     */
    function calculateDelayedDays(data) {
        // Try calculation function first
        if (data?.actual_issue_date && data?.request_date && typeof window?.calculateDelayedBusinessDays === 'function') {
            try {
                const days = window.calculateDelayedBusinessDays(data.request_date, data.actual_issue_date);
                if (typeof days === 'number' && !isNaN(days)) {
                    return days > 0 ? `${days} ngày làm việc` : '0 ngày';
                }
            } catch (e) {
                console.warn('[COC Detail] Error calculating delayed days:', e);
            }
        }
        
        // Fallback to stored value
        const stored = safeNumber(data?.business_days_delayed);
        if (stored > 0) {
            return `${stored} ngày làm việc`;
        }
        return stored === 0 ? '0 ngày' : '-';
    }

    /**
     * Format delayed days
     */
    function formatDelayedDays(days) {
        const num = safeNumber(days);
        return num > 0 ? `${num} ngày làm việc` : '0 ngày';
    }

    // ======================================================
    // RENDER FUNCTIONS - Simple and safe
    // ======================================================

    /**
     * Render all request information
     */
    function renderRequestInfo(info) {
        if (!info) {
            console.warn('[COC Detail] renderRequestInfo: info is null/undefined');
            return;
        }
        console.log('[COC Detail] renderRequestInfo called with:', info);
        setText('detail-contract-code', info.contractCode);
        setText('detail-customer-name', info.customerName);
        setText('detail-customer-phone', info.customerPhone);
        setText('detail-customer-email', info.customerEmail);
        setText('detail-customer-cccd', info.customerCccd);
        setText('detail-customer-address', info.customerAddress);
        setText('detail-car-model', info.carModel);
        setText('detail-car-version', info.carVersion);
        setText('detail-car-color', info.carColor);
        setText('detail-vin-number', info.vinNumber);
        setText('detail-requester', info.requester);
        setText('detail-request-date', info.requestDate);
        console.log('[COC Detail] renderRequestInfo completed');
    }

    /**
     * Render financial information
     */
    function renderFinancialInfo(info) {
        if (!info) return;
        setText('detail-po-number', info.poNumber);
        setText('detail-import-price', info.importPrice);
        setText('detail-payment-method', info.paymentMethod);
        setText('detail-guarantee-bank-coc', info.guaranteeBank);
        setText('detail-principal-amount', info.principalAmount);
        setText('detail-interest-rate', info.interestRate);
        setText('detail-delayed-days-preview', info.delayedDaysPreview);
    }

    /**
     * Render issue information
     */
    function renderIssueInfo(info) {
        if (!info) return;
        
        setText('detail-issuer', info.issuer);
        setText('detail-actual-issue-date', info.actualIssueDate);
        setText('detail-delayed-days', info.delayedDays);
        setText('detail-interest-amount', info.interestAmount);
        
        // COC Image
        renderFileLink('detail-coc-image-link', 'detail-coc-image', info.cocImageUrl);
        
        // Handover Document
        renderFileLink('detail-handover-doc-link', 'detail-handover-doc', info.handoverDocUrl);
    }

    /**
     * Render disbursement information
     */
    function renderDisbursementInfo(info) {
        if (!info) return;
        
        setText('detail-accountant', info.accountant);
        renderFileLink('detail-disbursement-file-link', 'detail-disbursement-file', info.disbursementFileUrl);
    }

    /**
     * Render file link helper
     */
    function renderFileLink(linkId, containerId, url) {
        const link = document.getElementById(linkId);
        const container = document.getElementById(containerId);
        
        if (!link || !container) {
            console.warn('[COC Detail] File link elements not found:', linkId, containerId);
            return;
        }

        const placeholder = container.querySelector('.text-gray-400');
        
        if (url && typeof url === 'string') {
            link.href = url;
            link.classList.remove('hidden');
            placeholder?.classList.add('hidden');
        } else {
            link.classList.add('hidden');
            placeholder?.classList.remove('hidden');
        }
    }

    /**
     * Render status badge
     */
    function renderStatus(status) {
        const statusMap = {
            'pending': { label: 'Đang chờ', class: 'bg-yellow-100 text-yellow-800' },
            'issued': { label: 'Đã cấp', class: 'bg-blue-100 text-blue-800' },
            'disbursed': { label: 'Đã giải ngân', class: 'bg-orange-100 text-orange-800' },
            'closed': { label: 'Đã đóng', class: 'bg-green-100 text-green-800' }
        };

        const statusInfo = statusMap[status] ?? statusMap.pending;
        const badge = document.getElementById('detail-status-badge');
        const label = document.getElementById('detail-status-label');

        if (badge) {
            badge.textContent = statusInfo.label;
            badge.className = `px-4 py-2 rounded-full text-sm font-bold ${statusInfo.class}`;
        }
        if (label) {
            label.textContent = `Trạng thái hiện tại: ${statusInfo.label}`;
        }
    }

    /**
     * Render notes
     */
    function renderNotes(notes) {
        const section = document.getElementById('detail-notes-section');
        const notesEl = document.getElementById('detail-notes');
        
        if (!section) return;
        
        if (notes && notes !== '-') {
            section.classList.remove('hidden');
            if (notesEl) notesEl.textContent = notes;
        } else {
            section.classList.add('hidden');
        }
    }

    // ======================================================
    // DATA FETCHING
    // ======================================================

    /**
     * Fetch COC request data with validation
     */
    async function fetchCocRequestData(requestId) {
        if (!requestId) {
            throw new Error('Request ID không hợp lệ');
        }

        // Try cache first
        const cached = window?.allCocRequests?.find(r => r?.id === requestId);
        if (cached) {
            console.log('[COC Detail] Found in cache');
            return cached;
        }

        // Validate session
        let session;
        try {
            const sessionStr = localStorage.getItem('user_session');
            if (!sessionStr) throw new Error('Phiên đăng nhập hết hạn');
            session = JSON.parse(sessionStr);
        } catch (e) {
            throw new Error('Phiên đăng nhập hết hạn');
        }

        if (!session?.username) {
            throw new Error('Phiên đăng nhập hết hạn');
        }

        // Validate API
        if (typeof window?.callAPI !== 'function') {
            throw new Error('API không khả dụng');
        }

        // Call API
        const result = await window.callAPI({
            action: 'get_coc_requests',
            username: session.username,
            role: session.role ?? null
        });

        if (!result?.success) {
            throw new Error(result?.message ?? 'Không thể tải dữ liệu');
        }

        if (!Array.isArray(result.data)) {
            throw new Error('Dữ liệu không hợp lệ');
        }

        const requestData = result.data.find(r => r?.id === requestId);
        if (!requestData) {
            throw new Error('Không tìm thấy đề nghị COC');
        }

        return requestData;
    }

    // ======================================================
    // MAIN MODAL FUNCTION
    // ======================================================

    /**
     * Open COC detail modal
     */
    async function openCocDetailModal(requestId) {
        if (!requestId) {
            console.error('[COC Detail] Invalid requestId');
            return;
        }

        // Get DOM elements
        const modal = document.getElementById('modal-coc-detail');
        const loadingDiv = document.getElementById('coc-detail-loading');
        const bodyDiv = document.getElementById('coc-detail-body');
        const errorDiv = document.getElementById('coc-detail-error');

        if (!modal) {
            console.error('[COC Detail] Modal not found');
            return;
        }

        // Show loading
        modal.classList.remove('hidden');
        console.log('[COC Detail] Modal shown, classList:', modal.classList.toString());
        loadingDiv?.classList.remove('hidden');
        bodyDiv?.classList.add('hidden');
        errorDiv?.classList.add('hidden');

        try {
            // Fetch and transform data
            const rawData = await fetchCocRequestData(requestId);
            console.log('[COC Detail] Fetched raw data:', rawData);
            const displayData = transformCocData(rawData);

            if (!displayData) {
                throw new Error('Không thể xử lý dữ liệu');
            }

            console.log('[COC Detail] Display data:', displayData);
            console.log('[COC Detail] Request info to render:', JSON.stringify(displayData.requestInfo, null, 2));
            console.log('[COC Detail] Financial info to render:', JSON.stringify(displayData.financialInfo, null, 2));

            // Check if DOM elements exist
            const testEl = document.getElementById('detail-contract-code');
            console.log('[COC Detail] DOM element check - detail-contract-code exists:', !!testEl);
            console.log('[COC Detail] bodyDiv exists:', !!bodyDiv);
            console.log('[COC Detail] bodyDiv classList:', bodyDiv?.classList.toString());

            // Show content FIRST, then render (to ensure DOM is ready)
            if (loadingDiv) loadingDiv.classList.add('hidden');
            if (bodyDiv) {
                bodyDiv.classList.remove('hidden');
                console.log('[COC Detail] Body div is now visible');
            } else {
                console.error('[COC Detail] Body div not found!');
                return;
            }

            // Render all sections AFTER body is visible
            // Use requestAnimationFrame to ensure DOM is fully ready
            requestAnimationFrame(() => {
                try {
                    console.log('[COC Detail] About to call renderRequestInfo');
                    renderRequestInfo(displayData.requestInfo);
                    console.log('[COC Detail] renderRequestInfo completed successfully');
                } catch (e) {
                    console.error('[COC Detail] Error in renderRequestInfo:', e);
                }
                
                try {
                    console.log('[COC Detail] About to call renderFinancialInfo');
                    renderFinancialInfo(displayData.financialInfo);
                    console.log('[COC Detail] renderFinancialInfo completed successfully');
                } catch (e) {
                    console.error('[COC Detail] Error in renderFinancialInfo:', e);
                }
                
                try {
                    renderStatus(displayData.status);
                } catch (e) {
                    console.error('[COC Detail] Error in renderStatus:', e);
                }
                
                try {
                    renderNotes(displayData.notes);
                } catch (e) {
                    console.error('[COC Detail] Error in renderNotes:', e);
                }

                // Render issue section if applicable
                const issueSection = document.getElementById('detail-issue-section');
                if (displayData.issueInfo) {
                    issueSection?.classList.remove('hidden');
                    renderIssueInfo(displayData.issueInfo);
                } else {
                    issueSection?.classList.add('hidden');
                }

                // Render disbursement section if closed
                const disburseSection = document.getElementById('detail-disburse-section');
                if (displayData.disbursementInfo) {
                    disburseSection?.classList.remove('hidden');
                    renderDisbursementInfo(displayData.disbursementInfo);
                } else {
                    disburseSection?.classList.add('hidden');
                }

                // Final verification and re-set if needed
                setTimeout(() => {
                    const contractCodeEl = document.getElementById('detail-contract-code');
                    const customerNameEl = document.getElementById('detail-customer-name');
                    const requesterEl = document.getElementById('detail-requester');
                    console.log('[COC Detail] Final verification after 50ms:');
                    console.log('  - detail-contract-code textContent:', contractCodeEl?.textContent);
                    console.log('  - detail-customer-name textContent:', customerNameEl?.textContent);
                    console.log('  - detail-requester textContent:', requesterEl?.textContent);
                    
                    // If values are missing, re-set them with multiple attempts
                    if (contractCodeEl && (!contractCodeEl.textContent || contractCodeEl.textContent.trim() === '' || contractCodeEl.textContent === '-')) {
                        console.warn('[COC Detail] Re-setting contractCode because it was empty/missing');
                        const value = displayData.requestInfo.contractCode;
                        contractCodeEl.textContent = value;
                        contractCodeEl.innerText = value;
                        contractCodeEl.innerHTML = value;
                    }
                    if (customerNameEl && (!customerNameEl.textContent || customerNameEl.textContent.trim() === '' || customerNameEl.textContent === '-')) {
                        console.warn('[COC Detail] Re-setting customerName because it was empty/missing');
                        const value = displayData.requestInfo.customerName;
                        customerNameEl.textContent = value;
                        customerNameEl.innerText = value;
                        customerNameEl.innerHTML = value;
                    }
                    if (requesterEl && (!requesterEl.textContent || requesterEl.textContent.trim() === '' || requesterEl.textContent === '-')) {
                        console.warn('[COC Detail] Re-setting requester because it was empty/missing');
                        const value = displayData.requestInfo.requester;
                        requesterEl.textContent = value;
                        requesterEl.innerText = value;
                        requesterEl.innerHTML = value;
                    }
                    
                    // Re-render everything one more time as final safety net
                    renderRequestInfo(displayData.requestInfo);
                    renderFinancialInfo(displayData.financialInfo);
                    
                    // One more check after 200ms
                    setTimeout(() => {
                        renderRequestInfo(displayData.requestInfo);
                        renderFinancialInfo(displayData.financialInfo);
                        console.log('[COC Detail] Final re-render completed at 200ms');
                    }, 200);
                }, 100);

                console.log('[COC Detail] All rendering completed');
            });


        } catch (error) {
            console.error('[COC Detail] Error:', error);
            
            loadingDiv?.classList.add('hidden');
            errorDiv?.classList.remove('hidden');
            
            const errorMsg = document.getElementById('coc-detail-error-message');
            if (errorMsg) {
                errorMsg.textContent = error?.message ?? 'Không thể tải thông tin chi tiết';
            }
        }
    }

    /**
     * Close modal
     */
    function closeCocDetailModal() {
        const modal = document.getElementById('modal-coc-detail');
        modal?.classList.add('hidden');
    }

    // ======================================================
    // DEBUG FUNCTION - Expose for browser console testing
    // ======================================================
    
    /**
     * Debug function to check element state
     * Run this in browser console: window.debugCocDetailModal()
     */
    function debugCocDetailModal() {
        console.log('=== COC Detail Modal Debug ===');
        
        const elements = [
            'detail-contract-code',
            'detail-customer-name',
            'detail-customer-phone',
            'detail-requester',
            'detail-car-model',
            'detail-request-date'
        ];
        
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                console.log(`\n[${id}]`);
                console.log('  - Element:', el);
                console.log('  - textContent:', el.textContent);
                console.log('  - innerText:', el.innerText);
                console.log('  - innerHTML:', el.innerHTML);
                console.log('  - nodeValue:', el.nodeValue);
                console.log('  - firstChild:', el.firstChild);
                console.log('  - childNodes:', el.childNodes);
                console.log('  - parentElement:', el.parentElement);
                console.log('  - classList:', el.classList.toString());
                console.log('  - style.display:', el.style.display);
                console.log('  - Computed display:', window.getComputedStyle(el).display);
                console.log('  - Computed visibility:', window.getComputedStyle(el).visibility);
                console.log('  - Computed opacity:', window.getComputedStyle(el).opacity);
                console.log('  - Computed color:', window.getComputedStyle(el).color);
                console.log('  - offsetWidth:', el.offsetWidth);
                console.log('  - offsetHeight:', el.offsetHeight);
            } else {
                console.warn(`[${id}] Element not found!`);
            }
        });
        
        const modal = document.getElementById('modal-coc-detail');
        const bodyDiv = document.getElementById('coc-detail-body');
        console.log('\n[Modal]');
        console.log('  - Modal exists:', !!modal);
        console.log('  - Modal classList:', modal?.classList.toString());
        console.log('  - Modal display:', modal ? window.getComputedStyle(modal).display : 'N/A');
        console.log('\n[Body Div]');
        console.log('  - BodyDiv exists:', !!bodyDiv);
        console.log('  - BodyDiv classList:', bodyDiv?.classList.toString());
        console.log('  - BodyDiv display:', bodyDiv ? window.getComputedStyle(bodyDiv).display : 'N/A');
        
        console.log('\n=== End Debug ===');
    }
    
    /**
     * Force set all values for debugging
     * Run this in browser console: window.forceSetCocDetailValues()
     */
    function forceSetCocDetailValues() {
        console.log('=== Force Setting COC Detail Values ===');
        
        const testValues = {
            'detail-contract-code': 'TEST-CONTRACT-CODE',
            'detail-customer-name': 'TEST CUSTOMER NAME',
            'detail-requester': 'TEST-USER',
            'detail-car-model': 'TEST CAR MODEL'
        };
        
        Object.entries(testValues).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) {
                console.log(`Setting ${id} to: ${value}`);
                // Try multiple methods
                el.textContent = value;
                el.innerText = value;
                // Also check computed styles
                const computed = window.getComputedStyle(el);
                console.log(`  - font-size: ${computed.fontSize}`);
                console.log(`  - line-height: ${computed.lineHeight}`);
                console.log(`  - text-indent: ${computed.textIndent}`);
                console.log(`  - width: ${computed.width}`);
                console.log(`  - height: ${computed.height}`);
                console.log(`  After set - textContent: ${el.textContent}`);
            }
        });
        
        console.log('=== End Force Set ===');
    }
    
    /**
     * Check if elements are being reset by MutationObserver
     */
    function checkForMutationObservers() {
        console.log('=== Checking for Mutation Observers ===');
        const contractCodeEl = document.getElementById('detail-contract-code');
        if (contractCodeEl) {
            // Try to detect if something is watching this element
            const originalSet = Object.getOwnPropertyDescriptor(Element.prototype, 'textContent')?.set;
            if (originalSet) {
                console.log('textContent setter exists');
            }
            
            // Check parent for observers
            let parent = contractCodeEl.parentElement;
            let level = 0;
            while (parent && level < 5) {
                console.log(`Parent level ${level}:`, parent.tagName, parent.id || parent.className);
                parent = parent.parentElement;
                level++;
            }
        }
        console.log('=== End Mutation Check ===');
    }

    // ======================================================
    // EXPOSE TO WINDOW
    // ======================================================

    if (typeof window !== 'undefined') {
        window.openCocDetailModal = openCocDetailModal;
        window.closeCocDetailModal = closeCocDetailModal;
        window.debugCocDetailModal = debugCocDetailModal;
        window.forceSetCocDetailValues = forceSetCocDetailValues;
        window.checkForMutationObservers = checkForMutationObservers;
        console.log('✅ COC detail modal functions exposed (including debug functions)');
    }

})();
</script>
