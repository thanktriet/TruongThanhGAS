<!-- Modal Chi tiết COC Request -->
<div id="modal-coc-detail" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-certificate mr-2"></i>Chi Tiết Đề Nghị Cấp COC
            </h2>
            <button onclick="closeCocDetailModal()" class="text-white hover:text-gray-200">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>

        <div id="coc-detail-content" class="p-6">
            <!-- Loading state -->
            <div id="coc-detail-loading" class="text-center py-8">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Đang tải thông tin...</p>
            </div>

            <!-- Content -->
            <div id="coc-detail-body" class="hidden">
                <!-- Thông tin đề nghị -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-blue-600"></i>
                        Thông Tin Đề Nghị
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Mã đơn hàng:</span>
                            <span id="detail-contract-code" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Khách hàng:</span>
                            <span id="detail-customer-name" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số điện thoại:</span>
                            <span id="detail-customer-phone" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Email:</span>
                            <span id="detail-customer-email" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số CCCD/CMND:</span>
                            <span id="detail-customer-cccd" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Địa chỉ:</span>
                            <span id="detail-customer-address" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Loại xe:</span>
                            <span id="detail-car-model" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phiên bản:</span>
                            <span id="detail-car-version" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Màu sắc:</span>
                            <span id="detail-car-color" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số khung (VIN):</span>
                            <span id="detail-vin-number" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Người đề nghị:</span>
                            <span id="detail-requester" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày đề nghị:</span>
                            <span id="detail-request-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin tài chính -->
                <div class="mb-6 bg-yellow-50 p-5 rounded-lg border border-yellow-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-coins mr-2 text-yellow-600"></i>
                        Thông Tin Tài Chính
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Số PO:</span>
                            <span id="detail-po-number" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Giá nhập:</span>
                            <span id="detail-import-price" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phương thức thanh toán:</span>
                            <span id="detail-payment-method" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngân hàng bảo lãnh COC:</span>
                            <span id="detail-guarantee-bank-coc" class="font-bold ml-2 text-purple-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Số tiền tính lãi:</span>
                            <span id="detail-principal-amount" class="font-bold ml-2 text-blue-600 text-lg"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Lãi suất (%/năm):</span>
                            <span id="detail-interest-rate" class="font-bold ml-2 text-gray-800">8.0%</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ (nếu có):</span>
                            <span id="detail-delayed-days-preview" class="font-bold ml-2 text-orange-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cấp COC -->
                <div id="detail-issue-section" class="mb-6 bg-blue-50 p-5 rounded-lg border border-blue-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-certificate mr-2 text-blue-600"></i>
                        Thông Tin Cấp COC
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người cấp:</span>
                            <span id="detail-issuer" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày cấp thực tế:</span>
                            <span id="detail-actual-issue-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ:</span>
                            <span id="detail-delayed-days" class="font-bold ml-2 text-orange-600"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số tiền lãi:</span>
                            <span id="detail-interest-amount" class="font-bold ml-2 text-red-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Ảnh COC:</span>
                            <div id="detail-coc-image" class="mt-2">
                                <a id="detail-coc-image-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-image mr-2"></i>
                                    <span>Xem ảnh COC</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Biên bản bàn giao:</span>
                            <div id="detail-handover-doc" class="mt-2">
                                <a id="detail-handover-doc-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-pdf mr-2"></i>
                                    <span>Xem biên bản bàn giao</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin giải ngân -->
                <div id="detail-disburse-section" class="mb-6 bg-orange-50 p-5 rounded-lg border border-orange-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-upload mr-2 text-orange-600"></i>
                        Thông Tin Giải Ngân
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người giải ngân:</span>
                            <span id="detail-accountant" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">File giải ngân:</span>
                            <div id="detail-disbursement-file" class="mt-2">
                                <a id="detail-disbursement-file-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-upload mr-2"></i>
                                    <span>Xem file giải ngân</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-gray-600"></i>
                        Trạng Thái
                    </h3>
                    <div class="flex items-center gap-3">
                        <span id="detail-status-badge" class="px-4 py-2 rounded-full text-sm font-bold"></span>
                        <span id="detail-status-label" class="text-gray-700"></span>
                    </div>
                </div>

                <!-- Ghi chú -->
                <div id="detail-notes-section" class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-sticky-note mr-2 text-gray-600"></i>
                        Ghi Chú
                    </h3>
                    <p id="detail-notes" class="text-gray-700 whitespace-pre-wrap"></p>
                </div>
            </div>

            <!-- Error state -->
            <div id="coc-detail-error" class="hidden text-center py-8">
                <i class="fa-solid fa-exclamation-circle text-3xl text-red-600 mb-4"></i>
                <p class="text-red-600" id="coc-detail-error-message">Không thể tải thông tin chi tiết</p>
            </div>
        </div>

        <!-- Footer buttons -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
            <button 
                onclick="closeCocDetailModal()" 
                class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition font-bold"
            >
                Đóng
            </button>
        </div>
    </div>
</div>

<script>
// ======================================================
// UTILITY FUNCTIONS
// ======================================================

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        return new Date(dateString).toLocaleDateString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        return String(dateString || '-');
    }
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '-';
    const num = parseFloat(amount);
    if (isNaN(num)) return '-';
    return num.toLocaleString('vi-VN') + ' VNĐ';
}

function getValue(data, ...paths) {
    for (const path of paths) {
        const keys = path.split('.');
        let value = data;
        for (const key of keys) {
            if (value && typeof value === 'object' && key in value) {
                value = value[key];
            } else {
                value = null;
                break;
            }
        }
        if (value !== null && value !== undefined && value !== '') {
            return value;
        }
    }
    return null;
}

function setElementText(id, value, defaultValue = '-') {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = value !== null && value !== undefined && value !== '' ? String(value) : defaultValue;
    }
}

// ======================================================
// DATA EXTRACTION FUNCTIONS
// ======================================================

/**
 * Extract request information from COC request data
 * Priority: coc_requests > orders > customers
 */
function extractRequestInfo(requestData) {
    const order = requestData.orders || null;
    const customer = order?.customers || null;

    return {
        // Contract & Customer
        contractCode: getValue(requestData, 'contract_code', 'orders.contract_code') || '-',
        customerName: getValue(requestData, 'customer_name', 'orders.customers.name') || '-',
        customerPhone: getValue(requestData, 'orders.customers.phone') || '-',
        customerEmail: getValue(requestData, 'orders.customers.email') || '-',
        customerCccd: getValue(requestData, 'orders.customers.cccd') || '-',
        customerAddress: getValue(requestData, 'orders.customers.address') || '-',
        
        // Car Info
        carModel: getValue(requestData, 'car_model', 'orders.car_model') || '-',
        carVersion: getValue(requestData, 'car_version', 'orders.car_version') || '-',
        carColor: getValue(requestData, 'car_color', 'orders.car_color') || '-',
        vinNumber: getValue(requestData, 'vin_number') || '-',
        
        // Requester
        requester: getRequesterDisplay(requestData.requester),
        
        // Request Date
        requestDate: formatDate(requestData.request_date)
    };
}

/**
 * Extract financial information
 */
function extractFinancialInfo(requestData) {
    const order = requestData.orders || null;
    
    return {
        poNumber: requestData.po_number || '-',
        importPrice: formatCurrency(requestData.import_price),
        paymentMethod: getValue(requestData, 'payment_method', 'orders.payment_method') || '-',
        guaranteeBank: requestData.guarantee_bank_coc || '-',
        principalAmount: formatCurrency(requestData.principal_amount || requestData.import_price || 0),
        interestRate: `${requestData.interest_rate || 8.0}%`,
        delayedDaysPreview: calculateDelayedDaysPreview(requestData)
    };
}

/**
 * Extract issue information (if issued/disbursed/closed)
 */
function extractIssueInfo(requestData) {
    return {
        issuer: requestData.issuer || '-',
        actualIssueDate: formatDate(requestData.actual_issue_date),
        delayedDays: requestData.business_days_delayed > 0 
            ? `${requestData.business_days_delayed} ngày làm việc`
            : '0 ngày',
        interestAmount: formatCurrency(requestData.interest_amount || 0),
        cocImageUrl: requestData.coc_image_url || null,
        handoverDocUrl: requestData.handover_document_url || null
    };
}

/**
 * Extract disbursement information (if closed)
 */
function extractDisbursementInfo(requestData) {
    return {
        accountant: requestData.accountant || '-',
        disbursementFileUrl: requestData.disbursement_file_url || null
    };
}

/**
 * Get requester display name (with fullname if available)
 */
function getRequesterDisplay(requester) {
    if (!requester) return '-';
    
    // Try to get fullname from cached users
    if (typeof window !== 'undefined' && window.cachedUsers && Array.isArray(window.cachedUsers)) {
        const user = window.cachedUsers.find(u => u.username === requester);
        if (user && user.fullname) {
            return `${user.fullname} (${requester})`;
        }
    }
    
    return requester;
}

/**
 * Calculate delayed days preview
 */
function calculateDelayedDaysPreview(requestData) {
    if (requestData.actual_issue_date && requestData.request_date) {
        if (typeof window.calculateDelayedBusinessDays === 'function') {
            const days = window.calculateDelayedBusinessDays(requestData.request_date, requestData.actual_issue_date);
            return days > 0 ? `${days} ngày làm việc` : '0 ngày';
        }
    }
    
    if (requestData.business_days_delayed !== undefined) {
        return requestData.business_days_delayed > 0 
            ? `${requestData.business_days_delayed} ngày làm việc` 
            : '0 ngày';
    }
    
    return '-';
}

// ======================================================
// RENDER FUNCTIONS
// ======================================================

/**
 * Render request information section
 */
function renderRequestInfo(info) {
    setElementText('detail-contract-code', info.contractCode);
    setElementText('detail-customer-name', info.customerName);
    setElementText('detail-customer-phone', info.customerPhone);
    setElementText('detail-customer-email', info.customerEmail);
    setElementText('detail-customer-cccd', info.customerCccd);
    setElementText('detail-customer-address', info.customerAddress);
    setElementText('detail-car-model', info.carModel);
    setElementText('detail-car-version', info.carVersion);
    setElementText('detail-car-color', info.carColor);
    setElementText('detail-vin-number', info.vinNumber);
    setElementText('detail-requester', info.requester);
    setElementText('detail-request-date', info.requestDate);
}

/**
 * Render financial information section
 */
function renderFinancialInfo(info) {
    setElementText('detail-po-number', info.poNumber);
    setElementText('detail-import-price', info.importPrice);
    setElementText('detail-payment-method', info.paymentMethod);
    setElementText('detail-guarantee-bank-coc', info.guaranteeBank);
    setElementText('detail-principal-amount', info.principalAmount);
    setElementText('detail-interest-rate', info.interestRate);
    setElementText('detail-delayed-days-preview', info.delayedDaysPreview);
}

/**
 * Render issue information section
 */
function renderIssueInfo(info) {
    setElementText('detail-issuer', info.issuer);
    setElementText('detail-actual-issue-date', info.actualIssueDate);
    setElementText('detail-delayed-days', info.delayedDays);
    setElementText('detail-interest-amount', info.interestAmount);
    
    // COC Image
    const cocImageLink = document.getElementById('detail-coc-image-link');
    const cocImageContainer = document.getElementById('detail-coc-image');
    if (info.cocImageUrl && cocImageLink) {
        cocImageLink.href = info.cocImageUrl;
        cocImageLink.classList.remove('hidden');
        cocImageContainer.querySelector('.text-gray-400')?.classList.add('hidden');
    } else {
        cocImageLink?.classList.add('hidden');
        cocImageContainer.querySelector('.text-gray-400')?.classList.remove('hidden');
    }
    
    // Handover Document
    const handoverDocLink = document.getElementById('detail-handover-doc-link');
    const handoverDocContainer = document.getElementById('detail-handover-doc');
    if (info.handoverDocUrl && handoverDocLink) {
        handoverDocLink.href = info.handoverDocUrl;
        handoverDocLink.classList.remove('hidden');
        handoverDocContainer.querySelector('.text-gray-400')?.classList.add('hidden');
    } else {
        handoverDocLink?.classList.add('hidden');
        handoverDocContainer.querySelector('.text-gray-400')?.classList.remove('hidden');
    }
}

/**
 * Render disbursement information section
 */
function renderDisbursementInfo(info) {
    setElementText('detail-accountant', info.accountant);
    
    // Disbursement File
    const fileLink = document.getElementById('detail-disbursement-file-link');
    const fileContainer = document.getElementById('detail-disbursement-file');
    if (info.disbursementFileUrl && fileLink) {
        fileLink.href = info.disbursementFileUrl;
        fileLink.classList.remove('hidden');
        fileContainer.querySelector('.text-gray-400')?.classList.add('hidden');
    } else {
        fileLink?.classList.add('hidden');
        fileContainer.querySelector('.text-gray-400')?.classList.remove('hidden');
    }
}

/**
 * Render status
 */
function renderStatus(status) {
    const statusMap = {
        'pending': { label: 'Đang chờ', class: 'bg-yellow-100 text-yellow-800' },
        'issued': { label: 'Đã cấp', class: 'bg-blue-100 text-blue-800' },
        'disbursed': { label: 'Đã giải ngân', class: 'bg-orange-100 text-orange-800' },
        'closed': { label: 'Đã đóng', class: 'bg-green-100 text-green-800' }
    };
    
    const statusInfo = statusMap[status] || statusMap.pending;
    const badge = document.getElementById('detail-status-badge');
    const label = document.getElementById('detail-status-label');
    
    if (badge) {
        badge.textContent = statusInfo.label;
        badge.className = `px-4 py-2 rounded-full text-sm font-bold ${statusInfo.class}`;
    }
    
    if (label) {
        label.textContent = `Trạng thái hiện tại: ${statusInfo.label}`;
    }
}

/**
 * Render notes
 */
function renderNotes(notes) {
    const section = document.getElementById('detail-notes-section');
    const notesEl = document.getElementById('detail-notes');
    
    if (notes && notes.trim()) {
        if (section) section.classList.remove('hidden');
        if (notesEl) notesEl.textContent = notes;
    } else {
        if (section) section.classList.add('hidden');
    }
}

// ======================================================
// MAIN FUNCTIONS
// ======================================================

/**
 * Fetch COC request data
 */
async function fetchCocRequestData(requestId) {
    // Try to find in cached data first
    if (typeof window.allCocRequests !== 'undefined' && Array.isArray(window.allCocRequests)) {
        const cached = window.allCocRequests.find(r => r.id === requestId);
        if (cached) {
            console.log('[COC Detail] Found in cache');
            return cached;
        }
    }
    
    // Fetch from API
    console.log('[COC Detail] Fetching from API...');
    const session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!session || !session.username) {
        throw new Error('Phiên đăng nhập hết hạn');
    }
    
    const result = await window.callAPI({
        action: 'get_coc_requests',
        username: session.username,
        role: session.role
    });
    
    if (!result.success || !result.data) {
        throw new Error(result.message || 'Không thể tải dữ liệu');
    }
    
    const requestData = result.data.find(r => r.id === requestId);
    if (!requestData) {
        throw new Error('Không tìm thấy đề nghị COC');
    }
    
    return requestData;
}

/**
 * Open COC detail modal
 */
async function openCocDetailModal(requestId) {
    const modal = document.getElementById('modal-coc-detail');
    const loadingDiv = document.getElementById('coc-detail-loading');
    const bodyDiv = document.getElementById('coc-detail-body');
    const errorDiv = document.getElementById('coc-detail-error');
    
    // Show modal and loading
    modal.classList.remove('hidden');
    loadingDiv.classList.remove('hidden');
    bodyDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    
    try {
        // Fetch data
        const requestData = await fetchCocRequestData(requestId);
        
        console.log('[COC Detail] Request data:', requestData);
        
        // Extract and render data
        const requestInfo = extractRequestInfo(requestData);
        const financialInfo = extractFinancialInfo(requestData);
        
        renderRequestInfo(requestInfo);
        renderFinancialInfo(financialInfo);
        renderStatus(requestData.status);
        renderNotes(requestData.notes);
        
        // Show issue section if issued/disbursed/closed
        if (['issued', 'disbursed', 'closed'].includes(requestData.status)) {
            const issueSection = document.getElementById('detail-issue-section');
            if (issueSection) {
                issueSection.classList.remove('hidden');
                const issueInfo = extractIssueInfo(requestData);
                renderIssueInfo(issueInfo);
            }
        } else {
            const issueSection = document.getElementById('detail-issue-section');
            if (issueSection) issueSection.classList.add('hidden');
        }
        
        // Show disbursement section if closed
        if (requestData.status === 'closed') {
            const disburseSection = document.getElementById('detail-disburse-section');
            if (disburseSection) {
                disburseSection.classList.remove('hidden');
                const disburseInfo = extractDisbursementInfo(requestData);
                renderDisbursementInfo(disburseInfo);
            }
        } else {
            const disburseSection = document.getElementById('detail-disburse-section');
            if (disburseSection) disburseSection.classList.add('hidden');
        }
        
        // Show content
        loadingDiv.classList.add('hidden');
        bodyDiv.classList.remove('hidden');
        
    } catch (error) {
        console.error('[COC Detail] Error:', error);
        loadingDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        const errorMsg = document.getElementById('coc-detail-error-message');
        if (errorMsg) {
            errorMsg.textContent = error.message || 'Không thể tải thông tin chi tiết';
        }
    }
}

/**
 * Close COC detail modal
 */
function closeCocDetailModal() {
    const modal = document.getElementById('modal-coc-detail');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ======================================================
// EXPOSE FUNCTIONS
// ======================================================

if (typeof window !== 'undefined') {
    window.openCocDetailModal = openCocDetailModal;
    window.closeCocDetailModal = closeCocDetailModal;
    console.log('✅ COC detail modal functions exposed to window');
}
</script>
