<!-- Modal Chi tiết COC Request -->
<div id="modal-coc-detail" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-certificate mr-2"></i>Chi Tiết Đề Nghị Cấp COC
            </h2>
            <button onclick="closeCocDetailModal()" class="text-white hover:text-gray-200">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>

        <div id="coc-detail-content" class="p-6">
            <!-- Loading state -->
            <div id="coc-detail-loading" class="text-center py-8">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Đang tải thông tin...</p>
            </div>

            <!-- Content -->
            <div id="coc-detail-body" class="hidden">
                <!-- Thông tin đề nghị -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-blue-600"></i>
                        Thông Tin Đề Nghị
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Mã đơn hàng:</span>
                            <span id="detail-contract-code" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Khách hàng:</span>
                            <span id="detail-customer-name" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số điện thoại:</span>
                            <span id="detail-customer-phone" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Email:</span>
                            <span id="detail-customer-email" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số CCCD/CMND:</span>
                            <span id="detail-customer-cccd" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Địa chỉ:</span>
                            <span id="detail-customer-address" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Loại xe:</span>
                            <span id="detail-car-model" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phiên bản:</span>
                            <span id="detail-car-version" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Màu sắc:</span>
                            <span id="detail-car-color" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số khung (VIN):</span>
                            <span id="detail-vin-number" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Người đề nghị:</span>
                            <span id="detail-requester" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày đề nghị:</span>
                            <span id="detail-request-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin tài chính -->
                <div class="mb-6 bg-yellow-50 p-5 rounded-lg border border-yellow-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-coins mr-2 text-yellow-600"></i>
                        Thông Tin Tài Chính
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Số PO:</span>
                            <span id="detail-po-number" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Giá nhập:</span>
                            <span id="detail-import-price" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Phương thức thanh toán:</span>
                            <span id="detail-payment-method" class="font-bold ml-2 text-gray-800">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngân hàng bảo lãnh COC:</span>
                            <span id="detail-guarantee-bank-coc" class="font-bold ml-2 text-purple-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Số tiền tính lãi:</span>
                            <span id="detail-principal-amount" class="font-bold ml-2 text-blue-600 text-lg"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Lãi suất (%/năm):</span>
                            <span id="detail-interest-rate" class="font-bold ml-2 text-gray-800">8.0%</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ (nếu có):</span>
                            <span id="detail-delayed-days-preview" class="font-bold ml-2 text-orange-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cấp COC -->
                <div id="detail-issue-section" class="mb-6 bg-blue-50 p-5 rounded-lg border border-blue-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-certificate mr-2 text-blue-600"></i>
                        Thông Tin Cấp COC
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người cấp:</span>
                            <span id="detail-issuer" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ngày cấp thực tế:</span>
                            <span id="detail-actual-issue-date" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số ngày trễ:</span>
                            <span id="detail-delayed-days" class="font-bold ml-2 text-orange-600"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Số tiền lãi:</span>
                            <span id="detail-interest-amount" class="font-bold ml-2 text-red-600"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Ảnh COC:</span>
                            <div id="detail-coc-image" class="mt-2">
                                <a id="detail-coc-image-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-image mr-2"></i>
                                    <span>Xem ảnh COC</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">Biên bản bàn giao:</span>
                            <div id="detail-handover-doc" class="mt-2">
                                <a id="detail-handover-doc-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-pdf mr-2"></i>
                                    <span>Xem biên bản bàn giao</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin giải ngân -->
                <div id="detail-disburse-section" class="mb-6 bg-orange-50 p-5 rounded-lg border border-orange-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-upload mr-2 text-orange-600"></i>
                        Thông Tin Giải Ngân
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Người giải ngân:</span>
                            <span id="detail-accountant" class="font-bold ml-2 text-gray-800"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600">File giải ngân:</span>
                            <div id="detail-disbursement-file" class="mt-2">
                                <a id="detail-disbursement-file-link" href="#" target="_blank" class="text-blue-600 hover:underline inline-flex items-center hidden">
                                    <i class="fa-solid fa-file-upload mr-2"></i>
                                    <span>Xem file giải ngân</span>
                                </a>
                                <span class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái -->
                <div class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-gray-600"></i>
                        Trạng Thái
                    </h3>
                    <div class="flex items-center gap-3">
                        <span id="detail-status-badge" class="px-4 py-2 rounded-full text-sm font-bold"></span>
                        <span id="detail-status-label" class="text-gray-700"></span>
                    </div>
                </div>

                <!-- Ghi chú -->
                <div id="detail-notes-section" class="mb-6 bg-gray-50 p-5 rounded-lg border border-gray-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-sticky-note mr-2 text-gray-600"></i>
                        Ghi Chú
                    </h3>
                    <p id="detail-notes" class="text-gray-700 whitespace-pre-wrap"></p>
                </div>
            </div>

            <!-- Error state -->
            <div id="coc-detail-error" class="hidden text-center py-8">
                <i class="fa-solid fa-exclamation-circle text-3xl text-red-600 mb-4"></i>
                <p class="text-red-600" id="coc-detail-error-message">Không thể tải thông tin chi tiết</p>
            </div>
        </div>

        <!-- Footer buttons -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
            <button 
                onclick="closeCocDetailModal()" 
                class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition font-bold"
            >
                Đóng
            </button>
        </div>
    </div>
</div>

<script>
// ======================================================
// UTILITY FUNCTIONS - Safe null/undefined handling
// ======================================================

function formatDate(dateString) {
    if (dateString === null || dateString === undefined || dateString === '') {
        return '-';
    }
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            console.warn('[COC Detail] Invalid date:', dateString);
            return '-';
        }
        return date.toLocaleDateString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        console.warn('[COC Detail] Date format error:', e, dateString);
        return '-';
    }
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined || amount === '') {
        return '-';
    }
    try {
        const num = parseFloat(amount);
        if (isNaN(num)) {
            console.warn('[COC Detail] Invalid currency amount:', amount);
            return '-';
        }
        return num.toLocaleString('vi-VN') + ' VNĐ';
    } catch (e) {
        console.warn('[COC Detail] Currency format error:', e, amount);
        return '-';
    }
}

function getValue(data, ...paths) {
    if (!data || typeof data !== 'object') {
        return null;
    }
    for (const path of paths) {
        if (!path || typeof path !== 'string') continue;
        const keys = path.split('.');
        let value = data;
        for (const key of keys) {
            if (value === null || value === undefined) {
                value = null;
                break;
            }
            if (typeof value === 'object' && key in value) {
                value = value[key];
            } else {
                value = null;
                break;
            }
        }
        if (value !== null && value !== undefined && value !== '') {
            return value;
        }
    }
    return null;
}

function setElementText(id, value, defaultValue = '-') {
    if (!id || typeof id !== 'string') {
        console.warn('[COC Detail] Invalid element ID:', id);
        return false;
    }
    const el = document.getElementById(id);
    if (!el) {
        console.warn('[COC Detail] Element not found:', id);
        return false;
    }
    try {
        const displayValue = (value !== null && value !== undefined && value !== '') ? String(value) : defaultValue;
        el.textContent = displayValue;
        return true;
    } catch (e) {
        console.warn('[COC Detail] Error setting text for element:', id, e);
        return false;
    }
}

// ======================================================
// DATA EXTRACTION FUNCTIONS
// ======================================================

/**
 * Extract request information from COC request data
 * Priority: coc_requests > orders > customers
 */
function extractRequestInfo(requestData) {
    if (!requestData || typeof requestData !== 'object') {
        console.warn('[COC Detail] Invalid requestData in extractRequestInfo');
        return null;
    }
    
    const order = (requestData.orders && typeof requestData.orders === 'object') ? requestData.orders : null;
    const customer = (order && order.customers && typeof order.customers === 'object') ? order.customers : null;

    const contractCode = getValue(requestData, 'contract_code', 'orders.contract_code');
    const customerName = getValue(requestData, 'customer_name', 'orders.customers.name');
    const carModel = getValue(requestData, 'car_model', 'orders.car_model');
    const carVersion = getValue(requestData, 'car_version', 'orders.car_version');
    const carColor = getValue(requestData, 'car_color', 'orders.car_color');
    const vinNumber = getValue(requestData, 'vin_number');
    const requester = (requestData.requester) ? getRequesterDisplay(requestData.requester) : '-';
    const requestDate = formatDate(requestData.request_date);
    
    // Warn for missing critical data
    if (!contractCode || contractCode === '-') {
        console.warn('[COC Detail] Missing contract_code');
    }
    if (!customerName || customerName === '-') {
        console.warn('[COC Detail] Missing customer_name');
    }

    return {
        // Contract & Customer
        contractCode: contractCode || '-',
        customerName: customerName || '-',
        customerPhone: getValue(requestData, 'orders.customers.phone') || '-',
        customerEmail: getValue(requestData, 'orders.customers.email') || '-',
        customerCccd: getValue(requestData, 'orders.customers.cccd') || '-',
        customerAddress: getValue(requestData, 'orders.customers.address') || '-',
        
        // Car Info
        carModel: carModel || '-',
        carVersion: carVersion || '-',
        carColor: carColor || '-',
        vinNumber: vinNumber || '-',
        
        // Requester
        requester: requester,
        
        // Request Date
        requestDate: requestDate
    };
}

/**
 * Extract financial information
 */
function extractFinancialInfo(requestData) {
    if (!requestData || typeof requestData !== 'object') {
        console.warn('[COC Detail] Invalid requestData in extractFinancialInfo');
        return null;
    }
    
    const order = (requestData.orders && typeof requestData.orders === 'object') ? requestData.orders : null;
    
    const paymentMethod = getValue(requestData, 'payment_method', 'orders.payment_method');
    const interestRate = (requestData.interest_rate !== null && requestData.interest_rate !== undefined) 
        ? parseFloat(requestData.interest_rate) 
        : 8.0;
    const principalAmount = (requestData.principal_amount !== null && requestData.principal_amount !== undefined)
        ? requestData.principal_amount
        : (requestData.import_price !== null && requestData.import_price !== undefined ? requestData.import_price : 0);
    
    return {
        poNumber: (requestData.po_number) ? String(requestData.po_number) : '-',
        importPrice: formatCurrency(requestData.import_price),
        paymentMethod: paymentMethod || '-',
        guaranteeBank: (requestData.guarantee_bank_coc) ? String(requestData.guarantee_bank_coc) : '-',
        principalAmount: formatCurrency(principalAmount),
        interestRate: `${interestRate}%`,
        delayedDaysPreview: calculateDelayedDaysPreview(requestData)
    };
}

/**
 * Extract issue information (if issued/disbursed/closed)
 */
function extractIssueInfo(requestData) {
    if (!requestData || typeof requestData !== 'object') {
        console.warn('[COC Detail] Invalid requestData in extractIssueInfo');
        return null;
    }
    
    const businessDaysDelayed = (requestData.business_days_delayed !== null && requestData.business_days_delayed !== undefined)
        ? parseFloat(requestData.business_days_delayed)
        : 0;
    const interestAmount = (requestData.interest_amount !== null && requestData.interest_amount !== undefined)
        ? requestData.interest_amount
        : 0;
    
    return {
        issuer: (requestData.issuer) ? String(requestData.issuer) : '-',
        actualIssueDate: formatDate(requestData.actual_issue_date),
        delayedDays: (businessDaysDelayed > 0) 
            ? `${businessDaysDelayed} ngày làm việc`
            : '0 ngày',
        interestAmount: formatCurrency(interestAmount),
        cocImageUrl: (requestData.coc_image_url && typeof requestData.coc_image_url === 'string') ? requestData.coc_image_url : null,
        handoverDocUrl: (requestData.handover_document_url && typeof requestData.handover_document_url === 'string') ? requestData.handover_document_url : null
    };
}

/**
 * Extract disbursement information (if closed)
 */
function extractDisbursementInfo(requestData) {
    if (!requestData || typeof requestData !== 'object') {
        console.warn('[COC Detail] Invalid requestData in extractDisbursementInfo');
        return null;
    }
    
    return {
        accountant: (requestData.accountant) ? String(requestData.accountant) : '-',
        disbursementFileUrl: (requestData.disbursement_file_url && typeof requestData.disbursement_file_url === 'string') 
            ? requestData.disbursement_file_url 
            : null
    };
}

/**
 * Get requester display name (with fullname if available)
 */
function getRequesterDisplay(requester) {
    if (!requester || typeof requester !== 'string') {
        return '-';
    }
    
    // Try to get fullname from cached users
    if (typeof window !== 'undefined' && window.cachedUsers && Array.isArray(window.cachedUsers)) {
        try {
            const user = window.cachedUsers.find(u => u && u.username === requester);
            if (user && user.fullname && typeof user.fullname === 'string') {
                return `${user.fullname} (${requester})`;
            }
        } catch (e) {
            console.warn('[COC Detail] Error finding requester user:', e);
        }
    }
    
    return requester;
}

/**
 * Calculate delayed days preview
 */
function calculateDelayedDaysPreview(requestData) {
    if (!requestData || typeof requestData !== 'object') {
        return '-';
    }
    
    // Try to calculate from dates if both are available
    if (requestData.actual_issue_date && requestData.request_date) {
        if (typeof window !== 'undefined' && typeof window.calculateDelayedBusinessDays === 'function') {
            try {
                const days = window.calculateDelayedBusinessDays(requestData.request_date, requestData.actual_issue_date);
                if (typeof days === 'number' && !isNaN(days)) {
                    return days > 0 ? `${days} ngày làm việc` : '0 ngày';
                }
            } catch (e) {
                console.warn('[COC Detail] Error calculating delayed days:', e);
            }
        }
    }
    
    // Fallback to stored value
    if (requestData.business_days_delayed !== null && requestData.business_days_delayed !== undefined) {
        const days = parseFloat(requestData.business_days_delayed);
        if (!isNaN(days)) {
            return days > 0 ? `${days} ngày làm việc` : '0 ngày';
        }
    }
    
    return '-';
}

// ======================================================
// RENDER FUNCTIONS
// ======================================================

/**
 * Render request information section
 */
function renderRequestInfo(info) {
    if (!info || typeof info !== 'object') {
        console.warn('[COC Detail] Invalid info in renderRequestInfo');
        return;
    }
    
    setElementText('detail-contract-code', info.contractCode);
    setElementText('detail-customer-name', info.customerName);
    setElementText('detail-customer-phone', info.customerPhone);
    setElementText('detail-customer-email', info.customerEmail);
    setElementText('detail-customer-cccd', info.customerCccd);
    setElementText('detail-customer-address', info.customerAddress);
    setElementText('detail-car-model', info.carModel);
    setElementText('detail-car-version', info.carVersion);
    setElementText('detail-car-color', info.carColor);
    setElementText('detail-vin-number', info.vinNumber);
    setElementText('detail-requester', info.requester);
    setElementText('detail-request-date', info.requestDate);
}

/**
 * Render financial information section
 */
function renderFinancialInfo(info) {
    if (!info || typeof info !== 'object') {
        console.warn('[COC Detail] Invalid info in renderFinancialInfo');
        return;
    }
    
    setElementText('detail-po-number', info.poNumber);
    setElementText('detail-import-price', info.importPrice);
    setElementText('detail-payment-method', info.paymentMethod);
    setElementText('detail-guarantee-bank-coc', info.guaranteeBank);
    setElementText('detail-principal-amount', info.principalAmount);
    setElementText('detail-interest-rate', info.interestRate);
    setElementText('detail-delayed-days-preview', info.delayedDaysPreview);
}

/**
 * Render issue information section
 */
function renderIssueInfo(info) {
    if (!info || typeof info !== 'object') {
        console.warn('[COC Detail] Invalid info in renderIssueInfo');
        return;
    }
    
    setElementText('detail-issuer', info.issuer);
    setElementText('detail-actual-issue-date', info.actualIssueDate);
    setElementText('detail-delayed-days', info.delayedDays);
    setElementText('detail-interest-amount', info.interestAmount);
    
    // COC Image
    try {
        const cocImageLink = document.getElementById('detail-coc-image-link');
        const cocImageContainer = document.getElementById('detail-coc-image');
        if (info.cocImageUrl && typeof info.cocImageUrl === 'string' && cocImageLink && cocImageContainer) {
            cocImageLink.href = info.cocImageUrl;
            cocImageLink.classList.remove('hidden');
            const placeholder = cocImageContainer.querySelector('.text-gray-400');
            if (placeholder) placeholder.classList.add('hidden');
        } else {
            if (cocImageLink) cocImageLink.classList.add('hidden');
            const placeholder = cocImageContainer ? cocImageContainer.querySelector('.text-gray-400') : null;
            if (placeholder) placeholder.classList.remove('hidden');
        }
    } catch (e) {
        console.warn('[COC Detail] Error rendering COC image:', e);
    }
    
    // Handover Document
    try {
        const handoverDocLink = document.getElementById('detail-handover-doc-link');
        const handoverDocContainer = document.getElementById('detail-handover-doc');
        if (info.handoverDocUrl && typeof info.handoverDocUrl === 'string' && handoverDocLink && handoverDocContainer) {
            handoverDocLink.href = info.handoverDocUrl;
            handoverDocLink.classList.remove('hidden');
            const placeholder = handoverDocContainer.querySelector('.text-gray-400');
            if (placeholder) placeholder.classList.add('hidden');
        } else {
            if (handoverDocLink) handoverDocLink.classList.add('hidden');
            const placeholder = handoverDocContainer ? handoverDocContainer.querySelector('.text-gray-400') : null;
            if (placeholder) placeholder.classList.remove('hidden');
        }
    } catch (e) {
        console.warn('[COC Detail] Error rendering handover document:', e);
    }
}

/**
 * Render disbursement information section
 */
function renderDisbursementInfo(info) {
    if (!info || typeof info !== 'object') {
        console.warn('[COC Detail] Invalid info in renderDisbursementInfo');
        return;
    }
    
    setElementText('detail-accountant', info.accountant);
    
    // Disbursement File
    try {
        const fileLink = document.getElementById('detail-disbursement-file-link');
        const fileContainer = document.getElementById('detail-disbursement-file');
        if (info.disbursementFileUrl && typeof info.disbursementFileUrl === 'string' && fileLink && fileContainer) {
            fileLink.href = info.disbursementFileUrl;
            fileLink.classList.remove('hidden');
            const placeholder = fileContainer.querySelector('.text-gray-400');
            if (placeholder) placeholder.classList.add('hidden');
        } else {
            if (fileLink) fileLink.classList.add('hidden');
            const placeholder = fileContainer ? fileContainer.querySelector('.text-gray-400') : null;
            if (placeholder) placeholder.classList.remove('hidden');
        }
    } catch (e) {
        console.warn('[COC Detail] Error rendering disbursement file:', e);
    }
}

/**
 * Render status
 */
function renderStatus(status) {
    const statusMap = {
        'pending': { label: 'Đang chờ', class: 'bg-yellow-100 text-yellow-800' },
        'issued': { label: 'Đã cấp', class: 'bg-blue-100 text-blue-800' },
        'disbursed': { label: 'Đã giải ngân', class: 'bg-orange-100 text-orange-800' },
        'closed': { label: 'Đã đóng', class: 'bg-green-100 text-green-800' }
    };
    
    const validStatus = (status && typeof status === 'string' && status in statusMap) ? status : 'pending';
    const statusInfo = statusMap[validStatus];
    
    if (!statusInfo) {
        console.warn('[COC Detail] Invalid status:', status);
        return;
    }
    
    const badge = document.getElementById('detail-status-badge');
    const label = document.getElementById('detail-status-label');
    
    if (!badge) {
        console.warn('[COC Detail] Status badge element not found');
    } else {
        try {
            badge.textContent = statusInfo.label;
            badge.className = `px-4 py-2 rounded-full text-sm font-bold ${statusInfo.class}`;
        } catch (e) {
            console.warn('[COC Detail] Error rendering status badge:', e);
        }
    }
    
    if (!label) {
        console.warn('[COC Detail] Status label element not found');
    } else {
        try {
            label.textContent = `Trạng thái hiện tại: ${statusInfo.label}`;
        } catch (e) {
            console.warn('[COC Detail] Error rendering status label:', e);
        }
    }
}

/**
 * Render notes
 */
function renderNotes(notes) {
    const section = document.getElementById('detail-notes-section');
    const notesEl = document.getElementById('detail-notes');
    
    if (!section) {
        console.warn('[COC Detail] Notes section element not found');
        return;
    }
    
    try {
        if (notes && typeof notes === 'string' && notes.trim()) {
            section.classList.remove('hidden');
            if (notesEl) {
                notesEl.textContent = notes;
            } else {
                console.warn('[COC Detail] Notes element not found');
            }
        } else {
            section.classList.add('hidden');
        }
    } catch (e) {
        console.warn('[COC Detail] Error rendering notes:', e);
    }
}

// ======================================================
// MAIN FUNCTIONS
// ======================================================

/**
 * Fetch COC request data
 */
async function fetchCocRequestData(requestId) {
    // Validate requestId
    if (!requestId) {
        throw new Error('Request ID không hợp lệ');
    }
    
    // Try to find in cached data first
    if (typeof window !== 'undefined' && window.allCocRequests && Array.isArray(window.allCocRequests)) {
        try {
            const cached = window.allCocRequests.find(r => r && r.id === requestId);
            if (cached) {
                console.log('[COC Detail] Found in cache');
                return cached;
            }
        } catch (e) {
            console.warn('[COC Detail] Error accessing cached data:', e);
        }
    }
    
    // Fetch from API
    console.log('[COC Detail] Fetching from API...');
    
    // Check session
    let session = null;
    try {
        const sessionStr = localStorage.getItem('user_session');
        if (!sessionStr) {
            throw new Error('Phiên đăng nhập hết hạn');
        }
        session = JSON.parse(sessionStr);
    } catch (e) {
        console.warn('[COC Detail] Session parse error:', e);
        throw new Error('Phiên đăng nhập hết hạn');
    }
    
    if (!session || typeof session !== 'object' || !session.username || typeof session.username !== 'string') {
        throw new Error('Phiên đăng nhập hết hạn');
    }
    
    // Check API availability
    if (typeof window === 'undefined' || typeof window.callAPI !== 'function') {
        throw new Error('API không khả dụng');
    }
    
    // Call API
    let result = null;
    try {
        result = await window.callAPI({
            action: 'get_coc_requests',
            username: session.username,
            role: session.role || null
        });
    } catch (e) {
        console.error('[COC Detail] API call error:', e);
        throw new Error('Lỗi kết nối đến server');
    }
    
    if (!result || typeof result !== 'object') {
        throw new Error('Phản hồi từ server không hợp lệ');
    }
    
    if (!result.success) {
        const errorMsg = (result.message && typeof result.message === 'string') ? result.message : 'Không thể tải dữ liệu';
        throw new Error(errorMsg);
    }
    
    if (!result.data || !Array.isArray(result.data)) {
        throw new Error('Dữ liệu không hợp lệ');
    }
    
    const requestData = result.data.find(r => r && r.id === requestId);
    if (!requestData) {
        throw new Error('Không tìm thấy đề nghị COC');
    }
    
    return requestData;
}

/**
 * Open COC detail modal
 */
async function openCocDetailModal(requestId) {
    // Validate requestId
    if (!requestId) {
        console.error('[COC Detail] Invalid requestId:', requestId);
        return;
    }
    
    // Get DOM elements
    const modal = document.getElementById('modal-coc-detail');
    const loadingDiv = document.getElementById('coc-detail-loading');
    const bodyDiv = document.getElementById('coc-detail-body');
    const errorDiv = document.getElementById('coc-detail-error');
    
    // Validate DOM elements
    if (!modal) {
        console.error('[COC Detail] Modal element not found');
        return;
    }
    if (!loadingDiv) {
        console.warn('[COC Detail] Loading div not found');
    }
    if (!bodyDiv) {
        console.warn('[COC Detail] Body div not found');
    }
    if (!errorDiv) {
        console.warn('[COC Detail] Error div not found');
    }
    
    // Show modal and loading
    try {
        modal.classList.remove('hidden');
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (bodyDiv) bodyDiv.classList.add('hidden');
        if (errorDiv) errorDiv.classList.add('hidden');
    } catch (e) {
        console.error('[COC Detail] Error showing modal:', e);
        return;
    }
    
    try {
        // Fetch data
        const requestData = await fetchCocRequestData(requestId);
        
        if (!requestData || typeof requestData !== 'object') {
            throw new Error('Dữ liệu không hợp lệ');
        }
        
        console.log('[COC Detail] Request data:', requestData);
        
        // Extract and render data
        const requestInfo = extractRequestInfo(requestData);
        const financialInfo = extractFinancialInfo(requestData);
        
        if (requestInfo) {
            renderRequestInfo(requestInfo);
        } else {
            console.warn('[COC Detail] Failed to extract request info');
        }
        
        if (financialInfo) {
            renderFinancialInfo(financialInfo);
        } else {
            console.warn('[COC Detail] Failed to extract financial info');
        }
        
        // Render status
        const status = (requestData.status && typeof requestData.status === 'string') ? requestData.status : 'pending';
        renderStatus(status);
        
        // Render notes
        renderNotes(requestData.notes);
        
        // Show issue section if issued/disbursed/closed
        const validStatuses = ['issued', 'disbursed', 'closed'];
        if (validStatuses.includes(status)) {
            const issueSection = document.getElementById('detail-issue-section');
            if (issueSection) {
                try {
                    issueSection.classList.remove('hidden');
                    const issueInfo = extractIssueInfo(requestData);
                    if (issueInfo) {
                        renderIssueInfo(issueInfo);
                    } else {
                        console.warn('[COC Detail] Failed to extract issue info');
                    }
                } catch (e) {
                    console.warn('[COC Detail] Error showing issue section:', e);
                }
            } else {
                console.warn('[COC Detail] Issue section element not found');
            }
        } else {
            const issueSection = document.getElementById('detail-issue-section');
            if (issueSection) {
                try {
                    issueSection.classList.add('hidden');
                } catch (e) {
                    console.warn('[COC Detail] Error hiding issue section:', e);
                }
            }
        }
        
        // Show disbursement section if closed
        if (status === 'closed') {
            const disburseSection = document.getElementById('detail-disburse-section');
            if (disburseSection) {
                try {
                    disburseSection.classList.remove('hidden');
                    const disburseInfo = extractDisbursementInfo(requestData);
                    if (disburseInfo) {
                        renderDisbursementInfo(disburseInfo);
                    } else {
                        console.warn('[COC Detail] Failed to extract disbursement info');
                    }
                } catch (e) {
                    console.warn('[COC Detail] Error showing disbursement section:', e);
                }
            } else {
                console.warn('[COC Detail] Disbursement section element not found');
            }
        } else {
            const disburseSection = document.getElementById('detail-disburse-section');
            if (disburseSection) {
                try {
                    disburseSection.classList.add('hidden');
                } catch (e) {
                    console.warn('[COC Detail] Error hiding disbursement section:', e);
                }
            }
        }
        
        // Show content
        if (loadingDiv) {
            try {
                loadingDiv.classList.add('hidden');
            } catch (e) {
                console.warn('[COC Detail] Error hiding loading:', e);
            }
        }
        if (bodyDiv) {
            try {
                bodyDiv.classList.remove('hidden');
            } catch (e) {
                console.warn('[COC Detail] Error showing body:', e);
            }
        }
        
    } catch (error) {
        console.error('[COC Detail] Error:', error);
        
        // Show error state
        if (loadingDiv) {
            try {
                loadingDiv.classList.add('hidden');
            } catch (e) {
                console.warn('[COC Detail] Error hiding loading on error:', e);
            }
        }
        if (errorDiv) {
            try {
                errorDiv.classList.remove('hidden');
                const errorMsg = document.getElementById('coc-detail-error-message');
                if (errorMsg) {
                    const errorText = (error && error.message && typeof error.message === 'string') 
                        ? error.message 
                        : 'Không thể tải thông tin chi tiết';
                    errorMsg.textContent = errorText;
                } else {
                    console.warn('[COC Detail] Error message element not found');
                }
            } catch (e) {
                console.warn('[COC Detail] Error showing error state:', e);
            }
        }
    }
}

/**
 * Close COC detail modal
 */
function closeCocDetailModal() {
    try {
        const modal = document.getElementById('modal-coc-detail');
        if (modal) {
            modal.classList.add('hidden');
        } else {
            console.warn('[COC Detail] Modal element not found when closing');
        }
    } catch (e) {
        console.error('[COC Detail] Error closing modal:', e);
    }
}

// ======================================================
// EXPOSE FUNCTIONS
// ======================================================

if (typeof window !== 'undefined') {
    try {
        window.openCocDetailModal = openCocDetailModal;
        window.closeCocDetailModal = closeCocDetailModal;
        console.log('✅ COC detail modal functions exposed to window');
    } catch (e) {
        console.error('[COC Detail] Error exposing functions to window:', e);
    }
} else {
    console.error('[COC Detail] window is undefined, cannot expose functions');
}
</script>
