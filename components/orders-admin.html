<div id="tab-orders-admin" class="tab-content">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-purple-50 px-6 py-4 border-b border-purple-100">
            <h2 class="text-lg font-bold text-purple-800">
                <i class="fa-solid fa-key mr-2"></i>Cấp Mã Đơn Hàng
            </h2>
            <p class="text-sm text-gray-600 mt-1">Quản lý và cấp mã đơn hàng (số hợp đồng) cho các đơn hàng của TVBH</p>
        </div>
        <div class="p-6">
            <!-- Filter -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                    <label class="label text-xs">Lọc theo TVBH:</label>
                    <select id="filter-tvbh" class="input bg-white text-sm" onchange="loadOrdersForAdmin()">
                        <option value="">Tất cả TVBH</option>
                    </select>
                </div>
                <div>
                    <label class="label text-xs">Trạng thái:</label>
                    <select id="filter-status-admin" class="input bg-white text-sm" onchange="loadOrdersForAdmin()">
                        <option value="">Tất cả</option>
                        <option value="pending">Chưa có mã</option>
                        <option value="assigned">Đã có mã</option>
                    </select>
                </div>
                <div>
                    <label class="label text-xs">Tìm kiếm:</label>
                    <input 
                        type="text" 
                        id="search-orders-admin" 
                        class="input text-sm" 
                        placeholder="Tên KH, CCCD..."
                        onkeyup="filterOrdersAdmin()"
                    >
                </div>
                <div class="flex items-end">
                    <button 
                        onclick="loadOrdersForAdmin()" 
                        class="w-full bg-purple-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-purple-700 transition"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Làm mới
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="orders-admin-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="mt-2 text-gray-600">Đang tải...</p>
            </div>

            <!-- Orders List -->
            <div id="orders-admin-list" class="space-y-3">
                <!-- Orders will be loaded here -->
            </div>

            <div id="orders-admin-empty" class="text-center py-12 hidden">
                <i class="fa-solid fa-inbox text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">Chưa có đơn hàng nào</p>
            </div>
        </div>
    </div>
</div>

<script>
let allAdminOrders = [];

// Load orders for SaleAdmin
async function loadOrdersForAdmin() {
    const session = JSON.parse(localStorage.getItem('session') || '{}');
    if (!session || !session.username) {
        showToast('Vui lòng đăng nhập lại', 'danger');
        return;
    }

    document.getElementById('orders-admin-loading').classList.remove('hidden');
    document.getElementById('orders-admin-list').innerHTML = '';
    document.getElementById('orders-admin-empty').classList.add('hidden');

    const filterTVBH = document.getElementById('filter-tvbh').value;
    const filterStatus = document.getElementById('filter-status-admin').value;
    
    const filters = {};
    if (filterTVBH) {
        filters.requester = filterTVBH;
    }
    if (filterStatus === 'pending') {
        filters.status = 'pending';
    } else if (filterStatus === 'assigned') {
        filters.status = 'assigned';
    }

    const result = await window.callAPI({
        action: 'get_orders_for_saleadmin',
        filters: filters
    });

    document.getElementById('orders-admin-loading').classList.add('hidden');

    if (result.success && result.data && result.data.length > 0) {
        allAdminOrders = result.data;
        renderAdminOrders(allAdminOrders);
        populateTVBHFilter(result.data);
        document.getElementById('orders-admin-empty').classList.add('hidden');
    } else {
        allAdminOrders = [];
        document.getElementById('orders-admin-list').innerHTML = '';
        document.getElementById('orders-admin-empty').classList.remove('hidden');
    }
}

// Populate TVBH filter
function populateTVBHFilter(orders) {
    const tvbhSet = new Set();
    orders.forEach(order => {
        if (order.requester_user && order.requester_user.username) {
            tvbhSet.add(JSON.stringify({
                username: order.requester_user.username,
                fullname: order.requester_user.fullname || order.requester_user.username
            }));
        }
    });

    const filterSelect = document.getElementById('filter-tvbh');
    const currentValue = filterSelect.value;
    
    // Clear old options except "Tất cả"
    filterSelect.innerHTML = '<option value="">Tất cả TVBH</option>';
    
    // Add unique TVBH
    Array.from(tvbhSet).forEach(tvbhJson => {
        const tvbh = JSON.parse(tvbhJson);
        const option = document.createElement('option');
        option.value = tvbh.username;
        option.textContent = tvbh.fullname;
        filterSelect.appendChild(option);
    });

    // Restore selection
    if (currentValue) {
        filterSelect.value = currentValue;
    }
}

// Render admin orders
function renderAdminOrders(orders) {
    const container = document.getElementById('orders-admin-list');
    container.innerHTML = '';

    // Sort: pending first
    const sortedOrders = [...orders].sort((a, b) => {
        const aHasCode = a.contract_code ? 1 : 0;
        const bHasCode = b.contract_code ? 1 : 0;
        return aHasCode - bHasCode;
    });

    sortedOrders.forEach(order => {
        const customer = order.customers || {};
        const requester = order.requester_user || {};
        const hasContractCode = order.contract_code && order.contract_code.trim();
        
        const orderCard = document.createElement('div');
        orderCard.className = `border rounded-lg p-4 transition ${
            hasContractCode 
                ? 'bg-gray-50 border-gray-200' 
                : 'bg-yellow-50 border-yellow-300 border-2'
        }`;
        
        orderCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="font-bold text-gray-800 text-lg">${customer.name || 'Chưa có tên'}</h3>
                        ${hasContractCode ? `
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">
                                <i class="fa-solid fa-check-circle mr-1"></i>Đã cấp mã
                            </span>
                        ` : `
                            <span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded animate-pulse">
                                <i class="fa-solid fa-exclamation-circle mr-1"></i>Chưa có mã
                            </span>
                        `}
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600 mb-2">
                        <div>
                            <span class="font-medium">TVBH:</span> ${requester.fullname || requester.username || '-'}
                        </div>
                        <div>
                            <span class="font-medium">CCCD:</span> ${customer.cccd || '-'}
                        </div>
                        <div>
                            <span class="font-medium">SĐT:</span> ${customer.phone || '-'}
                        </div>
                        <div>
                            <span class="font-medium">Xe:</span> ${order.car_model || '-'}
                        </div>
                        ${hasContractCode ? `
                            <div class="md:col-span-2">
                                <span class="font-medium">Mã đơn hàng:</span> 
                                <span class="font-bold text-green-600 text-lg">${order.contract_code}</span>
                            </div>
                        ` : ''}
                        <div class="md:col-span-2">
                            <span class="font-medium">Ngày tạo:</span> ${formatDate(order.created_at)}
                        </div>
                    </div>
                </div>
            </div>
            ${!hasContractCode ? `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                    <h4 class="font-bold text-gray-800 mb-2">Cấp mã đơn hàng:</h4>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="contract-code-${order.id}" 
                            class="flex-1 input uppercase font-mono text-lg font-bold" 
                            placeholder="Nhập mã đơn hàng..."
                            required
                        >
                        <button 
                            onclick="assignContractCode('${order.id}')" 
                            class="bg-green-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-green-700 transition"
                        >
                            <i class="fa-solid fa-check mr-2"></i>Cấp mã
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        Mã đơn hàng phải là duy nhất (không trùng với đơn hàng khác)
                    </p>
                </div>
            ` : `
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-gray-700">Mã đơn hàng đã được cấp:</span>
                            <span class="ml-2 font-bold text-green-600 text-lg">${order.contract_code}</span>
                        </div>
                        ${order.assigned_sale ? `
                            <span class="text-xs text-gray-600">
                                Quản lý bởi: <strong>${order.assigned_sale}</strong>
                            </span>
                        ` : ''}
                    </div>
                </div>
            `}
        `;
        container.appendChild(orderCard);
    });
}

// Filter orders admin
function filterOrdersAdmin() {
    const searchTerm = document.getElementById('search-orders-admin').value.toLowerCase();
    if (!searchTerm) {
        renderAdminOrders(allAdminOrders);
        return;
    }

    const filtered = allAdminOrders.filter(order => {
        const customer = order.customers || {};
        const requester = order.requester_user || {};
        const searchText = `${customer.name || ''} ${customer.cccd || ''} ${requester.fullname || ''}`.toLowerCase();
        return searchText.includes(searchTerm);
    });

    renderAdminOrders(filtered);
}

// Assign contract code
async function assignContractCode(orderId) {
    const contractCodeInput = document.getElementById(`contract-code-${orderId}`);
    const contractCode = contractCodeInput.value.trim().toUpperCase();

    if (!contractCode) {
        showToast('Vui lòng nhập mã đơn hàng', 'warning');
        contractCodeInput.focus();
        return;
    }

    const session = JSON.parse(localStorage.getItem('session') || '{}');
    if (!session || !session.username) {
        showToast('Vui lòng đăng nhập lại', 'danger');
        return;
    }

    // Show loading
    contractCodeInput.disabled = true;

    const result = await window.callAPI({
        action: 'assign_contract_code',
        orderId: orderId,
        contract_code: contractCode,
        assigned_sale: session.username
    });

    contractCodeInput.disabled = false;

    if (result.success) {
        showToast('Đã cấp mã đơn hàng thành công!', 'success');
        // Reload orders
        loadOrdersForAdmin();
    } else {
        showToast('Lỗi: ' + result.message, 'danger');
        contractCodeInput.focus();
    }
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

// Auto load when tab is shown
if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
        const observer = new MutationObserver((mutations) => {
            const adminTab = document.getElementById('tab-orders-admin');
            if (adminTab && adminTab.classList.contains('active')) {
                loadOrdersForAdmin();
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container) {
            observer.observe(container.parentElement, { 
                attributes: true, 
                attributeFilter: ['class'],
                subtree: true 
            });
        }
    });
}
</script>

