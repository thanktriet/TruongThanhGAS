<div id="tab-car-models" class="tab-content max-w-6xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-purple-600 text-white px-6 py-4 border-b">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-car mr-2"></i>Qu·∫£n L√Ω D√≤ng Xe
            </h2>
            <p class="text-sm text-purple-100 mt-1">Qu·∫£n l√Ω danh s√°ch d√≤ng xe cho b√°o c√°o</p>
        </div>

        <div class="p-6">
            <!-- Form th√™m d√≤ng xe m·ªõi -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa-solid fa-plus-circle mr-2 text-green-600"></i>Th√™m D√≤ng Xe M·ªõi
                </h3>
                <form id="form-create-car-model" class="grid grid-cols-1 md:grid-cols-4 gap-4" onsubmit="handleCreateCarModel(event)">
                    <div>
                        <label class="label">T√™n d√≤ng xe *</label>
                        <input 
                            type="text" 
                            id="new-car-model-name" 
                            class="input" 
                            placeholder="VD: VF 10" 
                            required
                        >
                    </div>
                    <div>
                        <label class="label">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input 
                            type="number" 
                            id="new-car-model-order" 
                            class="input" 
                            value="0" 
                            min="0"
                        >
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="new-car-model-active" 
                                class="w-4 h-4 text-purple-600 rounded"
                                checked
                            >
                            <span class="text-sm font-medium">ƒêang s·ª≠ d·ª•ng</span>
                        </label>
                    </div>
                    <div class="flex items-end">
                        <button 
                            type="submit" 
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition"
                        >
                            <i class="fa-solid fa-plus mr-2"></i>Th√™m
                        </button>
                    </div>
                </form>
                <p id="create-car-model-status" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Danh s√°ch d√≤ng xe -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa-solid fa-list mr-2 text-blue-600"></i>Danh S√°ch D√≤ng Xe
                </h3>
                <div id="car-models-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>ƒêang t·∫£i danh s√°ch...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function ƒë·ªÉ t·∫°o promise v·ªõi timeout
function withTimeout(promise, timeoutMs, errorMessage) {
    return Promise.race([
        promise,
        new Promise((_, reject) => 
            setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
        )
    ]);
}

// Load danh s√°ch car models
async function loadCarModelsList() {
    const container = document.getElementById('car-models-list');
    if (!container) {
        console.error('car-models-list container not found');
        return;
    }

    console.log('Loading car models list...');
    container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>ƒêang t·∫£i danh s√°ch...</p></div>';

    try {
        // Ki·ªÉm tra callAPI
        if (typeof window.callAPI !== 'function') {
            throw new Error('callAPI function not found. Vui l√≤ng reload trang.');
        }

        // Ki·ªÉm tra supabaseAPI
        if (!window.supabaseAPI || !window.supabaseAPI.callAPI) {
            throw new Error('Supabase API ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o. Vui l√≤ng reload trang.');
        }

        console.log('Calling API: list_car_models');
        
        // Th√™m timeout 10 gi√¢y
        const apiCall = window.callAPI({
            action: 'list_car_models'
        });
        
        const result = await withTimeout(
            apiCall,
            10000,
            'API call timeout sau 10 gi√¢y. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.'
        );

        console.log('API result:', result);

        if (!result) {
            throw new Error('API kh√¥ng tr·∫£ v·ªÅ k·∫øt qu·∫£');
        }

        console.log('Checking result:', {
            success: result.success,
            hasData: !!result.data,
            isArray: Array.isArray(result.data),
            dataLength: result.data?.length,
            fullResult: result
        });

        if (result.success && result.data && Array.isArray(result.data)) {
            console.log('Rendering car models:', result.data.length, 'items');
            console.log('Data:', result.data);
            renderCarModelsList(result.data);
        } else {
            const errorMsg = result?.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch';
            console.error('API returned error or invalid data:', result);
            console.error('Result details:', {
                success: result?.success,
                data: result?.data,
                message: result?.message
            });
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="font-bold">L·ªói: ${escapeHtml(errorMsg)}</p>
                    <p class="text-sm mt-2 text-gray-600">Result: ${JSON.stringify(result)}</p>
                    <p class="text-sm mt-2">Vui l√≤ng m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt</p>
                    <button 
                        onclick="loadCarModelsList()" 
                        class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading car models:', error);
        const errorMsg = error.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch';
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">L·ªói: ${escapeHtml(errorMsg)}</p>
                <p class="text-sm mt-2 text-gray-600">Vui l√≤ng m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt</p>
                <button 
                    onclick="loadCarModelsList()" 
                    class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                >
                    <i class="fa-solid fa-rotate mr-2"></i>Th·ª≠ l·∫°i
                </button>
            </div>
        `;
    }
}

// Render danh s√°ch car models
function renderCarModelsList(carModels) {
    console.log('renderCarModelsList called with:', carModels);
    const container = document.getElementById('car-models-list');
    if (!container) {
        console.error('car-models-list container not found in renderCarModelsList');
        return;
    }

    console.log('Container found, carModels length:', carModels?.length);

    if (!carModels || !Array.isArray(carModels)) {
        console.error('carModels is not an array:', carModels);
        container.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i><p>D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</p></div>';
        return;
    }

    if (carModels.length === 0) {
        console.log('No car models to display');
        container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-2xl mb-2"></i><p>Ch∆∞a c√≥ d√≤ng xe n√†o</p><p class="text-xs mt-2">Vui l√≤ng th√™m d√≤ng xe m·ªõi</p></div>';
        return;
    }

    console.log('Rendering', carModels.length, 'car models');

    try {
        const html = carModels.map(model => {
            try {
                console.log('Rendering model:', model);
                if (!model.id) {
                    console.error('Model missing id:', model);
                    return '';
                }
                return `
        <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition" data-id="${model.id || ''}">
            <div class="flex items-center justify-between">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase">T√™n d√≤ng xe</label>
                        <input 
                            type="text" 
                            class="input mt-1 car-model-name" 
                            value="${escapeHtml(model.name)}" 
                            data-id="${model.id}"
                            data-model-id="${model.id}"
                            data-field="name"
                            onchange="handleUpdateCarModel(this.dataset.modelId, this.dataset.field, this.value)"
                        >
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input 
                            type="number" 
                            class="input mt-1 car-model-order" 
                            value="${model.display_order || 0}" 
                            min="0"
                            data-id="${model.id}"
                            data-model-id="${model.id}"
                            data-field="display_order"
                            onchange="handleUpdateCarModel(this.dataset.modelId, this.dataset.field, parseInt(this.value))"
                        >
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                class="car-model-active w-4 h-4 text-purple-600 rounded" 
                                ${model.is_active ? 'checked' : ''}
                                data-id="${model.id}"
                                data-model-id="${model.id}"
                                data-field="is_active"
                                onchange="handleUpdateCarModel(this.dataset.modelId, this.dataset.field, this.checked)"
                            >
                            <span class="text-sm font-medium">${model.is_active ? 'ƒêang s·ª≠ d·ª•ng' : 'T·∫°m ng∆∞ng'}</span>
                        </label>
                    </div>
                </div>
                <div class="ml-4">
                    <button 
                        data-model-id="${model.id}"
                        data-model-name="${escapeHtml(model.name)}"
                        onclick="handleDeleteCarModel(this.dataset.modelId, this.dataset.modelName)" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold"
                    >
                        <i class="fa-solid fa-trash mr-2"></i>X√≥a
                    </button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-400">
                ${model.created_by ? `T·∫°o b·ªüi: ${escapeHtml(model.created_by)}` : ''}
                ${model.created_at ? ` ‚Ä¢ ${formatDate(model.created_at)}` : ''}
            </div>
        </div>
    `;
            } catch (modelError) {
                console.error('Error rendering model:', model, modelError);
                return `<div class="border border-red-200 rounded-lg p-4 bg-red-50 text-red-600">L·ªói render model: ${model?.name || 'Unknown'}</div>`;
            }
        }).filter(html => html).join('');

        console.log('HTML generated, length:', html.length);
        if (html.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-2xl mb-2"></i><p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</p></div>';
            return;
        }
        container.innerHTML = html;
        console.log('Container innerHTML updated successfully');
    } catch (renderError) {
        console.error('Error rendering car models list:', renderError);
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">L·ªói render: ${escapeHtml(renderError.message)}</p>
                <p class="text-sm mt-2">Vui l√≤ng m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt</p>
            </div>
        `;
    }
}

// Escape HTML ƒë·ªÉ tr√°nh XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString;
    }
}

// Handle create car model
async function handleCreateCarModel(event) {
    event.preventDefault();

    const nameInput = document.getElementById('new-car-model-name');
    const orderInput = document.getElementById('new-car-model-order');
    const activeInput = document.getElementById('new-car-model-active');
    const statusDiv = document.getElementById('create-car-model-status');

    if (!nameInput || !orderInput || !activeInput || !statusDiv) return;

    const name = nameInput.value.trim();
    if (!name) {
        statusDiv.className = 'text-sm text-red-500 mt-2';
        statusDiv.textContent = 'Vui l√≤ng nh·∫≠p t√™n d√≤ng xe';
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang th√™m...';
    }

    statusDiv.className = 'text-sm text-gray-500 mt-2';
    statusDiv.textContent = 'ƒêang x·ª≠ l√Ω...';

    try {
        const result = await window.callAPI({
            action: 'create_car_model',
            name: name,
            display_order: parseInt(orderInput.value) || 0,
            is_active: activeInput.checked
        });

        if (result.success) {
            statusDiv.className = 'text-sm text-green-500 mt-2';
            statusDiv.textContent = 'ƒê√£ th√™m d√≤ng xe th√†nh c√¥ng!';
            
            // Reset form
            nameInput.value = '';
            orderInput.value = '0';
            activeInput.checked = true;
            
            // Reload list
            setTimeout(() => {
                loadCarModelsList();
                statusDiv.textContent = '';
            }, 1000);
        } else {
            statusDiv.className = 'text-sm text-red-500 mt-2';
            statusDiv.textContent = 'L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ th√™m d√≤ng xe');
        }
    } catch (error) {
        console.error('Error creating car model:', error);
        statusDiv.className = 'text-sm text-red-500 mt-2';
        statusDiv.textContent = 'L·ªói: ' + error.message;
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i>Th√™m';
        }
    }
}

// Handle update car model
async function handleUpdateCarModel(id, field, value) {
    if (!id) return;

    try {
        const updateData = { id: id };
        updateData[field] = value;

        const result = await window.callAPI({
            action: 'update_car_model',
            ...updateData
        });

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng', 'success');
            }
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'), 'danger');
            }
            // Reload ƒë·ªÉ reset gi√° tr·ªã
            loadCarModelsList();
        }
    } catch (error) {
        console.error('Error updating car model:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói: ' + error.message, 'danger');
        }
        // Reload ƒë·ªÉ reset gi√° tr·ªã
        loadCarModelsList();
    }
}

// Handle delete car model
async function handleDeleteCarModel(id, name) {
    if (!id) return;

    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng xe "${name}"?\n\nL∆∞u √Ω: H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
        return;
    }

    try {
        const result = await window.callAPI({
            action: 'delete_car_model',
            id: id
        });

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('ƒê√£ x√≥a d√≤ng xe th√†nh c√¥ng', 'success');
            }
            // Reload list
            loadCarModelsList();
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ x√≥a'), 'danger');
            }
        }
    } catch (error) {
        console.error('Error deleting car model:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('L·ªói: ' + error.message, 'danger');
        }
    }
}

// Expose function globally for manual call
if (typeof window !== 'undefined') {
    window.loadCarModelsList = loadCarModelsList;
    window.renderCarModelsList = renderCarModelsList;
    window.handleCreateCarModel = handleCreateCarModel;
    window.handleUpdateCarModel = handleUpdateCarModel;
    window.handleDeleteCarModel = handleDeleteCarModel;
    
    console.log('‚úÖ Car models functions exposed to window');
}

// Initialize when tab is shown
if (typeof window !== 'undefined') {
    console.log('üöÄ Initializing car models component...');
    
    // Load immediately if tab is already active
    const checkAndLoad = () => {
        console.log('üîç Checking if car models tab is active...');
        const carModelsTab = document.getElementById('tab-car-models');
        console.log('Tab element:', carModelsTab);
        if (carModelsTab) {
            console.log('Tab classes:', carModelsTab.classList.toString());
            if (carModelsTab.classList.contains('active')) {
                console.log('‚úÖ Car models tab is active, loading data...');
                loadCarModelsList();
            } else {
                console.log('‚è≥ Car models tab is not active yet');
            }
        } else {
            console.warn('‚ö†Ô∏è tab-car-models element not found');
        }
    };

    // Try to load on page load
    if (document.readyState === 'loading') {
        console.log('üìÑ Document is loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOMContentLoaded fired');
            setTimeout(() => {
                checkAndLoad();
            }, 1000); // Wait a bit for components to load
        });
    } else {
        console.log('üìÑ Document already loaded');
        setTimeout(() => {
            checkAndLoad();
        }, 1000);
    }

    // Also listen for tab switches
    window.addEventListener('load', () => {
        console.log('üåê Window load event fired');
        
        // Auto load when tab is shown
        const observer = new MutationObserver((mutations) => {
            const carModelsTab = document.getElementById('tab-car-models');
            if (carModelsTab && carModelsTab.classList.contains('active')) {
                console.log('üîÑ Car models tab became active (via observer), loading data...');
                loadCarModelsList();
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container && container.parentElement) {
            console.log('üëÄ Setting up MutationObserver...');
            observer.observe(container.parentElement, { 
                attributes: true, 
                attributeFilter: ['class'],
                subtree: true 
            });
        } else {
            console.warn('‚ö†Ô∏è Container not found for observer');
        }

        // Also check immediately
        setTimeout(() => {
            console.log('‚è∞ Delayed check after window load...');
            checkAndLoad();
        }, 2000);
    });

    console.log('‚úÖ Car models initialization complete');
}
</script>

