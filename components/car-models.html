<div id="tab-car-models" class="tab-content max-w-6xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-purple-600 text-white px-6 py-4 border-b">
            <h2 class="text-xl font-bold">
                <i class="fa-solid fa-car mr-2"></i>Quản Lý Dòng Xe
            </h2>
            <p class="text-sm text-purple-100 mt-1">Quản lý danh sách dòng xe cho báo cáo</p>
        </div>

        <div class="p-6">
            <!-- Form thêm dòng xe mới -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa-solid fa-plus-circle mr-2 text-green-600"></i>Thêm Dòng Xe Mới
                </h3>
                <form id="form-create-car-model" class="grid grid-cols-1 md:grid-cols-4 gap-4" onsubmit="handleCreateCarModel(event)">
                    <div>
                        <label class="label">Tên dòng xe *</label>
                        <input 
                            type="text" 
                            id="new-car-model-name" 
                            class="input" 
                            placeholder="VD: VF 10" 
                            required
                        >
                    </div>
                    <div>
                        <label class="label">Thứ tự hiển thị</label>
                        <input 
                            type="number" 
                            id="new-car-model-order" 
                            class="input" 
                            value="0" 
                            min="0"
                        >
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="new-car-model-active" 
                                class="w-4 h-4 text-purple-600 rounded"
                                checked
                            >
                            <span class="text-sm font-medium">Đang sử dụng</span>
                        </label>
                    </div>
                    <div class="flex items-end">
                        <button 
                            type="submit" 
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition"
                        >
                            <i class="fa-solid fa-plus mr-2"></i>Thêm
                        </button>
                    </div>
                </form>
                <p id="create-car-model-status" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Danh sách dòng xe -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa-solid fa-list mr-2 text-blue-600"></i>Danh Sách Dòng Xe
                </h3>
                <div id="car-models-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Đang tải danh sách...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function để tạo promise với timeout
function withTimeout(promise, timeoutMs, errorMessage) {
    return Promise.race([
        promise,
        new Promise((_, reject) => 
            setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
        )
    ]);
}

// Load danh sách car models
async function loadCarModelsList() {
    const container = document.getElementById('car-models-list');
    if (!container) {
        console.error('car-models-list container not found');
        return;
    }

    console.log('Loading car models list...');
    container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>Đang tải danh sách...</p></div>';

    try {
        // Kiểm tra callAPI
        if (typeof window.callAPI !== 'function') {
            throw new Error('callAPI function not found. Vui lòng reload trang.');
        }

        // Kiểm tra supabaseAPI
        if (!window.supabaseAPI || !window.supabaseAPI.callAPI) {
            throw new Error('Supabase API chưa được khởi tạo. Vui lòng reload trang.');
        }

        console.log('Calling API: list_car_models');
        
        // Thêm timeout 10 giây
        const apiCall = window.callAPI({
            action: 'list_car_models'
        });
        
        const result = await withTimeout(
            apiCall,
            10000,
            'API call timeout sau 10 giây. Vui lòng kiểm tra kết nối mạng hoặc thử lại.'
        );

        console.log('API result:', result);

        if (!result) {
            throw new Error('API không trả về kết quả');
        }

        console.log('Checking result:', {
            success: result.success,
            hasData: !!result.data,
            isArray: Array.isArray(result.data),
            dataLength: result.data?.length,
            fullResult: result
        });

        if (result.success && result.data && Array.isArray(result.data)) {
            console.log('Rendering car models:', result.data.length, 'items');
            console.log('Data:', result.data);
            renderCarModelsList(result.data);
        } else {
            const errorMsg = result?.message || 'Không thể tải danh sách';
            console.error('API returned error or invalid data:', result);
            console.error('Result details:', {
                success: result?.success,
                data: result?.data,
                message: result?.message
            });
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="font-bold">Lỗi: ${escapeHtml(errorMsg)}</p>
                    <p class="text-sm mt-2 text-gray-600">Result: ${JSON.stringify(result)}</p>
                    <p class="text-sm mt-2">Vui lòng mở Console (F12) để xem chi tiết</p>
                    <button 
                        onclick="loadCarModelsList()" 
                        class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                    >
                        <i class="fa-solid fa-rotate mr-2"></i>Thử lại
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading car models:', error);
        const errorMsg = error.message || 'Không thể tải danh sách';
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">Lỗi: ${escapeHtml(errorMsg)}</p>
                <p class="text-sm mt-2 text-gray-600">Vui lòng mở Console (F12) để xem chi tiết</p>
                <button 
                    onclick="loadCarModelsList()" 
                    class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                >
                    <i class="fa-solid fa-rotate mr-2"></i>Thử lại
                </button>
            </div>
        `;
    }
}

// Render danh sách car models
function renderCarModelsList(carModels) {
    console.log('renderCarModelsList called with:', carModels);
    const container = document.getElementById('car-models-list');
    if (!container) {
        console.error('car-models-list container not found in renderCarModelsList');
        return;
    }

    console.log('Container found, carModels length:', carModels?.length);

    if (!carModels || !Array.isArray(carModels)) {
        console.error('carModels is not an array:', carModels);
        container.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i><p>Dữ liệu không hợp lệ</p></div>';
        return;
    }

    if (carModels.length === 0) {
        console.log('No car models to display');
        container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-2xl mb-2"></i><p>Chưa có dòng xe nào</p><p class="text-xs mt-2">Vui lòng thêm dòng xe mới</p></div>';
        return;
    }

    console.log('Rendering', carModels.length, 'car models');

    try {
        const html = carModels.map(model => {
            try {
                console.log('Rendering model:', model);
                if (!model.id) {
                    console.error('Model missing id:', model);
                    return '';
                }
                return `
        <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition" data-id="${model.id || ''}">
            <div class="flex items-center justify-between">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Tên dòng xe</label>
                        <input 
                            type="text" 
                            class="input mt-1 car-model-name" 
                            value="${escapeHtml(model.name)}" 
                            data-id="${model.id}"
                            onchange="handleUpdateCarModel(\`${model.id}\`, 'name', this.value)"
                        >
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Thứ tự hiển thị</label>
                        <input 
                            type="number" 
                            class="input mt-1 car-model-order" 
                            value="${model.display_order || 0}" 
                            min="0"
                            data-id="${model.id}"
                            onchange="handleUpdateCarModel(\`${model.id}\`, 'display_order', parseInt(this.value))"
                        >
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                class="car-model-active w-4 h-4 text-purple-600 rounded" 
                                ${model.is_active ? 'checked' : ''}
                                data-id="${model.id}"
                                onchange="handleUpdateCarModel(\`${model.id}\`, 'is_active', this.checked)"
                            >
                            <span class="text-sm font-medium">${model.is_active ? 'Đang sử dụng' : 'Tạm ngưng'}</span>
                        </label>
                    </div>
                </div>
                <div class="ml-4">
                    <button 
                        onclick="handleDeleteCarModel(\`${model.id}\`, \`${escapeHtml(model.name)}\`)" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold"
                    >
                        <i class="fa-solid fa-trash mr-2"></i>Xóa
                    </button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-400">
                ${model.created_by ? `Tạo bởi: ${escapeHtml(model.created_by)}` : ''}
                ${model.created_at ? ` • ${formatDate(model.created_at)}` : ''}
            </div>
        </div>
    `;
            } catch (modelError) {
                console.error('Error rendering model:', model, modelError);
                return `<div class="border border-red-200 rounded-lg p-4 bg-red-50 text-red-600">Lỗi render model: ${model?.name || 'Unknown'}</div>`;
            }
        }).filter(html => html).join('');

        console.log('HTML generated, length:', html.length);
        if (html.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-2xl mb-2"></i><p>Không có dữ liệu để hiển thị</p></div>';
            return;
        }
        container.innerHTML = html;
        console.log('Container innerHTML updated successfully');
    } catch (renderError) {
        console.error('Error rendering car models list:', renderError);
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                <p class="font-bold">Lỗi render: ${escapeHtml(renderError.message)}</p>
                <p class="text-sm mt-2">Vui lòng mở Console (F12) để xem chi tiết</p>
            </div>
        `;
    }
}

// Escape HTML để tránh XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString;
    }
}

// Handle create car model
async function handleCreateCarModel(event) {
    event.preventDefault();

    const nameInput = document.getElementById('new-car-model-name');
    const orderInput = document.getElementById('new-car-model-order');
    const activeInput = document.getElementById('new-car-model-active');
    const statusDiv = document.getElementById('create-car-model-status');

    if (!nameInput || !orderInput || !activeInput || !statusDiv) return;

    const name = nameInput.value.trim();
    if (!name) {
        statusDiv.className = 'text-sm text-red-500 mt-2';
        statusDiv.textContent = 'Vui lòng nhập tên dòng xe';
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang thêm...';
    }

    statusDiv.className = 'text-sm text-gray-500 mt-2';
    statusDiv.textContent = 'Đang xử lý...';

    try {
        const result = await window.callAPI({
            action: 'create_car_model',
            name: name,
            display_order: parseInt(orderInput.value) || 0,
            is_active: activeInput.checked
        });

        if (result.success) {
            statusDiv.className = 'text-sm text-green-500 mt-2';
            statusDiv.textContent = 'Đã thêm dòng xe thành công!';
            
            // Reset form
            nameInput.value = '';
            orderInput.value = '0';
            activeInput.checked = true;
            
            // Reload list
            setTimeout(() => {
                loadCarModelsList();
                statusDiv.textContent = '';
            }, 1000);
        } else {
            statusDiv.className = 'text-sm text-red-500 mt-2';
            statusDiv.textContent = 'Lỗi: ' + (result.message || 'Không thể thêm dòng xe');
        }
    } catch (error) {
        console.error('Error creating car model:', error);
        statusDiv.className = 'text-sm text-red-500 mt-2';
        statusDiv.textContent = 'Lỗi: ' + error.message;
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i>Thêm';
        }
    }
}

// Handle update car model
async function handleUpdateCarModel(id, field, value) {
    if (!id) return;

    try {
        const updateData = { id: id };
        updateData[field] = value;

        const result = await window.callAPI({
            action: 'update_car_model',
            ...updateData
        });

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('Đã cập nhật thành công', 'success');
            }
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể cập nhật'), 'danger');
            }
            // Reload để reset giá trị
            loadCarModelsList();
        }
    } catch (error) {
        console.error('Error updating car model:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
        // Reload để reset giá trị
        loadCarModelsList();
    }
}

// Handle delete car model
async function handleDeleteCarModel(id, name) {
    if (!id) return;

    if (!confirm(`Bạn có chắc chắn muốn xóa dòng xe "${name}"?\n\nLưu ý: Hành động này không thể hoàn tác!`)) {
        return;
    }

    try {
        const result = await window.callAPI({
            action: 'delete_car_model',
            id: id
        });

        if (result.success) {
            if (typeof window.showToast === 'function') {
                window.showToast('Đã xóa dòng xe thành công', 'success');
            }
            // Reload list
            loadCarModelsList();
        } else {
            if (typeof window.showToast === 'function') {
                window.showToast('Lỗi: ' + (result.message || 'Không thể xóa'), 'danger');
            }
        }
    } catch (error) {
        console.error('Error deleting car model:', error);
        if (typeof window.showToast === 'function') {
            window.showToast('Lỗi: ' + error.message, 'danger');
        }
    }
}

// Initialize when tab is shown
if (typeof window !== 'undefined') {
    // Load immediately if tab is already active
    const checkAndLoad = () => {
        const carModelsTab = document.getElementById('tab-car-models');
        if (carModelsTab && carModelsTab.classList.contains('active')) {
            console.log('Car models tab is active, loading data...');
            loadCarModelsList();
        }
    };

    // Try to load on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkAndLoad, 500); // Wait a bit for components to load
        });
    } else {
        setTimeout(checkAndLoad, 500);
    }

    // Also listen for tab switches
    window.addEventListener('load', () => {
        // Auto load when tab is shown
        const observer = new MutationObserver((mutations) => {
            const carModelsTab = document.getElementById('tab-car-models');
            if (carModelsTab && carModelsTab.classList.contains('active')) {
                console.log('Car models tab became active, loading data...');
                loadCarModelsList();
            }
        });
        
        const container = document.querySelector('.tab-content');
        if (container && container.parentElement) {
            observer.observe(container.parentElement, { 
                attributes: true, 
                attributeFilter: ['class'],
                subtree: true 
            });
        }

        // Also check immediately
        setTimeout(checkAndLoad, 1000);
    });

    // Expose function globally for manual call
    window.loadCarModelsList = loadCarModelsList;
}
</script>

