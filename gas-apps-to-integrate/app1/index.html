<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>

  /* === BI·∫æN M√ÄU S·∫ÆC & THI·∫æT K·∫æ CHUNG === */
:root {
  --primary-color: #0052D4; --secondary-color: #43A0F7;
  --success-color: #28a745; --success-hover: #218838; --success-bg: #e9f7ef;
  --danger-color: #dc3545; --warning-color: #ffc107; --warning-bg: #fff8e1; 
  --title-color: #003366; --bg-color: #f7f8fc; --card-bg-color: #ffffff; 
  --text-color: #333; --subtle-text-color: #777; --border-color: #e9ecef;
  --shadow: 0 4px 6px rgba(0,0,0,0.04); --shadow-lg: 0 10px 25px rgba(0,0,0,0.08);
  --radius: 12px; --transition: all 0.3s ease;
}

/* === CSS T·ªîNG TH·ªÇ === */
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Be Vietnam Pro', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
}
.main-wrapper { max-width: 1400px; margin: 0 auto; }
/* CSS cho n√∫t X√≥a */
.btn-danger {
  background: #dc3545; /* M√†u ƒë·ªè */
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-danger:hover {
  background: #c82333;
  box-shadow: var(--shadow);
}
/* === HEADER & TABS === */
.header { background: var(--card-bg-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
.header h1 { font-size: 1.6em; color: var(--primary-color); font-weight: 700; }
#adminLoginIcon { cursor: pointer; padding: 10px; border-radius: 50%; transition: var(--transition); background-color: transparent; border: none; }
#adminLoginIcon svg { width: 24px; height: 24px; vertical-align: middle; color: var(--primary-color); }
.tab-bar { background-color: var(--card-bg-color); padding: 5px 20px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; position: sticky; top: 0; z-index: 999; flex-wrap: wrap; }
.tab-link { background: none; border: none; padding: 12px 20px; cursor: pointer; font-size: 1em; font-weight: 500; color: var(--subtle-text-color); border-radius: 8px; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
.tab-link:hover { background-color: #f0f0f0; color: var(--primary-color); }
.tab-link.active { background-color: var(--primary-color); color: white; }
.tab-link svg { width: 18px; height: 18px; }
.tab-content { display: none; padding: 25px; }
.tab-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }

/* === TH·∫∫ CARD & TI√äU ƒê·ªÄ === */
.card { background: var(--card-bg-color); padding: 30px 40px; border-radius: var(--radius); box-shadow: var(--shadow); }
h2, h3, h4 { color: var(--title-color); }
h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 12px; margin-bottom: 25px; font-weight: 700; font-size: 1.5em; }

/* === C√ÅC TH√ÄNH PH·∫¶N FORM CHUNG === */
label { font-weight: 500; margin-bottom: 8px; font-size: 0.9em; color: var(--subtle-text-color); display: block; }
.form-group { position: relative; margin-bottom: 15px; }
input, select, textarea {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 1em;
  transition: var(--transition);
  background-color: #fdfdfd;
  font-family: 'Be Vietnam Pro', sans-serif;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 82, 212, 0.15);
}
button, input[type="button"] {
  color: white; cursor: pointer; border: none; font-weight: bold;
  margin-top: 20px; border-radius: 8px; padding: 14px 20px;
  font-size: 1em; transition: var(--transition);
  display: inline-flex; align-items: center; justify-content: center; gap: 10px;
}
button:hover, input[type="button"]:hover { box-shadow: var(--shadow-lg); transform: translateY(-3px); }
button:disabled, input[type="button"]:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
.btn-secondary { background: var(--subtle-text-color); }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 25px; }
.form-group.full-width { grid-column: 1 / -1; }
.order-list-container { display: flex; flex-direction: column; gap: 15px; }

/* === CSS RI√äNG CHO FORM T·∫†O H·ª¢P ƒê·ªíNG === */
#contractForm { font-family: 'Poppins', sans-serif; }
#contractForm h1 {
  font-family: 'Be Vietnam Pro', sans-serif;
  color: var(--primary-color);
  font-weight: 700;
  margin-bottom: 40px;
  font-size: 1.8rem;
}
.form-section { margin-bottom: 40px; }
.form-section-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 25px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}
#thanh_tien { background-color: var(--bg-color); font-weight: bold; color: var(--success-color); }
.form-actions { text-align: center; margin-top: 40px; padding-top: 25px; border-top: 1px solid var(--border-color); }
.form-actions input[type="button"] {
  max-width: 300px;
  width: 100%;
  background-color: var(--success-color);
  font-size: 1.1rem;
}
.form-actions input[type="button"]:hover { background-color: var(--success-hover); }
#downloadLink { display: none; text-align: center; margin-top: 20px; padding: 12px; background-color: var(--primary-color); color: white; text-decoration: none; font-weight: 500; border-radius: 8px; }

/* === T·ªêI ∆ØU CSS CHO CH√çNH S√ÅCH B√ÅN H√ÄNG === */
.policy-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 12px;
  background-color: var(--bg-color);
  padding: 20px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
}
.policy-item {
  display: flex;
  align-items: center;
  padding: 8px;
  border-radius: 8px;
  transition: background-color 0.2s ease-in-out;
}
.policy-item:hover {
  background-color: #eaf2ff;
}
.policy-item input[type="checkbox"] {
  display: none; /* ·∫®n checkbox g·ªëc */
}
.policy-item label {
  position: relative;
  padding-left: 30px;
  margin: 0;
  cursor: pointer;
  font-weight: 500;
  color: var(--text-color);
  flex-grow: 1;
}
/* T·∫°o checkbox t√πy ch·ªânh - h√¨nh vu√¥ng */
.policy-item label::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  border: 2px solid var(--subtle-text-color);
  border-radius: 4px;
  background: #fff;
  transition: var(--transition);
}
/* T·∫°o d·∫•u tick b√™n trong */
.policy-item label::after {
  content: '‚úî';
  position: absolute;
  left: 3px;
  top: 50%;
  transform: translateY(-50%) scale(0);
  font-size: 14px;
  font-weight: bold;
  color: white;
  transition: var(--transition);
}
/* Style khi checkbox ƒë∆∞·ª£c ch·ªçn */
.policy-item input[type="checkbox"]:checked + label::before {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
}
.policy-item input[type="checkbox"]:checked + label::after {
  transform: translateY(-50%) scale(1);
}

/* === T·ªêI ∆ØU CSS CHO PH·∫¶N THANH TO√ÅN === */
.payment-method-container {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 20px;
  background-color: var(--bg-color);
  padding: 15px 20px;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
}
.payment-method-container > .payment-label {
  font-weight: 600;
  margin: 0;
  color: var(--title-color);
}
.radio-option {
  display: flex;
  align-items: center;
  cursor: pointer;
}
.radio-option input[type="radio"] {
  display: none; /* ·∫®n radio g·ªëc */
}
.radio-option label {
  position: relative;
  padding-left: 30px;
  margin: 0;
  font-weight: 500;
  color: var(--text-color);
}
/* V√≤ng tr√≤n ngo√†i c·ªßa radio */
.radio-option label::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  border: 2px solid var(--subtle-text-color);
  border-radius: 50%;
  background: #fff;
  transition: var(--transition);
}
/* D·∫•u ch·∫•m b√™n trong c·ªßa radio */
.radio-option label::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 50%;
  transform: translateY(-50%) scale(0);
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--primary-color);
  transition: var(--transition);
}
/* Style khi radio ƒë∆∞·ª£c ch·ªçn */
.radio-option input[type="radio"]:checked + label::before {
  border-color: var(--primary-color);
}
.radio-option input[type="radio"]:checked + label::after {
  transform: translateY(-50%) scale(1);
}

#tra_thang_section, #tra_gop_section {
  margin-top: 15px;
  background-color: var(--bg-color);
  padding: 20px;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
}

/* === C√ÅC TH√ÄNH PH·∫¶N KH√ÅC (SPINNER, TOAST, MODAL) === */
.spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
.loader-inline { display: none; vertical-align: middle; margin-left: 10px; font-size: 0.9em; font-weight: 500; color: var(--primary-color); }
.modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
.modal-content { background-color: var(--card-bg-color); margin: 10% auto; border-radius: var(--radius); width: 90%; max-width: 550px; box-shadow: var(--shadow-lg); overflow: hidden; animation: slideIn 0.4s; }
.modal-header { padding: 18px 25px; background: var(--primary-color); color: white; }
.modal-body { padding: 25px; }
.close-button { color: white; float: right; font-size: 30px; font-weight: bold; cursor: pointer; }
.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 12px; }
.detail-grid p { margin: 0; padding: 8px; border-radius: 6px; background-color: #f7f8fc; border: 1px solid var(--border-color); }
.detail-grid strong { color: var(--primary-color); min-width: 120px; display: inline-block; }
/* === CSS CHO TH√îNG B√ÅO (TOAST) - ƒê√É S·ª¨A M√ÄU CH·ªÆ === */
.toast-container { 
  position: fixed; 
  bottom: 20px; 
  right: 20px; 
  z-index: 9999; 
}
.toast { 
  padding: 15px 20px; 
  border-radius: 8px; 
  box-shadow: var(--shadow-lg); 
  margin-bottom: 10px; 
  animation: slideInUp 0.5s, fadeOut 0.5s 4.5s forwards; 
  font-weight: 500;
  border: 1px solid transparent;
}

/* N·ªÅn ƒë·ªè, ch·ªØ tr·∫Øng (Gi·ªØ nguy√™n) */
.toast.danger { 
  background-color: var(--danger-color); 
  color: white;
  border-color: #d62535;
}

/* N·ªÅn xanh l√° nh·∫°t, ch·ªØ ƒëen (Thay ƒë·ªïi) */
.toast.success { 
  background-color: #d4edda;
  color: #155724; 
  border-color: #c3e6cb;
}

/* N·ªÅn v√†ng nh·∫°t, ch·ªØ ƒëen (Thay ƒë·ªïi) */
.toast.warning {
  background-color: #fff3cd;
  color: #856404;
  border-color: #ffeeba;
}

/* N·ªÅn xanh d∆∞∆°ng nh·∫°t, ch·ªØ ƒëen (Thay ƒë·ªïi) */
.toast.info {
   background-color: #d1ecf1;
   color: #0c5460;
   border-color: #bee5eb;
}

/* === CSS M·ªöI CHO B·ªò L·ªåC V√Ä DANH S√ÅCH ƒê∆†N H√ÄNG === */

.filter-container label {
  font-weight: 600;
  margin-bottom: 0;
  white-space: nowrap;
}
.filter-container select {
  background-color: white;
}
/* C·∫≠p nh·∫≠t CSS cho b·ªô l·ªçc */
.filter-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  max-width: 100%;
  align-items: flex-end;
}
.filter-item {
  display: flex;
  flex-direction: column;
}
.filter-item.search-item input {
  padding: 12px;
}
.order-list-table {
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  overflow: hidden;
}

.order-list-header {
  display: grid;
  grid-template-columns: 2.5fr 2fr 2fr 1.5fr;
  background-color: var(--bg-color);
  font-weight: 600;
  color: var(--title-color);
  border-bottom: 1px solid var(--border-color);
}
.header-cell {
  padding: 12px 15px;
}

/* ƒê·ªïi t√™n .order-card th√†nh .order-row ƒë·ªÉ ph√π h·ª£p giao di·ªán m·ªõi */
.order-row {
  display: grid;
  grid-template-columns: 2.5fr 2fr 2fr 1.5fr;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
  transition: var(--transition);
}
.order-row:last-child {
  border-bottom: none;
}
.order-row:hover {
  background-color: #fafdff;
  transform: none; /* B·ªè hi·ªáu ·ª©ng translateY */
  box-shadow: none; /* B·ªè hi·ªáu ·ª©ng ƒë·ªï b√≥ng */
}

.order-cell {
  padding: 15px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.order-cell .name { font-weight: 500; font-size: 1.05em; }
.order-cell .sub-text { color: var(--subtle-text-color); font-size: 0.9em; }

.order-status .badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 700;
}
.badge.created { background-color: var(--success-bg); color: var(--success-color); }
.badge.pending { background-color: var(--warning-bg); color: var(--warning-color); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* === CSS M·ªöI CHO B·∫¢NG QU·∫¢N L√ù ADMIN === */
.admin-table-header, .admin-row {
  display: grid;
  grid-template-columns: 2fr 2fr 1.5fr 2fr 1.5fr; /* Chia 5 c·ªôt */
  align-items: center;
  border-bottom: 1px solid var(--border-color);
}
.admin-table-header {
  background-color: var(--bg-color);
  font-weight: 600;
  color: var(--title-color);
  padding: 8px 15px;
}
.admin-row {
  transition: background-color 0.2s;
}
.admin-row:hover {
  background-color: #fafdff;
}
.admin-row.edit-mode {
  background-color: var(--warning-bg); /* N·ªÅn v√†ng khi ƒëang s·ª≠a */
}
.admin-cell {
  padding: 10px 15px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.admin-cell .cell-text {
  display: block; /* M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã text */
  padding: 6px 0;
}
.admin-cell .cell-input {
  display: none; /* M·∫∑c ƒë·ªãnh ·∫©n input */
  width: 100%;
  padding: 6px;
  font-size: 0.9em;
  border-radius: 4px;
}
.edit-mode .cell-text {
  display: none; /* ·∫®n text khi ƒëang s·ª≠a */
}
.edit-mode .cell-input {
  display: block; /* Hi·ªán input khi ƒëang s·ª≠a */
}

.admin-actions button {
  margin: 2px;
  padding: 6px 10px;
  font-size: 0.85em;
}
.edit-buttons, .save-buttons {
  display: flex;
  gap: 5px;
}
.save-buttons {
  display: none; /* M·∫∑c ƒë·ªãnh ·∫©n n√∫t L∆∞u/H·ªßy */
}
.edit-mode .edit-buttons {
  display: none; /* ·∫®n n√∫t S·ª≠a/Xem khi ƒëang s·ª≠a */
}
.edit-mode .save-buttons {
  display: flex; /* Hi·ªán n√∫t L∆∞u/H·ªßy khi ƒëang s·ª≠a */
}
  </style>
</head>
<body>
<div class="main-wrapper">
  <div class="header">
    <h1>H·ªá th·ªëng nh·∫≠p li·ªáu ƒë∆°n h√†ng v√† t·∫°o bi·ªÉu m·∫´u</h1>
    <button id="adminLoginIcon" title="ƒêƒÉng nh·∫≠p Admin">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>
  </div>
  <div class="tab-bar">
    <button class="tab-link" onclick="openTab(event, 'form')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
      <span>Nh·∫≠p li·ªáu ƒê∆°n h√†ng</span>
    </button>
    <button class="tab-link" onclick="openTab(event, 'list')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12M8.25 17.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
      <span>Danh s√°ch ƒê∆°n h√†ng</span>
    </button>
    <button class="tab-link" onclick="openTab(event, 'contract')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
      <span>T·∫°o H·ª£p ƒë·ªìng Mua b√°n</span>
    </button>

    <button class="tab-link" onclick="openTab(event, 'disbursement')">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0h.75A.75.75 0 005.25 6v.75m0 0v.75a.75.75 0 00.75.75h.75M6 12h.75a.75.75 0 00.75-.75V10.5a.75.75 0 00-.75-.75H6v2.25zm0 0h3.75m-3.75 0h.75a.75.75 0 01.75.75v2.25a.75.75 0 01-.75.75H6v-3z" /></svg>
      <span>ƒê·ªÅ ngh·ªã Gi·∫£i ng√¢n</span>
    </button>
    <button id="adminTabBtn" class="tab-link" onclick="openTab(event, 'admin')" style="display: none;">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.28-.1c.34-.121.68-.121 1.02 0l.28.1c.55.219 1.02.684 1.11 1.226l.09.542-.09.542c-.09-.542-.56-1.007-1.11-1.226l-.28-.1c-.34-.121-.68-.121-1.02 0l-.28.1c-.55.219-1.02.684-1.11 1.226l-.09.542.09.542zM8.25 5.25h7.5M8.25 5.25c0 .363-.03.722-.085 1.076a.75.75 0 01-1.085.603l-.283-.176a.75.75 0 00-.776 0l-.283.176a.75.75 0 01-1.085-.603A49.01 49.01 0 015.25 5.25m0 0c0 .363-.03.722-.085 1.076a.75.75 0 01-1.085.603l-.283-.176a.75.75 0 00-.776 0l-.283.176a.75.75 0 01-1.085-.603A49.01 49.01 0 012.25 5.25m13.5 0c0 .363.03.722.085 1.076a.75.75 0 001.085.603l.283-.176a.75.75 0 01.776 0l.283.176a.75.75 0 001.085-.603A49.01 49.01 0 0021.75 5.25m-16.5 0c.23.638.493 1.26.794 1.854a.75.75 0 00.941.44l.283-.109a.75.75 0 01.941 0l.283.109a.75.75 0 00.941-.44c.301-.594.564-1.216.794-1.854M12 9a3 3 0 100 6 3 3 0 000-6z" /></svg>
      <span>Qu·∫£n l√Ω Admin</span>
    </button>
  </div>
  <div id="formContent" class="tab-content">
    <div class="card">
      <h2>Th√¥ng tin kh√°ch h√†ng & ƒê∆°n h√†ng</h2>
      <form id="customerForm">
        <div class="form-grid">
          <div class="form-group"><label>T√™n TVBH</label><input name="tvbh" required></div>
          <div class="form-group"><label>T√™n Kh√°ch h√†ng</label><input name="khach" required></div>
          <div class="form-group">
              <label>SƒêT</label>
              <input 
                  name="sdt" 
                  required 
                  type="tel" 
                  pattern="\d{10}" 
                  title="Vui l√≤ng nh·∫≠p ƒë√∫ng 10 ch·ªØ s·ªë."
              >
          </div>
          <div class="form-group">
              <label>CCCD</label>
              <input 
                  name="cccd" 
                  required 
                  type="text" 
                  pattern="\d{12}" 
                  title="Vui l√≤ng nh·∫≠p ƒë√∫ng 12 ch·ªØ s·ªë."
              >
          </div>
          <div class="form-group"><label>Ng√†y c·∫•p</label><input type="date" name="ngaycap" required></div>
          <div class="form-group"><label>N∆°i c·∫•p</label><input name="noicap" required></div>
          <div class="form-group"><label>Lo·∫°i xe</label><input name="loaixe" required></div>
          <div class="form-group"><label>Phi√™n b·∫£n</label><input name="phienban" required></div>
          <div class="form-group"><label>M√†u xe</label><input name="mauxe" required></div>
          <div class="form-group">
            <label>H√¨nh th·ª©c thanh to√°n</label>
            <select name="hinhthucthanhtoan" required><option value="" disabled selected>-- Ch·ªçn --</option><option value="Tr·∫£ th·∫≥ng">Tr·∫£ th·∫≥ng</option><option value="Tr·∫£ g√≥p">Tr·∫£ g√≥p</option></select>
          </div>
          <div class="form-group full-width"><label>Email kh√°ch</label><input type="email" name="email" required></div>
          <div class="form-group full-width"><label>ƒê·ªãa ch·ªâ</label><input name="diachi" required></div>
          <div class="form-group full-width">
            <label style="color: red; font-weight: bold;">File ƒë√≠nh k√®m bao g·ªìm file h√¨nh ch·ª•p VNeID v√† U·ª∑ Nhi·ªám Chi C·ªçc (h√¨nh ch·ª•p chuy·ªÉn kho·∫£n c·ªçc) | Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß ƒë·ªÉ admin l√™n ƒë∆°n</label>
            <input type="file" id="files" multiple>
          </div>
        </div>
        <button type="submit" class="btn-primary">L∆∞u Th√¥ng Tin</button>
      </form>
    </div>
  </div>

  <div id="contractContent" class="tab-content">
      <form id="contractForm">
        <div class="card">
        <h2>NH·∫¨P TH√îNG TIN H·ª¢P ƒê·ªíNG</h2>
        <div class="form-section">
          <h3 class="form-section-title">Th√¥ng tin H·ª£p ƒë·ªìng & S·∫£n ph·∫©m</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="so_hop_dong">S·ªë h·ª£p ƒë·ªìng (*)</label>
              <input type="text" id="so_hop_dong" name="so_hop_dong" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng r·ªìi nh·∫•n Tab">
              <span id="lookupLoader" class="loader-inline">üîç ƒêang t√¨m...</span>
            </div>
            <div class="form-group"> <label for="ngay_ky">Ng√†y k√Ω</label> <input type="date" id="ngay_ky" name="ngay_ky"> </div>
            <div class="form-group"> <label for="loai_xe">Lo·∫°i xe</label> <input type="text" id="loai_xe" name="loai_xe"> </div>
            <div class="form-group"> <label for="phien_ban">Phi√™n B·∫£n</label> <input type="text" id="phien_ban" name="phien_ban"> </div>
            <div class="form-group"> <label for="mau_xe">M√†u xe</label> <input type="text" id="mau_xe" name="mau_xe"> </div>
            <div class="form-group"> <label for="so_luong">S·ªë l∆∞·ª£ng</label> <input type="number" id="so_luong" name="so_luong" oninput="updateTotal()" value="1"> </div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Th√¥ng tin Kh√°ch h√†ng (S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn)</h3>
          <div class="form-grid">
            <div class="form-group"><label for="khach_hang">Kh√°ch h√†ng (*)</label><input type="text" id="khach_hang" name="khach_hang"></div>
            <div class="form-group"><label for="so_cccd">S·ªë CCCD (*)</label><input type="text" id="so_cccd" name="so_cccd"></div>
            <div class="form-group"><label for="sdt">S·ªë ƒëi·ªán tho·∫°i</label><input type="text" id="sdt" name="sdt"></div>
            <div class="form-group"><label for="ngay_cap">Ng√†y c·∫•p</label><input type="date" id="ngay_cap" name="ngay_cap"></div>
            <div class="form-group"><label for="noi_cap">N∆°i c·∫•p</label><input type="text" id="noi_cap" name="noi_cap"></div>
            <div class="form-group"><label for="dia_chi">ƒê·ªãa ch·ªâ</label><input type="text" id="dia_chi" name="dia_chi"></div>
            <div class="form-group"><label for="email">Email</label><input type="email" id="email" name="email"></div>
            <div class="form-group"><label for="ma_so_thue">M√£ s·ªë thu·∫ø</label><input type="text" id="ma_so_thue" name="ma_so_thue"></div>
            <div class="form-group"><label for="nguoi_dai_dien">Ng∆∞·ªùi ƒë·∫°i di·ªán</label><input type="text" id="nguoi_dai_dien" name="nguoi_dai_dien"></div>
            <div class="form-group"><label for="chuc_vu">Ch·ª©c v·ª•</label><input type="text" id="chuc_vu" name="chuc_vu"></div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Ch√≠nh s√°ch b√°n h√†ng</h3>
        <div class="form-group full-width">
            <label>Ch√≠nh s√°ch b√°n h√†ng (ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu)</label>
            <div class="policy-container">
                <div class="policy-item">
                    <input type="checkbox" id="policy-1" name="chinh_sach_ban_hang" value="Ch√≠nh s√°ch M√ÉNH LI·ªÜT TINH TH·∫¶N VI·ªÜT NAM - V√å T∆Ø∆†NG LAI XANH L·∫¶N 3: t·∫∑ng 4% tr√™n gi√° MSRP gi·∫£m gi√° b·∫±ng ti·ªÅn m·∫∑t √°p d·ª•ng t·ª´ 22/05/2025 ƒë·∫øn 31/12/2025.">
                    <label for="policy-1">CSBH MLTTVN 3 gi·∫£m 4%</label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-2" name="chinh_sach_ban_hang" value="CSBH T·∫∑ng 2 nƒÉm b·∫£o hi·ªÉm ∆∞u ƒë√£i b·∫±ng ti·ªÅn tr·ªã gi√° 12.000.000 VNƒê/xe cho xe VF5 Plus/HerioGreen ƒë·ªëi v·ªõi kh√°ch h√†ng xu·∫•t ho√° ƒë∆°n t·ª´ 15/08/2025 - 31/12/2025.">
                    <label for="policy-2">Quy ƒë·ªïi ti·ªÅn m·∫∑t VF5, Herio bi·ªÉn tr·∫Øng</label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-3" name="chinh_sach_ban_hang" value="CSBH T·∫∑ng 2 nƒÉm b·∫£o hi·ªÉm ∆∞u ƒë√£i b·∫±ng ti·ªÅn tr·ªã gi√° 6.500.000 VNƒê/xe cho xe VF3 ƒë·ªëi v·ªõi kh√°ch h√†ng xu·∫•t ho√° ƒë∆°n t·ª´ 20/08/2025 - 31/12/2025.">
                    <label for="policy-3">Quy ƒë·ªïi ti·ªÅn m·∫∑t VF3</label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-4" name="chinh_sach_ban_hang" value="CSBH ∆∞u ƒë√£i b·∫±ng ti·ªÅn tr·ªã gi√° 12.000.000 VNƒê/xe cho xe VF5 Plus/HerioGreen v·ªõi m·ª•c ƒë√≠ch kinh doanh v·∫≠n t·∫£i,mua xe v√† xu·∫•t ho√° ƒë∆°n t·ª´ 15/08/2025 - 31/12/2025.">
                    <label for="policy-4">Quy ƒë·ªïi TM VF5/Herio Green bi·ªÉn v√†ng</label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-5" name="chinh_sach_ban_hang" value="CSBH ∆∞u ƒë√£i mi·ªÖn ph√≠ m√†u n√¢ng cao VF3, VF5 tr·ªã gi√° 8.000.000 VNƒê ƒë·ªëi v·ªõi xe xu·∫•t ho√° ƒë∆°n t·ª´ 1/10/2025 ƒë·∫øn 31/12/2025.">
                    <label for="policy-5">Mi·ªÖn ph√≠ m√†u n√¢ng cao VF3 - VF5 </label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-6" name="chinh_sach_ban_hang" value="CSBH ∆∞u ƒë√£i gi·∫£m 50.000.000 VNƒê cho VF7 Plus xu·∫•t ho√° ƒë∆°n t·ª´ 3/10/2025. ">
                    <label for="policy-6">Gi·∫£m 50tr cho VF7 Plus</label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-7" name="chinh_sach_ban_hang" value="CSBH Kh√°ch h√†ng mua xe VF8 ho·∫∑c VF9 trong th·ªùi gian √°p d·ª•ng ch∆∞∆°ng tr√¨nh s·∫Ω nh·∫≠n ƒë∆∞·ª£c voucher ngh·ªâ d∆∞·ª°ng Vinpearl, c√≥ th·ªÉ quy ƒë·ªïi ti·ªÅn m·∫∑t v·ªõi gi√° tr·ªã 50.000.000 VNƒê √°p d·ª•ng t·ª´ 1/11/2025 ƒë·∫øn 31/12/2025 theo ng√†y xu·∫•t ho√° ƒë∆°n ">
                    <label for="policy-7">CSBH VF8, VF9 VC VinPearl 50tr quy ƒë·ªïi TM </label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-8" name="chinh_sach_ban_hang" value="Ch√≠nh s√°ch ∆∞u ƒë√£i l√£i su·∫•t theo ch∆∞∆°ng tr√¨nh chuy·ªÉn ƒë·ªïi xanh √°p d·ª•ng t·ª´ 30/07/2025 ƒë·∫øn 31/12/2025.">
                    <label for="policy-8">CSBH h·ªï tr·ª£ l√£i su·∫•t CƒêX </label>
                </div>
                <div class="policy-item">
                    <input type="checkbox" id="policy-9" name="chinh_sach_ban_hang" value="Ch√≠nh s√°ch ∆∞u ƒë√£i chi·∫øt kh·∫•u th√™m 3% tr√™n gi√° MSRP d√†nh cho chi·∫øn sƒ© thu·ªôc Qu√¢n ƒë·ªôi nh√¢n d√¢n Vi·ªát Nam v√† C√¥ng an nh√¢n d√¢n Vi·ªát Nam ƒëang c√¥ng t√°c trong bi√™n ch·∫ø ch√≠nh th·ª©c t·ª´ 14/10/2025 ƒë·∫øn 31/12/2025.">
                    <label for="policy-9">CSBH C√¥ng an v√† Qu√¢n ƒê·ªôi gi·∫£m 3% </label>
                </div>
                </div>
        </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Th√¥ng tin Thanh to√°n</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="don_gia">ƒê∆°n gi√°</label>
              <input type="text" id="don_gia" name="don_gia" oninput="formatCurrencyInput(this); updateTotal(); calculatePaymentInstallments();">
            </div>
            <div class="form-group">
              <label for="tien_coc">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc</label>
              <input type="text" id="tien_coc" name="tien_coc" oninput="formatCurrencyInput(this); calculatePaymentInstallments();">
            </div>
            <div class="form-group">
              <label for="thanh_tien">Th√†nh ti·ªÅn (t·ª± ƒë·ªông)</label>
              <input type="text" id="thanh_tien" name="thanh_tien" readonly style="background-color: var(--bg-color); font-weight: bold; color: var(--success-color);">
            </div>
            
            <div class="form-group full-width">
                <div class="payment-method-container">
                    <label class="payment-label">H√¨nh th·ª©c thanh to√°n:</label>
                    <div class="radio-option">
                      <input type="radio" id="tra_thang" name="hinh_thuc_thanh_toan" value="tra_thang" onchange="togglePaymentMethod(); calculatePaymentInstallments();">
                      <label for="tra_thang">Tr·∫£ th·∫≥ng</label>
                    </div>
                    <div class="radio-option">
                      <input type="radio" id="tra_gop" name="hinh_thuc_thanh_toan" value="tra_gop" onchange="togglePaymentMethod(); calculatePaymentInstallments();">
                      <label for="tra_gop">Tr·∫£ g√≥p</label>
                    </div>
                </div>
            </div>

            <div id="tra_thang_section" style="display:none;">
                <label for="tien_dot_2_TT">Ti·ªÅn ƒë·ª£t 2 tr·∫£ th·∫≥ng (t·ª± ƒë·ªông):</label>
                <input type="text" id="tien_dot_2_TT" name="tien_dot_2_TT" readonly style="background-color: var(--bg-color);">
            </div>

            <div id="tra_gop_section" style="display:none;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tien_dot_2_TG">Ti·ªÅn ƒë·ª£t 2 tr·∫£ g√≥p:</label>
                        <input type="text" id="tien_dot_2_TG" name="tien_dot_2_TG" oninput="formatCurrencyInput(this); calculatePaymentInstallments();">
                    </div>
                    <div class="form-group">
                        <label for="tien_dot_3">Ti·ªÅn ƒë·ª£t 3 tr·∫£ g√≥p (t·ª± ƒë·ªông):</label>
                        <input type="text" id="tien_dot_3" name="tien_dot_3" readonly style="background-color: var(--bg-color);">
                    </div>
                </div>
            </div>
          </div>
        </div>
        <div class="form-actions">
            <input type="button" id="submitContractButton" value="T·∫°o h·ª£p ƒë·ªìng" onclick="submitContractForm()">
            <span id="contractLoader" class="loader-inline">‚è≥ ƒêang x·ª≠ l√Ω...</span>
            <a id="downloadLink" href="#" target="_blank">üìÑ T·∫£i h·ª£p ƒë·ªìng</a>
        </div>
        </div>
      </form>
  </div>
  <div id="disbursementContent" class="tab-content">
  <div class="card">
    <form id="disbursementForm">
      <h2>T·∫†O ƒê·ªÄ NGH·ªä GI·∫¢I NG√ÇN</h2>
      <div class="form-section">
        <h3 class="form-section-title">1. T√¨m th√¥ng tin theo M√£ ƒë∆°n h√†ng</h3>
        <div class="form-grid" style="grid-template-columns: 2fr 1fr; align-items: flex-end;">
            <div class="form-group">
              <label for="so_hop_dong_lookup">Nh·∫≠p M√£ ƒë∆°n h√†ng</label>
              <input type="text" id="so_hop_dong_lookup" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng nh·∫•n T√¨m...">
            </div>
            <div class="form-group">
              <input type="button" class="btn-primary" value="T√¨m th√¥ng tin" onclick="findContractForDisbursement()">
            </div>
        </div>
      </div>
      <div id="disbursementDetails" style="display: none;">
        <div class="form-section">
          <h3 class="form-section-title">2. Th√¥ng tin gi·∫£i ng√¢n</h3>
          <div class="form-grid">
          <div class="form-group"> <label>T√™n kh√°ch h√†ng</label> <input type="text" id="dngn_ten_khach_hang" readonly> </div>
          <div class="form-group"> <label>S·ªë h·ª£p ƒë·ªìng</label> <input type="text" id="dngn_so_hop_dong" readonly> </div>
          <div class="form-group"> <label>Lo·∫°i xe</label> <input type="text" id="dngn_loai_xe" readonly> </div>
          <div class="form-group"> <label for="dngn_ngay_captbcv">Ng√†y c·∫•p TBCV (*)</label> <input type="date" id="dngn_ngay_captbcv"> </div>
          <div class="form-group">
            <label for="dngn_ten_ngan_hang">K√≠nh g·ª≠i Ng√¢n h√†ng (*)</label>
            <select id="dngn_ten_ngan_hang">
                <option value="" disabled selected>-- Ch·ªçn ng√¢n h√†ng --</option>
                <option value="Ng√¢n h√†ng TMCP Ngo·∫°i th∆∞∆°ng Vi·ªát Nam (Vietcombank)">Vietcombank</option>
                <option value="Ng√¢n h√†ng TMCP K·ªπ Th∆∞∆°ng Vi·ªát Nam CN Ki√™n Giang(Techcombank)">Techcombank KG</option>
                <option value="Ng√¢n h√†ng TMCP Vi·ªát Nam Th·ªãnh V∆∞·ª£ng CN Ki√™n Giang(VPBank)">VPBank KG</option>
                <option value="Ng√¢n h√†ng TMCP Vi·ªát Nam Th·ªãnh V∆∞·ª£ng CN Ph√∫ Qu·ªëc (VPBank)">VPBank Ph√∫ Qu·ªëc</option>
                <option value="Ng√¢n h√†ng TMCP S√†i G√≤n Th∆∞∆°ng T√≠n CN Ki√™n Giang(Sacombank)">Sacombank KG</option>
                <option value="Ng√¢n h√†ng TMCP Ti√™n Phong CN Ki√™n Giang(TPBank)">TPBank KG</option>
                <option value="Ng√¢n h√†ng TMCP Qu√¢n ƒê·ªôi CN Ki√™n Giang(MBBank)">MBBank KG</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dngn_tai_khoan_thu_huong">T√†i kho·∫£n th·ª• h∆∞·ªüng (*)</label>
            <select id="dngn_tai_khoan_thu_huong">
              <option value="" disabled selected>-- Ch·ªçn t√†i kho·∫£n --</option>
              <option value="0848563333 Ng√¢n h√†ng TMCP S√†i G√≤n Th∆∞∆°ng T√≠n (Sacombank) - Chi nh√°nh Ki√™n Giang">0848563333 - Sacombank Ki√™n Giang</option>
              <option value="0822442222 Ng√¢n h√†ng TMCP Vi·ªát Nam Th·ªãnh V∆∞·ª£ng (VPBank) - Chi nh√°nh Ki√™n Giang">0822442222 - VPBank Ki√™n Giang</option>
              <option value="848563333 Ng√¢n h√†ng TMCP Qu√¢n ƒê·ªôi (MBBank) - Chi nh√°nh Ki√™n Giang">848563333 - MBBank Ki√™n Giang</option>


            </select>
          </div>
          <div class="form-group">
            <label for="dngn_so_tien_doi_ung">S·ªë ti·ªÅn ƒë·ªëi ·ª©ng (*)</label>
            <input type="text" id="dngn_so_tien_doi_ung" oninput="formatCurrencyInput(this)">
          </div>
          <div class="form-group">
            <label for="dngn_so_tien_giai_ngan">S·ªë ti·ªÅn gi·∫£i ng√¢n (*)</label>
            <input type="text" id="dngn_so_tien_giai_ngan" oninput="formatCurrencyInput(this)">
          </div>
        </div>
        </div>
        <div class="form-actions">
          <input type="button" id="submitDisbursementButton" value="T·∫°o ƒê·ªÅ ngh·ªã" onclick="submitDisbursementForm()">
          <span id="disbursementLoader" class="loader-inline">‚è≥ ƒêang x·ª≠ l√Ω...</span>
          <a id="disbursementDownloadLink" href="#" target="_blank" style="display: none;">üìÑ T·∫£i ƒê·ªÅ ngh·ªã Gi·∫£i ng√¢n</a>
        </div>
      </div>
    </form>
  </div>
</div>
  <div id="listContent" class="tab-content">
    <div class="card">
      <h2>Danh s√°ch ƒë∆°n h√†ng ƒë√£ nh·∫≠p</h2>

    <div class="filter-container">
      <div class="filter-item">
        <label for="salespersonFilter">L·ªçc theo TVBH:</label>
        <select id="salespersonFilter"></select>
      </div>
      <div class="filter-item">
        <label for="statusFilter">L·ªçc theo Tr·∫°ng th√°i:</label>
        <select id="statusFilter">
          <option value="all">T·∫•t c·∫£ Tr·∫°ng th√°i</option>
          <option value="pending">‚è≥ Ch·ªù t·∫°o</option>
          <option value="created">‚úÖ ƒê√£ t·∫°o</option>
        </select>
      </div>
      <div class="filter-item search-item">
        <label for="searchInput">T√¨m ki·∫øm:</label>
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n KH ho·∫∑c m√£ ƒë∆°n...">
      </div>
    </div>

      <div class="order-list-table">
        <div class="order-list-header">
          <div class="header-cell">Kh√°ch h√†ng</div>
          <div class="header-cell">T√™n TVBH</div>
          <div class="header-cell">M√£ ƒë∆°n h√†ng</div>
          <div class="header-cell">Tr·∫°ng th√°i</div>
        </div>
        <div id="orderListContainer" class="order-list-container">
          </div>
      </div>
    </div>
  </div>
  
  <div id="adminContent" class="tab-content">
    <h2>B·∫£ng Qu·∫£n l√Ω v√† Ch·ªânh s·ª≠a</h2>
    <div class="filter-container" class="card">
        <div class="filter-item">
          <label for="adminSalespersonFilter">L·ªçc theo TVBH:</label>
          <select id="adminSalespersonFilter"></select>
        </div>
        <div class="filter-item">
          <label for="adminStatusFilter">L·ªçc theo Tr·∫°ng th√°i:</label>
          <select id="adminStatusFilter">
            <option value="all">T·∫•t c·∫£ Tr·∫°ng th√°i</option>
            <option value="pending">‚è≥ Ch·ªù t·∫°o</option>
            <option value="created">‚úÖ ƒê√£ t·∫°o</option>
          </select>
        </div>
        <div class="filter-item search-item">
          <label for="adminSearchInput">T√¨m ki·∫øm:</label>
          <input type="text" id="adminSearchInput" placeholder="Nh·∫≠p t√™n KH, SƒêT, m√£ ƒë∆°n...">
        </div>
      </div>
    <div id="adminDetailView" class="card" style="display: none; margin-top: 20px;margin-bottom: 20px"></div>
    <div class="card">
      <div id="adminListContainer" class="order-list-container"></div>
    </div>
    
  </div>
</div>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><span class="close-button" onclick="closeLoginModal()">&times;</span><h3>ƒêƒÉng nh·∫≠p Admin</h3></div>
    <div class="modal-body">
      <label for="adminPass">M·∫≠t kh·∫©u</label>
      <input type="password" id="adminPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin...">
      <button id="loginSubmitBtn" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ===============================================================
// === BI·∫æN TO√ÄN C·ª§C ===
// ===============================================================
let adminPassword = "";
let isAdminLoggedIn = false;
let adminDataCache = [];
let allOrdersCache = []; // Cache cho danh s√°ch ƒë∆°n h√†ng
let foundContractData = null; // Cache cho d·ªØ li·ªáu h·ª£p ƒë·ªìng/ƒë∆°n h√†ng t√¨m th·∫•y


// ===============================================================
// === C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN CHUNG (UI) ===
// ===============================================================
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.style.animation = 'fadeOut 0.5s forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 4500);
}

function openTab(evt, tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove("active"));
  document.querySelectorAll('.tab-link').forEach(l => l.classList.remove("active"));
  document.getElementById(tabName + 'Content').classList.add("active");
  evt.currentTarget.classList.add("active");
}

function showLoginModal() { document.getElementById('loginModal').style.display = 'block'; }
function closeLoginModal() { document.getElementById('loginModal').style.display = 'none'; }


// ===============================================================
// === C√ÅC H√ÄM TI·ªÜN √çCH CHO FORM (format, parse) ===
// ===============================================================
function formatCurrencyInput(input) { 
  let value = input.value.replace(/\D/g, ""); 
  input.value = value ? parseInt(value, 10).toLocaleString("vi-VN") : ""; 
}
function parseCurrency(value) { 
  return parseInt(String(value).replace(/\D/g, ""), 10) || 0; 
}


// ===============================================================
// === C√ÅC H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T ===
// ===============================================================
function handleAdminLogin() {
    const pass = document.getElementById("adminPass").value;
    const btn = document.getElementById("loginSubmitBtn");
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><span>ƒêang ki·ªÉm tra...</span>';
    google.script.run.withSuccessHandler(ok => {
        if (ok) {
            isAdminLoggedIn = true; adminPassword = pass; closeLoginModal();
            document.getElementById("adminLoginIcon").onclick = handleAdminLogout;
            const adminTabBtn = document.getElementById('adminTabBtn');
            adminTabBtn.style.display = 'flex'; adminTabBtn.click();
            loadAdminTable();

            // --- TH√äM C√ÅC D√íNG N√ÄY V√ÄO ---
            populateAdminFilter();
            document.getElementById('adminSalespersonFilter').addEventListener('change', filterAdminTable);
            document.getElementById('adminStatusFilter').addEventListener('change', filterAdminTable);
            document.getElementById('adminSearchInput').addEventListener('input', filterAdminTable);
            // --- K·∫æT TH√öC PH·∫¶N TH√äM ---

        } else { showToast("Sai m·∫≠t kh·∫©u!", "danger"); }
        btn.disabled = false; btn.innerHTML = 'ƒêƒÉng nh·∫≠p';
    }).adminLogin(pass);
}

function handleAdminLogout() {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) return;
    isAdminLoggedIn = false; adminPassword = "";
    document.getElementById("adminLoginIcon").onclick = showLoginModal;
    document.getElementById('adminTabBtn').style.display = 'none';
    document.getElementById('adminDetailView').style.display = 'none';
    document.querySelector('.tab-link').click();
    showToast("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.");
}


// ===============================================================
// === C√ÅC H√ÄM CHO TAB NH·∫¨P LI·ªÜU, DANH S√ÅCH & ADMIN ===
// ===============================================================
function saveForm(data, files, btn) {
    google.script.run.withSuccessHandler(msg => {
        showToast(msg, 'success');
        loadOrders();
        document.getElementById("customerForm").reset();
        btn.disabled = false;
        btn.innerHTML = 'L∆∞u Th√¥ng Tin';
    }).withFailureHandler(err => {
        showToast("L·ªói: " + err.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = 'L∆∞u Th√¥ng Tin';
    }).submitFormWithFiles(data, files);
}

// H√†m m·ªõi ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng
function renderOrderList(orders) {
    const listContainer = document.getElementById("orderListContainer");
    listContainer.innerHTML = "";
    if (!orders || orders.length === 0) {
        listContainer.innerHTML = `<p style="text-align:center; padding: 20px;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p.</p>`;
        return;
    }

    const rowsHtml = orders.map(row => {
        const statusClass = (row.trangthai === "‚úÖ ƒê√£ t·∫°o") ? "created" : "pending";
        return `
            <div class="order-row">
            <div class="order-cell">
                <div class="name">${row.khach || ""}</div>
            </div>
            <div class="order-cell">
                <div class="sub-text">${row.tvbh || "N/A"}</div>
            </div>
            <div class="order-cell">
                <div class="sub-text">${row.madon || "Ch∆∞a c√≥"}</div>
            </div>
            <div class="order-cell order-status">
                <span class="badge ${statusClass}">${row.trangthai}</span>
            </div>
            </div>`;
    }).join('');
    listContainer.innerHTML = rowsHtml;
}

// H√†m loadOrders ƒë∆∞·ª£c c·∫≠p nh·∫≠t: ch·ªâ l·∫•y d·ªØ li·ªáu v√† g·ªçi h√†m hi·ªÉn th·ªã
function loadOrders() {
    const listContainer = document.getElementById("orderListContainer");
    listContainer.innerHTML = `<p style="padding: 20px;">ƒêang t·∫£i danh s√°ch...</p>`;
    
    google.script.run.withSuccessHandler(data => {
        allOrdersCache = data; // L∆∞u d·ªØ li·ªáu g·ªëc v√†o cache
        renderOrderList(allOrdersCache); // Hi·ªÉn th·ªã to√†n b·ªô danh s√°ch ban ƒë·∫ßu
        populateSalespersonFilter(); // C·∫≠p nh·∫≠t b·ªô l·ªçc sau khi c√≥ d·ªØ li·ªáu m·ªõi
    }).getOrders();
}

// H√†m m·ªõi: L·ªçc danh s√°ch ƒë∆°n h√†ng
function filterOrders() {
    const selectedSalesperson = document.getElementById('salespersonFilter').value;
    const selectedStatus = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

    let filteredOrders = allOrdersCache;

    // L·ªçc theo TVBH
    if (selectedSalesperson !== 'all') {
        filteredOrders = filteredOrders.filter(order => order.tvbh === selectedSalesperson);
    }

    // L·ªçc theo Tr·∫°ng th√°i
    if (selectedStatus !== 'all') {
        const statusText = selectedStatus === 'pending' ? '‚è≥ Ch·ªù t·∫°o' : '‚úÖ ƒê√£ t·∫°o';
        filteredOrders = filteredOrders.filter(order => order.trangthai === statusText);
    }

    // L·ªçc theo √¥ t√¨m ki·∫øm
    if (searchTerm) {
        filteredOrders = filteredOrders.filter(order => 
            (order.khach && order.khach.toLowerCase().includes(searchTerm)) ||
            (order.madon && order.madon.toLowerCase().includes(searchTerm))
        );
    }

    renderOrderList(filteredOrders);
}

// H√†m m·ªõi: L·∫•y danh s√°ch TVBH v√† ƒëi·ªÅn v√†o dropdown
function populateSalespersonFilter() {
    google.script.run.withSuccessHandler(salespersons => {
        const filterSelect = document.getElementById('salespersonFilter');
        filterSelect.innerHTML = '<option value="all">T·∫•t c·∫£ TVBH</option>'; // L·ª±a ch·ªçn m·∫∑c ƒë·ªãnh
        salespersons.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            filterSelect.appendChild(option);
        });
    }).getUniqueSalespersons();
}


function showDetailsInPanel(rowIndex, buttonElement) {
    const orderData = adminDataCache.find(row => row.index === rowIndex);
    if (!orderData) {
        showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt.", "danger");
        return;
    }

    // --- S·ª¨A L·ªñI ·ªû ƒê√ÇY ---
    // T√¨m ƒë·∫øn class .admin-row thay v√¨ .admin-card nh∆∞ c≈©
    document.querySelectorAll('.admin-row.active-row').forEach(row => row.classList.remove('active-row'));
    if (buttonElement) { // Th√™m ki·ªÉm tra ƒë·ªÉ tr√°nh l·ªói
        buttonElement.closest('.admin-row').classList.add('active-row');
    }
    // --- K·∫æT TH√öC S·ª¨A L·ªñI ---

    const detailPanel = document.getElementById('adminDetailView');
    
    let filesHtml = "Kh√¥ng c√≥ file ƒë√≠nh k√®m.";
    if (orderData['File ƒë√≠nh k√®m'] && orderData['File ƒë√≠nh k√®m'].trim() !== "") {
        filesHtml = orderData['File ƒë√≠nh k√®m'].split(" , ").map(fileInfo => {
            const [fileName, fileUrl] = fileInfo.split('|');
            return `<li><a href="${fileUrl}" target="_blank" style="color: var(--primary-color);">${fileName || 'Link'}</a></li>`;
        }).join("");
        filesHtml = `<ul style="margin: 0; padding-left: 20px;">${filesHtml}</ul>`;
    }

    const detailsHtml = `
      <h2>Chi ti·∫øt ƒë∆°n h√†ng - ${orderData['T√™n Kh√°ch h√†ng'] || ""}</h2>
      <div class="detail-grid">
        <p><strong>Ng√†y nh·∫≠p:</strong> ${orderData['Ng√†y nh·∫≠p'] || ""}</p>
        <p><strong>T√™n TVBH:</strong> ${orderData['T√™n TVBH'] || ""}</p>
        <p><strong>SƒêT:</strong> ${orderData['SƒêT'] || ""}</p>
        <p><strong>CCCD:</strong> ${orderData['CCCD'] || ""}</p>
        <p><strong>Ng√†y c·∫•p:</strong> ${orderData['Ng√†y c·∫•p'] || ""}</p>
        <p><strong>N∆°i c·∫•p:</strong> ${orderData['N∆°i c·∫•p'] || ""}</p>
        <p><strong>Email:</strong> ${orderData['Email kh√°ch'] || ""}</p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${orderData['ƒê·ªãa ch·ªâ'] || ""}</p>
        <p><strong>Lo·∫°i xe:</strong> ${orderData['Lo·∫°i xe'] || ""}</p>
        <p><strong>Phi√™n b·∫£n:</strong> ${orderData['Phi√™n b·∫£n'] || ""}</p>
        <p><strong>M√†u xe:</strong> ${orderData['M√†u xe'] || ""}</p>
        <p><strong>H√¨nh th·ª©c TT:</strong> ${orderData['H√¨nh th·ª©c TT'] || ""}</p>
        <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${orderData['M√£ ƒë∆°n h√†ng'] || ""}</p>
      </div>
      <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
      <h4>File ƒë√≠nh k√®m:</h4>
      <div>${filesHtml}</div>
    `;
    
    detailPanel.innerHTML = detailsHtml;
    detailPanel.style.display = 'block';
    detailPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// H√ÄM M·ªöI: D√πng ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng admin
function renderAdminTable(dataToRender) {
    const adminContainer = document.getElementById("adminListContainer");
    const oldHeader = adminContainer.parentElement.querySelector('.admin-table-header');
    if (oldHeader) oldHeader.remove();

    if (!dataToRender || dataToRender.length === 0) {
        adminContainer.innerHTML = `<p style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</p>`;
        return;
    }
    const headerHtml = `<div class="admin-table-header"><div>T√™n TVBH</div><div>T√™n Kh√°ch h√†ng</div><div>SƒêT</div><div>M√£ ƒë∆°n h√†ng</div><div>H√†nh ƒë·ªông</div></div>`;
    
    const rowsHtml = dataToRender.map(row => `
        <div class="admin-row" id="admin-row-${row.index}">
            <div class="admin-cell"><span class="cell-text">${row['T√™n TVBH'] || ""}</span><input class="cell-input" id="tvbh${row.index}" type="text" value="${row['T√™n TVBH'] || ""}"></div>
            <div class="admin-cell"><span class="cell-text">${row['T√™n Kh√°ch h√†ng'] || ""}</span><input class="cell-input" id="khach${row.index}" type="text" value="${row['T√™n Kh√°ch h√†ng'] || ""}"></div>
            <div class="admin-cell"><span class="cell-text">${row['SƒêT'] || ""}</span><input class="cell-input" id="sdt${row.index}" type="text" value="${row['SƒêT'] || ""}"></div>
            <div class="admin-cell"><span class="cell-text">${row['M√£ ƒë∆°n h√†ng'] || ""}</span><input class="cell-input" id="madon${row.index}" type="text" value="${row['M√£ ƒë∆°n h√†ng'] || ""}"></div>
            <div class="admin-cell admin-actions">
                <div class="edit-buttons">
                    <button class="btn-primary" onclick="toggleEditMode(${row.index})">S·ª≠a</button>
                    <button class="btn-secondary" onclick="showDetailsInPanel(${row.index}, this)">Xem</button>
                    <button class="btn-danger" onclick="handleDeleteOrder(${row.index})">X√≥a</button>
                </div>
                <div class="save-buttons">
                    <button class="btn-primary" onclick="saveAdminChanges(${row.index}, this)">L∆∞u</button>
                    <button class="btn-secondary" onclick="toggleEditMode(${row.index})">H·ªßy</button>
                </div>
            </div>
        </div>`
    ).join('');
    
    adminContainer.parentElement.insertAdjacentHTML('afterbegin', headerHtml);
    adminContainer.innerHTML = rowsHtml;
}

// H√†m x·ª≠ l√Ω x√≥a ƒë∆°n h√†ng
function handleDeleteOrder(rowIndex) {
    // 1. X√°c nh·∫≠n v·ªõi ng∆∞·ªùi d√πng tr∆∞·ªõc khi x√≥a
    if (!confirm("C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA vƒ©nh vi·ªÖn ƒë∆°n h√†ng n√†y kh√¥ng?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
        return; // N·∫øu ch·ªçn Cancel th√¨ d·ª´ng l·∫°i
    }

    // 2. Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω
    showToast("ƒêang x√≥a d·ªØ li·ªáu...", "info");

    // 3. G·ªçi server ƒë·ªÉ x√≥a
    google.script.run.withSuccessHandler(msg => {
        showToast(msg, "success");
        // 4. T·∫£i l·∫°i b·∫£ng admin ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch (quan tr·ªçng v√¨ s·ªë d√≤ng s·∫Ω thay ƒë·ªïi)
        loadAdminTable(); 
        loadOrders(); // C·∫≠p nh·∫≠t c·∫£ tab danh s√°ch c√¥ng khai
    }).withFailureHandler(err => {
        showToast("L·ªói khi x√≥a: " + err.message, "danger");
    }).deleteOrder(adminPassword, rowIndex);
}

// H√ÄM C≈® ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T: Ch·ªâ l·∫•y d·ªØ li·ªáu
function loadAdminTable() {
    const adminContainer = document.getElementById("adminListContainer");
    adminContainer.innerHTML = `<p>ƒêang t·∫£i d·ªØ li·ªáu admin...</p>`;
    google.script.run.withSuccessHandler(data => {
        adminDataCache = data;
        renderAdminTable(adminDataCache); // Hi·ªÉn th·ªã to√†n b·ªô d·ªØ li·ªáu ban ƒë·∫ßu
    }).getAllOrdersForAdmin(adminPassword);
}

// H√†m m·ªõi: B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ch·ªânh s·ª≠a cho m·ªôt d√≤ng
function toggleEditMode(rowIndex) {
    const row = document.getElementById(`admin-row-${rowIndex}`);
    if (row) {
        row.classList.toggle('edit-mode');
    }
}

// H√†m m·ªõi: L∆∞u c√°c thay ƒë·ªïi sau khi s·ª≠a
function saveAdminChanges(rowIndex, btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div>';

    let updateData = {
        tvbh: document.getElementById("tvbh" + rowIndex).value,
        khach: document.getElementById("khach" + rowIndex).value,
        sdt: document.getElementById("sdt" + rowIndex).value,
        madon: document.getElementById("madon" + rowIndex).value
    };

    google.script.run.withSuccessHandler(msg => {
        showToast(msg, 'success');
        // T·∫Øt ch·∫ø ƒë·ªô s·ª≠a v√† l√†m m·ªõi d·ªØ li·ªáu
        toggleEditMode(rowIndex);
        loadAdminTable(); // T·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t cache v√† hi·ªÉn th·ªã
        loadOrders(); // C·∫≠p nh·∫≠t l·∫°i c·∫£ danh s√°ch c√¥ng khai
        btn.disabled = false;
        btn.innerHTML = originalText;
    }).withFailureHandler(err => {
        showToast("L·ªói: " + err.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }).updateOrder(adminPassword, rowIndex, updateData);
}

// ===============================================================
// === C√ÅC H√ÄM CHO TAB T·∫†O H·ª¢P ƒê·ªíNG ===
// ===============================================================
function updateTotal() {
    var soLuong = parseCurrency(document.getElementById("so_luong").value);
    var donGia = parseCurrency(document.getElementById("don_gia").value);
    document.getElementById("thanh_tien").value = (soLuong > 0 && donGia > 0) ? (soLuong * donGia).toLocaleString("vi-VN") + " VND" : "";
}

function prepareFormData() {
    var checkedPolicies = document.querySelectorAll('input[name="chinh_sach_ban_hang"]:checked');
    var policiesString = Array.from(checkedPolicies).map(cb => cb.value).join("\n- ");
    return {
        so_hop_dong: document.getElementById('so_hop_dong').value.trim(), ngay_ky: document.getElementById('ngay_ky').value.trim(),
        khach_hang: document.getElementById('khach_hang').value.trim(), dia_chi: document.getElementById('dia_chi').value.trim(),
        sdt: document.getElementById('sdt').value.trim(), email: document.getElementById('email').value.trim(),
        so_cccd: document.getElementById('so_cccd').value.trim(), ngay_cap: document.getElementById('ngay_cap').value.trim(),
        noi_cap: document.getElementById('noi_cap').value.trim(), loai_xe: document.getElementById('loai_xe').value.trim(),
        phien_ban: document.getElementById('phien_ban').value.trim(), mau_xe: document.getElementById('mau_xe').value.trim(),
        chinh_sach_ban_hang: policiesString ? "- " + policiesString : "",
        so_luong: parseCurrency(document.getElementById('so_luong').value), don_gia: parseCurrency(document.getElementById('don_gia').value),
        tien_coc: parseCurrency(document.getElementById('tien_coc').value),
        tien_dot_2_TT: parseCurrency(document.getElementById('tien_dot_2_TT').value) || 0,
        tien_dot_2_TG: parseCurrency(document.getElementById('tien_dot_2_TG').value) || 0,
        tien_dot_3: parseCurrency(document.getElementById('tien_dot_3').value) || 0,
        thanh_tien: parseCurrency(document.getElementById('thanh_tien').value)
    };
}

function submitContractForm() {
    var button = document.getElementById("submitContractButton");
    var loader = document.getElementById("contractLoader");
    var downloadLink = document.getElementById("downloadLink");
    button.disabled = true; loader.style.display = "inline-block"; downloadLink.style.display = "none";
    var formData = prepareFormData();
    google.script.run.withSuccessHandler(function(response) {
        loader.style.display = "none"; button.disabled = false;
        if (response.success) {
            showToast("H·ª£p ƒë·ªìng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!");
            downloadLink.href = response.fileUrl;
            downloadLink.style.display = "block";
        } else { showToast("L·ªói khi t·∫°o h·ª£p ƒë·ªìng: " + response.message, "danger"); }
    }).withFailureHandler(function(error) {
        loader.style.display = "none"; button.disabled = false;
        showToast("C√≥ l·ªói x·∫£y ra: " + error.message, "danger");
    }).createContract(formData);
}

function togglePaymentMethod() {
    const isTraThang = document.getElementById("tra_thang").checked;
    document.getElementById("tra_thang_section").style.display = isTraThang ? "block" : "none";
    document.getElementById("tra_gop_section").style.display = !isTraThang ? "block" : "none";
}

function findOrderData() {
    const codeInput = document.getElementById('so_hop_dong');
    const orderCode = codeInput.value.trim();
    const loader = document.getElementById('lookupLoader');
    if (!orderCode) return;
    loader.style.display = 'inline-block';
    google.script.run.withSuccessHandler(response => {
        loader.style.display = 'none';
        if (response && response.success === true && response.data) {
            const data = response.data;
            try {
                document.getElementById('khach_hang').value = data['T√™n Kh√°ch h√†ng'] || '';
                document.getElementById('so_cccd').value = data['CCCD'] || '';
                document.getElementById('sdt').value = data['SƒêT'] || '';
                document.getElementById('ngay_cap').value = data['Ng√†y c·∫•p'] ? new Date(data['Ng√†y c·∫•p']).toISOString().split('T')[0] : '';
                document.getElementById('noi_cap').value = data['N∆°i c·∫•p'] || '';
                document.getElementById('dia_chi').value = data['ƒê·ªãa ch·ªâ'] || ''; 
                document.getElementById('email').value = data['Email kh√°ch'] || '';
                document.getElementById('loai_xe').value = data['Lo·∫°i xe'] || '';
                document.getElementById('phien_ban').value = data['Phi√™n b·∫£n'] || '';
                document.getElementById('mau_xe').value = data['M√†u xe'] || '';
                showToast('ƒê√£ ƒëi·ªÅn th√¥ng tin th√†nh c√¥ng!', 'success');
            } catch (error) { alert("L·ªói JavaScript khi ƒëi·ªÅn d·ªØ li·ªáu: " + error.message); }
        } else {
            const errorMessage = response ? response.error : "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server.";
            showToast("T√¨m ki·∫øm th·∫•t b·∫°i: " + errorMessage, "danger");
        }
    }).withFailureHandler(err => {
        loader.style.display = 'none';
        alert('L·ªói nghi√™m tr·ªçng khi g·ªçi server: ' + err.message);
    }).getOrderDataByCode(orderCode);
}

// ===============================================================
// === C√ÅC H√ÄM CHO TAB ƒê·ªÄ NGH·ªä GI·∫¢I NG√ÇN ===
// ===============================================================
function findContractForDisbursement() {
    const contractNumber = document.getElementById('so_hop_dong_lookup').value.trim();
    if (!contractNumber) {
        showToast("Vui l√≤ng nh·∫≠p M√£ ƒë∆°n h√†ng.", "warning");
        return;
    }
    showToast("ƒêang t√¨m th√¥ng tin...", "info");
    google.script.run.withSuccessHandler(response => {
        if (response.success) {
            showToast("ƒê√£ t√¨m th·∫•y th√¥ng tin!", "success");
            foundContractData = response.data;
            document.getElementById('dngn_ten_khach_hang').value = foundContractData['T√™n Kh√°ch h√†ng'] || '';
            document.getElementById('dngn_so_hop_dong').value = foundContractData['M√£ ƒë∆°n h√†ng'] || '';
            document.getElementById('dngn_loai_xe').value = foundContractData['Lo·∫°i xe'] || ''; 
            document.getElementById('dngn_so_tien_giai_ngan').value = ''; 
            document.getElementById('disbursementDetails').style.display = 'block';
            document.getElementById('dngn_so_tien_giai_ngan').focus();
        } else {
            showToast(response.error, "danger");
        }
    }).getOrderDataByCode(contractNumber);
}

function submitDisbursementForm() {
    if (!foundContractData) {
        showToast("L·ªói: Kh√¥ng c√≥ th√¥ng tin h·ª£p ƒë·ªìng. Vui l√≤ng t√¨m l·∫°i.", "danger");
        return;
    }
    const button = document.getElementById("submitDisbursementButton");
    const loader = document.getElementById("disbursementLoader");
    const downloadLink = document.getElementById("disbursementDownloadLink");
    button.disabled = true; loader.style.display = "inline-block"; downloadLink.style.display = "none";
    
    const taiKhoanThuhuongValue = document.getElementById('dngn_tai_khoan_thu_huong').value;
    const [soTaiKhoan, tenNganHangThuhuong] = taiKhoanThuhuongValue ? taiKhoanThuhuongValue.split('|') : [null, null];
    
    const requestData = {
      ten_khach_hang: document.getElementById('dngn_ten_khach_hang').value,
      so_hop_dong: document.getElementById('dngn_so_hop_dong').value,
      ten_ngan_hang_vay: document.getElementById('dngn_ten_ngan_hang').value,
      ngay_captbcv: document.getElementById('dngn_ngay_captbcv').value,
      loai_xe: document.getElementById('dngn_loai_xe').value,
      so_tai_khoan: soTaiKhoan,
      ten_ngan_hang_thu_huong: tenNganHangThuhuong,
      so_tien_doi_ung: parseCurrency(document.getElementById('dngn_so_tien_doi_ung').value),
      so_tien_giai_ngan: parseCurrency(document.getElementById('dngn_so_tien_giai_ngan').value)
    };

    if (!requestData.ten_ngan_hang_vay || !requestData.so_tai_khoan || !requestData.ngay_captbcv || !requestData.so_tien_giai_ngan || !requestData.so_tien_doi_ung) {
        showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng c√≥ d·∫•u (*).", "warning");
        button.disabled = false; loader.style.display = "none";
        return;
    }

    google.script.run.withSuccessHandler(response => {
        if (response.success) {
            showToast("T·∫°o ƒê·ªÅ ngh·ªã Gi·∫£i ng√¢n th√†nh c√¥ng!", "success");
            downloadLink.href = response.fileUrl;
            downloadLink.style.display = "block";
        } else {
            showToast("L·ªói: " + response.message, "danger");
        }
        button.disabled = false; loader.style.display = "none";
    }).createDisbursementRequest(requestData);
}

// ===============================================================
// === G√ÅN S·ª∞ KI·ªÜN KHI T·∫¢I TRANG ===
// ===============================================================
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.tab-link').click();
    loadOrders();
    populateSalespersonFilter(); 
    
    // G√°n s·ª± ki·ªán cho c√°c b·ªô l·ªçc
    document.getElementById('salespersonFilter').addEventListener('change', filterOrders);
    document.getElementById('statusFilter').addEventListener('change', filterOrders);
    document.getElementById('searchInput').addEventListener('input', filterOrders); // 'input' ƒë·ªÉ t√¨m ki·∫øm ngay khi g√µ
    document.getElementById('adminLoginIcon').addEventListener("click", showLoginModal);
    document.getElementById('loginSubmitBtn').addEventListener("click", handleAdminLogin);
    
    // --- B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI T·∫†I ƒê√ÇY ---
    document.getElementById("customerForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        // KI·ªÇM TRA FILE ƒê√çNH K√àM
        const fileInput = document.getElementById("files");
        if (fileInput.files.length === 0) {
            showToast("Vui l√≤ng ƒë√≠nh k√®m √≠t nh·∫•t m·ªôt file.", "warning");
            return; // D·ª´ng l·∫°i n·∫øu ch∆∞a ch·ªçn file
        }
        
        // N·∫øu ƒë√£ ch·ªçn file, ti·∫øp t·ª•c x·ª≠ l√Ω nh∆∞ c≈©
        const btn = e.target.querySelector("button[type='submit']");
        btn.disabled = true; 
        btn.innerHTML = '<div class="spinner"></div><span>ƒêang l∆∞u...</span>';
        let data = Object.fromEntries(new FormData(this).entries());
        
        if (fileInput.files.length > 3) {
            showToast("Ch·ªâ ƒë∆∞·ª£c upload t·ªëi ƒëa 3 file!", 'danger');
            btn.disabled = false; 
            btn.innerHTML = 'L∆∞u Th√¥ng Tin'; 
            return;
        }

        let files = []; 
        let count = 0;
        [...fileInput.files].forEach(file => {
            let reader = new FileReader();
            reader.onload = evt => {
                files.push({ name: file.name, mimeType: file.type, data: evt.target.result.split(",")[1] });
                if (++count === fileInput.files.length) {
                    saveForm(data, files, btn);
                }
            };
            reader.readAsDataURL(file);
        });
    });
    // --- K·∫æT TH√öC THAY ƒê·ªîI ---

    document.getElementById('so_hop_dong').addEventListener('blur', findOrderData);
    window.onclick = function(event) { 
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none"; 
        }
    }
});

// H√ÄM M·ªöI: ƒêi·ªÅn d·ªØ li·ªáu v√†o b·ªô l·ªçc c·ªßa Admin
function populateAdminFilter() {
    google.script.run.withSuccessHandler(salespersons => {
        const filterSelect = document.getElementById('adminSalespersonFilter');
        filterSelect.innerHTML = '<option value="all">T·∫•t c·∫£ TVBH</option>';
        salespersons.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            filterSelect.appendChild(option);
        });
    }).getUniqueSalespersons();
}

// H√ÄM M·ªöI: L·ªçc b·∫£ng Admin
function filterAdminTable() {
    const selectedSalesperson = document.getElementById('adminSalespersonFilter').value;
    const selectedStatus = document.getElementById('adminStatusFilter').value;
    const searchTerm = document.getElementById('adminSearchInput').value.toLowerCase().trim();

    let filteredData = adminDataCache;

    if (selectedSalesperson !== 'all') {
        filteredData = filteredData.filter(row => row['T√™n TVBH'] === selectedSalesperson);
    }
    if (selectedStatus !== 'all') {
        const hasCode = selectedStatus === 'created';
        filteredData = filteredData.filter(row => !!(row['M√£ ƒë∆°n h√†ng'] && row['M√£ ƒë∆°n h√†ng'].trim()) === hasCode);
    }
    if (searchTerm) {
        filteredData = filteredData.filter(row => 
            (row['T√™n Kh√°ch h√†ng'] && row['T√™n Kh√°ch h√†ng'].toLowerCase().includes(searchTerm)) ||
            (row['SƒêT'] && row['SƒêT'].toString().toLowerCase().includes(searchTerm)) ||
            (row['M√£ ƒë∆°n h√†ng'] && row['M√£ ƒë∆°n h√†ng'].toLowerCase().includes(searchTerm))
        );
    }
    renderAdminTable(filteredData);
}
// D√°n h√†m n√†y v√†o b√™n trong th·∫ª <script>
function calculatePaymentInstallments() {
  // L·∫•y gi√° tr·ªã s·ªë t·ª´ c√°c √¥ input
  const donGia = parseCurrency(document.getElementById('don_gia').value);
  const tienCoc = parseCurrency(document.getElementById('tien_coc').value);

  // T√≠nh to√°n cho tr∆∞·ªùng h·ª£p Tr·∫£ th·∫≥ng
  const tienDot2TT = donGia - tienCoc;
  const tienDot2TT_Input = document.getElementById('tien_dot_2_TT');
  // Hi·ªÉn th·ªã k·∫øt qu·∫£, n·∫øu √¢m th√¨ hi·ªÉn th·ªã 0
  tienDot2TT_Input.value = (tienDot2TT > 0) ? tienDot2TT.toLocaleString("vi-VN") : "0";

  // T√≠nh to√°n cho tr∆∞·ªùng h·ª£p Tr·∫£ g√≥p
  const tienDot2TG = parseCurrency(document.getElementById('tien_dot_2_TG').value);
  const tienDot3 = donGia - tienCoc - tienDot2TG;
  const tienDot3_Input = document.getElementById('tien_dot_3');
  // Hi·ªÉn th·ªã k·∫øt qu·∫£, n·∫øu √¢m th√¨ hi·ªÉn th·ªã 0
  tienDot3_Input.value = (tienDot3 > 0) ? tienDot3.toLocaleString("vi-VN") : "0";
}

</script>
</body>
</html>
